
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://swe-bench.com/latest/api/inference/">
      
      
        <link rel="prev" href="../harness/">
      
      
        <link rel="next" href="../versioning/">
      
      
      <link rel="icon" href="../../assets/swellama.svg">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.16">
    
    
      
        <title>Inference - SWE-bench documentation</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.7e37652d.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      

  
  
  
  
  <style>:root{--md-annotation-icon:url('data:image/svg+xml;charset=utf-8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20viewBox%3D%220%200%2024%2024%22%3E%3Cpath%20d%3D%22M22%2012a10%2010%200%200%201-10%2010A10%2010%200%200%201%202%2012%2010%2010%200%200%201%2012%202a10%2010%200%200%201%2010%2010m-12%206%206-6-6-6-1.4%201.4%204.6%204.6-4.6%204.6z%22/%3E%3C/svg%3E');}</style>


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../assets/_mkdocstrings.css">
    
      <link rel="stylesheet" href="../../css/custom.css">
    
      <link rel="stylesheet" href="../../css/mkdocstrings.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      
  


  
  

<script id="__analytics">function __md_analytics(){function e(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],e("js",new Date),e("config","G-T5P2NYGJYR"),document.addEventListener("DOMContentLoaded",(function(){document.forms.search&&document.forms.search.query.addEventListener("blur",(function(){this.value&&e("event","search",{search_term:this.value})}));document$.subscribe((function(){var t=document.forms.feedback;if(void 0!==t)for(var a of t.querySelectorAll("[type=submit]"))a.addEventListener("click",(function(a){a.preventDefault();var n=document.location.pathname,d=this.getAttribute("data-md-value");e("event","feedback",{page:n,data:d}),t.firstElementChild.disabled=!0;var r=t.querySelector(".md-feedback__note [data-md-value='"+d+"']");r&&(r.hidden=!1)})),t.hidden=!1})),location$.subscribe((function(t){e("config","G-T5P2NYGJYR",{page_path:t.pathname})}))}));var t=document.createElement("script");t.async=!0,t.src="https://www.googletagmanager.com/gtag/js?id=G-T5P2NYGJYR",document.getElementById("__analytics").insertAdjacentElement("afterEnd",t)}</script>
  
    <script>"undefined"!=typeof __md_analytics&&__md_analytics()</script>
  

    
    
    
   <link href="../../assets/stylesheets/glightbox.min.css" rel="stylesheet"/><style>
    html.glightbox-open { overflow: initial; height: 100%; }
    .gslide-title { margin-top: 0px; user-select: text; }
    .gslide-desc { color: #666; user-select: text; }
    .gslide-image img { background: white; }
    .gscrollbar-fixer { padding-right: 15px; }
    .gdesc-inner { font-size: 0.75rem; }
    body[data-md-color-scheme="slate"] .gdesc-inner { background: var(--md-default-bg-color);}
    body[data-md-color-scheme="slate"] .gslide-title { color: var(--md-default-fg-color);}
    body[data-md-color-scheme="slate"] .gslide-desc { color: var(--md-default-fg-color);}</style> <script src="../../assets/javascripts/glightbox.min.js"></script></head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#inference-api" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <div data-md-color-scheme="default" data-md-component="outdated" hidden>
        
      </div>
    
    
      

  

<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="SWE-bench documentation" class="md-header__button md-logo" aria-label="SWE-bench documentation" data-md-component="logo">
      
  <img src="../../assets/swellama.svg" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            SWE-bench documentation
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Inference
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme)" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m14.3 16-.7-2h-3.2l-.7 2H7.8L11 7h2l3.2 9zM20 8.69V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12zm-9.15 3.96h2.3L12 9z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="deep-orange"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3zm3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95zm-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="deep-orange"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_2">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5s-1.65.15-2.39.42zM3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29zm.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14zM20.65 7l-1.77 3.79a7.02 7.02 0 0 0-2.38-4.15zm-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29zM12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/SWE-bench/SWE-bench" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill="currentColor" d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    SWE-bench
  </div>
</a>
      </div>
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../.." class="md-tabs__link">
          
  
  
    
  
  Getting Started

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../guides/quickstart/" class="md-tabs__link">
          
  
  
    
  
  User Guides

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../reference/harness/" class="md-tabs__link">
          
  
  
    
  
  Reference

        </a>
      </li>
    
  

      
        
  
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../harness/" class="md-tabs__link">
          
  
  
    
  
  API

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="SWE-bench documentation" class="md-nav__button md-logo" aria-label="SWE-bench documentation" data-md-component="logo">
      
  <img src="../../assets/swellama.svg" alt="logo">

    </a>
    SWE-bench documentation
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/SWE-bench/SWE-bench" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill="currentColor" d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    SWE-bench
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../.." class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    Getting Started
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_1" id="__nav_1_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_1">
            <span class="md-nav__icon md-icon"></span>
            Getting Started
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../installation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Installation
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../faq/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    FAQ
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    User Guides
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            User Guides
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guides/quickstart/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Quickstart
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guides/evaluation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Evaluation
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guides/docker_setup/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Docker Setup
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guides/datasets/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Datasets
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guides/create_rag_datasets/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Create RAG Datasets
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Reference
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Reference
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/harness/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    The Harness
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/inference/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Inference
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/versioning/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Versioning
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
      
        
      
        
      
        
      
    
    
    
      
        
        
      
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" checked>
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    API
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            API
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../harness/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Harness
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    Inference
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    Inference
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#swebench.inference" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;inference
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" inference">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#swebench.inference.llamao" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;llamao
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" llamao">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#swebench.inference.llamao.distributed_attention" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;distributed_attention
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" distributed_attention">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#swebench.inference.llamao.distributed_attention.SeqAllToAll" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;SeqAllToAll
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.llamao.distributed_attention.DistributedAttention" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;DistributedAttention
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.llamao.modeling_flash_llama" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;modeling_flash_llama
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" modeling_flash_llama">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#swebench.inference.llamao.modeling_flash_llama.logger" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-attribute"></code>&nbsp;logger
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.llamao.modeling_flash_llama.LlamaRMSNorm" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;LlamaRMSNorm
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.llamao.modeling_flash_llama.FlashRotaryEmbedding" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;FlashRotaryEmbedding
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.llamao.modeling_flash_llama.LlamaMLP" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;LlamaMLP
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.llamao.modeling_flash_llama.LlamaAttention" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;LlamaAttention
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.llamao.modeling_flash_llama.LlamaDecoderLayer" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;LlamaDecoderLayer
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.llamao.modeling_flash_llama.LlamaPreTrainedModel" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;LlamaPreTrainedModel
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.llamao.modeling_flash_llama.LlamaModel" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;LlamaModel
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.llamao.modeling_flash_llama.LlamaForCausalLM" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;LlamaForCausalLM
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.llamao.modeling_flash_llama.LlamaForSequenceClassification" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;LlamaForSequenceClassification
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.llamao.modeling_flash_llama.rmsnorm_func" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;rmsnorm_func
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.llamao.modeling_flash_llama.repeat_kv" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;repeat_kv
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.make_datasets" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;make_datasets
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" make_datasets">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#swebench.inference.make_datasets.bm25_retrieval" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;bm25_retrieval
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" bm25_retrieval">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#swebench.inference.make_datasets.bm25_retrieval.logger" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-attribute"></code>&nbsp;logger
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.make_datasets.bm25_retrieval.DOCUMENT_ENCODING_FUNCTIONS" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-attribute"></code>&nbsp;DOCUMENT_ENCODING_FUNCTIONS
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.make_datasets.bm25_retrieval.parser" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-attribute"></code>&nbsp;parser
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.make_datasets.bm25_retrieval.args" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-attribute"></code>&nbsp;args
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.make_datasets.bm25_retrieval.ContextManager" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;ContextManager
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.make_datasets.bm25_retrieval.file_name_and_contents" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;file_name_and_contents
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.make_datasets.bm25_retrieval.file_name_and_documentation" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;file_name_and_documentation
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.make_datasets.bm25_retrieval.file_name_and_docs_jedi" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;file_name_and_docs_jedi
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.make_datasets.bm25_retrieval.clone_repo" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;clone_repo
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.make_datasets.bm25_retrieval.build_documents" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;build_documents
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.make_datasets.bm25_retrieval.make_index" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;make_index
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.make_datasets.bm25_retrieval.get_remaining_instances" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;get_remaining_instances
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.make_datasets.bm25_retrieval.search" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;search
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.make_datasets.bm25_retrieval.search_indexes" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;search_indexes
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.make_datasets.bm25_retrieval.get_missing_ids" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;get_missing_ids
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.make_datasets.bm25_retrieval.get_index_paths_worker" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;get_index_paths_worker
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.make_datasets.bm25_retrieval.get_index_paths" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;get_index_paths
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.make_datasets.bm25_retrieval.get_root_dir" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;get_root_dir
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.make_datasets.bm25_retrieval.main" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;main
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.make_datasets.create_instance" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;create_instance
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" create_instance">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#swebench.inference.make_datasets.create_instance.logger" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-attribute"></code>&nbsp;logger
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.make_datasets.create_instance.PATCH_EXAMPLE" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-attribute"></code>&nbsp;PATCH_EXAMPLE
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.make_datasets.create_instance.FULL_GENERATION_EXAMPLE" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-attribute"></code>&nbsp;FULL_GENERATION_EXAMPLE
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.make_datasets.create_instance.PROMPT_FUNCTIONS" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-attribute"></code>&nbsp;PROMPT_FUNCTIONS
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.make_datasets.create_instance.add_lines_list" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;add_lines_list
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.make_datasets.create_instance.add_lines" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;add_lines
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.make_datasets.create_instance.make_code_text" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;make_code_text
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.make_datasets.create_instance.make_code_text_edits_only" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;make_code_text_edits_only
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.make_datasets.create_instance.prompt_style_2" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;prompt_style_2
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.make_datasets.create_instance.prompt_style_2_edits_only" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;prompt_style_2_edits_only
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.make_datasets.create_instance.prompt_style_3" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;prompt_style_3
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.make_datasets.create_instance.full_file_gen" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;full_file_gen
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.make_datasets.create_instance.ingest_files" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;ingest_files
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.make_datasets.create_instance.add_retrieval_results" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;add_retrieval_results
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.make_datasets.create_instance.get_oracle_filenames" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;get_oracle_filenames
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.make_datasets.create_instance.add_text_inputs" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;add_text_inputs
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.make_datasets.create_text_dataset" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;create_text_dataset
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" create_text_dataset">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#swebench.inference.make_datasets.create_text_dataset.logger" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-attribute"></code>&nbsp;logger
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.make_datasets.create_text_dataset.parser" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-attribute"></code>&nbsp;parser
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.make_datasets.create_text_dataset.load_jsonl_file" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;load_jsonl_file
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.make_datasets.create_text_dataset.instances_generator" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;instances_generator
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.make_datasets.create_text_dataset.get_training_and_eval_instances" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;get_training_and_eval_instances
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.make_datasets.create_text_dataset.extract_fields" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;extract_fields
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.make_datasets.create_text_dataset.validate_arguments" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;validate_arguments
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.make_datasets.create_text_dataset.construct_output_filename" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;construct_output_filename
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.make_datasets.create_text_dataset.main" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;main
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.make_datasets.eval_retrieval" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;eval_retrieval
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" eval_retrieval">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#swebench.inference.make_datasets.eval_retrieval.logger" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-attribute"></code>&nbsp;logger
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.make_datasets.eval_retrieval.parser" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-attribute"></code>&nbsp;parser
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.make_datasets.eval_retrieval.args" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-attribute"></code>&nbsp;args
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.make_datasets.eval_retrieval.main" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;main
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.make_datasets.tokenize_dataset" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;tokenize_dataset
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" tokenize_dataset">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#swebench.inference.make_datasets.tokenize_dataset.logger" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-attribute"></code>&nbsp;logger
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.make_datasets.tokenize_dataset.TOKENIZER_FUNCS" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-attribute"></code>&nbsp;TOKENIZER_FUNCS
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.make_datasets.tokenize_dataset.parser" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-attribute"></code>&nbsp;parser
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.make_datasets.tokenize_dataset.cl100k" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;cl100k
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.make_datasets.tokenize_dataset.llama" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;llama
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.make_datasets.tokenize_dataset.extract_fields" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;extract_fields
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.make_datasets.tokenize_dataset.extract_test_fields" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;extract_test_fields
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.make_datasets.tokenize_dataset.add_columns_from_dict" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;add_columns_from_dict
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.make_datasets.tokenize_dataset.main" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;main
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.make_datasets.utils" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;utils
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" utils">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#swebench.inference.make_datasets.utils.DIFF_PATTERN" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-attribute"></code>&nbsp;DIFF_PATTERN
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.make_datasets.utils.PATCH_PATTERN" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-attribute"></code>&nbsp;PATCH_PATTERN
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.make_datasets.utils.PATCH_FILE_PATTERN" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-attribute"></code>&nbsp;PATCH_FILE_PATTERN
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.make_datasets.utils.PATCH_HUNK_PATTERN" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-attribute"></code>&nbsp;PATCH_HUNK_PATTERN
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.make_datasets.utils.ContextManager" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;ContextManager
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.make_datasets.utils.AutoContextManager" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;AutoContextManager
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.make_datasets.utils.get_first_idx" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;get_first_idx
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.make_datasets.utils.get_last_idx" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;get_last_idx
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.make_datasets.utils.strip_content" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;strip_content
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.make_datasets.utils.get_hunk_stats" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;get_hunk_stats
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.make_datasets.utils.repair_patch" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;repair_patch
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.make_datasets.utils.extract_minimal_patch" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;extract_minimal_patch
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.make_datasets.utils.extract_diff" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;extract_diff
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.make_datasets.utils.is_test" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;is_test
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.make_datasets.utils.get_imported_modules" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;get_imported_modules
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.make_datasets.utils.resolve_module_to_file" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;resolve_module_to_file
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.make_datasets.utils.ingest_file_directory_contents" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;ingest_file_directory_contents
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.make_datasets.utils.detect_encoding" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;detect_encoding
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.make_datasets.utils.list_files" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;list_files
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.make_datasets.utils.ingest_directory_contents" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;ingest_directory_contents
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.make_datasets.utils.string_to_bool" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;string_to_bool
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.run_api" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;run_api
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" run_api">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#swebench.inference.run_api.logger" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-attribute"></code>&nbsp;logger
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.run_api.MODEL_LIMITS" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-attribute"></code>&nbsp;MODEL_LIMITS
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.run_api.MODEL_COST_PER_INPUT" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-attribute"></code>&nbsp;MODEL_COST_PER_INPUT
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.run_api.MODEL_COST_PER_OUTPUT" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-attribute"></code>&nbsp;MODEL_COST_PER_OUTPUT
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.run_api.ENGINES" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-attribute"></code>&nbsp;ENGINES
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.run_api.parser" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-attribute"></code>&nbsp;parser
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.run_api.args" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-attribute"></code>&nbsp;args
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.run_api.calc_cost" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;calc_cost
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.run_api.call_chat" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;call_chat
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.run_api.gpt_tokenize" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;gpt_tokenize
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.run_api.claude_tokenize" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;claude_tokenize
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.run_api.openai_inference" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;openai_inference
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.run_api.call_anthropic" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;call_anthropic
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.run_api.call_anthropic_v2" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;call_anthropic_v2
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.run_api.anthropic_inference" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;anthropic_inference
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.run_api.parse_model_args" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;parse_model_args
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.run_api.main" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;main
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.run_live" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;run_live
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" run_live">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#swebench.inference.run_live.logger" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-attribute"></code>&nbsp;logger
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.run_live.parser" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-attribute"></code>&nbsp;parser
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.run_live.args" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-attribute"></code>&nbsp;args
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.run_live.get_problem_statement" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;get_problem_statement
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.run_live.get_readme_files" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;get_readme_files
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.run_live.make_instance" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;make_instance
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.run_live.parse_issue_url" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;parse_issue_url
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.run_live.main" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;main
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.run_llama" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;run_llama
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" run_llama">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#swebench.inference.run_llama.logger" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-attribute"></code>&nbsp;logger
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.run_llama.DEVICE_MAPS" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-attribute"></code>&nbsp;DEVICE_MAPS
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.run_llama.parser" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-attribute"></code>&nbsp;parser
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.run_llama.args" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-attribute"></code>&nbsp;args
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.run_llama.get_output_file" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;get_output_file
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.run_llama.load_model" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;load_model
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.run_llama.load_tokenizer" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;load_tokenizer
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.run_llama.load_data" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;load_data
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.run_llama.generate" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;generate
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.run_llama.get_all_existing_ids" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;get_all_existing_ids
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.run_llama.main" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;main
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../versioning/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Versioning
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#swebench.inference" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;inference
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" inference">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#swebench.inference.llamao" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;llamao
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" llamao">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#swebench.inference.llamao.distributed_attention" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;distributed_attention
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" distributed_attention">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#swebench.inference.llamao.distributed_attention.SeqAllToAll" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;SeqAllToAll
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.llamao.distributed_attention.DistributedAttention" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;DistributedAttention
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.llamao.modeling_flash_llama" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;modeling_flash_llama
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" modeling_flash_llama">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#swebench.inference.llamao.modeling_flash_llama.logger" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-attribute"></code>&nbsp;logger
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.llamao.modeling_flash_llama.LlamaRMSNorm" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;LlamaRMSNorm
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.llamao.modeling_flash_llama.FlashRotaryEmbedding" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;FlashRotaryEmbedding
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.llamao.modeling_flash_llama.LlamaMLP" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;LlamaMLP
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.llamao.modeling_flash_llama.LlamaAttention" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;LlamaAttention
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.llamao.modeling_flash_llama.LlamaDecoderLayer" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;LlamaDecoderLayer
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.llamao.modeling_flash_llama.LlamaPreTrainedModel" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;LlamaPreTrainedModel
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.llamao.modeling_flash_llama.LlamaModel" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;LlamaModel
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.llamao.modeling_flash_llama.LlamaForCausalLM" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;LlamaForCausalLM
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.llamao.modeling_flash_llama.LlamaForSequenceClassification" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;LlamaForSequenceClassification
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.llamao.modeling_flash_llama.rmsnorm_func" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;rmsnorm_func
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.llamao.modeling_flash_llama.repeat_kv" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;repeat_kv
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.make_datasets" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;make_datasets
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" make_datasets">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#swebench.inference.make_datasets.bm25_retrieval" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;bm25_retrieval
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" bm25_retrieval">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#swebench.inference.make_datasets.bm25_retrieval.logger" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-attribute"></code>&nbsp;logger
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.make_datasets.bm25_retrieval.DOCUMENT_ENCODING_FUNCTIONS" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-attribute"></code>&nbsp;DOCUMENT_ENCODING_FUNCTIONS
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.make_datasets.bm25_retrieval.parser" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-attribute"></code>&nbsp;parser
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.make_datasets.bm25_retrieval.args" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-attribute"></code>&nbsp;args
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.make_datasets.bm25_retrieval.ContextManager" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;ContextManager
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.make_datasets.bm25_retrieval.file_name_and_contents" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;file_name_and_contents
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.make_datasets.bm25_retrieval.file_name_and_documentation" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;file_name_and_documentation
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.make_datasets.bm25_retrieval.file_name_and_docs_jedi" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;file_name_and_docs_jedi
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.make_datasets.bm25_retrieval.clone_repo" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;clone_repo
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.make_datasets.bm25_retrieval.build_documents" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;build_documents
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.make_datasets.bm25_retrieval.make_index" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;make_index
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.make_datasets.bm25_retrieval.get_remaining_instances" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;get_remaining_instances
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.make_datasets.bm25_retrieval.search" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;search
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.make_datasets.bm25_retrieval.search_indexes" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;search_indexes
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.make_datasets.bm25_retrieval.get_missing_ids" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;get_missing_ids
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.make_datasets.bm25_retrieval.get_index_paths_worker" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;get_index_paths_worker
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.make_datasets.bm25_retrieval.get_index_paths" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;get_index_paths
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.make_datasets.bm25_retrieval.get_root_dir" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;get_root_dir
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.make_datasets.bm25_retrieval.main" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;main
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.make_datasets.create_instance" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;create_instance
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" create_instance">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#swebench.inference.make_datasets.create_instance.logger" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-attribute"></code>&nbsp;logger
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.make_datasets.create_instance.PATCH_EXAMPLE" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-attribute"></code>&nbsp;PATCH_EXAMPLE
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.make_datasets.create_instance.FULL_GENERATION_EXAMPLE" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-attribute"></code>&nbsp;FULL_GENERATION_EXAMPLE
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.make_datasets.create_instance.PROMPT_FUNCTIONS" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-attribute"></code>&nbsp;PROMPT_FUNCTIONS
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.make_datasets.create_instance.add_lines_list" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;add_lines_list
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.make_datasets.create_instance.add_lines" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;add_lines
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.make_datasets.create_instance.make_code_text" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;make_code_text
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.make_datasets.create_instance.make_code_text_edits_only" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;make_code_text_edits_only
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.make_datasets.create_instance.prompt_style_2" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;prompt_style_2
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.make_datasets.create_instance.prompt_style_2_edits_only" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;prompt_style_2_edits_only
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.make_datasets.create_instance.prompt_style_3" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;prompt_style_3
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.make_datasets.create_instance.full_file_gen" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;full_file_gen
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.make_datasets.create_instance.ingest_files" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;ingest_files
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.make_datasets.create_instance.add_retrieval_results" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;add_retrieval_results
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.make_datasets.create_instance.get_oracle_filenames" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;get_oracle_filenames
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.make_datasets.create_instance.add_text_inputs" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;add_text_inputs
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.make_datasets.create_text_dataset" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;create_text_dataset
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" create_text_dataset">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#swebench.inference.make_datasets.create_text_dataset.logger" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-attribute"></code>&nbsp;logger
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.make_datasets.create_text_dataset.parser" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-attribute"></code>&nbsp;parser
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.make_datasets.create_text_dataset.load_jsonl_file" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;load_jsonl_file
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.make_datasets.create_text_dataset.instances_generator" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;instances_generator
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.make_datasets.create_text_dataset.get_training_and_eval_instances" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;get_training_and_eval_instances
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.make_datasets.create_text_dataset.extract_fields" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;extract_fields
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.make_datasets.create_text_dataset.validate_arguments" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;validate_arguments
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.make_datasets.create_text_dataset.construct_output_filename" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;construct_output_filename
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.make_datasets.create_text_dataset.main" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;main
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.make_datasets.eval_retrieval" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;eval_retrieval
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" eval_retrieval">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#swebench.inference.make_datasets.eval_retrieval.logger" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-attribute"></code>&nbsp;logger
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.make_datasets.eval_retrieval.parser" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-attribute"></code>&nbsp;parser
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.make_datasets.eval_retrieval.args" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-attribute"></code>&nbsp;args
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.make_datasets.eval_retrieval.main" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;main
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.make_datasets.tokenize_dataset" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;tokenize_dataset
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" tokenize_dataset">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#swebench.inference.make_datasets.tokenize_dataset.logger" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-attribute"></code>&nbsp;logger
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.make_datasets.tokenize_dataset.TOKENIZER_FUNCS" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-attribute"></code>&nbsp;TOKENIZER_FUNCS
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.make_datasets.tokenize_dataset.parser" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-attribute"></code>&nbsp;parser
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.make_datasets.tokenize_dataset.cl100k" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;cl100k
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.make_datasets.tokenize_dataset.llama" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;llama
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.make_datasets.tokenize_dataset.extract_fields" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;extract_fields
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.make_datasets.tokenize_dataset.extract_test_fields" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;extract_test_fields
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.make_datasets.tokenize_dataset.add_columns_from_dict" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;add_columns_from_dict
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.make_datasets.tokenize_dataset.main" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;main
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.make_datasets.utils" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;utils
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" utils">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#swebench.inference.make_datasets.utils.DIFF_PATTERN" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-attribute"></code>&nbsp;DIFF_PATTERN
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.make_datasets.utils.PATCH_PATTERN" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-attribute"></code>&nbsp;PATCH_PATTERN
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.make_datasets.utils.PATCH_FILE_PATTERN" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-attribute"></code>&nbsp;PATCH_FILE_PATTERN
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.make_datasets.utils.PATCH_HUNK_PATTERN" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-attribute"></code>&nbsp;PATCH_HUNK_PATTERN
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.make_datasets.utils.ContextManager" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;ContextManager
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.make_datasets.utils.AutoContextManager" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;AutoContextManager
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.make_datasets.utils.get_first_idx" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;get_first_idx
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.make_datasets.utils.get_last_idx" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;get_last_idx
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.make_datasets.utils.strip_content" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;strip_content
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.make_datasets.utils.get_hunk_stats" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;get_hunk_stats
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.make_datasets.utils.repair_patch" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;repair_patch
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.make_datasets.utils.extract_minimal_patch" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;extract_minimal_patch
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.make_datasets.utils.extract_diff" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;extract_diff
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.make_datasets.utils.is_test" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;is_test
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.make_datasets.utils.get_imported_modules" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;get_imported_modules
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.make_datasets.utils.resolve_module_to_file" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;resolve_module_to_file
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.make_datasets.utils.ingest_file_directory_contents" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;ingest_file_directory_contents
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.make_datasets.utils.detect_encoding" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;detect_encoding
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.make_datasets.utils.list_files" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;list_files
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.make_datasets.utils.ingest_directory_contents" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;ingest_directory_contents
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.make_datasets.utils.string_to_bool" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;string_to_bool
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.run_api" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;run_api
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" run_api">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#swebench.inference.run_api.logger" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-attribute"></code>&nbsp;logger
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.run_api.MODEL_LIMITS" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-attribute"></code>&nbsp;MODEL_LIMITS
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.run_api.MODEL_COST_PER_INPUT" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-attribute"></code>&nbsp;MODEL_COST_PER_INPUT
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.run_api.MODEL_COST_PER_OUTPUT" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-attribute"></code>&nbsp;MODEL_COST_PER_OUTPUT
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.run_api.ENGINES" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-attribute"></code>&nbsp;ENGINES
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.run_api.parser" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-attribute"></code>&nbsp;parser
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.run_api.args" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-attribute"></code>&nbsp;args
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.run_api.calc_cost" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;calc_cost
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.run_api.call_chat" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;call_chat
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.run_api.gpt_tokenize" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;gpt_tokenize
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.run_api.claude_tokenize" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;claude_tokenize
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.run_api.openai_inference" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;openai_inference
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.run_api.call_anthropic" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;call_anthropic
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.run_api.call_anthropic_v2" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;call_anthropic_v2
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.run_api.anthropic_inference" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;anthropic_inference
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.run_api.parse_model_args" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;parse_model_args
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.run_api.main" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;main
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.run_live" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;run_live
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" run_live">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#swebench.inference.run_live.logger" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-attribute"></code>&nbsp;logger
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.run_live.parser" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-attribute"></code>&nbsp;parser
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.run_live.args" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-attribute"></code>&nbsp;args
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.run_live.get_problem_statement" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;get_problem_statement
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.run_live.get_readme_files" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;get_readme_files
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.run_live.make_instance" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;make_instance
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.run_live.parse_issue_url" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;parse_issue_url
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.run_live.main" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;main
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.run_llama" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;run_llama
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" run_llama">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#swebench.inference.run_llama.logger" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-attribute"></code>&nbsp;logger
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.run_llama.DEVICE_MAPS" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-attribute"></code>&nbsp;DEVICE_MAPS
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.run_llama.parser" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-attribute"></code>&nbsp;parser
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.run_llama.args" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-attribute"></code>&nbsp;args
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.run_llama.get_output_file" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;get_output_file
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.run_llama.load_model" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;load_model
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.run_llama.load_tokenizer" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;load_tokenizer
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.run_llama.load_data" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;load_data
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.run_llama.generate" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;generate
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.run_llama.get_all_existing_ids" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;get_all_existing_ids
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swebench.inference.run_llama.main" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;main
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
    <a href="https://github.com/SWE-bench/SWE-bench/edit/main/docs/api/inference.md" title="Edit this page" class="md-content__button md-icon" rel="edit">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M10 20H6V4h7v5h5v3.1l2-2V8l-6-6H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h4zm10.2-7c.1 0 .3.1.4.2l1.3 1.3c.2.2.2.6 0 .8l-1 1-2.1-2.1 1-1c.1-.1.2-.2.4-.2m0 3.9L14.1 23H12v-2.1l6.1-6.1z"/></svg>
    </a>
  
  


<h1 id="inference-api">Inference API</h1>


<div class="doc doc-object doc-module">



<h3 id="swebench.inference" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <span class="doc doc-object-name doc-module-name">swebench.inference</span>


</h3>

    <div class="doc doc-contents first">









  <div class="doc doc-children">










<div class="doc doc-object doc-module">



<h4 id="swebench.inference.llamao" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <span class="doc doc-object-name doc-module-name">llamao</span>


</h4>

    <div class="doc doc-contents ">









  <div class="doc doc-children">










<div class="doc doc-object doc-module">



<h5 id="swebench.inference.llamao.distributed_attention" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <span class="doc doc-object-name doc-module-name">distributed_attention</span>


</h5>

    <div class="doc doc-contents ">









  <div class="doc doc-children">








<div class="doc doc-object doc-class">



<h6 id="swebench.inference.llamao.distributed_attention.SeqAllToAll" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>            <span class="doc doc-object-name doc-class-name">SeqAllToAll</span>


</h6>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="torch.autograd.Function">Function</span></code></p>











  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h7 id="swebench.inference.llamao.distributed_attention.SeqAllToAll.forward" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <span class="doc doc-object-name doc-function-name">forward</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-staticmethod"><code>staticmethod</code></small>
  </span>

</h7>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">forward</span><span class="p">(</span><span class="n">ctx</span><span class="p">:</span> <span class="n"><span title="typing.Any">Any</span></span><span class="p">,</span> <span class="nb">input</span><span class="p">:</span> <span class="n"><span title="torch.Tensor">Tensor</span></span><span class="p">,</span> <span class="n">scatter_idx</span><span class="p">:</span> <span class="n"><span title="int">int</span></span><span class="p">,</span> <span class="n">gather_idx</span><span class="p">:</span> <span class="n"><span title="int">int</span></span><span class="p">,</span> <span class="n">group</span><span class="p">:</span> <span class="n"><span title="typing.Any">Any</span></span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><span title="torch.Tensor">Tensor</span></span>
</code></pre></div>

    <div class="doc doc-contents ">


            <details class="quote">
              <summary>Source code in <code>swebench/inference/llamao/distributed_attention.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@staticmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span>
    <span class="n">ctx</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="nb">input</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span> <span class="n">scatter_idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">gather_idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">group</span><span class="p">:</span> <span class="n">Any</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
    <span class="n">ctx</span><span class="o">.</span><span class="n">scatter_idx</span> <span class="o">=</span> <span class="n">scatter_idx</span>
    <span class="n">ctx</span><span class="o">.</span><span class="n">gather_idx</span> <span class="o">=</span> <span class="n">gather_idx</span>
    <span class="n">ctx</span><span class="o">.</span><span class="n">group</span> <span class="o">=</span> <span class="n">group</span>

    <span class="n">world_size</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">get_world_size</span><span class="p">(</span><span class="n">group</span><span class="p">)</span>

    <span class="n">input_list</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">t</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor_split</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="n">world_size</span><span class="p">,</span> <span class="n">scatter_idx</span><span class="p">)</span>
    <span class="p">]</span>
    <span class="n">output_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">empty_like</span><span class="p">(</span><span class="n">input_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">world_size</span><span class="p">)]</span>

    <span class="n">dist</span><span class="o">.</span><span class="n">all_to_all</span><span class="p">(</span><span class="n">output_list</span><span class="p">,</span> <span class="n">input_list</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="n">group</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">output_list</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="n">gather_idx</span><span class="p">)</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h7 id="swebench.inference.llamao.distributed_attention.SeqAllToAll.backward" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <span class="doc doc-object-name doc-function-name">backward</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-staticmethod"><code>staticmethod</code></small>
  </span>

</h7>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">backward</span><span class="p">(</span><span class="n">ctx</span><span class="p">:</span> <span class="n"><span title="typing.Any">Any</span></span><span class="p">,</span> <span class="o">*</span><span class="n">grad_output</span><span class="p">:</span> <span class="n"><span title="torch.Tensor">Tensor</span></span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><span title="tuple">tuple</span></span><span class="p">[</span><span class="n"><span title="torch.Tensor">Tensor</span></span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>
</code></pre></div>

    <div class="doc doc-contents ">


            <details class="quote">
              <summary>Source code in <code>swebench/inference/llamao/distributed_attention.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@staticmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">backward</span><span class="p">(</span><span class="n">ctx</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="o">*</span><span class="n">grad_output</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">Tensor</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
    <span class="k">return</span> <span class="p">(</span>
        <span class="n">SeqAllToAll</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="o">*</span><span class="n">grad_output</span><span class="p">,</span> <span class="n">ctx</span><span class="o">.</span><span class="n">gather_idx</span><span class="p">,</span> <span class="n">ctx</span><span class="o">.</span><span class="n">scatter_idx</span><span class="p">,</span> <span class="n">ctx</span><span class="o">.</span><span class="n">group</span><span class="p">),</span>
        <span class="kc">None</span><span class="p">,</span>
        <span class="kc">None</span><span class="p">,</span>
        <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h6 id="swebench.inference.llamao.distributed_attention.DistributedAttention" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>            <span class="doc doc-object-name doc-class-name">DistributedAttention</span>


</h6>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">DistributedAttention</span><span class="p">(</span><span class="n">local_attention</span><span class="p">:</span> <span class="n"><span title="torch.nn.Module">Module</span></span><span class="p">,</span> <span class="n">scatter_idx</span><span class="p">:</span> <span class="n"><span title="int">int</span></span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="n">gather_idx</span><span class="p">:</span> <span class="n"><span title="int">int</span></span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="torch.nn.Module">Module</span></code></p>


        <p>Initialization.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>local_attention</code>
            </td>
            <td>
                  <code><span title="torch.nn.Module">Module</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>local attention with q,k,v</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>scatter_idx</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>scatter_idx for all2all comm</p>
              </div>
            </td>
            <td>
                  <code>-2</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>gather_idx</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>gather_idx for all2all comm</p>
              </div>
            </td>
            <td>
                  <code>1</code>
            </td>
          </tr>
      </tbody>
    </table>







                  <details class="quote">
                    <summary>Source code in <code>swebench/inference/llamao/distributed_attention.py</code></summary>
                    <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">local_attention</span><span class="p">:</span> <span class="n">Module</span><span class="p">,</span>
    <span class="n">scatter_idx</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span>
    <span class="n">gather_idx</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">local_attn</span> <span class="o">=</span> <span class="n">local_attention</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">scatter_idx</span> <span class="o">=</span> <span class="n">scatter_idx</span>  <span class="c1"># head axis</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">gather_idx</span> <span class="o">=</span> <span class="n">gather_idx</span>  <span class="c1"># seq axis</span>
</code></pre></div></td></tr></table></div>
                  </details>



  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h7 id="swebench.inference.llamao.distributed_attention.DistributedAttention.local_attn" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <span class="doc doc-object-name doc-attribute-name">local_attn</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h7>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">local_attn</span> <span class="o">=</span> <span class="n"><span title="swebench.inference.llamao.distributed_attention.DistributedAttention(local_attention)">local_attention</span></span>
</code></pre></div>

    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h7 id="swebench.inference.llamao.distributed_attention.DistributedAttention.scatter_idx" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <span class="doc doc-object-name doc-attribute-name">scatter_idx</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h7>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">scatter_idx</span> <span class="o">=</span> <span class="n"><span title="swebench.inference.llamao.distributed_attention.DistributedAttention(scatter_idx)">scatter_idx</span></span>
</code></pre></div>

    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h7 id="swebench.inference.llamao.distributed_attention.DistributedAttention.gather_idx" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <span class="doc doc-object-name doc-attribute-name">gather_idx</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h7>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">gather_idx</span> <span class="o">=</span> <span class="n"><span title="swebench.inference.llamao.distributed_attention.DistributedAttention(gather_idx)">gather_idx</span></span>
</code></pre></div>

    <div class="doc doc-contents ">

    </div>

</div>



<div class="doc doc-object doc-function">


<h7 id="swebench.inference.llamao.distributed_attention.DistributedAttention.forward" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <span class="doc doc-object-name doc-function-name">forward</span>


</h7>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">forward</span><span class="p">(</span><span class="n">query</span><span class="p">:</span> <span class="n"><span title="torch.Tensor">Tensor</span></span><span class="p">,</span> <span class="n">key_values</span><span class="p">:</span> <span class="n"><span title="torch.Tensor">Tensor</span></span><span class="p">,</span> <span class="n">group</span><span class="p">:</span> <span class="n"><span title="typing.Any">Any</span></span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><span title="torch.Tensor">Tensor</span></span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>forward</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>query</code>
            </td>
            <td>
                  <code><span title="torch.Tensor">Tensor</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>query input to the layer</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>key</code>
            </td>
            <td>
                  <code><span title="torch.Tensor">Tensor</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>key input to the layer</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>value</code>
            </td>
            <td>
                  <code><span title="torch.Tensor">Tensor</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>value input to the layer</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>args</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>other args</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="torch.Tensor">Tensor</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <ul>
<li>output (Tensor): context output</li>
</ul>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>swebench/inference/llamao/distributed_attention.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span> <span class="n">key_values</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span> <span class="n">group</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;forward</span>

<span class="sd">    Arguments:</span>
<span class="sd">        query (Tensor): query input to the layer</span>
<span class="sd">        key (Tensor): key input to the layer</span>
<span class="sd">        value (Tensor): value input to the layer</span>
<span class="sd">        args: other args</span>

<span class="sd">    Returns:</span>
<span class="sd">        * output (Tensor): context output</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># in shape : e.g.,  [s/p:h:]</span>
    <span class="n">query_heads</span> <span class="o">=</span> <span class="n">SeqAllToAll</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">scatter_idx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">gather_idx</span><span class="p">,</span> <span class="n">group</span><span class="p">)</span>
    <span class="n">key_values_heads</span> <span class="o">=</span> <span class="n">SeqAllToAll</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
        <span class="n">key_values</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">scatter_idx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">gather_idx</span><span class="p">,</span> <span class="n">group</span>
    <span class="p">)</span>

    <span class="c1"># out shape : e.g., [s:h/p:]</span>
    <span class="n">output_heads</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">local_attn</span><span class="p">(</span><span class="n">query_heads</span><span class="p">,</span> <span class="n">key_values_heads</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="c1"># out e.g., [s/p::h]</span>
    <span class="k">return</span> <span class="n">SeqAllToAll</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">output_heads</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">gather_idx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">scatter_idx</span><span class="p">,</span> <span class="n">group</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>




  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h5 id="swebench.inference.llamao.modeling_flash_llama" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <span class="doc doc-object-name doc-module-name">modeling_flash_llama</span>


</h5>

    <div class="doc doc-contents ">

        <p>PyTorch LLaMA model.</p>









  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h6 id="swebench.inference.llamao.modeling_flash_llama.logger" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <span class="doc doc-object-name doc-attribute-name">logger</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-module-attribute"><code>module-attribute</code></small>
  </span>

</h6>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">logger</span> <span class="o">=</span> <span class="n"><span title="transformers.utils.logging.get_logger">get_logger</span></span><span class="p">(</span><span class="n"><span title="__name__">__name__</span></span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

    </div>

</div>


<div class="doc doc-object doc-class">



<h6 id="swebench.inference.llamao.modeling_flash_llama.LlamaRMSNorm" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>            <span class="doc doc-object-name doc-class-name">LlamaRMSNorm</span>


</h6>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">LlamaRMSNorm</span><span class="p">(</span><span class="n">hidden_size</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="mf">1e-06</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="torch.nn.Module">Module</span></code></p>


        <p>LlamaRMSNorm is equivalent to T5LayerNorm</p>







                  <details class="quote">
                    <summary>Source code in <code>swebench/inference/llamao/modeling_flash_llama.py</code></summary>
                    <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hidden_size</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    LlamaRMSNorm is equivalent to T5LayerNorm</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">weight</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">hidden_size</span><span class="p">))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span>
        <span class="s2">&quot;variance_epsilon&quot;</span><span class="p">,</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">eps</span><span class="p">),</span>
        <span class="n">persistent</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
                  </details>



  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h7 id="swebench.inference.llamao.modeling_flash_llama.LlamaRMSNorm.weight" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <span class="doc doc-object-name doc-attribute-name">weight</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h7>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">weight</span> <span class="o">=</span> <span class="n"><span title="torch.nn.Parameter">Parameter</span></span><span class="p">(</span><span class="n"><span title="torch.ones">ones</span></span><span class="p">(</span><span class="n"><span title="swebench.inference.llamao.modeling_flash_llama.LlamaRMSNorm(hidden_size)">hidden_size</span></span><span class="p">))</span>
</code></pre></div>

    <div class="doc doc-contents ">

    </div>

</div>



<div class="doc doc-object doc-function">


<h7 id="swebench.inference.llamao.modeling_flash_llama.LlamaRMSNorm.forward" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <span class="doc doc-object-name doc-function-name">forward</span>


</h7>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">forward</span><span class="p">(</span><span class="n">hidden_states</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">


            <details class="quote">
              <summary>Source code in <code>swebench/inference/llamao/modeling_flash_llama.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">79</span>
<span class="normal">80</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hidden_states</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">rmsnorm_func</span><span class="p">(</span><span class="n">hidden_states</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">weight</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">variance_epsilon</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h6 id="swebench.inference.llamao.modeling_flash_llama.FlashRotaryEmbedding" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>            <span class="doc doc-object-name doc-class-name">FlashRotaryEmbedding</span>


</h6>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">FlashRotaryEmbedding</span><span class="p">(</span><span class="n">dim</span><span class="p">:</span> <span class="n"><span title="int">int</span></span><span class="p">,</span> <span class="n">base</span><span class="o">=</span><span class="mf">10000.0</span><span class="p">,</span> <span class="n">interleaved</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">scale_base</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">scaling_factor</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">pos_idx_in_fp32</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="torch.nn.Module">Module</span></code></p>


        <p>The rotary position embeddings from RoFormer_ (Su et. al).
A crucial insight from the method is that the query and keys are
transformed by rotation matrices which depend on the relative positions.</p>
<p>Other implementations are available in the Rotary Transformer repo_ and in
GPT-NeoX_, GPT-NeoX was an inspiration</p>
<p>.. _RoFormer: <a href="https://arxiv.org/abs/2104.09864">https://arxiv.org/abs/2104.09864</a>
.. _repo: <a href="https://github.com/ZhuiyiTechnology/roformer">https://github.com/ZhuiyiTechnology/roformer</a>
.. _GPT-NeoX: <a href="https://github.com/EleutherAI/gpt-neox">https://github.com/EleutherAI/gpt-neox</a></p>
<p>If scale_base is not None, this implements XPos (Sun et al., <a href="https://arxiv.org/abs/2212.10554">https://arxiv.org/abs/2212.10554</a>).
A recommended value for scale_base is 512: <a href="https://github.com/HazyResearch/flash-attention/issues/96">https://github.com/HazyResearch/flash-attention/issues/96</a>
Reference: <a href="https://github.com/sunyt32/torchscale/blob/main/torchscale/component/xpos_relative_position.py">https://github.com/sunyt32/torchscale/blob/main/torchscale/component/xpos_relative_position.py</a></p>



<details class="interleaved" open>
  <summary>if True, rotate pairs of even and odd dimensions (GPT-J style) instead</summary>
  <p>of 1st half and 2nd half (GPT-NeoX style).</p>
</details>        <p>pos_idx_in_fp32: if True, the position indices [0.0, ..., seqlen - 1] are in fp32,
    otherwise they might be in lower precision.
    This option was added because previously (before 2023-07-02), when we construct
    the position indices, we use the dtype of self.inv_freq. In most cases this would
    be fp32, but if the model is trained in pure bf16 (not mixed precision), then
    self.inv_freq would be bf16, and the position indices are also in bf16.
    Because of the limited precision of bf16 (e.g. 1995.0 is rounded to 2000.0), the
    embeddings for some positions will coincide.
    To maintain compatibility with models previously trained in pure bf16,
    we add this option.
scaling_factor: RotaryEmbedding extended with linear scaling.</p>







                  <details class="quote">
                    <summary>Source code in <code>swebench/inference/llamao/modeling_flash_llama.py</code></summary>
                    <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">dim</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">base</span><span class="o">=</span><span class="mf">10000.0</span><span class="p">,</span>
    <span class="n">interleaved</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">scale_base</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">scaling_factor</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
    <span class="n">pos_idx_in_fp32</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">device</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    interleaved: if True, rotate pairs of even and odd dimensions (GPT-J style) instead</span>
<span class="sd">        of 1st half and 2nd half (GPT-NeoX style).</span>
<span class="sd">    pos_idx_in_fp32: if True, the position indices [0.0, ..., seqlen - 1] are in fp32,</span>
<span class="sd">        otherwise they might be in lower precision.</span>
<span class="sd">        This option was added because previously (before 2023-07-02), when we construct</span>
<span class="sd">        the position indices, we use the dtype of self.inv_freq. In most cases this would</span>
<span class="sd">        be fp32, but if the model is trained in pure bf16 (not mixed precision), then</span>
<span class="sd">        self.inv_freq would be bf16, and the position indices are also in bf16.</span>
<span class="sd">        Because of the limited precision of bf16 (e.g. 1995.0 is rounded to 2000.0), the</span>
<span class="sd">        embeddings for some positions will coincide.</span>
<span class="sd">        To maintain compatibility with models previously trained in pure bf16,</span>
<span class="sd">        we add this option.</span>
<span class="sd">    scaling_factor: RotaryEmbedding extended with linear scaling.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">=</span> <span class="n">dim</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">base</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">base</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">pos_idx_in_fp32</span> <span class="o">=</span> <span class="n">pos_idx_in_fp32</span>
    <span class="c1"># Generate and save the inverse frequency buffer (non trainable)</span>
    <span class="n">inv_freq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_inv_freq</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span><span class="s2">&quot;inv_freq&quot;</span><span class="p">,</span> <span class="n">inv_freq</span><span class="p">,</span> <span class="n">persistent</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">interleaved</span> <span class="o">=</span> <span class="n">interleaved</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">scale_base</span> <span class="o">=</span> <span class="n">scale_base</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">scaling_factor</span> <span class="o">=</span> <span class="n">scaling_factor</span>
    <span class="n">scale</span> <span class="o">=</span> <span class="p">(</span>
        <span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dim</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.4</span> <span class="o">*</span> <span class="n">dim</span><span class="p">)</span>
        <span class="o">/</span> <span class="p">(</span><span class="mf">1.4</span> <span class="o">*</span> <span class="n">dim</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">scale_base</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">else</span> <span class="kc">None</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span><span class="s2">&quot;scale&quot;</span><span class="p">,</span> <span class="n">scale</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_seq_len_cached</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_cos_cached</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_sin_cached</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_cos_k_cached</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_sin_k_cached</span> <span class="o">=</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
                  </details>



  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h7 id="swebench.inference.llamao.modeling_flash_llama.FlashRotaryEmbedding.dim" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <span class="doc doc-object-name doc-attribute-name">dim</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h7>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">dim</span> <span class="o">=</span> <span class="n"><span title="swebench.inference.llamao.modeling_flash_llama.FlashRotaryEmbedding(dim)">dim</span></span>
</code></pre></div>

    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h7 id="swebench.inference.llamao.modeling_flash_llama.FlashRotaryEmbedding.base" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <span class="doc doc-object-name doc-attribute-name">base</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h7>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">base</span> <span class="o">=</span> <span class="n"><span title="float">float</span></span><span class="p">(</span><span class="n"><span title="swebench.inference.llamao.modeling_flash_llama.FlashRotaryEmbedding(base)">base</span></span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h7 id="swebench.inference.llamao.modeling_flash_llama.FlashRotaryEmbedding.pos_idx_in_fp32" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <span class="doc doc-object-name doc-attribute-name">pos_idx_in_fp32</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h7>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">pos_idx_in_fp32</span> <span class="o">=</span> <span class="n"><span title="swebench.inference.llamao.modeling_flash_llama.FlashRotaryEmbedding(pos_idx_in_fp32)">pos_idx_in_fp32</span></span>
</code></pre></div>

    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h7 id="swebench.inference.llamao.modeling_flash_llama.FlashRotaryEmbedding.interleaved" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <span class="doc doc-object-name doc-attribute-name">interleaved</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h7>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">interleaved</span> <span class="o">=</span> <span class="n"><span title="swebench.inference.llamao.modeling_flash_llama.FlashRotaryEmbedding(interleaved)">interleaved</span></span>
</code></pre></div>

    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h7 id="swebench.inference.llamao.modeling_flash_llama.FlashRotaryEmbedding.scale_base" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <span class="doc doc-object-name doc-attribute-name">scale_base</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h7>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">scale_base</span> <span class="o">=</span> <span class="n"><span title="swebench.inference.llamao.modeling_flash_llama.FlashRotaryEmbedding(scale_base)">scale_base</span></span>
</code></pre></div>

    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h7 id="swebench.inference.llamao.modeling_flash_llama.FlashRotaryEmbedding.scaling_factor" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <span class="doc doc-object-name doc-attribute-name">scaling_factor</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h7>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">scaling_factor</span> <span class="o">=</span> <span class="n"><span title="swebench.inference.llamao.modeling_flash_llama.FlashRotaryEmbedding(scaling_factor)">scaling_factor</span></span>
</code></pre></div>

    <div class="doc doc-contents ">

    </div>

</div>



<div class="doc doc-object doc-function">


<h7 id="swebench.inference.llamao.modeling_flash_llama.FlashRotaryEmbedding.forward" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <span class="doc doc-object-name doc-function-name">forward</span>


</h7>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">forward</span><span class="p">(</span><span class="n">q</span><span class="p">:</span> <span class="n"><span title="torch.Tensor">Tensor</span></span><span class="p">,</span> <span class="n">k</span><span class="p">:</span> <span class="n"><span title="torch.Tensor">Tensor</span></span><span class="p">,</span> <span class="n">seqlen_offset</span><span class="p">:</span> <span class="n"><span title="int">int</span></span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">unpadded_lengths</span><span class="p">:</span> <span class="n"><span title="typing.Optional">Optional</span></span><span class="p">[</span><span class="n"><span title="tuple">tuple</span></span><span class="p">[</span><span class="n"><span title="torch.Tensor">Tensor</span></span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><span title="tuple">tuple</span></span><span class="p">[</span><span class="n"><span title="torch.Tensor">Tensor</span></span><span class="p">,</span> <span class="n"><span title="torch.Tensor">Tensor</span></span><span class="p">]</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>q: (batch, seqlen, nheads, headdim)
k: (batch, seqlen, nheads, headdim)
seqlen_offset: can be used in generation where the qkv being passed in is only the last
token in the batch.</p>


            <details class="quote">
              <summary>Source code in <code>swebench/inference/llamao/modeling_flash_llama.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">q</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
    <span class="n">k</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
    <span class="n">seqlen_offset</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">unpadded_lengths</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    q: (batch, seqlen, nheads, headdim)</span>
<span class="sd">    k: (batch, seqlen, nheads, headdim)</span>
<span class="sd">    seqlen_offset: can be used in generation where the qkv being passed in is only the last</span>
<span class="sd">    token in the batch.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">unpadded_lengths</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">cu_seqlens</span><span class="p">,</span> <span class="n">max_seqlen</span> <span class="o">=</span> <span class="n">unpadded_lengths</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">cu_seqlens</span><span class="p">,</span> <span class="n">max_seqlen</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">q</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_update_cos_sin_cache</span><span class="p">(</span>
        <span class="n">max_seqlen</span> <span class="o">+</span> <span class="n">seqlen_offset</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">q</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">q</span><span class="o">.</span><span class="n">dtype</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="n">apply_rotary_emb_func</span><span class="p">(</span>
                <span class="n">q</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_cos_cached</span><span class="p">[</span><span class="n">seqlen_offset</span><span class="p">:],</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_sin_cached</span><span class="p">[</span><span class="n">seqlen_offset</span><span class="p">:],</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">interleaved</span><span class="p">,</span>
                <span class="kc">True</span><span class="p">,</span>  <span class="c1"># inplace=True,</span>
                <span class="n">cu_seqlens</span><span class="o">=</span><span class="n">cu_seqlens</span><span class="p">,</span>
                <span class="n">max_seqlen</span><span class="o">=</span><span class="n">max_seqlen</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="n">apply_rotary_emb_func</span><span class="p">(</span>
                <span class="n">k</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_cos_cached</span><span class="p">[</span><span class="n">seqlen_offset</span><span class="p">:],</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_sin_cached</span><span class="p">[</span><span class="n">seqlen_offset</span><span class="p">:],</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">interleaved</span><span class="p">,</span>
                <span class="kc">True</span><span class="p">,</span>  <span class="c1"># inplace=True</span>
                <span class="n">cu_seqlens</span><span class="o">=</span><span class="n">cu_seqlens</span><span class="p">,</span>
                <span class="n">max_seqlen</span><span class="o">=</span><span class="n">max_seqlen</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">assert</span> <span class="kc">False</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h6 id="swebench.inference.llamao.modeling_flash_llama.LlamaMLP" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>            <span class="doc doc-object-name doc-class-name">LlamaMLP</span>


</h6>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">LlamaMLP</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="torch.nn.Module">Module</span></code></p>








                  <details class="quote">
                    <summary>Source code in <code>swebench/inference/llamao/modeling_flash_llama.py</code></summary>
                    <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">hidden_size</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">hidden_size</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">intermediate_size</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">intermediate_size</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">gate_proj</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hidden_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">intermediate_size</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">up_proj</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hidden_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">intermediate_size</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">down_proj</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">intermediate_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hidden_size</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">act_fn</span> <span class="o">=</span> <span class="n">ACT2FN</span><span class="p">[</span><span class="n">config</span><span class="o">.</span><span class="n">hidden_act</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
                  </details>



  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h7 id="swebench.inference.llamao.modeling_flash_llama.LlamaMLP.config" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <span class="doc doc-object-name doc-attribute-name">config</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h7>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">config</span> <span class="o">=</span> <span class="n"><span title="swebench.inference.llamao.modeling_flash_llama.LlamaMLP(config)">config</span></span>
</code></pre></div>

    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h7 id="swebench.inference.llamao.modeling_flash_llama.LlamaMLP.hidden_size" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <span class="doc doc-object-name doc-attribute-name">hidden_size</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h7>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">hidden_size</span> <span class="o">=</span> <span class="n"><span title="swebench.inference.llamao.modeling_flash_llama.LlamaMLP(config).hidden_size">hidden_size</span></span>
</code></pre></div>

    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h7 id="swebench.inference.llamao.modeling_flash_llama.LlamaMLP.intermediate_size" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <span class="doc doc-object-name doc-attribute-name">intermediate_size</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h7>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">intermediate_size</span> <span class="o">=</span> <span class="n"><span title="swebench.inference.llamao.modeling_flash_llama.LlamaMLP(config).intermediate_size">intermediate_size</span></span>
</code></pre></div>

    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h7 id="swebench.inference.llamao.modeling_flash_llama.LlamaMLP.gate_proj" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <span class="doc doc-object-name doc-attribute-name">gate_proj</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h7>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">gate_proj</span> <span class="o">=</span> <span class="n"><span title="torch.nn.Linear">Linear</span></span><span class="p">(</span><span class="n"><span title="swebench.inference.llamao.modeling_flash_llama.LlamaMLP(self).hidden_size">hidden_size</span></span><span class="p">,</span> <span class="n"><span title="swebench.inference.llamao.modeling_flash_llama.LlamaMLP(self).intermediate_size">intermediate_size</span></span><span class="p">,</span> <span class="n"><span title="torch.nn.Linear(bias)">bias</span></span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h7 id="swebench.inference.llamao.modeling_flash_llama.LlamaMLP.up_proj" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <span class="doc doc-object-name doc-attribute-name">up_proj</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h7>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">up_proj</span> <span class="o">=</span> <span class="n"><span title="torch.nn.Linear">Linear</span></span><span class="p">(</span><span class="n"><span title="swebench.inference.llamao.modeling_flash_llama.LlamaMLP(self).hidden_size">hidden_size</span></span><span class="p">,</span> <span class="n"><span title="swebench.inference.llamao.modeling_flash_llama.LlamaMLP(self).intermediate_size">intermediate_size</span></span><span class="p">,</span> <span class="n"><span title="torch.nn.Linear(bias)">bias</span></span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h7 id="swebench.inference.llamao.modeling_flash_llama.LlamaMLP.down_proj" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <span class="doc doc-object-name doc-attribute-name">down_proj</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h7>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">down_proj</span> <span class="o">=</span> <span class="n"><span title="torch.nn.Linear">Linear</span></span><span class="p">(</span><span class="n"><span title="swebench.inference.llamao.modeling_flash_llama.LlamaMLP(self).intermediate_size">intermediate_size</span></span><span class="p">,</span> <span class="n"><span title="swebench.inference.llamao.modeling_flash_llama.LlamaMLP(self).hidden_size">hidden_size</span></span><span class="p">,</span> <span class="n"><span title="torch.nn.Linear(bias)">bias</span></span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h7 id="swebench.inference.llamao.modeling_flash_llama.LlamaMLP.act_fn" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <span class="doc doc-object-name doc-attribute-name">act_fn</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h7>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">act_fn</span> <span class="o">=</span> <span class="n"><span title="transformers.activations.ACT2FN">ACT2FN</span></span><span class="p">[</span><span class="n"><span title="swebench.inference.llamao.modeling_flash_llama.LlamaMLP(config).hidden_act">hidden_act</span></span><span class="p">]</span>
</code></pre></div>

    <div class="doc doc-contents ">

    </div>

</div>



<div class="doc doc-object doc-function">


<h7 id="swebench.inference.llamao.modeling_flash_llama.LlamaMLP.forward" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <span class="doc doc-object-name doc-function-name">forward</span>


</h7>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">forward</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">


            <details class="quote">
              <summary>Source code in <code>swebench/inference/llamao/modeling_flash_llama.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">265</span>
<span class="normal">266</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">down_proj</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">act_fn</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gate_proj</span><span class="p">(</span><span class="n">x</span><span class="p">))</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">up_proj</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h6 id="swebench.inference.llamao.modeling_flash_llama.LlamaAttention" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>            <span class="doc doc-object-name doc-class-name">LlamaAttention</span>


</h6>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">LlamaAttention</span><span class="p">(</span><span class="n">config</span><span class="p">:</span> <span class="n"><span title="transformers.models.llama.configuration_llama.LlamaConfig">LlamaConfig</span></span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="torch.nn.Module">Module</span></code></p>


        <p>Multi-headed attention from 'Attention Is All You Need' paper</p>







                  <details class="quote">
                    <summary>Source code in <code>swebench/inference/llamao/modeling_flash_llama.py</code></summary>
                    <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">LlamaConfig</span><span class="p">):</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">hidden_size</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">hidden_size</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">num_heads</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">num_attention_heads</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">head_dim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hidden_size</span> <span class="o">//</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_heads</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">num_key_value_heads</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span>
        <span class="n">config</span><span class="p">,</span> <span class="s2">&quot;num_key_value_heads&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_heads</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">num_key_value_groups</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_heads</span> <span class="o">//</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_key_value_heads</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">max_position_embeddings</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">max_position_embeddings</span>

    <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">head_dim</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_heads</span><span class="p">)</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hidden_size</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;hidden_size must be divisible by num_heads (got `hidden_size`: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">hidden_size</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot; and `num_heads`: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">num_heads</span><span class="si">}</span><span class="s2">).&quot;</span>
        <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">q_proj</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hidden_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_heads</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">head_dim</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">k_proj</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hidden_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_key_value_heads</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">head_dim</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">v_proj</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hidden_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_key_value_heads</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">head_dim</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">o_proj</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_heads</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">head_dim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hidden_size</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span>
        <span class="s2">&quot;norm_factor&quot;</span><span class="p">,</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">head_dim</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span><span class="o">.</span><span class="n">to</span><span class="p">(</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">get_default_dtype</span><span class="p">()</span>
        <span class="p">),</span>
        <span class="n">persistent</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="s2">&quot;rope_scaling&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
        <span class="n">scaling_factor</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">scaling_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">rope_scaling</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span>
        <span class="n">scaling_factor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">rope_scaling</span><span class="p">[</span><span class="s2">&quot;factor&quot;</span><span class="p">]</span>
        <span class="k">assert</span> <span class="n">scaling_type</span> <span class="o">==</span> <span class="s2">&quot;linear&quot;</span>
    <span class="n">theta</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="s2">&quot;rope_theta&quot;</span><span class="p">,</span> <span class="mi">10000</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">rotary_emb</span> <span class="o">=</span> <span class="n">FlashRotaryEmbedding</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">head_dim</span><span class="p">,</span>
        <span class="n">base</span><span class="o">=</span><span class="n">theta</span><span class="p">,</span>
        <span class="n">interleaved</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">scaling_factor</span><span class="o">=</span><span class="n">scaling_factor</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">distributed_attn_func</span> <span class="o">=</span> <span class="n">DistributedAttention</span><span class="p">(</span><span class="n">flash_attn_kvpacked_func</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
                  </details>



  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h7 id="swebench.inference.llamao.modeling_flash_llama.LlamaAttention.config" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <span class="doc doc-object-name doc-attribute-name">config</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h7>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">config</span> <span class="o">=</span> <span class="n"><span title="swebench.inference.llamao.modeling_flash_llama.LlamaAttention(config)">config</span></span>
</code></pre></div>

    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h7 id="swebench.inference.llamao.modeling_flash_llama.LlamaAttention.hidden_size" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <span class="doc doc-object-name doc-attribute-name">hidden_size</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h7>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">hidden_size</span> <span class="o">=</span> <span class="n"><span title="swebench.inference.llamao.modeling_flash_llama.LlamaAttention(config).hidden_size">hidden_size</span></span>
</code></pre></div>

    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h7 id="swebench.inference.llamao.modeling_flash_llama.LlamaAttention.num_heads" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <span class="doc doc-object-name doc-attribute-name">num_heads</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h7>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">num_heads</span> <span class="o">=</span> <span class="n"><span title="swebench.inference.llamao.modeling_flash_llama.LlamaAttention(config).num_attention_heads">num_attention_heads</span></span>
</code></pre></div>

    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h7 id="swebench.inference.llamao.modeling_flash_llama.LlamaAttention.head_dim" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <span class="doc doc-object-name doc-attribute-name">head_dim</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h7>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">head_dim</span> <span class="o">=</span> <span class="n"><span title="swebench.inference.llamao.modeling_flash_llama.LlamaAttention(self).hidden_size">hidden_size</span></span> <span class="o">//</span> <span class="n"><span title="swebench.inference.llamao.modeling_flash_llama.LlamaAttention(self).num_heads">num_heads</span></span>
</code></pre></div>

    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h7 id="swebench.inference.llamao.modeling_flash_llama.LlamaAttention.num_key_value_heads" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <span class="doc doc-object-name doc-attribute-name">num_key_value_heads</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h7>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">num_key_value_heads</span> <span class="o">=</span> <span class="n"><span title="getattr">getattr</span></span><span class="p">(</span><span class="n"><span title="swebench.inference.llamao.modeling_flash_llama.LlamaAttention(config)">config</span></span><span class="p">,</span> <span class="s1">&#39;num_key_value_heads&#39;</span><span class="p">,</span> <span class="n"><span title="swebench.inference.llamao.modeling_flash_llama.LlamaAttention(self).num_heads">num_heads</span></span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h7 id="swebench.inference.llamao.modeling_flash_llama.LlamaAttention.num_key_value_groups" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <span class="doc doc-object-name doc-attribute-name">num_key_value_groups</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h7>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">num_key_value_groups</span> <span class="o">=</span> <span class="n"><span title="swebench.inference.llamao.modeling_flash_llama.LlamaAttention(self).num_heads">num_heads</span></span> <span class="o">//</span> <span class="n"><span title="swebench.inference.llamao.modeling_flash_llama.LlamaAttention(self).num_key_value_heads">num_key_value_heads</span></span>
</code></pre></div>

    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h7 id="swebench.inference.llamao.modeling_flash_llama.LlamaAttention.max_position_embeddings" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <span class="doc doc-object-name doc-attribute-name">max_position_embeddings</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h7>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">max_position_embeddings</span> <span class="o">=</span> <span class="n"><span title="swebench.inference.llamao.modeling_flash_llama.LlamaAttention(config).max_position_embeddings">max_position_embeddings</span></span>
</code></pre></div>

    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h7 id="swebench.inference.llamao.modeling_flash_llama.LlamaAttention.q_proj" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <span class="doc doc-object-name doc-attribute-name">q_proj</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h7>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">q_proj</span> <span class="o">=</span> <span class="n"><span title="torch.nn.Linear">Linear</span></span><span class="p">(</span><span class="n"><span title="swebench.inference.llamao.modeling_flash_llama.LlamaAttention(self).hidden_size">hidden_size</span></span><span class="p">,</span> <span class="n"><span title="swebench.inference.llamao.modeling_flash_llama.LlamaAttention(self).num_heads">num_heads</span></span> <span class="o">*</span> <span class="n"><span title="swebench.inference.llamao.modeling_flash_llama.LlamaAttention(self).head_dim">head_dim</span></span><span class="p">,</span> <span class="n"><span title="torch.nn.Linear(bias)">bias</span></span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h7 id="swebench.inference.llamao.modeling_flash_llama.LlamaAttention.k_proj" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <span class="doc doc-object-name doc-attribute-name">k_proj</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h7>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">k_proj</span> <span class="o">=</span> <span class="n"><span title="torch.nn.Linear">Linear</span></span><span class="p">(</span><span class="n"><span title="swebench.inference.llamao.modeling_flash_llama.LlamaAttention(self).hidden_size">hidden_size</span></span><span class="p">,</span> <span class="n"><span title="swebench.inference.llamao.modeling_flash_llama.LlamaAttention(self).num_key_value_heads">num_key_value_heads</span></span> <span class="o">*</span> <span class="n"><span title="swebench.inference.llamao.modeling_flash_llama.LlamaAttention(self).head_dim">head_dim</span></span><span class="p">,</span> <span class="n"><span title="torch.nn.Linear(bias)">bias</span></span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h7 id="swebench.inference.llamao.modeling_flash_llama.LlamaAttention.v_proj" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <span class="doc doc-object-name doc-attribute-name">v_proj</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h7>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">v_proj</span> <span class="o">=</span> <span class="n"><span title="torch.nn.Linear">Linear</span></span><span class="p">(</span><span class="n"><span title="swebench.inference.llamao.modeling_flash_llama.LlamaAttention(self).hidden_size">hidden_size</span></span><span class="p">,</span> <span class="n"><span title="swebench.inference.llamao.modeling_flash_llama.LlamaAttention(self).num_key_value_heads">num_key_value_heads</span></span> <span class="o">*</span> <span class="n"><span title="swebench.inference.llamao.modeling_flash_llama.LlamaAttention(self).head_dim">head_dim</span></span><span class="p">,</span> <span class="n"><span title="torch.nn.Linear(bias)">bias</span></span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h7 id="swebench.inference.llamao.modeling_flash_llama.LlamaAttention.o_proj" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <span class="doc doc-object-name doc-attribute-name">o_proj</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h7>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">o_proj</span> <span class="o">=</span> <span class="n"><span title="torch.nn.Linear">Linear</span></span><span class="p">(</span><span class="n"><span title="swebench.inference.llamao.modeling_flash_llama.LlamaAttention(self).num_heads">num_heads</span></span> <span class="o">*</span> <span class="n"><span title="swebench.inference.llamao.modeling_flash_llama.LlamaAttention(self).head_dim">head_dim</span></span><span class="p">,</span> <span class="n"><span title="swebench.inference.llamao.modeling_flash_llama.LlamaAttention(self).hidden_size">hidden_size</span></span><span class="p">,</span> <span class="n"><span title="torch.nn.Linear(bias)">bias</span></span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h7 id="swebench.inference.llamao.modeling_flash_llama.LlamaAttention.rotary_emb" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <span class="doc doc-object-name doc-attribute-name">rotary_emb</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h7>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">rotary_emb</span> <span class="o">=</span> <span class="n"><a class="autorefs autorefs-internal" title="            FlashRotaryEmbedding (swebench.inference.llamao.modeling_flash_llama.FlashRotaryEmbedding)" href="#swebench.inference.llamao.modeling_flash_llama.FlashRotaryEmbedding">FlashRotaryEmbedding</a></span><span class="p">(</span><span class="n"><span title="swebench.inference.llamao.modeling_flash_llama.LlamaAttention(self).head_dim">head_dim</span></span><span class="p">,</span> <span class="n"><span title="swebench.inference.llamao.modeling_flash_llama.FlashRotaryEmbedding(base)">base</span></span><span class="o">=</span><span class="n"><span title="theta">theta</span></span><span class="p">,</span> <span class="n"><span title="swebench.inference.llamao.modeling_flash_llama.FlashRotaryEmbedding(interleaved)">interleaved</span></span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n"><span title="swebench.inference.llamao.modeling_flash_llama.FlashRotaryEmbedding(scaling_factor)">scaling_factor</span></span><span class="o">=</span><span class="n"><span title="scaling_factor">scaling_factor</span></span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h7 id="swebench.inference.llamao.modeling_flash_llama.LlamaAttention.distributed_attn_func" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <span class="doc doc-object-name doc-attribute-name">distributed_attn_func</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h7>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">distributed_attn_func</span> <span class="o">=</span> <span class="n"><a class="autorefs autorefs-internal" title="            DistributedAttention (swebench.inference.llamao.distributed_attention.DistributedAttention)" href="#swebench.inference.llamao.distributed_attention.DistributedAttention">DistributedAttention</a></span><span class="p">(</span><span class="n"><span title="flash_attn.flash_attn_kvpacked_func">flash_attn_kvpacked_func</span></span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

    </div>

</div>



<div class="doc doc-object doc-function">


<h7 id="swebench.inference.llamao.modeling_flash_llama.LlamaAttention.forward" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <span class="doc doc-object-name doc-function-name">forward</span>


</h7>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">forward</span><span class="p">(</span><span class="n">hidden_states</span><span class="p">:</span> <span class="n"><span title="torch.Tensor">Tensor</span></span><span class="p">,</span> <span class="n">attention_mask</span><span class="p">:</span> <span class="n"><span title="typing.Optional">Optional</span></span><span class="p">[</span><span class="n"><span title="torch.Tensor">Tensor</span></span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">position_ids</span><span class="p">:</span> <span class="n"><span title="typing.Optional">Optional</span></span><span class="p">[</span><span class="n"><span title="torch.LongTensor">LongTensor</span></span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">past_key_value</span><span class="p">:</span> <span class="n"><span title="typing.Optional">Optional</span></span><span class="p">[</span><span class="n"><span title="tuple">tuple</span></span><span class="p">[</span><span class="n"><span title="torch.Tensor">Tensor</span></span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">output_attentions</span><span class="p">:</span> <span class="n"><span title="bool">bool</span></span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">use_cache</span><span class="p">:</span> <span class="n"><span title="bool">bool</span></span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">unpadded_lengths</span><span class="p">:</span> <span class="n"><span title="typing.Optional">Optional</span></span><span class="p">[</span><span class="n"><span title="tuple">tuple</span></span><span class="p">[</span><span class="n"><span title="torch.Tensor">Tensor</span></span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">seq_parallel_group</span><span class="p">:</span> <span class="n"><span title="typing.Optional">Optional</span></span><span class="p">[</span><span class="n"><span title="typing.Any">Any</span></span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><span title="tuple">tuple</span></span><span class="p">[</span><span class="n"><span title="torch.Tensor">Tensor</span></span><span class="p">,</span> <span class="n"><span title="typing.Optional">Optional</span></span><span class="p">[</span><span class="n"><span title="torch.Tensor">Tensor</span></span><span class="p">],</span> <span class="n"><span title="typing.Optional">Optional</span></span><span class="p">[</span><span class="n"><span title="tuple">tuple</span></span><span class="p">[</span><span class="n"><span title="torch.Tensor">Tensor</span></span><span class="p">]]]</span>
</code></pre></div>

    <div class="doc doc-contents ">


            <details class="quote">
              <summary>Source code in <code>swebench/inference/llamao/modeling_flash_llama.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">hidden_states</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
    <span class="n">attention_mask</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">position_ids</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">past_key_value</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">output_attentions</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">use_cache</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">unpadded_lengths</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">seq_parallel_group</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">Optional</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">],</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]]]:</span>
    <span class="n">h_size</span> <span class="o">=</span> <span class="n">hidden_states</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">has_layer_past</span> <span class="o">=</span> <span class="n">past_key_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">past_key_value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="n">has_layer_past</span><span class="p">:</span>
        <span class="n">past_kv</span> <span class="o">=</span> <span class="n">past_key_value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">past_len</span> <span class="o">=</span> <span class="n">past_key_value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">past_len</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1"># NOTE: Hack to include position_ids, assuming they are increasing uniformly per block</span>
    <span class="k">if</span> <span class="n">position_ids</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">past_len</span> <span class="o">+=</span> <span class="n">position_ids</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>

    <span class="n">q</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">q_proj</span><span class="p">(</span><span class="n">hidden_states</span><span class="p">)</span>
    <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_proj</span><span class="p">(</span><span class="n">hidden_states</span><span class="p">)</span>
    <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">v_proj</span><span class="p">(</span><span class="n">hidden_states</span><span class="p">)</span>

    <span class="n">q</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">*</span><span class="n">q</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_heads</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">head_dim</span><span class="p">)</span>
    <span class="n">k</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">*</span><span class="n">k</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_key_value_heads</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">head_dim</span><span class="p">)</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">*</span><span class="n">v</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_key_value_heads</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">head_dim</span><span class="p">)</span>

    <span class="n">q</span><span class="p">,</span> <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rotary_emb</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">past_len</span><span class="p">,</span> <span class="n">unpadded_lengths</span><span class="p">)</span>

    <span class="n">kv</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">],</span> <span class="o">-</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">kv</span> <span class="o">=</span> <span class="n">repeat_kv</span><span class="p">(</span><span class="n">kv</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_key_value_groups</span><span class="p">)</span>

    <span class="c1"># Cache QKV values</span>
    <span class="k">if</span> <span class="n">has_layer_past</span><span class="p">:</span>
        <span class="n">new_len</span> <span class="o">=</span> <span class="n">past_len</span> <span class="o">+</span> <span class="n">q</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">new_len</span> <span class="o">&gt;</span> <span class="n">past_kv</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">past_kv</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="n">past_kv</span><span class="p">,</span>
                    <span class="n">torch</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span>
                        <span class="n">hidden_states</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
                        <span class="mi">256</span><span class="p">,</span>
                        <span class="mi">2</span><span class="p">,</span>
                        <span class="n">kv</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span>
                        <span class="n">kv</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span>
                        <span class="n">dtype</span><span class="o">=</span><span class="n">kv</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
                        <span class="n">device</span><span class="o">=</span><span class="n">kv</span><span class="o">.</span><span class="n">device</span><span class="p">,</span>
                    <span class="p">),</span>
                <span class="p">],</span>
                <span class="mi">1</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="n">past_kv</span><span class="p">[:,</span> <span class="n">past_len</span><span class="p">:</span><span class="n">new_len</span><span class="p">]</span> <span class="o">=</span> <span class="n">kv</span>
        <span class="n">kv</span> <span class="o">=</span> <span class="n">past_kv</span><span class="p">[:,</span> <span class="p">:</span><span class="n">new_len</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">past_kv</span> <span class="o">=</span> <span class="n">kv</span>

    <span class="n">past_key_value</span> <span class="o">=</span> <span class="p">(</span><span class="n">past_kv</span><span class="p">,</span> <span class="n">past_len</span> <span class="o">+</span> <span class="n">q</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span> <span class="k">if</span> <span class="n">use_cache</span> <span class="k">else</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="n">dist</span><span class="o">.</span><span class="n">is_initialized</span><span class="p">()</span> <span class="ow">and</span> <span class="n">dist</span><span class="o">.</span><span class="n">get_world_size</span><span class="p">(</span><span class="n">seq_parallel_group</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="c1"># NOTE: we assume that padding tokens are at the end of the sequence and may ignore `attention_mask`</span>
        <span class="k">assert</span> <span class="n">output_attentions</span> <span class="ow">is</span> <span class="kc">False</span>
        <span class="n">attn_outputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">distributed_attn_func</span><span class="p">(</span>
            <span class="n">q</span><span class="p">,</span>
            <span class="n">kv</span><span class="p">,</span>
            <span class="n">dropout_p</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
            <span class="n">softmax_scale</span><span class="o">=</span><span class="mf">1.0</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">norm_factor</span><span class="p">,</span>
            <span class="n">causal</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">return_attn_probs</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">group</span><span class="o">=</span><span class="n">seq_parallel_group</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">unpadded_lengths</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># varlen, ignore padding tokens, efficient for large batch with many paddings</span>
            <span class="k">assert</span> <span class="n">attention_mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="n">cu_seqlens</span><span class="p">,</span> <span class="n">max_seqlen</span> <span class="o">=</span> <span class="n">unpadded_lengths</span>

            <span class="n">attn_outputs</span> <span class="o">=</span> <span class="n">flash_attn_varlen_kvpacked_func</span><span class="p">(</span>
                <span class="n">q</span><span class="p">,</span>
                <span class="n">kv</span><span class="p">,</span>
                <span class="n">cu_seqlens</span><span class="p">,</span>
                <span class="n">cu_seqlens</span><span class="p">,</span>
                <span class="n">max_seqlen</span><span class="p">,</span>
                <span class="n">max_seqlen</span><span class="p">,</span>
                <span class="n">dropout_p</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
                <span class="n">softmax_scale</span><span class="o">=</span><span class="mf">1.0</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">norm_factor</span><span class="p">,</span>
                <span class="n">causal</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">return_attn_probs</span><span class="o">=</span><span class="n">output_attentions</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">attn_outputs</span> <span class="o">=</span> <span class="n">flash_attn_kvpacked_func</span><span class="p">(</span>
                <span class="n">q</span><span class="p">,</span>
                <span class="n">kv</span><span class="p">,</span>
                <span class="n">dropout_p</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
                <span class="n">softmax_scale</span><span class="o">=</span><span class="mf">1.0</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">norm_factor</span><span class="p">,</span>
                <span class="n">causal</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">return_attn_probs</span><span class="o">=</span><span class="n">output_attentions</span><span class="p">,</span>
            <span class="p">)</span>

    <span class="n">attn_output</span> <span class="o">=</span> <span class="n">attn_outputs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">output_attentions</span> <span class="k">else</span> <span class="n">attn_outputs</span>
    <span class="n">attn_output</span> <span class="o">=</span> <span class="n">attn_output</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">*</span><span class="n">attn_output</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="n">h_size</span><span class="p">)</span>
    <span class="n">attn_weights</span> <span class="o">=</span> <span class="n">attn_outputs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">if</span> <span class="n">output_attentions</span> <span class="k">else</span> <span class="kc">None</span>

    <span class="n">attn_output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">o_proj</span><span class="p">(</span><span class="n">attn_output</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">output_attentions</span><span class="p">:</span>
        <span class="n">attn_weights</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">return</span> <span class="n">attn_output</span><span class="p">,</span> <span class="n">attn_weights</span><span class="p">,</span> <span class="n">past_key_value</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h6 id="swebench.inference.llamao.modeling_flash_llama.LlamaDecoderLayer" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>            <span class="doc doc-object-name doc-class-name">LlamaDecoderLayer</span>


</h6>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">LlamaDecoderLayer</span><span class="p">(</span><span class="n">config</span><span class="p">:</span> <span class="n"><span title="transformers.models.llama.configuration_llama.LlamaConfig">LlamaConfig</span></span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="torch.nn.Module">Module</span></code></p>








                  <details class="quote">
                    <summary>Source code in <code>swebench/inference/llamao/modeling_flash_llama.py</code></summary>
                    <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">LlamaConfig</span><span class="p">):</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">hidden_size</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">hidden_size</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">self_attn</span> <span class="o">=</span> <span class="n">LlamaAttention</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">mlp</span> <span class="o">=</span> <span class="n">LlamaMLP</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">input_layernorm</span> <span class="o">=</span> <span class="n">LlamaRMSNorm</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">hidden_size</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">rms_norm_eps</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">post_attention_layernorm</span> <span class="o">=</span> <span class="n">LlamaRMSNorm</span><span class="p">(</span>
        <span class="n">config</span><span class="o">.</span><span class="n">hidden_size</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">rms_norm_eps</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_fsdp_wrap</span> <span class="o">=</span> <span class="kc">True</span>
</code></pre></div></td></tr></table></div>
                  </details>



  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h7 id="swebench.inference.llamao.modeling_flash_llama.LlamaDecoderLayer.hidden_size" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <span class="doc doc-object-name doc-attribute-name">hidden_size</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h7>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">hidden_size</span> <span class="o">=</span> <span class="n"><span title="swebench.inference.llamao.modeling_flash_llama.LlamaDecoderLayer(config).hidden_size">hidden_size</span></span>
</code></pre></div>

    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h7 id="swebench.inference.llamao.modeling_flash_llama.LlamaDecoderLayer.self_attn" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <span class="doc doc-object-name doc-attribute-name">self_attn</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h7>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">self_attn</span> <span class="o">=</span> <span class="n"><a class="autorefs autorefs-internal" title="            LlamaAttention (swebench.inference.llamao.modeling_flash_llama.LlamaAttention)" href="#swebench.inference.llamao.modeling_flash_llama.LlamaAttention">LlamaAttention</a></span><span class="p">(</span><span class="n"><span title="swebench.inference.llamao.modeling_flash_llama.LlamaAttention(config)">config</span></span><span class="o">=</span><span class="n"><span title="swebench.inference.llamao.modeling_flash_llama.LlamaDecoderLayer(config)">config</span></span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h7 id="swebench.inference.llamao.modeling_flash_llama.LlamaDecoderLayer.mlp" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <span class="doc doc-object-name doc-attribute-name">mlp</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h7>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">mlp</span> <span class="o">=</span> <span class="n"><a class="autorefs autorefs-internal" title="            LlamaMLP (swebench.inference.llamao.modeling_flash_llama.LlamaMLP)" href="#swebench.inference.llamao.modeling_flash_llama.LlamaMLP">LlamaMLP</a></span><span class="p">(</span><span class="n"><span title="swebench.inference.llamao.modeling_flash_llama.LlamaDecoderLayer(config)">config</span></span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h7 id="swebench.inference.llamao.modeling_flash_llama.LlamaDecoderLayer.input_layernorm" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <span class="doc doc-object-name doc-attribute-name">input_layernorm</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h7>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">input_layernorm</span> <span class="o">=</span> <span class="n"><a class="autorefs autorefs-internal" title="            LlamaRMSNorm (swebench.inference.llamao.modeling_flash_llama.LlamaRMSNorm)" href="#swebench.inference.llamao.modeling_flash_llama.LlamaRMSNorm">LlamaRMSNorm</a></span><span class="p">(</span><span class="n"><span title="swebench.inference.llamao.modeling_flash_llama.LlamaDecoderLayer(config).hidden_size">hidden_size</span></span><span class="p">,</span> <span class="n"><span title="swebench.inference.llamao.modeling_flash_llama.LlamaRMSNorm(eps)">eps</span></span><span class="o">=</span><span class="n"><span title="swebench.inference.llamao.modeling_flash_llama.LlamaDecoderLayer(config).rms_norm_eps">rms_norm_eps</span></span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h7 id="swebench.inference.llamao.modeling_flash_llama.LlamaDecoderLayer.post_attention_layernorm" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <span class="doc doc-object-name doc-attribute-name">post_attention_layernorm</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h7>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">post_attention_layernorm</span> <span class="o">=</span> <span class="n"><a class="autorefs autorefs-internal" title="            LlamaRMSNorm (swebench.inference.llamao.modeling_flash_llama.LlamaRMSNorm)" href="#swebench.inference.llamao.modeling_flash_llama.LlamaRMSNorm">LlamaRMSNorm</a></span><span class="p">(</span><span class="n"><span title="swebench.inference.llamao.modeling_flash_llama.LlamaDecoderLayer(config).hidden_size">hidden_size</span></span><span class="p">,</span> <span class="n"><span title="swebench.inference.llamao.modeling_flash_llama.LlamaRMSNorm(eps)">eps</span></span><span class="o">=</span><span class="n"><span title="swebench.inference.llamao.modeling_flash_llama.LlamaDecoderLayer(config).rms_norm_eps">rms_norm_eps</span></span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

    </div>

</div>



<div class="doc doc-object doc-function">


<h7 id="swebench.inference.llamao.modeling_flash_llama.LlamaDecoderLayer.forward" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <span class="doc doc-object-name doc-function-name">forward</span>


</h7>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">forward</span><span class="p">(</span><span class="n">hidden_states</span><span class="p">:</span> <span class="n"><span title="torch.Tensor">Tensor</span></span><span class="p">,</span> <span class="n">attention_mask</span><span class="p">:</span> <span class="n"><span title="typing.Optional">Optional</span></span><span class="p">[</span><span class="n"><span title="torch.Tensor">Tensor</span></span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">position_ids</span><span class="p">:</span> <span class="n"><span title="typing.Optional">Optional</span></span><span class="p">[</span><span class="n"><span title="torch.LongTensor">LongTensor</span></span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">past_key_value</span><span class="p">:</span> <span class="n"><span title="typing.Optional">Optional</span></span><span class="p">[</span><span class="n"><span title="tuple">tuple</span></span><span class="p">[</span><span class="n"><span title="torch.Tensor">Tensor</span></span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">unpadded_lengths</span><span class="p">:</span> <span class="n"><span title="typing.Optional">Optional</span></span><span class="p">[</span><span class="n"><span title="tuple">tuple</span></span><span class="p">[</span><span class="n"><span title="torch.Tensor">Tensor</span></span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">output_attentions</span><span class="p">:</span> <span class="n"><span title="typing.Optional">Optional</span></span><span class="p">[</span><span class="n"><span title="bool">bool</span></span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">use_cache</span><span class="p">:</span> <span class="n"><span title="typing.Optional">Optional</span></span><span class="p">[</span><span class="n"><span title="bool">bool</span></span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">seq_parallel_group</span><span class="p">:</span> <span class="n"><span title="typing.Optional">Optional</span></span><span class="p">[</span><span class="n"><span title="typing.Any">Any</span></span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><span title="tuple">tuple</span></span><span class="p">[</span><span class="n"><span title="torch.FloatTensor">FloatTensor</span></span><span class="p">,</span> <span class="n"><span title="typing.Optional">Optional</span></span><span class="p">[</span><span class="n"><span title="tuple">tuple</span></span><span class="p">[</span><span class="n"><span title="torch.FloatTensor">FloatTensor</span></span><span class="p">,</span> <span class="n"><span title="torch.FloatTensor">FloatTensor</span></span><span class="p">]]]</span>
</code></pre></div>

    <div class="doc doc-contents ">



<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>hidden_states</code>
            </td>
            <td>
                  <code>`torch.FloatTensor`</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>input to the layer of shape <code>(batch, seq_len, embed_dim)</code></p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>attention_mask</code>
            </td>
            <td>
                  <code>`torch.FloatTensor`, *optional*</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>attention mask of size
<code>(batch, 1, tgt_len, src_len)</code> where padding elements are indicated by very large negative values.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>output_attentions</code>
            </td>
            <td>
                  <code>`bool`, *optional*</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether or not to return the attentions tensors of all attention layers. See <code>attentions</code> under
returned tensors for more detail.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>use_cache</code>
            </td>
            <td>
                  <code>`bool`, *optional*</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If set to <code>True</code>, <code>past_key_values</code> key value states are returned and can be used to speed up decoding
(see <code>past_key_values</code>).</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>past_key_value</code>
            </td>
            <td>
                  <code>`Tuple(torch.FloatTensor)`, *optional*</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>cached past key and value projection states</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>swebench/inference/llamao/modeling_flash_llama.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">hidden_states</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
    <span class="n">attention_mask</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">position_ids</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">past_key_value</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">unpadded_lengths</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">output_attentions</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">use_cache</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">seq_parallel_group</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span>
    <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">,</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">]]</span>
<span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Args:</span>
<span class="sd">        hidden_states (`torch.FloatTensor`): input to the layer of shape `(batch, seq_len, embed_dim)`</span>
<span class="sd">        attention_mask (`torch.FloatTensor`, *optional*): attention mask of size</span>
<span class="sd">            `(batch, 1, tgt_len, src_len)` where padding elements are indicated by very large negative values.</span>
<span class="sd">        output_attentions (`bool`, *optional*):</span>
<span class="sd">            Whether or not to return the attentions tensors of all attention layers. See `attentions` under</span>
<span class="sd">            returned tensors for more detail.</span>
<span class="sd">        use_cache (`bool`, *optional*):</span>
<span class="sd">            If set to `True`, `past_key_values` key value states are returned and can be used to speed up decoding</span>
<span class="sd">            (see `past_key_values`).</span>
<span class="sd">        past_key_value (`Tuple(torch.FloatTensor)`, *optional*): cached past key and value projection states</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">residual</span> <span class="o">=</span> <span class="n">hidden_states</span>

    <span class="n">hidden_states</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_layernorm</span><span class="p">(</span><span class="n">hidden_states</span><span class="p">)</span>

    <span class="c1"># Self Attention</span>
    <span class="n">hidden_states</span><span class="p">,</span> <span class="n">self_attn_weights</span><span class="p">,</span> <span class="n">present_key_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">self_attn</span><span class="p">(</span>
        <span class="n">hidden_states</span><span class="o">=</span><span class="n">hidden_states</span><span class="p">,</span>
        <span class="n">attention_mask</span><span class="o">=</span><span class="n">attention_mask</span><span class="p">,</span>
        <span class="n">position_ids</span><span class="o">=</span><span class="n">position_ids</span><span class="p">,</span>
        <span class="n">past_key_value</span><span class="o">=</span><span class="n">past_key_value</span><span class="p">,</span>
        <span class="n">output_attentions</span><span class="o">=</span><span class="n">output_attentions</span><span class="p">,</span>
        <span class="n">use_cache</span><span class="o">=</span><span class="n">use_cache</span><span class="p">,</span>
        <span class="n">unpadded_lengths</span><span class="o">=</span><span class="n">unpadded_lengths</span><span class="p">,</span>
        <span class="n">seq_parallel_group</span><span class="o">=</span><span class="n">seq_parallel_group</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">hidden_states</span> <span class="o">=</span> <span class="n">residual</span> <span class="o">+</span> <span class="n">hidden_states</span>

    <span class="c1"># Fully Connected</span>
    <span class="n">residual</span> <span class="o">=</span> <span class="n">hidden_states</span>
    <span class="n">hidden_states</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">post_attention_layernorm</span><span class="p">(</span><span class="n">hidden_states</span><span class="p">)</span>
    <span class="n">hidden_states</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mlp</span><span class="p">(</span><span class="n">hidden_states</span><span class="p">)</span>
    <span class="n">hidden_states</span> <span class="o">=</span> <span class="n">residual</span> <span class="o">+</span> <span class="n">hidden_states</span>

    <span class="n">outputs</span> <span class="o">=</span> <span class="p">(</span><span class="n">hidden_states</span><span class="p">,)</span>

    <span class="k">if</span> <span class="n">output_attentions</span><span class="p">:</span>
        <span class="n">outputs</span> <span class="o">+=</span> <span class="p">(</span><span class="n">self_attn_weights</span><span class="p">,)</span>

    <span class="k">if</span> <span class="n">use_cache</span><span class="p">:</span>
        <span class="n">outputs</span> <span class="o">+=</span> <span class="p">(</span><span class="n">present_key_value</span><span class="p">,)</span>

    <span class="k">return</span> <span class="n">outputs</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h6 id="swebench.inference.llamao.modeling_flash_llama.LlamaPreTrainedModel" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>            <span class="doc doc-object-name doc-class-name">LlamaPreTrainedModel</span>


</h6>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="transformers.modeling_utils.PreTrainedModel">PreTrainedModel</span></code>, <code><span title="transformers.GenerationMixin">GenerationMixin</span></code></p>











  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h7 id="swebench.inference.llamao.modeling_flash_llama.LlamaPreTrainedModel.config_class" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <span class="doc doc-object-name doc-attribute-name">config_class</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h7>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">config_class</span> <span class="o">=</span> <span class="n"><span title="transformers.models.llama.configuration_llama.LlamaConfig">LlamaConfig</span></span>
</code></pre></div>

    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h7 id="swebench.inference.llamao.modeling_flash_llama.LlamaPreTrainedModel.base_model_prefix" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <span class="doc doc-object-name doc-attribute-name">base_model_prefix</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h7>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">base_model_prefix</span> <span class="o">=</span> <span class="s1">&#39;model&#39;</span>
</code></pre></div>

    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h7 id="swebench.inference.llamao.modeling_flash_llama.LlamaPreTrainedModel.supports_gradient_checkpointing" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <span class="doc doc-object-name doc-attribute-name">supports_gradient_checkpointing</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h7>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">supports_gradient_checkpointing</span> <span class="o">=</span> <span class="kc">True</span>
</code></pre></div>

    <div class="doc doc-contents ">

    </div>

</div>





  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h6 id="swebench.inference.llamao.modeling_flash_llama.LlamaModel" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>            <span class="doc doc-object-name doc-class-name">LlamaModel</span>


</h6>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">LlamaModel</span><span class="p">(</span><span class="n">config</span><span class="p">:</span> <span class="n"><span title="transformers.models.llama.configuration_llama.LlamaConfig">LlamaConfig</span></span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="            LlamaPreTrainedModel (swebench.inference.llamao.modeling_flash_llama.LlamaPreTrainedModel)" href="#swebench.inference.llamao.modeling_flash_llama.LlamaPreTrainedModel">LlamaPreTrainedModel</a></code></p>


        <p>Transformer decoder consisting of <em>config.num_hidden_layers</em> layers. Each layer is a [<code>LlamaDecoderLayer</code>]</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>config</code>
            </td>
            <td>
                  <code><span title="transformers.models.llama.configuration_llama.LlamaConfig">LlamaConfig</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>LlamaConfig</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>







                  <details class="quote">
                    <summary>Source code in <code>swebench/inference/llamao/modeling_flash_llama.py</code></summary>
                    <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">LlamaConfig</span><span class="p">):</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">padding_idx</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">pad_token_id</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">vocab_size</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">vocab_size</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">embed_tokens</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Embedding</span><span class="p">(</span>
        <span class="n">config</span><span class="o">.</span><span class="n">vocab_size</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">hidden_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">padding_idx</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">layers</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ModuleList</span><span class="p">(</span>
        <span class="p">[</span><span class="n">LlamaDecoderLayer</span><span class="p">(</span><span class="n">config</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">num_hidden_layers</span><span class="p">)]</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">norm</span> <span class="o">=</span> <span class="n">LlamaRMSNorm</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">hidden_size</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">rms_norm_eps</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">gradient_checkpointing</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="c1"># Initialize weights and apply final processing</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">post_init</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
                  </details>



  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h7 id="swebench.inference.llamao.modeling_flash_llama.LlamaModel.padding_idx" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <span class="doc doc-object-name doc-attribute-name">padding_idx</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h7>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">padding_idx</span> <span class="o">=</span> <span class="n"><span title="swebench.inference.llamao.modeling_flash_llama.LlamaModel(config).pad_token_id">pad_token_id</span></span>
</code></pre></div>

    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h7 id="swebench.inference.llamao.modeling_flash_llama.LlamaModel.vocab_size" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <span class="doc doc-object-name doc-attribute-name">vocab_size</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h7>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">vocab_size</span> <span class="o">=</span> <span class="n"><span title="swebench.inference.llamao.modeling_flash_llama.LlamaModel(config).vocab_size">vocab_size</span></span>
</code></pre></div>

    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h7 id="swebench.inference.llamao.modeling_flash_llama.LlamaModel.embed_tokens" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <span class="doc doc-object-name doc-attribute-name">embed_tokens</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h7>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">embed_tokens</span> <span class="o">=</span> <span class="n"><span title="torch.nn.Embedding">Embedding</span></span><span class="p">(</span><span class="n"><span title="swebench.inference.llamao.modeling_flash_llama.LlamaModel(config).vocab_size">vocab_size</span></span><span class="p">,</span> <span class="n"><span title="swebench.inference.llamao.modeling_flash_llama.LlamaModel(config).hidden_size">hidden_size</span></span><span class="p">,</span> <span class="n"><span title="swebench.inference.llamao.modeling_flash_llama.LlamaModel(self).padding_idx">padding_idx</span></span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h7 id="swebench.inference.llamao.modeling_flash_llama.LlamaModel.layers" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <span class="doc doc-object-name doc-attribute-name">layers</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h7>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">layers</span> <span class="o">=</span> <span class="n"><span title="torch.nn.ModuleList">ModuleList</span></span><span class="p">([(</span><span class="n"><a class="autorefs autorefs-internal" title="            LlamaDecoderLayer (swebench.inference.llamao.modeling_flash_llama.LlamaDecoderLayer)" href="#swebench.inference.llamao.modeling_flash_llama.LlamaDecoderLayer">LlamaDecoderLayer</a></span><span class="p">(</span><span class="n"><span title="swebench.inference.llamao.modeling_flash_llama.LlamaModel(config)">config</span></span><span class="p">))</span> <span class="k">for</span> <span class="n"><span title="_">_</span></span> <span class="ow">in</span> <span class="p">(</span><span class="n"><span title="range">range</span></span><span class="p">(</span><span class="n"><span title="swebench.inference.llamao.modeling_flash_llama.LlamaModel(config).num_hidden_layers">num_hidden_layers</span></span><span class="p">))])</span>
</code></pre></div>

    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h7 id="swebench.inference.llamao.modeling_flash_llama.LlamaModel.norm" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <span class="doc doc-object-name doc-attribute-name">norm</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h7>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">norm</span> <span class="o">=</span> <span class="n"><a class="autorefs autorefs-internal" title="            LlamaRMSNorm (swebench.inference.llamao.modeling_flash_llama.LlamaRMSNorm)" href="#swebench.inference.llamao.modeling_flash_llama.LlamaRMSNorm">LlamaRMSNorm</a></span><span class="p">(</span><span class="n"><span title="swebench.inference.llamao.modeling_flash_llama.LlamaModel(config).hidden_size">hidden_size</span></span><span class="p">,</span> <span class="n"><span title="swebench.inference.llamao.modeling_flash_llama.LlamaRMSNorm(eps)">eps</span></span><span class="o">=</span><span class="n"><span title="swebench.inference.llamao.modeling_flash_llama.LlamaModel(config).rms_norm_eps">rms_norm_eps</span></span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h7 id="swebench.inference.llamao.modeling_flash_llama.LlamaModel.gradient_checkpointing" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <span class="doc doc-object-name doc-attribute-name">gradient_checkpointing</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h7>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">gradient_checkpointing</span> <span class="o">=</span> <span class="kc">False</span>
</code></pre></div>

    <div class="doc doc-contents ">

    </div>

</div>



<div class="doc doc-object doc-function">


<h7 id="swebench.inference.llamao.modeling_flash_llama.LlamaModel.get_input_embeddings" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <span class="doc doc-object-name doc-function-name">get_input_embeddings</span>


</h7>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">get_input_embeddings</span><span class="p">()</span>
</code></pre></div>

    <div class="doc doc-contents ">


            <details class="quote">
              <summary>Source code in <code>swebench/inference/llamao/modeling_flash_llama.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">584</span>
<span class="normal">585</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_input_embeddings</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">embed_tokens</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h7 id="swebench.inference.llamao.modeling_flash_llama.LlamaModel.set_input_embeddings" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <span class="doc doc-object-name doc-function-name">set_input_embeddings</span>


</h7>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">set_input_embeddings</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">


            <details class="quote">
              <summary>Source code in <code>swebench/inference/llamao/modeling_flash_llama.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">587</span>
<span class="normal">588</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">set_input_embeddings</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">embed_tokens</span> <span class="o">=</span> <span class="n">value</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h7 id="swebench.inference.llamao.modeling_flash_llama.LlamaModel.forward" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <span class="doc doc-object-name doc-function-name">forward</span>


</h7>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">forward</span><span class="p">(</span><span class="n">input_ids</span><span class="p">:</span> <span class="n"><span title="torch.LongTensor">LongTensor</span></span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">attention_mask</span><span class="p">:</span> <span class="n"><span title="typing.Optional">Optional</span></span><span class="p">[</span><span class="n"><span title="torch.Tensor">Tensor</span></span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">position_ids</span><span class="p">:</span> <span class="n"><span title="typing.Optional">Optional</span></span><span class="p">[</span><span class="n"><span title="torch.LongTensor">LongTensor</span></span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">past_key_values</span><span class="p">:</span> <span class="n"><span title="typing.Optional">Optional</span></span><span class="p">[</span><span class="n"><span title="list">list</span></span><span class="p">[</span><span class="n"><span title="torch.FloatTensor">FloatTensor</span></span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">inputs_embeds</span><span class="p">:</span> <span class="n"><span title="typing.Optional">Optional</span></span><span class="p">[</span><span class="n"><span title="torch.FloatTensor">FloatTensor</span></span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">use_cache</span><span class="p">:</span> <span class="n"><span title="typing.Optional">Optional</span></span><span class="p">[</span><span class="n"><span title="bool">bool</span></span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">output_attentions</span><span class="p">:</span> <span class="n"><span title="typing.Optional">Optional</span></span><span class="p">[</span><span class="n"><span title="bool">bool</span></span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">output_hidden_states</span><span class="p">:</span> <span class="n"><span title="typing.Optional">Optional</span></span><span class="p">[</span><span class="n"><span title="bool">bool</span></span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">return_dict</span><span class="p">:</span> <span class="n"><span title="typing.Optional">Optional</span></span><span class="p">[</span><span class="n"><span title="bool">bool</span></span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">seq_parallel_group</span><span class="p">:</span> <span class="n"><span title="typing.Optional">Optional</span></span><span class="p">[</span><span class="n"><span title="typing.Any">Any</span></span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><span title="typing.Union">Union</span></span><span class="p">[</span><span class="n"><span title="tuple">tuple</span></span><span class="p">,</span> <span class="n"><span title="transformers.modeling_outputs.BaseModelOutputWithPast">BaseModelOutputWithPast</span></span><span class="p">]</span>
</code></pre></div>

    <div class="doc doc-contents ">


            <details class="quote">
              <summary>Source code in <code>swebench/inference/llamao/modeling_flash_llama.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span>
<span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span>
<span class="normal">649</span>
<span class="normal">650</span>
<span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span>
<span class="normal">659</span>
<span class="normal">660</span>
<span class="normal">661</span>
<span class="normal">662</span>
<span class="normal">663</span>
<span class="normal">664</span>
<span class="normal">665</span>
<span class="normal">666</span>
<span class="normal">667</span>
<span class="normal">668</span>
<span class="normal">669</span>
<span class="normal">670</span>
<span class="normal">671</span>
<span class="normal">672</span>
<span class="normal">673</span>
<span class="normal">674</span>
<span class="normal">675</span>
<span class="normal">676</span>
<span class="normal">677</span>
<span class="normal">678</span>
<span class="normal">679</span>
<span class="normal">680</span>
<span class="normal">681</span>
<span class="normal">682</span>
<span class="normal">683</span>
<span class="normal">684</span>
<span class="normal">685</span>
<span class="normal">686</span>
<span class="normal">687</span>
<span class="normal">688</span>
<span class="normal">689</span>
<span class="normal">690</span>
<span class="normal">691</span>
<span class="normal">692</span>
<span class="normal">693</span>
<span class="normal">694</span>
<span class="normal">695</span>
<span class="normal">696</span>
<span class="normal">697</span>
<span class="normal">698</span>
<span class="normal">699</span>
<span class="normal">700</span>
<span class="normal">701</span>
<span class="normal">702</span>
<span class="normal">703</span>
<span class="normal">704</span>
<span class="normal">705</span>
<span class="normal">706</span>
<span class="normal">707</span>
<span class="normal">708</span>
<span class="normal">709</span>
<span class="normal">710</span>
<span class="normal">711</span>
<span class="normal">712</span>
<span class="normal">713</span>
<span class="normal">714</span>
<span class="normal">715</span>
<span class="normal">716</span>
<span class="normal">717</span>
<span class="normal">718</span>
<span class="normal">719</span>
<span class="normal">720</span>
<span class="normal">721</span>
<span class="normal">722</span>
<span class="normal">723</span>
<span class="normal">724</span>
<span class="normal">725</span>
<span class="normal">726</span>
<span class="normal">727</span>
<span class="normal">728</span>
<span class="normal">729</span>
<span class="normal">730</span>
<span class="normal">731</span>
<span class="normal">732</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">input_ids</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">attention_mask</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">position_ids</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">past_key_values</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">inputs_embeds</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">use_cache</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">output_attentions</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">output_hidden_states</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">return_dict</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">seq_parallel_group</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="nb">tuple</span><span class="p">,</span> <span class="n">BaseModelOutputWithPast</span><span class="p">]:</span>
    <span class="n">output_attentions</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">output_attentions</span>
        <span class="k">if</span> <span class="n">output_attentions</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">output_attentions</span>
    <span class="p">)</span>
    <span class="n">output_hidden_states</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">output_hidden_states</span>
        <span class="k">if</span> <span class="n">output_hidden_states</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">output_hidden_states</span>
    <span class="p">)</span>
    <span class="n">use_cache</span> <span class="o">=</span> <span class="n">use_cache</span> <span class="k">if</span> <span class="n">use_cache</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">use_cache</span>

    <span class="n">return_dict</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">return_dict</span> <span class="k">if</span> <span class="n">return_dict</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">use_return_dict</span>
    <span class="p">)</span>

    <span class="c1"># retrieve input_ids and inputs_embeds</span>
    <span class="k">if</span> <span class="n">input_ids</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">inputs_embeds</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;You cannot specify both decoder_input_ids and decoder_inputs_embeds at the same time&quot;</span>
        <span class="p">)</span>
    <span class="k">elif</span> <span class="n">input_ids</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">batch_size</span><span class="p">,</span> <span class="n">seq_length</span> <span class="o">=</span> <span class="n">input_ids</span><span class="o">.</span><span class="n">shape</span>
    <span class="k">elif</span> <span class="n">inputs_embeds</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">batch_size</span><span class="p">,</span> <span class="n">seq_length</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">inputs_embeds</span><span class="o">.</span><span class="n">shape</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;You have to specify either decoder_input_ids or decoder_inputs_embeds&quot;</span>
        <span class="p">)</span>

    <span class="c1"># position_ids = None</span>

    <span class="k">if</span> <span class="n">inputs_embeds</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">inputs_embeds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">embed_tokens</span><span class="p">(</span><span class="n">input_ids</span><span class="p">)</span>

    <span class="n">hidden_states</span> <span class="o">=</span> <span class="n">inputs_embeds</span>
    <span class="n">bsz</span> <span class="o">=</span> <span class="n">hidden_states</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">gradient_checkpointing</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">training</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">use_cache</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning_once</span><span class="p">(</span>
                <span class="s2">&quot;`use_cache=True` is incompatible with gradient checkpointing. Setting `use_cache=False`...&quot;</span>
            <span class="p">)</span>
            <span class="n">use_cache</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">if</span> <span class="p">(</span>
        <span class="p">((</span><span class="n">attention_mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">attention_mask</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()))</span>
        <span class="ow">and</span> <span class="ow">not</span> <span class="n">use_cache</span>
        <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span>
            <span class="n">dist</span><span class="o">.</span><span class="n">is_initialized</span><span class="p">()</span> <span class="ow">and</span> <span class="n">dist</span><span class="o">.</span><span class="n">get_world_size</span><span class="p">(</span><span class="n">seq_parallel_group</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span>
        <span class="p">)</span>
    <span class="p">):</span>
        <span class="n">hidden_states</span><span class="p">,</span> <span class="n">unpad_indices</span><span class="p">,</span> <span class="n">cu_seqlens</span><span class="p">,</span> <span class="n">max_seqlen</span> <span class="o">=</span> <span class="n">unpad_input</span><span class="p">(</span>
            <span class="n">hidden_states</span><span class="p">,</span> <span class="n">attention_mask</span>
        <span class="p">)</span>
        <span class="n">unpadded_lengths</span> <span class="o">=</span> <span class="p">(</span><span class="n">cu_seqlens</span><span class="p">,</span> <span class="n">max_seqlen</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">unpadded_lengths</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># decoder layers</span>
    <span class="n">all_hidden_states</span> <span class="o">=</span> <span class="p">()</span> <span class="k">if</span> <span class="n">output_hidden_states</span> <span class="k">else</span> <span class="kc">None</span>
    <span class="n">all_self_attns</span> <span class="o">=</span> <span class="p">()</span> <span class="k">if</span> <span class="n">output_attentions</span> <span class="k">else</span> <span class="kc">None</span>
    <span class="n">next_decoder_cache</span> <span class="o">=</span> <span class="p">()</span> <span class="k">if</span> <span class="n">use_cache</span> <span class="k">else</span> <span class="kc">None</span>

    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">decoder_layer</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">output_hidden_states</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">unpadded_lengths</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">all_hidden_states</span> <span class="o">+=</span> <span class="p">(</span>
                    <span class="n">pad_input</span><span class="p">(</span><span class="n">hidden_states</span><span class="p">,</span> <span class="n">unpad_indices</span><span class="p">,</span> <span class="n">bsz</span><span class="p">,</span> <span class="n">max_seqlen</span><span class="p">),</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">all_hidden_states</span> <span class="o">+=</span> <span class="p">(</span><span class="n">hidden_states</span><span class="p">,)</span>

        <span class="n">past_key_value</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">past_key_values</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="k">if</span> <span class="n">past_key_values</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">past_key_values</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">gradient_checkpointing</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">training</span><span class="p">:</span>
            <span class="n">layer_outputs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">checkpoint</span><span class="o">.</span><span class="n">checkpoint</span><span class="p">(</span>
                <span class="n">decoder_layer</span><span class="p">,</span>
                <span class="n">hidden_states</span><span class="p">,</span>
                <span class="n">attention_mask</span><span class="p">,</span>
                <span class="n">position_ids</span><span class="p">,</span>
                <span class="kc">None</span><span class="p">,</span>
                <span class="n">unpadded_lengths</span><span class="p">,</span>
                <span class="n">output_attentions</span><span class="p">,</span>
                <span class="kc">False</span><span class="p">,</span>
                <span class="n">seq_parallel_group</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">layer_outputs</span> <span class="o">=</span> <span class="n">decoder_layer</span><span class="p">(</span>
                <span class="n">hidden_states</span><span class="p">,</span>
                <span class="n">attention_mask</span><span class="o">=</span><span class="n">attention_mask</span><span class="p">,</span>
                <span class="n">position_ids</span><span class="o">=</span><span class="n">position_ids</span><span class="p">,</span>
                <span class="n">past_key_value</span><span class="o">=</span><span class="n">past_key_value</span><span class="p">,</span>
                <span class="n">unpadded_lengths</span><span class="o">=</span><span class="n">unpadded_lengths</span><span class="p">,</span>
                <span class="n">output_attentions</span><span class="o">=</span><span class="n">output_attentions</span><span class="p">,</span>
                <span class="n">use_cache</span><span class="o">=</span><span class="n">use_cache</span><span class="p">,</span>
                <span class="n">seq_parallel_group</span><span class="o">=</span><span class="n">seq_parallel_group</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="n">hidden_states</span> <span class="o">=</span> <span class="n">layer_outputs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">use_cache</span><span class="p">:</span>
            <span class="n">next_decoder_cache</span> <span class="o">+=</span> <span class="p">(</span><span class="n">layer_outputs</span><span class="p">[</span><span class="mi">2</span> <span class="k">if</span> <span class="n">output_attentions</span> <span class="k">else</span> <span class="mi">1</span><span class="p">],)</span>

        <span class="k">if</span> <span class="n">output_attentions</span><span class="p">:</span>
            <span class="n">all_self_attns</span> <span class="o">+=</span> <span class="p">(</span><span class="n">layer_outputs</span><span class="p">[</span><span class="mi">1</span><span class="p">],)</span>

    <span class="k">if</span> <span class="n">unpadded_lengths</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">hidden_states</span> <span class="o">=</span> <span class="n">pad_input</span><span class="p">(</span><span class="n">hidden_states</span><span class="p">,</span> <span class="n">unpad_indices</span><span class="p">,</span> <span class="n">bsz</span><span class="p">,</span> <span class="n">max_seqlen</span><span class="p">)</span>
    <span class="n">hidden_states</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">hidden_states</span><span class="p">)</span>

    <span class="c1"># add hidden states from the last decoder layer</span>
    <span class="k">if</span> <span class="n">output_hidden_states</span><span class="p">:</span>
        <span class="n">all_hidden_states</span> <span class="o">+=</span> <span class="p">(</span><span class="n">hidden_states</span><span class="p">,)</span>

    <span class="n">next_cache</span> <span class="o">=</span> <span class="n">next_decoder_cache</span> <span class="k">if</span> <span class="n">use_cache</span> <span class="k">else</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">return_dict</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span>
            <span class="n">v</span>
            <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="p">[</span><span class="n">hidden_states</span><span class="p">,</span> <span class="n">next_cache</span><span class="p">,</span> <span class="n">all_hidden_states</span><span class="p">,</span> <span class="n">all_self_attns</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="n">BaseModelOutputWithPast</span><span class="p">(</span>
        <span class="n">last_hidden_state</span><span class="o">=</span><span class="n">hidden_states</span><span class="p">,</span>
        <span class="n">past_key_values</span><span class="o">=</span><span class="n">next_cache</span><span class="p">,</span>
        <span class="n">hidden_states</span><span class="o">=</span><span class="n">all_hidden_states</span><span class="p">,</span>
        <span class="n">attentions</span><span class="o">=</span><span class="n">all_self_attns</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h6 id="swebench.inference.llamao.modeling_flash_llama.LlamaForCausalLM" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>            <span class="doc doc-object-name doc-class-name">LlamaForCausalLM</span>


</h6>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">LlamaForCausalLM</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="            LlamaPreTrainedModel (swebench.inference.llamao.modeling_flash_llama.LlamaPreTrainedModel)" href="#swebench.inference.llamao.modeling_flash_llama.LlamaPreTrainedModel">LlamaPreTrainedModel</a></code>, <code><span title="transformers.GenerationMixin">GenerationMixin</span></code></p>








                  <details class="quote">
                    <summary>Source code in <code>swebench/inference/llamao/modeling_flash_llama.py</code></summary>
                    <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">738</span>
<span class="normal">739</span>
<span class="normal">740</span>
<span class="normal">741</span>
<span class="normal">742</span>
<span class="normal">743</span>
<span class="normal">744</span>
<span class="normal">745</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">LlamaModel</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">vocab_size</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">vocab_size</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">lm_head</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">hidden_size</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">vocab_size</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="c1"># Initialize weights and apply final processing</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">post_init</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
                  </details>



  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h7 id="swebench.inference.llamao.modeling_flash_llama.LlamaForCausalLM.model" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <span class="doc doc-object-name doc-attribute-name">model</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h7>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">model</span> <span class="o">=</span> <span class="n"><a class="autorefs autorefs-internal" title="            LlamaModel (swebench.inference.llamao.modeling_flash_llama.LlamaModel)" href="#swebench.inference.llamao.modeling_flash_llama.LlamaModel">LlamaModel</a></span><span class="p">(</span><span class="n"><span title="swebench.inference.llamao.modeling_flash_llama.LlamaForCausalLM(config)">config</span></span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h7 id="swebench.inference.llamao.modeling_flash_llama.LlamaForCausalLM.vocab_size" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <span class="doc doc-object-name doc-attribute-name">vocab_size</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h7>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">vocab_size</span> <span class="o">=</span> <span class="n"><span title="swebench.inference.llamao.modeling_flash_llama.LlamaForCausalLM(config).vocab_size">vocab_size</span></span>
</code></pre></div>

    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h7 id="swebench.inference.llamao.modeling_flash_llama.LlamaForCausalLM.lm_head" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <span class="doc doc-object-name doc-attribute-name">lm_head</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h7>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">lm_head</span> <span class="o">=</span> <span class="n"><span title="torch.nn.Linear">Linear</span></span><span class="p">(</span><span class="n"><span title="swebench.inference.llamao.modeling_flash_llama.LlamaForCausalLM(config).hidden_size">hidden_size</span></span><span class="p">,</span> <span class="n"><span title="swebench.inference.llamao.modeling_flash_llama.LlamaForCausalLM(config).vocab_size">vocab_size</span></span><span class="p">,</span> <span class="n"><span title="torch.nn.Linear(bias)">bias</span></span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

    </div>

</div>



<div class="doc doc-object doc-function">


<h7 id="swebench.inference.llamao.modeling_flash_llama.LlamaForCausalLM.get_input_embeddings" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <span class="doc doc-object-name doc-function-name">get_input_embeddings</span>


</h7>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">get_input_embeddings</span><span class="p">()</span>
</code></pre></div>

    <div class="doc doc-contents ">


            <details class="quote">
              <summary>Source code in <code>swebench/inference/llamao/modeling_flash_llama.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">747</span>
<span class="normal">748</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_input_embeddings</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">embed_tokens</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h7 id="swebench.inference.llamao.modeling_flash_llama.LlamaForCausalLM.set_input_embeddings" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <span class="doc doc-object-name doc-function-name">set_input_embeddings</span>


</h7>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">set_input_embeddings</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">


            <details class="quote">
              <summary>Source code in <code>swebench/inference/llamao/modeling_flash_llama.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">750</span>
<span class="normal">751</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">set_input_embeddings</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">embed_tokens</span> <span class="o">=</span> <span class="n">value</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h7 id="swebench.inference.llamao.modeling_flash_llama.LlamaForCausalLM.get_output_embeddings" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <span class="doc doc-object-name doc-function-name">get_output_embeddings</span>


</h7>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">get_output_embeddings</span><span class="p">()</span>
</code></pre></div>

    <div class="doc doc-contents ">


            <details class="quote">
              <summary>Source code in <code>swebench/inference/llamao/modeling_flash_llama.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">753</span>
<span class="normal">754</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_output_embeddings</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">lm_head</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h7 id="swebench.inference.llamao.modeling_flash_llama.LlamaForCausalLM.set_output_embeddings" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <span class="doc doc-object-name doc-function-name">set_output_embeddings</span>


</h7>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">set_output_embeddings</span><span class="p">(</span><span class="n">new_embeddings</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">


            <details class="quote">
              <summary>Source code in <code>swebench/inference/llamao/modeling_flash_llama.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">756</span>
<span class="normal">757</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">set_output_embeddings</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_embeddings</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">lm_head</span> <span class="o">=</span> <span class="n">new_embeddings</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h7 id="swebench.inference.llamao.modeling_flash_llama.LlamaForCausalLM.set_decoder" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <span class="doc doc-object-name doc-function-name">set_decoder</span>


</h7>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">set_decoder</span><span class="p">(</span><span class="n">decoder</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">


            <details class="quote">
              <summary>Source code in <code>swebench/inference/llamao/modeling_flash_llama.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">759</span>
<span class="normal">760</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">set_decoder</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">decoder</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">decoder</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h7 id="swebench.inference.llamao.modeling_flash_llama.LlamaForCausalLM.get_decoder" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <span class="doc doc-object-name doc-function-name">get_decoder</span>


</h7>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">get_decoder</span><span class="p">()</span>
</code></pre></div>

    <div class="doc doc-contents ">


            <details class="quote">
              <summary>Source code in <code>swebench/inference/llamao/modeling_flash_llama.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">762</span>
<span class="normal">763</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_decoder</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h7 id="swebench.inference.llamao.modeling_flash_llama.LlamaForCausalLM.forward" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <span class="doc doc-object-name doc-function-name">forward</span>


</h7>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">forward</span><span class="p">(</span><span class="n">input_ids</span><span class="p">:</span> <span class="n"><span title="torch.LongTensor">LongTensor</span></span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">attention_mask</span><span class="p">:</span> <span class="n"><span title="typing.Optional">Optional</span></span><span class="p">[</span><span class="n"><span title="torch.Tensor">Tensor</span></span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">position_ids</span><span class="p">:</span> <span class="n"><span title="typing.Optional">Optional</span></span><span class="p">[</span><span class="n"><span title="torch.LongTensor">LongTensor</span></span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">past_key_values</span><span class="p">:</span> <span class="n"><span title="typing.Optional">Optional</span></span><span class="p">[</span><span class="n"><span title="list">list</span></span><span class="p">[</span><span class="n"><span title="torch.FloatTensor">FloatTensor</span></span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">inputs_embeds</span><span class="p">:</span> <span class="n"><span title="typing.Optional">Optional</span></span><span class="p">[</span><span class="n"><span title="torch.FloatTensor">FloatTensor</span></span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">labels</span><span class="p">:</span> <span class="n"><span title="typing.Optional">Optional</span></span><span class="p">[</span><span class="n"><span title="torch.LongTensor">LongTensor</span></span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">use_cache</span><span class="p">:</span> <span class="n"><span title="typing.Optional">Optional</span></span><span class="p">[</span><span class="n"><span title="bool">bool</span></span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">output_attentions</span><span class="p">:</span> <span class="n"><span title="typing.Optional">Optional</span></span><span class="p">[</span><span class="n"><span title="bool">bool</span></span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">output_hidden_states</span><span class="p">:</span> <span class="n"><span title="typing.Optional">Optional</span></span><span class="p">[</span><span class="n"><span title="bool">bool</span></span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">return_dict</span><span class="p">:</span> <span class="n"><span title="typing.Optional">Optional</span></span><span class="p">[</span><span class="n"><span title="bool">bool</span></span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">unpadded_lengths</span><span class="p">:</span> <span class="n"><span title="typing.Optional">Optional</span></span><span class="p">[</span><span class="n"><span title="bool">bool</span></span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">avg_valid_labels_per_chunk</span><span class="p">:</span> <span class="n"><span title="typing.Optional">Optional</span></span><span class="p">[</span><span class="n"><span title="float">float</span></span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">seq_parallel_group</span><span class="p">:</span> <span class="n"><span title="typing.Optional">Optional</span></span><span class="p">[</span><span class="n"><span title="typing.Any">Any</span></span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><span title="typing.Union">Union</span></span><span class="p">[</span><span class="n"><span title="tuple">tuple</span></span><span class="p">,</span> <span class="n"><span title="transformers.modeling_outputs.CausalLMOutputWithPast">CausalLMOutputWithPast</span></span><span class="p">]</span>
</code></pre></div>

    <div class="doc doc-contents ">



<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>labels</code>
            </td>
            <td>
                  <code>`torch.LongTensor` of shape `(batch_size, sequence_length)`, *optional*</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Labels for computing the masked language modeling loss. Indices should either be in <code>[0, ...,
config.vocab_size]</code> or -100 (see <code>input_ids</code> docstring). Tokens with indices set to <code>-100</code> are ignored
(masked), the loss is only computed for the tokens with labels in <code>[0, ..., config.vocab_size]</code>.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>
        <p>Returns:</p>
<p>Example:</p>
<div class="highlight"><pre><span></span><code><span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span><span class="w"> </span><span class="nn">transformers</span><span class="w"> </span><span class="kn">import</span> <span class="n">AutoTokenizer</span><span class="p">,</span> <span class="n">LlamaForCausalLM</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">model</span> <span class="o">=</span> <span class="n">LlamaForCausalLM</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">PATH_TO_CONVERTED_WEIGHTS</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">tokenizer</span> <span class="o">=</span> <span class="n">AutoTokenizer</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">PATH_TO_CONVERTED_TOKENIZER</span><span class="p">)</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">prompt</span> <span class="o">=</span> <span class="s2">&quot;Hey, are you conscious? Can you talk to me?&quot;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">inputs</span> <span class="o">=</span> <span class="n">tokenizer</span><span class="p">(</span><span class="n">prompt</span><span class="p">,</span> <span class="n">return_tensors</span><span class="o">=</span><span class="s2">&quot;pt&quot;</span><span class="p">)</span>

<span class="o">&gt;&gt;&gt;</span> <span class="c1"># Generate</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">generate_ids</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="n">inputs</span><span class="o">.</span><span class="n">input_ids</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">tokenizer</span><span class="o">.</span><span class="n">batch_decode</span><span class="p">(</span><span class="n">generate_ids</span><span class="p">,</span> <span class="n">skip_special_tokens</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">clean_up_tokenization_spaces</span><span class="o">=</span><span class="kc">False</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="s2">&quot;Hey, are you conscious? Can you talk to me?</span><span class="se">\n</span><span class="s2">I&#39;m not conscious, but I can talk to you.&quot;</span>
</code></pre></div>


            <details class="quote">
              <summary>Source code in <code>swebench/inference/llamao/modeling_flash_llama.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">765</span>
<span class="normal">766</span>
<span class="normal">767</span>
<span class="normal">768</span>
<span class="normal">769</span>
<span class="normal">770</span>
<span class="normal">771</span>
<span class="normal">772</span>
<span class="normal">773</span>
<span class="normal">774</span>
<span class="normal">775</span>
<span class="normal">776</span>
<span class="normal">777</span>
<span class="normal">778</span>
<span class="normal">779</span>
<span class="normal">780</span>
<span class="normal">781</span>
<span class="normal">782</span>
<span class="normal">783</span>
<span class="normal">784</span>
<span class="normal">785</span>
<span class="normal">786</span>
<span class="normal">787</span>
<span class="normal">788</span>
<span class="normal">789</span>
<span class="normal">790</span>
<span class="normal">791</span>
<span class="normal">792</span>
<span class="normal">793</span>
<span class="normal">794</span>
<span class="normal">795</span>
<span class="normal">796</span>
<span class="normal">797</span>
<span class="normal">798</span>
<span class="normal">799</span>
<span class="normal">800</span>
<span class="normal">801</span>
<span class="normal">802</span>
<span class="normal">803</span>
<span class="normal">804</span>
<span class="normal">805</span>
<span class="normal">806</span>
<span class="normal">807</span>
<span class="normal">808</span>
<span class="normal">809</span>
<span class="normal">810</span>
<span class="normal">811</span>
<span class="normal">812</span>
<span class="normal">813</span>
<span class="normal">814</span>
<span class="normal">815</span>
<span class="normal">816</span>
<span class="normal">817</span>
<span class="normal">818</span>
<span class="normal">819</span>
<span class="normal">820</span>
<span class="normal">821</span>
<span class="normal">822</span>
<span class="normal">823</span>
<span class="normal">824</span>
<span class="normal">825</span>
<span class="normal">826</span>
<span class="normal">827</span>
<span class="normal">828</span>
<span class="normal">829</span>
<span class="normal">830</span>
<span class="normal">831</span>
<span class="normal">832</span>
<span class="normal">833</span>
<span class="normal">834</span>
<span class="normal">835</span>
<span class="normal">836</span>
<span class="normal">837</span>
<span class="normal">838</span>
<span class="normal">839</span>
<span class="normal">840</span>
<span class="normal">841</span>
<span class="normal">842</span>
<span class="normal">843</span>
<span class="normal">844</span>
<span class="normal">845</span>
<span class="normal">846</span>
<span class="normal">847</span>
<span class="normal">848</span>
<span class="normal">849</span>
<span class="normal">850</span>
<span class="normal">851</span>
<span class="normal">852</span>
<span class="normal">853</span>
<span class="normal">854</span>
<span class="normal">855</span>
<span class="normal">856</span>
<span class="normal">857</span>
<span class="normal">858</span>
<span class="normal">859</span>
<span class="normal">860</span>
<span class="normal">861</span>
<span class="normal">862</span>
<span class="normal">863</span>
<span class="normal">864</span>
<span class="normal">865</span>
<span class="normal">866</span>
<span class="normal">867</span>
<span class="normal">868</span>
<span class="normal">869</span>
<span class="normal">870</span>
<span class="normal">871</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">input_ids</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">attention_mask</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">position_ids</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">past_key_values</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">inputs_embeds</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">labels</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">use_cache</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">output_attentions</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">output_hidden_states</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">return_dict</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">unpadded_lengths</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">avg_valid_labels_per_chunk</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">seq_parallel_group</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="nb">tuple</span><span class="p">,</span> <span class="n">CausalLMOutputWithPast</span><span class="p">]:</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Args:</span>
<span class="sd">        labels (`torch.LongTensor` of shape `(batch_size, sequence_length)`, *optional*):</span>
<span class="sd">            Labels for computing the masked language modeling loss. Indices should either be in `[0, ...,</span>
<span class="sd">            config.vocab_size]` or -100 (see `input_ids` docstring). Tokens with indices set to `-100` are ignored</span>
<span class="sd">            (masked), the loss is only computed for the tokens with labels in `[0, ..., config.vocab_size]`.</span>

<span class="sd">    Returns:</span>

<span class="sd">    Example:</span>

<span class="sd">    ```python</span>
<span class="sd">    &gt;&gt;&gt; from transformers import AutoTokenizer, LlamaForCausalLM</span>

<span class="sd">    &gt;&gt;&gt; model = LlamaForCausalLM.from_pretrained(PATH_TO_CONVERTED_WEIGHTS)</span>
<span class="sd">    &gt;&gt;&gt; tokenizer = AutoTokenizer.from_pretrained(PATH_TO_CONVERTED_TOKENIZER)</span>

<span class="sd">    &gt;&gt;&gt; prompt = &quot;Hey, are you conscious? Can you talk to me?&quot;</span>
<span class="sd">    &gt;&gt;&gt; inputs = tokenizer(prompt, return_tensors=&quot;pt&quot;)</span>

<span class="sd">    &gt;&gt;&gt; # Generate</span>
<span class="sd">    &gt;&gt;&gt; generate_ids = model.generate(inputs.input_ids, max_length=30)</span>
<span class="sd">    &gt;&gt;&gt; tokenizer.batch_decode(generate_ids, skip_special_tokens=True, clean_up_tokenization_spaces=False)[0]</span>
<span class="sd">    &quot;Hey, are you conscious? Can you talk to me?\nI&#39;m not conscious, but I can talk to you.&quot;</span>
<span class="sd">    ```&quot;&quot;&quot;</span>

    <span class="n">output_attentions</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">output_attentions</span>
        <span class="k">if</span> <span class="n">output_attentions</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">output_attentions</span>
    <span class="p">)</span>
    <span class="n">output_hidden_states</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">output_hidden_states</span>
        <span class="k">if</span> <span class="n">output_hidden_states</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">output_hidden_states</span>
    <span class="p">)</span>
    <span class="n">return_dict</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">return_dict</span> <span class="k">if</span> <span class="n">return_dict</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">use_return_dict</span>
    <span class="p">)</span>

    <span class="c1"># decoder outputs consists of (dec_features, layer_state, dec_hidden, dec_attn)</span>
    <span class="n">outputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span>
        <span class="n">input_ids</span><span class="o">=</span><span class="n">input_ids</span><span class="p">,</span>
        <span class="n">attention_mask</span><span class="o">=</span><span class="n">attention_mask</span><span class="p">,</span>
        <span class="n">position_ids</span><span class="o">=</span><span class="n">position_ids</span><span class="p">,</span>
        <span class="n">past_key_values</span><span class="o">=</span><span class="n">past_key_values</span><span class="p">,</span>
        <span class="n">inputs_embeds</span><span class="o">=</span><span class="n">inputs_embeds</span><span class="p">,</span>
        <span class="n">use_cache</span><span class="o">=</span><span class="n">use_cache</span><span class="p">,</span>
        <span class="n">output_attentions</span><span class="o">=</span><span class="n">output_attentions</span><span class="p">,</span>
        <span class="n">output_hidden_states</span><span class="o">=</span><span class="n">output_hidden_states</span><span class="p">,</span>
        <span class="n">return_dict</span><span class="o">=</span><span class="n">return_dict</span><span class="p">,</span>
        <span class="n">seq_parallel_group</span><span class="o">=</span><span class="n">seq_parallel_group</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">hidden_states</span> <span class="o">=</span> <span class="n">outputs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">loss</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">labels</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Only compute loss on tokens that contribute to loss</span>
        <span class="n">valid_prediction</span> <span class="o">=</span> <span class="n">labels</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">100</span>
        <span class="n">hidden_states_</span> <span class="o">=</span> <span class="n">hidden_states</span><span class="p">[</span><span class="n">valid_prediction</span><span class="p">]</span>
        <span class="n">logits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lm_head</span><span class="p">(</span><span class="n">hidden_states_</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>

        <span class="c1"># NOTE: We don&#39;t shift the labels inside the model here!</span>
        <span class="n">labels_</span> <span class="o">=</span> <span class="n">labels</span><span class="p">[</span><span class="n">valid_prediction</span><span class="p">]</span>

        <span class="k">if</span> <span class="p">(</span>
            <span class="n">avg_valid_labels_per_chunk</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="ow">and</span> <span class="n">avg_valid_labels_per_chunk</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="p">):</span>
            <span class="c1"># Don&#39;t take mean since this will give unequal weight to GPUs with unequal amount of padding</span>
            <span class="n">loss</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">cross_entropy</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="n">labels_</span><span class="p">,</span> <span class="n">reduction</span><span class="o">=</span><span class="s2">&quot;mean&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span>
                <span class="n">labels_</span><span class="o">.</span><span class="n">numel</span><span class="p">()</span> <span class="o">/</span> <span class="n">avg_valid_labels_per_chunk</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">valid_prediction</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                <span class="n">loss</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">loss</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">loss</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">cross_entropy</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="n">labels_</span><span class="p">,</span> <span class="n">reduction</span><span class="o">=</span><span class="s2">&quot;mean&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lm_head</span><span class="p">(</span><span class="n">hidden_states</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">return_dict</span><span class="p">:</span>
        <span class="n">output</span> <span class="o">=</span> <span class="p">(</span><span class="n">logits</span><span class="p">,)</span> <span class="o">+</span> <span class="n">outputs</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">loss</span><span class="p">,)</span> <span class="o">+</span> <span class="n">output</span> <span class="k">if</span> <span class="n">loss</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">output</span>

    <span class="k">return</span> <span class="n">CausalLMOutputWithPast</span><span class="p">(</span>
        <span class="n">loss</span><span class="o">=</span><span class="n">loss</span><span class="p">,</span>
        <span class="n">logits</span><span class="o">=</span><span class="n">logits</span><span class="p">,</span>
        <span class="n">past_key_values</span><span class="o">=</span><span class="n">outputs</span><span class="o">.</span><span class="n">past_key_values</span><span class="p">,</span>
        <span class="n">hidden_states</span><span class="o">=</span><span class="n">outputs</span><span class="o">.</span><span class="n">hidden_states</span><span class="p">,</span>
        <span class="n">attentions</span><span class="o">=</span><span class="n">outputs</span><span class="o">.</span><span class="n">attentions</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h7 id="swebench.inference.llamao.modeling_flash_llama.LlamaForCausalLM.prepare_inputs_for_generation" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <span class="doc doc-object-name doc-function-name">prepare_inputs_for_generation</span>


</h7>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">prepare_inputs_for_generation</span><span class="p">(</span><span class="n">input_ids</span><span class="p">,</span> <span class="n">past_key_values</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">attention_mask</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">inputs_embeds</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">


            <details class="quote">
              <summary>Source code in <code>swebench/inference/llamao/modeling_flash_llama.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">873</span>
<span class="normal">874</span>
<span class="normal">875</span>
<span class="normal">876</span>
<span class="normal">877</span>
<span class="normal">878</span>
<span class="normal">879</span>
<span class="normal">880</span>
<span class="normal">881</span>
<span class="normal">882</span>
<span class="normal">883</span>
<span class="normal">884</span>
<span class="normal">885</span>
<span class="normal">886</span>
<span class="normal">887</span>
<span class="normal">888</span>
<span class="normal">889</span>
<span class="normal">890</span>
<span class="normal">891</span>
<span class="normal">892</span>
<span class="normal">893</span>
<span class="normal">894</span>
<span class="normal">895</span>
<span class="normal">896</span>
<span class="normal">897</span>
<span class="normal">898</span>
<span class="normal">899</span>
<span class="normal">900</span>
<span class="normal">901</span>
<span class="normal">902</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">prepare_inputs_for_generation</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">input_ids</span><span class="p">,</span>
    <span class="n">past_key_values</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">attention_mask</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">inputs_embeds</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<span class="p">):</span>
    <span class="k">if</span> <span class="n">past_key_values</span><span class="p">:</span>
        <span class="n">input_ids</span> <span class="o">=</span> <span class="n">input_ids</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">:]</span>

    <span class="c1"># if `inputs_embeds` are passed, we only want to use them in the 1st generation step</span>
    <span class="k">if</span> <span class="n">inputs_embeds</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">past_key_values</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">model_inputs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;inputs_embeds&quot;</span><span class="p">:</span> <span class="n">inputs_embeds</span><span class="p">}</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">model_inputs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;input_ids&quot;</span><span class="p">:</span> <span class="n">input_ids</span><span class="p">}</span>

    <span class="n">model_inputs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
        <span class="p">{</span>
            <span class="s2">&quot;position_ids&quot;</span><span class="p">:</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;position_ids&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="s2">&quot;past_key_values&quot;</span><span class="p">:</span> <span class="n">past_key_values</span><span class="p">,</span>
            <span class="s2">&quot;use_cache&quot;</span><span class="p">:</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;use_cache&quot;</span><span class="p">),</span>
            <span class="s2">&quot;attention_mask&quot;</span><span class="p">:</span> <span class="n">attention_mask</span><span class="p">,</span>
            <span class="s2">&quot;unpadded_lengths&quot;</span><span class="p">:</span> <span class="p">(</span>
                <span class="p">(</span><span class="n">attention_mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">attention_mask</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>
            <span class="p">),</span>
            <span class="s2">&quot;seq_parallel_group&quot;</span><span class="p">:</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;seq_parallel_group&quot;</span><span class="p">),</span>
        <span class="p">}</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">model_inputs</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h6 id="swebench.inference.llamao.modeling_flash_llama.LlamaForSequenceClassification" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>            <span class="doc doc-object-name doc-class-name">LlamaForSequenceClassification</span>


</h6>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">LlamaForSequenceClassification</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="            LlamaPreTrainedModel (swebench.inference.llamao.modeling_flash_llama.LlamaPreTrainedModel)" href="#swebench.inference.llamao.modeling_flash_llama.LlamaPreTrainedModel">LlamaPreTrainedModel</a></code></p>








                  <details class="quote">
                    <summary>Source code in <code>swebench/inference/llamao/modeling_flash_llama.py</code></summary>
                    <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">918</span>
<span class="normal">919</span>
<span class="normal">920</span>
<span class="normal">921</span>
<span class="normal">922</span>
<span class="normal">923</span>
<span class="normal">924</span>
<span class="normal">925</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">num_labels</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">num_labels</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">LlamaModel</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">score</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">hidden_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_labels</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="c1"># Initialize weights and apply final processing</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">post_init</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
                  </details>



  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h7 id="swebench.inference.llamao.modeling_flash_llama.LlamaForSequenceClassification.num_labels" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <span class="doc doc-object-name doc-attribute-name">num_labels</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h7>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">num_labels</span> <span class="o">=</span> <span class="n"><span title="swebench.inference.llamao.modeling_flash_llama.LlamaForSequenceClassification(config).num_labels">num_labels</span></span>
</code></pre></div>

    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h7 id="swebench.inference.llamao.modeling_flash_llama.LlamaForSequenceClassification.model" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <span class="doc doc-object-name doc-attribute-name">model</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h7>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">model</span> <span class="o">=</span> <span class="n"><a class="autorefs autorefs-internal" title="            LlamaModel (swebench.inference.llamao.modeling_flash_llama.LlamaModel)" href="#swebench.inference.llamao.modeling_flash_llama.LlamaModel">LlamaModel</a></span><span class="p">(</span><span class="n"><span title="swebench.inference.llamao.modeling_flash_llama.LlamaForSequenceClassification(config)">config</span></span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h7 id="swebench.inference.llamao.modeling_flash_llama.LlamaForSequenceClassification.score" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <span class="doc doc-object-name doc-attribute-name">score</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h7>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">score</span> <span class="o">=</span> <span class="n"><span title="torch.nn.Linear">Linear</span></span><span class="p">(</span><span class="n"><span title="swebench.inference.llamao.modeling_flash_llama.LlamaForSequenceClassification(config).hidden_size">hidden_size</span></span><span class="p">,</span> <span class="n"><span title="swebench.inference.llamao.modeling_flash_llama.LlamaForSequenceClassification(self).num_labels">num_labels</span></span><span class="p">,</span> <span class="n"><span title="torch.nn.Linear(bias)">bias</span></span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

    </div>

</div>



<div class="doc doc-object doc-function">


<h7 id="swebench.inference.llamao.modeling_flash_llama.LlamaForSequenceClassification.get_input_embeddings" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <span class="doc doc-object-name doc-function-name">get_input_embeddings</span>


</h7>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">get_input_embeddings</span><span class="p">()</span>
</code></pre></div>

    <div class="doc doc-contents ">


            <details class="quote">
              <summary>Source code in <code>swebench/inference/llamao/modeling_flash_llama.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">927</span>
<span class="normal">928</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_input_embeddings</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">embed_tokens</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h7 id="swebench.inference.llamao.modeling_flash_llama.LlamaForSequenceClassification.set_input_embeddings" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <span class="doc doc-object-name doc-function-name">set_input_embeddings</span>


</h7>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">set_input_embeddings</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">


            <details class="quote">
              <summary>Source code in <code>swebench/inference/llamao/modeling_flash_llama.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">930</span>
<span class="normal">931</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">set_input_embeddings</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">embed_tokens</span> <span class="o">=</span> <span class="n">value</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h7 id="swebench.inference.llamao.modeling_flash_llama.LlamaForSequenceClassification.forward" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <span class="doc doc-object-name doc-function-name">forward</span>


</h7>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">forward</span><span class="p">(</span><span class="n">input_ids</span><span class="p">:</span> <span class="n"><span title="torch.LongTensor">LongTensor</span></span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">attention_mask</span><span class="p">:</span> <span class="n"><span title="typing.Optional">Optional</span></span><span class="p">[</span><span class="n"><span title="torch.Tensor">Tensor</span></span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">position_ids</span><span class="p">:</span> <span class="n"><span title="typing.Optional">Optional</span></span><span class="p">[</span><span class="n"><span title="torch.LongTensor">LongTensor</span></span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">past_key_values</span><span class="p">:</span> <span class="n"><span title="typing.Optional">Optional</span></span><span class="p">[</span><span class="n"><span title="list">list</span></span><span class="p">[</span><span class="n"><span title="torch.FloatTensor">FloatTensor</span></span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">inputs_embeds</span><span class="p">:</span> <span class="n"><span title="typing.Optional">Optional</span></span><span class="p">[</span><span class="n"><span title="torch.FloatTensor">FloatTensor</span></span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">labels</span><span class="p">:</span> <span class="n"><span title="typing.Optional">Optional</span></span><span class="p">[</span><span class="n"><span title="torch.LongTensor">LongTensor</span></span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">use_cache</span><span class="p">:</span> <span class="n"><span title="typing.Optional">Optional</span></span><span class="p">[</span><span class="n"><span title="bool">bool</span></span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">output_attentions</span><span class="p">:</span> <span class="n"><span title="typing.Optional">Optional</span></span><span class="p">[</span><span class="n"><span title="bool">bool</span></span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">output_hidden_states</span><span class="p">:</span> <span class="n"><span title="typing.Optional">Optional</span></span><span class="p">[</span><span class="n"><span title="bool">bool</span></span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">return_dict</span><span class="p">:</span> <span class="n"><span title="typing.Optional">Optional</span></span><span class="p">[</span><span class="n"><span title="bool">bool</span></span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><span title="typing.Union">Union</span></span><span class="p">[</span><span class="n"><span title="tuple">tuple</span></span><span class="p">,</span> <span class="n"><span title="transformers.modeling_outputs.SequenceClassifierOutputWithPast">SequenceClassifierOutputWithPast</span></span><span class="p">]</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>labels (<code>torch.LongTensor</code> of shape <code>(batch_size,)</code>, <em>optional</em>):
    Labels for computing the sequence classification/regression loss. Indices should be in <code>[0, ...,
    config.num_labels - 1]</code>. If <code>config.num_labels == 1</code> a regression loss is computed (Mean-Square loss), If
    <code>config.num_labels &gt; 1</code> a classification loss is computed (Cross-Entropy).</p>


            <details class="quote">
              <summary>Source code in <code>swebench/inference/llamao/modeling_flash_llama.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 933</span>
<span class="normal"> 934</span>
<span class="normal"> 935</span>
<span class="normal"> 936</span>
<span class="normal"> 937</span>
<span class="normal"> 938</span>
<span class="normal"> 939</span>
<span class="normal"> 940</span>
<span class="normal"> 941</span>
<span class="normal"> 942</span>
<span class="normal"> 943</span>
<span class="normal"> 944</span>
<span class="normal"> 945</span>
<span class="normal"> 946</span>
<span class="normal"> 947</span>
<span class="normal"> 948</span>
<span class="normal"> 949</span>
<span class="normal"> 950</span>
<span class="normal"> 951</span>
<span class="normal"> 952</span>
<span class="normal"> 953</span>
<span class="normal"> 954</span>
<span class="normal"> 955</span>
<span class="normal"> 956</span>
<span class="normal"> 957</span>
<span class="normal"> 958</span>
<span class="normal"> 959</span>
<span class="normal"> 960</span>
<span class="normal"> 961</span>
<span class="normal"> 962</span>
<span class="normal"> 963</span>
<span class="normal"> 964</span>
<span class="normal"> 965</span>
<span class="normal"> 966</span>
<span class="normal"> 967</span>
<span class="normal"> 968</span>
<span class="normal"> 969</span>
<span class="normal"> 970</span>
<span class="normal"> 971</span>
<span class="normal"> 972</span>
<span class="normal"> 973</span>
<span class="normal"> 974</span>
<span class="normal"> 975</span>
<span class="normal"> 976</span>
<span class="normal"> 977</span>
<span class="normal"> 978</span>
<span class="normal"> 979</span>
<span class="normal"> 980</span>
<span class="normal"> 981</span>
<span class="normal"> 982</span>
<span class="normal"> 983</span>
<span class="normal"> 984</span>
<span class="normal"> 985</span>
<span class="normal"> 986</span>
<span class="normal"> 987</span>
<span class="normal"> 988</span>
<span class="normal"> 989</span>
<span class="normal"> 990</span>
<span class="normal"> 991</span>
<span class="normal"> 992</span>
<span class="normal"> 993</span>
<span class="normal"> 994</span>
<span class="normal"> 995</span>
<span class="normal"> 996</span>
<span class="normal"> 997</span>
<span class="normal"> 998</span>
<span class="normal"> 999</span>
<span class="normal">1000</span>
<span class="normal">1001</span>
<span class="normal">1002</span>
<span class="normal">1003</span>
<span class="normal">1004</span>
<span class="normal">1005</span>
<span class="normal">1006</span>
<span class="normal">1007</span>
<span class="normal">1008</span>
<span class="normal">1009</span>
<span class="normal">1010</span>
<span class="normal">1011</span>
<span class="normal">1012</span>
<span class="normal">1013</span>
<span class="normal">1014</span>
<span class="normal">1015</span>
<span class="normal">1016</span>
<span class="normal">1017</span>
<span class="normal">1018</span>
<span class="normal">1019</span>
<span class="normal">1020</span>
<span class="normal">1021</span>
<span class="normal">1022</span>
<span class="normal">1023</span>
<span class="normal">1024</span>
<span class="normal">1025</span>
<span class="normal">1026</span>
<span class="normal">1027</span>
<span class="normal">1028</span>
<span class="normal">1029</span>
<span class="normal">1030</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">input_ids</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">attention_mask</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">position_ids</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">past_key_values</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">inputs_embeds</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">labels</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">use_cache</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">output_attentions</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">output_hidden_states</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">return_dict</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="nb">tuple</span><span class="p">,</span> <span class="n">SequenceClassifierOutputWithPast</span><span class="p">]:</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    labels (`torch.LongTensor` of shape `(batch_size,)`, *optional*):</span>
<span class="sd">        Labels for computing the sequence classification/regression loss. Indices should be in `[0, ...,</span>
<span class="sd">        config.num_labels - 1]`. If `config.num_labels == 1` a regression loss is computed (Mean-Square loss), If</span>
<span class="sd">        `config.num_labels &gt; 1` a classification loss is computed (Cross-Entropy).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">return_dict</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">return_dict</span> <span class="k">if</span> <span class="n">return_dict</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">use_return_dict</span>
    <span class="p">)</span>

    <span class="n">transformer_outputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span>
        <span class="n">input_ids</span><span class="p">,</span>
        <span class="n">attention_mask</span><span class="o">=</span><span class="n">attention_mask</span><span class="p">,</span>
        <span class="n">position_ids</span><span class="o">=</span><span class="n">position_ids</span><span class="p">,</span>
        <span class="n">past_key_values</span><span class="o">=</span><span class="n">past_key_values</span><span class="p">,</span>
        <span class="n">inputs_embeds</span><span class="o">=</span><span class="n">inputs_embeds</span><span class="p">,</span>
        <span class="n">use_cache</span><span class="o">=</span><span class="n">use_cache</span><span class="p">,</span>
        <span class="n">output_attentions</span><span class="o">=</span><span class="n">output_attentions</span><span class="p">,</span>
        <span class="n">output_hidden_states</span><span class="o">=</span><span class="n">output_hidden_states</span><span class="p">,</span>
        <span class="n">return_dict</span><span class="o">=</span><span class="n">return_dict</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">hidden_states</span> <span class="o">=</span> <span class="n">transformer_outputs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">logits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">hidden_states</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">input_ids</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">batch_size</span> <span class="o">=</span> <span class="n">input_ids</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">batch_size</span> <span class="o">=</span> <span class="n">inputs_embeds</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">pad_token_id</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">batch_size</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;Cannot handle batch sizes &gt; 1 if no padding token is defined.&quot;</span>
        <span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">pad_token_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">sequence_lengths</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">input_ids</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">sequence_lengths</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">torch</span><span class="o">.</span><span class="n">ne</span><span class="p">(</span><span class="n">input_ids</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">pad_token_id</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">logits</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sequence_lengths</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

    <span class="n">pooled_logits</span> <span class="o">=</span> <span class="n">logits</span><span class="p">[</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">logits</span><span class="o">.</span><span class="n">device</span><span class="p">),</span> <span class="n">sequence_lengths</span>
    <span class="p">]</span>

    <span class="n">loss</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">labels</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="n">labels</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">logits</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">problem_type</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_labels</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">problem_type</span> <span class="o">=</span> <span class="s2">&quot;regression&quot;</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_labels</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="p">(</span>
                <span class="n">labels</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="n">torch</span><span class="o">.</span><span class="n">long</span> <span class="ow">or</span> <span class="n">labels</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="n">torch</span><span class="o">.</span><span class="n">int</span>
            <span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">problem_type</span> <span class="o">=</span> <span class="s2">&quot;single_label_classification&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">problem_type</span> <span class="o">=</span> <span class="s2">&quot;multi_label_classification&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">problem_type</span> <span class="o">==</span> <span class="s2">&quot;regression&quot;</span><span class="p">:</span>
            <span class="n">loss_fct</span> <span class="o">=</span> <span class="n">MSELoss</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_labels</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">loss</span> <span class="o">=</span> <span class="n">loss_fct</span><span class="p">(</span><span class="n">pooled_logits</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(),</span> <span class="n">labels</span><span class="o">.</span><span class="n">squeeze</span><span class="p">())</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">loss</span> <span class="o">=</span> <span class="n">loss_fct</span><span class="p">(</span><span class="n">pooled_logits</span><span class="p">,</span> <span class="n">labels</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">problem_type</span> <span class="o">==</span> <span class="s2">&quot;single_label_classification&quot;</span><span class="p">:</span>
            <span class="n">loss_fct</span> <span class="o">=</span> <span class="n">CrossEntropyLoss</span><span class="p">()</span>
            <span class="n">loss</span> <span class="o">=</span> <span class="n">loss_fct</span><span class="p">(</span>
                <span class="n">pooled_logits</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_labels</span><span class="p">),</span> <span class="n">labels</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">problem_type</span> <span class="o">==</span> <span class="s2">&quot;multi_label_classification&quot;</span><span class="p">:</span>
            <span class="n">loss_fct</span> <span class="o">=</span> <span class="n">BCEWithLogitsLoss</span><span class="p">()</span>
            <span class="n">loss</span> <span class="o">=</span> <span class="n">loss_fct</span><span class="p">(</span><span class="n">pooled_logits</span><span class="p">,</span> <span class="n">labels</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">return_dict</span><span class="p">:</span>
        <span class="n">output</span> <span class="o">=</span> <span class="p">(</span><span class="n">pooled_logits</span><span class="p">,)</span> <span class="o">+</span> <span class="n">transformer_outputs</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="k">return</span> <span class="p">((</span><span class="n">loss</span><span class="p">,)</span> <span class="o">+</span> <span class="n">output</span><span class="p">)</span> <span class="k">if</span> <span class="n">loss</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">output</span>

    <span class="k">return</span> <span class="n">SequenceClassifierOutputWithPast</span><span class="p">(</span>
        <span class="n">loss</span><span class="o">=</span><span class="n">loss</span><span class="p">,</span>
        <span class="n">logits</span><span class="o">=</span><span class="n">pooled_logits</span><span class="p">,</span>
        <span class="n">past_key_values</span><span class="o">=</span><span class="n">transformer_outputs</span><span class="o">.</span><span class="n">past_key_values</span><span class="p">,</span>
        <span class="n">hidden_states</span><span class="o">=</span><span class="n">transformer_outputs</span><span class="o">.</span><span class="n">hidden_states</span><span class="p">,</span>
        <span class="n">attentions</span><span class="o">=</span><span class="n">transformer_outputs</span><span class="o">.</span><span class="n">attentions</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>


<div class="doc doc-object doc-function">


<h6 id="swebench.inference.llamao.modeling_flash_llama.rmsnorm_func" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>            <span class="doc doc-object-name doc-function-name">rmsnorm_func</span>


</h6>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">rmsnorm_func</span><span class="p">(</span><span class="n">hidden_states</span><span class="p">,</span> <span class="n">weight</span><span class="p">,</span> <span class="n">variance_epsilon</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">


            <details class="quote">
              <summary>Source code in <code>swebench/inference/llamao/modeling_flash_llama.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">rmsnorm_func</span><span class="p">(</span><span class="n">hidden_states</span><span class="p">,</span> <span class="n">weight</span><span class="p">,</span> <span class="n">variance_epsilon</span><span class="p">):</span>
    <span class="n">input_dtype</span> <span class="o">=</span> <span class="n">hidden_states</span><span class="o">.</span><span class="n">dtype</span>
    <span class="n">hidden_states</span> <span class="o">=</span> <span class="n">hidden_states</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">variance</span> <span class="o">=</span> <span class="n">hidden_states</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">hidden_states</span> <span class="o">=</span> <span class="n">hidden_states</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">rsqrt</span><span class="p">(</span><span class="n">variance</span> <span class="o">+</span> <span class="n">variance_epsilon</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">weight</span> <span class="o">*</span> <span class="n">hidden_states</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">input_dtype</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h6 id="swebench.inference.llamao.modeling_flash_llama.repeat_kv" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>            <span class="doc doc-object-name doc-function-name">repeat_kv</span>


</h6>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">repeat_kv</span><span class="p">(</span><span class="n">hidden_states</span><span class="p">:</span> <span class="n"><span title="torch.Tensor">Tensor</span></span><span class="p">,</span> <span class="n">n_rep</span><span class="p">:</span> <span class="n"><span title="int">int</span></span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><span title="torch.Tensor">Tensor</span></span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>This is the equivalent of torch.repeat_interleave(x, dim=1, repeats=n_rep). The hidden states go from (batch,
num_key_value_heads, seqlen, head_dim) to (batch, num_attention_heads, seqlen, head_dim)</p>


            <details class="quote">
              <summary>Source code in <code>swebench/inference/llamao/modeling_flash_llama.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@torch</span><span class="o">.</span><span class="n">jit</span><span class="o">.</span><span class="n">script</span>
<span class="k">def</span><span class="w"> </span><span class="nf">repeat_kv</span><span class="p">(</span><span class="n">hidden_states</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">n_rep</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This is the equivalent of torch.repeat_interleave(x, dim=1, repeats=n_rep). The hidden states go from (batch,</span>
<span class="sd">    num_key_value_heads, seqlen, head_dim) to (batch, num_attention_heads, seqlen, head_dim)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">n_rep</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">hidden_states</span>
    <span class="n">final_shape</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">hidden_states</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span> <span class="o">+</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">hidden_states</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
    <span class="n">expand_shape</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">hidden_states</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="n">n_rep</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">hidden_states</span> <span class="o">=</span> <span class="n">hidden_states</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="n">expand_shape</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">hidden_states</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">final_shape</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>


  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h4 id="swebench.inference.make_datasets" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <span class="doc doc-object-name doc-module-name">make_datasets</span>


</h4>

    <div class="doc doc-contents ">









  <div class="doc doc-children">










<div class="doc doc-object doc-module">



<h5 id="swebench.inference.make_datasets.bm25_retrieval" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <span class="doc doc-object-name doc-module-name">bm25_retrieval</span>


</h5>

    <div class="doc doc-contents ">









  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h6 id="swebench.inference.make_datasets.bm25_retrieval.logger" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <span class="doc doc-object-name doc-attribute-name">logger</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-module-attribute"><code>module-attribute</code></small>
  </span>

</h6>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">logger</span> <span class="o">=</span> <span class="n"><span title="logging.getLogger">getLogger</span></span><span class="p">(</span><span class="n"><span title="__name__">__name__</span></span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h6 id="swebench.inference.make_datasets.bm25_retrieval.DOCUMENT_ENCODING_FUNCTIONS" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <span class="doc doc-object-name doc-attribute-name">DOCUMENT_ENCODING_FUNCTIONS</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-module-attribute"><code>module-attribute</code></small>
  </span>

</h6>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">DOCUMENT_ENCODING_FUNCTIONS</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;file_name_and_contents&#39;</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-internal" title="            file_name_and_contents (swebench.inference.make_datasets.bm25_retrieval.file_name_and_contents)" href="#swebench.inference.make_datasets.bm25_retrieval.file_name_and_contents">file_name_and_contents</a></span><span class="p">,</span> <span class="s1">&#39;file_name_and_documentation&#39;</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-internal" title="            file_name_and_documentation (swebench.inference.make_datasets.bm25_retrieval.file_name_and_documentation)" href="#swebench.inference.make_datasets.bm25_retrieval.file_name_and_documentation">file_name_and_documentation</a></span><span class="p">,</span> <span class="s1">&#39;file_name_and_docs_jedi&#39;</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-internal" title="            file_name_and_docs_jedi (swebench.inference.make_datasets.bm25_retrieval.file_name_and_docs_jedi)" href="#swebench.inference.make_datasets.bm25_retrieval.file_name_and_docs_jedi">file_name_and_docs_jedi</a></span><span class="p">}</span>
</code></pre></div>

    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h6 id="swebench.inference.make_datasets.bm25_retrieval.parser" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <span class="doc doc-object-name doc-attribute-name">parser</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-module-attribute"><code>module-attribute</code></small>
  </span>

</h6>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">parser</span> <span class="o">=</span> <span class="n"><span title="argparse.ArgumentParser">ArgumentParser</span></span><span class="p">()</span>
</code></pre></div>

    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h6 id="swebench.inference.make_datasets.bm25_retrieval.args" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <span class="doc doc-object-name doc-attribute-name">args</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-module-attribute"><code>module-attribute</code></small>
  </span>

</h6>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">args</span> <span class="o">=</span> <span class="n"><span title="swebench.inference.make_datasets.bm25_retrieval.parser.parse_args">parse_args</span></span><span class="p">()</span>
</code></pre></div>

    <div class="doc doc-contents ">

    </div>

</div>


<div class="doc doc-object doc-class">



<h6 id="swebench.inference.make_datasets.bm25_retrieval.ContextManager" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>            <span class="doc doc-object-name doc-class-name">ContextManager</span>


</h6>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">ContextManager</span><span class="p">(</span><span class="n">repo_path</span><span class="p">,</span> <span class="n">base_commit</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">


        <p>A context manager for managing a Git repository at a specific commit.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>repo_path</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The path to the Git repository.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>base_commit</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The commit hash to switch to.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>verbose</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to print verbose output. Defaults to False.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="            repo_path


  
      instance-attribute
   (swebench.inference.make_datasets.bm25_retrieval.ContextManager.repo_path)" href="#swebench.inference.make_datasets.bm25_retrieval.ContextManager.repo_path">repo_path</a></code></td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The path to the Git repository.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="            base_commit


  
      instance-attribute
   (swebench.inference.make_datasets.bm25_retrieval.ContextManager.base_commit)" href="#swebench.inference.make_datasets.bm25_retrieval.ContextManager.base_commit">base_commit</a></code></td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The commit hash to switch to.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="            verbose


  
      instance-attribute
   (swebench.inference.make_datasets.bm25_retrieval.ContextManager.verbose)" href="#swebench.inference.make_datasets.bm25_retrieval.ContextManager.verbose">verbose</a></code></td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to print verbose output.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="            repo


  
      instance-attribute
   (swebench.inference.make_datasets.bm25_retrieval.ContextManager.repo)" href="#swebench.inference.make_datasets.bm25_retrieval.ContextManager.repo">repo</a></code></td>
            <td>
                  <code><span title="git.Repo">Repo</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The Git repository object.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Methods:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
            <tr class="doc-section-item">
              <td><code><a class="autorefs autorefs-internal" title="            __enter__ (swebench.inference.make_datasets.bm25_retrieval.ContextManager.__enter__)" href="#swebench.inference.make_datasets.bm25_retrieval.ContextManager.__enter__">__enter__</a></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Switches to the specified commit and returns the context manager object.</p>
                </div>
              </td>
            </tr>
            <tr class="doc-section-item">
              <td><code><a class="autorefs autorefs-internal" title="            get_readme_files (swebench.inference.make_datasets.bm25_retrieval.ContextManager.get_readme_files)" href="#swebench.inference.make_datasets.bm25_retrieval.ContextManager.get_readme_files">get_readme_files</a></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Returns a list of filenames for all README files in the repository.</p>
                </div>
              </td>
            </tr>
            <tr class="doc-section-item">
              <td><code><a class="autorefs autorefs-internal" title="            __exit__ (swebench.inference.make_datasets.bm25_retrieval.ContextManager.__exit__)" href="#swebench.inference.make_datasets.bm25_retrieval.ContextManager.__exit__">__exit__</a></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Does nothing.</p>
                </div>
              </td>
            </tr>
      </tbody>
    </table>







                  <details class="quote">
                    <summary>Source code in <code>swebench/inference/make_datasets/bm25_retrieval.py</code></summary>
                    <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">repo_path</span><span class="p">,</span> <span class="n">base_commit</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">repo_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">repo_path</span><span class="p">)</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span><span class="o">.</span><span class="n">as_posix</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">base_commit</span> <span class="o">=</span> <span class="n">base_commit</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">repo</span> <span class="o">=</span> <span class="n">Repo</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">repo_path</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
                  </details>



  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h7 id="swebench.inference.make_datasets.bm25_retrieval.ContextManager.repo_path" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <span class="doc doc-object-name doc-attribute-name">repo_path</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h7>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">repo_path</span> <span class="o">=</span> <span class="n"><span title="as_posix">as_posix</span></span><span class="p">()</span>
</code></pre></div>

    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h7 id="swebench.inference.make_datasets.bm25_retrieval.ContextManager.base_commit" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <span class="doc doc-object-name doc-attribute-name">base_commit</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h7>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">base_commit</span> <span class="o">=</span> <span class="n"><span title="swebench.inference.make_datasets.bm25_retrieval.ContextManager(base_commit)">base_commit</span></span>
</code></pre></div>

    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h7 id="swebench.inference.make_datasets.bm25_retrieval.ContextManager.verbose" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <span class="doc doc-object-name doc-attribute-name">verbose</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h7>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">verbose</span> <span class="o">=</span> <span class="n"><span title="swebench.inference.make_datasets.bm25_retrieval.ContextManager(verbose)">verbose</span></span>
</code></pre></div>

    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h7 id="swebench.inference.make_datasets.bm25_retrieval.ContextManager.repo" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <span class="doc doc-object-name doc-attribute-name">repo</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h7>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">repo</span> <span class="o">=</span> <span class="n"><span title="git.Repo">Repo</span></span><span class="p">(</span><span class="n"><span title="swebench.inference.make_datasets.bm25_retrieval.ContextManager(self).repo_path">repo_path</span></span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

    </div>

</div>



<div class="doc doc-object doc-function">


<h7 id="swebench.inference.make_datasets.bm25_retrieval.ContextManager.__enter__" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <span class="doc doc-object-name doc-function-name">__enter__</span>


</h7>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">__enter__</span><span class="p">()</span>
</code></pre></div>

    <div class="doc doc-contents ">


            <details class="quote">
              <summary>Source code in <code>swebench/inference/make_datasets/bm25_retrieval.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Switching to </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">base_commit</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">repo</span><span class="o">.</span><span class="n">git</span><span class="o">.</span><span class="n">reset</span><span class="p">(</span><span class="s2">&quot;--hard&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_commit</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">repo</span><span class="o">.</span><span class="n">git</span><span class="o">.</span><span class="n">clean</span><span class="p">(</span><span class="s2">&quot;-fdxq&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to switch to </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">base_commit</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">e</span>
    <span class="k">return</span> <span class="bp">self</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h7 id="swebench.inference.make_datasets.bm25_retrieval.ContextManager.get_readme_files" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <span class="doc doc-object-name doc-function-name">get_readme_files</span>


</h7>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">get_readme_files</span><span class="p">()</span>
</code></pre></div>

    <div class="doc doc-contents ">


            <details class="quote">
              <summary>Source code in <code>swebench/inference/make_datasets/bm25_retrieval.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_readme_files</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">files</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">repo_path</span><span class="p">)</span>
    <span class="n">files</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">files</span><span class="p">))</span>
    <span class="n">files</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;readme&quot;</span><span class="p">),</span> <span class="n">files</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">files</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h7 id="swebench.inference.make_datasets.bm25_retrieval.ContextManager.__exit__" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <span class="doc doc-object-name doc-function-name">__exit__</span>


</h7>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">__exit__</span><span class="p">(</span><span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_val</span><span class="p">,</span> <span class="n">exc_tb</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">


            <details class="quote">
              <summary>Source code in <code>swebench/inference/make_datasets/bm25_retrieval.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">70</span>
<span class="normal">71</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_val</span><span class="p">,</span> <span class="n">exc_tb</span><span class="p">):</span>
    <span class="k">pass</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>


<div class="doc doc-object doc-function">


<h6 id="swebench.inference.make_datasets.bm25_retrieval.file_name_and_contents" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>            <span class="doc doc-object-name doc-function-name">file_name_and_contents</span>


</h6>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">file_name_and_contents</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">relative_path</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">


            <details class="quote">
              <summary>Source code in <code>swebench/inference/make_datasets/bm25_retrieval.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">file_name_and_contents</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">relative_path</span><span class="p">):</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">relative_path</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">text</span> <span class="o">+=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">text</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h6 id="swebench.inference.make_datasets.bm25_retrieval.file_name_and_documentation" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>            <span class="doc doc-object-name doc-function-name">file_name_and_documentation</span>


</h6>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">file_name_and_documentation</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">relative_path</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">


            <details class="quote">
              <summary>Source code in <code>swebench/inference/make_datasets/bm25_retrieval.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">file_name_and_documentation</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">relative_path</span><span class="p">):</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">relative_path</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">node</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">get_docstring</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">data</span><span class="p">:</span>
            <span class="n">text</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">data</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">for</span> <span class="n">child_node</span> <span class="ow">in</span> <span class="n">ast</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">node</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span>
                <span class="n">child_node</span><span class="p">,</span> <span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">FunctionDef</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">AsyncFunctionDef</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">ClassDef</span><span class="p">)</span>
            <span class="p">):</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">get_docstring</span><span class="p">(</span><span class="n">child_node</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">data</span><span class="p">:</span>
                    <span class="n">text</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="si">{</span><span class="n">child_node</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="se">\n</span><span class="si">{</span><span class="n">data</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to parse file </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span><span class="si">}</span><span class="s2">. Using simple filecontent.&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">text</span> <span class="o">+=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">text</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h6 id="swebench.inference.make_datasets.bm25_retrieval.file_name_and_docs_jedi" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>            <span class="doc doc-object-name doc-function-name">file_name_and_docs_jedi</span>


</h6>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">file_name_and_docs_jedi</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">relative_path</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">


            <details class="quote">
              <summary>Source code in <code>swebench/inference/make_datasets/bm25_retrieval.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">file_name_and_docs_jedi</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">relative_path</span><span class="p">):</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">relative_path</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">source_code</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">script</span> <span class="o">=</span> <span class="n">jedi</span><span class="o">.</span><span class="n">Script</span><span class="p">(</span><span class="n">source_code</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">filename</span><span class="p">)</span>
        <span class="n">module</span> <span class="o">=</span> <span class="n">script</span><span class="o">.</span><span class="n">get_context</span><span class="p">()</span>
        <span class="n">docstring</span> <span class="o">=</span> <span class="n">module</span><span class="o">.</span><span class="n">docstring</span><span class="p">()</span>
        <span class="n">text</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">module</span><span class="o">.</span><span class="n">full_name</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="n">docstring</span><span class="p">:</span>
            <span class="n">text</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">docstring</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span>
        <span class="n">abspath</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span><span class="o">.</span><span class="n">absolute</span><span class="p">()</span>
        <span class="n">names</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">name</span>
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">script</span><span class="o">.</span><span class="n">get_names</span><span class="p">(</span>
                <span class="n">all_scopes</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">definitions</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">references</span><span class="o">=</span><span class="kc">False</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span><span class="o">.</span><span class="n">in_builtin_module</span><span class="p">()</span>
        <span class="p">]</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">origin</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">goto</span><span class="p">(</span><span class="n">follow_imports</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">origin</span><span class="o">.</span><span class="n">module_name</span> <span class="o">!=</span> <span class="n">module</span><span class="o">.</span><span class="n">full_name</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="n">name</span><span class="o">.</span><span class="n">parent</span><span class="p">()</span><span class="o">.</span><span class="n">full_name</span> <span class="o">!=</span> <span class="n">module</span><span class="o">.</span><span class="n">full_name</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">name</span><span class="o">.</span><span class="n">type</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;statement&quot;</span><span class="p">,</span> <span class="s2">&quot;param&quot;</span><span class="p">}:</span>
                        <span class="k">continue</span>
                <span class="n">full_name</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">full_name</span>
                <span class="n">text</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">full_name</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="n">docstring</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">docstring</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">docstring</span><span class="p">:</span>
                    <span class="n">text</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">docstring</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">continue</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to parse file </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span><span class="si">}</span><span class="s2">. Using simple filecontent.&quot;</span><span class="p">)</span>
        <span class="n">text</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">relative_path</span><span class="si">}</span><span class="se">\n</span><span class="si">{</span><span class="n">source_code</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">return</span> <span class="n">text</span>
    <span class="k">return</span> <span class="n">text</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h6 id="swebench.inference.make_datasets.bm25_retrieval.clone_repo" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>            <span class="doc doc-object-name doc-function-name">clone_repo</span>


</h6>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">clone_repo</span><span class="p">(</span><span class="n">repo</span><span class="p">,</span> <span class="n">root_dir</span><span class="p">,</span> <span class="n">token</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Clones a GitHub repository to a specified directory.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>repo</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The GitHub repository to clone.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>root_dir</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The root directory to clone the repository to.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>token</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The GitHub personal access token to use for authentication.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>Path</code></td>            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The path to the cloned repository directory.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>swebench/inference/make_datasets/bm25_retrieval.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">clone_repo</span><span class="p">(</span><span class="n">repo</span><span class="p">,</span> <span class="n">root_dir</span><span class="p">,</span> <span class="n">token</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Clones a GitHub repository to a specified directory.</span>

<span class="sd">    Args:</span>
<span class="sd">        repo (str): The GitHub repository to clone.</span>
<span class="sd">        root_dir (str): The root directory to clone the repository to.</span>
<span class="sd">        token (str): The GitHub personal access token to use for authentication.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Path: The path to the cloned repository directory.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">repo_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">root_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;repo__</span><span class="si">{</span><span class="n">repo</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;__&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">repo_dir</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
        <span class="n">repo_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;https://</span><span class="si">{</span><span class="n">token</span><span class="si">}</span><span class="s2">@github.com/</span><span class="si">{</span><span class="n">repo</span><span class="si">}</span><span class="s2">.git&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cloning </span><span class="si">{</span><span class="n">repo</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">Repo</span><span class="o">.</span><span class="n">clone_from</span><span class="p">(</span><span class="n">repo_url</span><span class="p">,</span> <span class="n">repo_dir</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">repo_dir</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h6 id="swebench.inference.make_datasets.bm25_retrieval.build_documents" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>            <span class="doc doc-object-name doc-function-name">build_documents</span>


</h6>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">build_documents</span><span class="p">(</span><span class="n">repo_dir</span><span class="p">,</span> <span class="n">commit</span><span class="p">,</span> <span class="n">document_encoding_func</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Builds a dictionary of documents from a given repository directory and commit.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>repo_dir</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The path to the repository directory.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>commit</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The commit hash to use.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>document_encoding_func</code>
            </td>
            <td>
                  <code><span title="function">function</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A function that takes a filename and a relative path and returns the encoded document text.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>dict</code></td>            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A dictionary where the keys are the relative paths of the documents and the values are the encoded document text.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>swebench/inference/make_datasets/bm25_retrieval.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">build_documents</span><span class="p">(</span><span class="n">repo_dir</span><span class="p">,</span> <span class="n">commit</span><span class="p">,</span> <span class="n">document_encoding_func</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Builds a dictionary of documents from a given repository directory and commit.</span>

<span class="sd">    Args:</span>
<span class="sd">        repo_dir (str): The path to the repository directory.</span>
<span class="sd">        commit (str): The commit hash to use.</span>
<span class="sd">        document_encoding_func (function): A function that takes a filename and a relative path and returns the encoded document text.</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: A dictionary where the keys are the relative paths of the documents and the values are the encoded document text.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">documents</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="k">with</span> <span class="n">ContextManager</span><span class="p">(</span><span class="n">repo_dir</span><span class="p">,</span> <span class="n">commit</span><span class="p">):</span>
        <span class="n">filenames</span> <span class="o">=</span> <span class="n">list_files</span><span class="p">(</span><span class="n">repo_dir</span><span class="p">,</span> <span class="n">include_tests</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">relative_path</span> <span class="ow">in</span> <span class="n">filenames</span><span class="p">:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">repo_dir</span><span class="p">,</span> <span class="n">relative_path</span><span class="p">)</span>
            <span class="n">text</span> <span class="o">=</span> <span class="n">document_encoding_func</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">relative_path</span><span class="p">)</span>
            <span class="n">documents</span><span class="p">[</span><span class="n">relative_path</span><span class="p">]</span> <span class="o">=</span> <span class="n">text</span>
    <span class="k">return</span> <span class="n">documents</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h6 id="swebench.inference.make_datasets.bm25_retrieval.make_index" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>            <span class="doc doc-object-name doc-function-name">make_index</span>


</h6>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">make_index</span><span class="p">(</span><span class="n">repo_dir</span><span class="p">,</span> <span class="n">root_dir</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">commit</span><span class="p">,</span> <span class="n">document_encoding_func</span><span class="p">,</span> <span class="n">python</span><span class="p">,</span> <span class="n">instance_id</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Builds an index for a given set of documents using Pyserini.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>repo_dir</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The path to the repository directory.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>root_dir</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The path to the root directory.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>query</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The query to use for retrieval.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>commit</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The commit hash to use for retrieval.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>document_encoding_func</code>
            </td>
            <td>
                  <code><span title="function">function</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The function to use for encoding documents.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>python</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The path to the Python executable.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>instance_id</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The ID of the current instance.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>index_path</code></td>            <td>
                  <code><span title="pathlib.Path">Path</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The path to the built index.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>swebench/inference/make_datasets/bm25_retrieval.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">make_index</span><span class="p">(</span>
    <span class="n">repo_dir</span><span class="p">,</span>
    <span class="n">root_dir</span><span class="p">,</span>
    <span class="n">query</span><span class="p">,</span>
    <span class="n">commit</span><span class="p">,</span>
    <span class="n">document_encoding_func</span><span class="p">,</span>
    <span class="n">python</span><span class="p">,</span>
    <span class="n">instance_id</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Builds an index for a given set of documents using Pyserini.</span>

<span class="sd">    Args:</span>
<span class="sd">        repo_dir (str): The path to the repository directory.</span>
<span class="sd">        root_dir (str): The path to the root directory.</span>
<span class="sd">        query (str): The query to use for retrieval.</span>
<span class="sd">        commit (str): The commit hash to use for retrieval.</span>
<span class="sd">        document_encoding_func (function): The function to use for encoding documents.</span>
<span class="sd">        python (str): The path to the Python executable.</span>
<span class="sd">        instance_id (int): The ID of the current instance.</span>

<span class="sd">    Returns:</span>
<span class="sd">        index_path (Path): The path to the built index.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">index_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">root_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;index__</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">instance_id</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;index&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">index_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
        <span class="k">return</span> <span class="n">index_path</span>
    <span class="n">thread_prefix</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;(pid </span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">()</span><span class="si">}</span><span class="s2">) &quot;</span>
    <span class="n">documents_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">root_dir</span><span class="p">,</span> <span class="n">instance_id</span><span class="p">,</span> <span class="s2">&quot;documents.jsonl&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">documents_path</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
        <span class="n">documents_path</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">documents</span> <span class="o">=</span> <span class="n">build_documents</span><span class="p">(</span><span class="n">repo_dir</span><span class="p">,</span> <span class="n">commit</span><span class="p">,</span> <span class="n">document_encoding_func</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">documents_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">docfile</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">relative_path</span><span class="p">,</span> <span class="n">contents</span> <span class="ow">in</span> <span class="n">documents</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">relative_path</span><span class="p">,</span> <span class="s2">&quot;contents&quot;</span><span class="p">:</span> <span class="n">contents</span><span class="p">}),</span>
                <span class="n">file</span><span class="o">=</span><span class="n">docfile</span><span class="p">,</span>
                <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>
    <span class="n">cmd</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">python</span><span class="p">,</span>
        <span class="s2">&quot;-m&quot;</span><span class="p">,</span>
        <span class="s2">&quot;pyserini.index&quot;</span><span class="p">,</span>
        <span class="s2">&quot;--collection&quot;</span><span class="p">,</span>
        <span class="s2">&quot;JsonCollection&quot;</span><span class="p">,</span>
        <span class="s2">&quot;--generator&quot;</span><span class="p">,</span>
        <span class="s2">&quot;DefaultLuceneDocumentGenerator&quot;</span><span class="p">,</span>
        <span class="s2">&quot;--threads&quot;</span><span class="p">,</span>
        <span class="s2">&quot;2&quot;</span><span class="p">,</span>
        <span class="s2">&quot;--input&quot;</span><span class="p">,</span>
        <span class="n">documents_path</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">as_posix</span><span class="p">(),</span>
        <span class="s2">&quot;--index&quot;</span><span class="p">,</span>
        <span class="n">index_path</span><span class="o">.</span><span class="n">as_posix</span><span class="p">(),</span>
        <span class="s2">&quot;--storePositions&quot;</span><span class="p">,</span>
        <span class="s2">&quot;--storeDocvectors&quot;</span><span class="p">,</span>
        <span class="s2">&quot;--storeRaw&quot;</span><span class="p">,</span>
    <span class="p">]</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">proc</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span>
            <span class="n">cmd</span><span class="p">,</span>
            <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
            <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
            <span class="n">universal_newlines</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">output</span><span class="p">,</span> <span class="n">error</span> <span class="o">=</span> <span class="n">proc</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
        <span class="n">proc</span><span class="o">.</span><span class="n">kill</span><span class="p">()</span>
        <span class="k">raise</span> <span class="ne">KeyboardInterrupt</span>
    <span class="k">if</span> <span class="n">proc</span><span class="o">.</span><span class="n">returncode</span> <span class="o">==</span> <span class="mi">130</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">thread_prefix</span> <span class="o">+</span> <span class="s2">&quot;Process killed by user&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">KeyboardInterrupt</span>
    <span class="k">if</span> <span class="n">proc</span><span class="o">.</span><span class="n">returncode</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;return code: </span><span class="si">{</span><span class="n">proc</span><span class="o">.</span><span class="n">returncode</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
            <span class="n">thread_prefix</span>
            <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;Failed to build index for </span><span class="si">{</span><span class="n">instance_id</span><span class="si">}</span><span class="s2"> with error </span><span class="si">{</span><span class="n">error</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="n">index_path</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h6 id="swebench.inference.make_datasets.bm25_retrieval.get_remaining_instances" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>            <span class="doc doc-object-name doc-function-name">get_remaining_instances</span>


</h6>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">get_remaining_instances</span><span class="p">(</span><span class="n">instances</span><span class="p">,</span> <span class="n">output_file</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Filters a list of instances to exclude those that have already been processed and saved in a file.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>instances</code>
            </td>
            <td>
                  <code><span title="List">List</span>[<span title="Dict">Dict</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A list of instances, where each instance is a dictionary with an "instance_id" key.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>output_file</code>
            </td>
            <td>
                  <code><span title="pathlib.Path">Path</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The path to the file where the processed instances are saved.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List[Dict]: A list of instances that have not been processed yet.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>swebench/inference/make_datasets/bm25_retrieval.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_remaining_instances</span><span class="p">(</span><span class="n">instances</span><span class="p">,</span> <span class="n">output_file</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Filters a list of instances to exclude those that have already been processed and saved in a file.</span>

<span class="sd">    Args:</span>
<span class="sd">        instances (List[Dict]): A list of instances, where each instance is a dictionary with an &quot;instance_id&quot; key.</span>
<span class="sd">        output_file (Path): The path to the file where the processed instances are saved.</span>

<span class="sd">    Returns:</span>
<span class="sd">        List[Dict]: A list of instances that have not been processed yet.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">instance_ids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="n">remaining_instances</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">output_file</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
        <span class="k">with</span> <span class="n">FileLock</span><span class="p">(</span><span class="n">output_file</span><span class="o">.</span><span class="n">as_posix</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;.lock&quot;</span><span class="p">):</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">output_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">instance</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                    <span class="n">instance_id</span> <span class="o">=</span> <span class="n">instance</span><span class="p">[</span><span class="s2">&quot;instance_id&quot;</span><span class="p">]</span>
                    <span class="n">instance_ids</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">instance_id</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">instance_ids</span><span class="p">)</span><span class="si">}</span><span class="s2"> existing instances in </span><span class="si">{</span><span class="n">output_file</span><span class="si">}</span><span class="s2">. Will skip them.&quot;</span>
            <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">output_file</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">instances</span>
    <span class="k">for</span> <span class="n">instance</span> <span class="ow">in</span> <span class="n">instances</span><span class="p">:</span>
        <span class="n">instance_id</span> <span class="o">=</span> <span class="n">instance</span><span class="p">[</span><span class="s2">&quot;instance_id&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">instance_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">instance_ids</span><span class="p">:</span>
            <span class="n">remaining_instances</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">remaining_instances</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h6 id="swebench.inference.make_datasets.bm25_retrieval.search" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>            <span class="doc doc-object-name doc-function-name">search</span>


</h6>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">search</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">index_path</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Searches for relevant documents in the given index for the given instance.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>instance</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The instance to search for.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>index_path</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The path to the index to search in.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>dict</code></td>            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A dictionary containing the instance ID and a list of hits, where each hit is a dictionary containing the</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
<td></td>            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>document ID and its score.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>swebench/inference/make_datasets/bm25_retrieval.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">search</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">index_path</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Searches for relevant documents in the given index for the given instance.</span>

<span class="sd">    Args:</span>
<span class="sd">        instance (dict): The instance to search for.</span>
<span class="sd">        index_path (str): The path to the index to search in.</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: A dictionary containing the instance ID and a list of hits, where each hit is a dictionary containing the</span>
<span class="sd">        document ID and its score.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">instance_id</span> <span class="o">=</span> <span class="n">instance</span><span class="p">[</span><span class="s2">&quot;instance_id&quot;</span><span class="p">]</span>
        <span class="n">searcher</span> <span class="o">=</span> <span class="n">LuceneSearcher</span><span class="p">(</span><span class="n">index_path</span><span class="o">.</span><span class="n">as_posix</span><span class="p">())</span>
        <span class="n">cutoff</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">instance</span><span class="p">[</span><span class="s2">&quot;problem_statement&quot;</span><span class="p">])</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">hits</span> <span class="o">=</span> <span class="n">searcher</span><span class="o">.</span><span class="n">search</span><span class="p">(</span>
                    <span class="n">instance</span><span class="p">[</span><span class="s2">&quot;problem_statement&quot;</span><span class="p">][:</span><span class="n">cutoff</span><span class="p">],</span>
                    <span class="n">k</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
                    <span class="n">remove_dups</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">if</span> <span class="s2">&quot;maxClauseCount&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">):</span>
                    <span class="n">cutoff</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">cutoff</span> <span class="o">*</span> <span class="mf">0.8</span><span class="p">))</span>
                    <span class="k">continue</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">e</span>
            <span class="k">break</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;instance_id&quot;</span><span class="p">:</span> <span class="n">instance_id</span><span class="p">,</span> <span class="s2">&quot;hits&quot;</span><span class="p">:</span> <span class="p">[]}</span>
        <span class="k">for</span> <span class="n">hit</span> <span class="ow">in</span> <span class="n">hits</span><span class="p">:</span>
            <span class="n">results</span><span class="p">[</span><span class="s2">&quot;hits&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;docid&quot;</span><span class="p">:</span> <span class="n">hit</span><span class="o">.</span><span class="n">docid</span><span class="p">,</span> <span class="s2">&quot;score&quot;</span><span class="p">:</span> <span class="n">hit</span><span class="o">.</span><span class="n">score</span><span class="p">})</span>
        <span class="k">return</span> <span class="n">results</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to process </span><span class="si">{</span><span class="n">instance_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
        <span class="k">return</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h6 id="swebench.inference.make_datasets.bm25_retrieval.search_indexes" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>            <span class="doc doc-object-name doc-function-name">search_indexes</span>


</h6>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">search_indexes</span><span class="p">(</span><span class="n">remaining_instance</span><span class="p">,</span> <span class="n">output_file</span><span class="p">,</span> <span class="n">all_index_paths</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Searches the indexes for the given instances and writes the results to the output file.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>remaining_instance</code>
            </td>
            <td>
                  <code><span title="list">list</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A list of instances to search for.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>output_file</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The path to the output file to write the results to.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>all_index_paths</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A dictionary mapping instance IDs to the paths of their indexes.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>swebench/inference/make_datasets/bm25_retrieval.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">search_indexes</span><span class="p">(</span><span class="n">remaining_instance</span><span class="p">,</span> <span class="n">output_file</span><span class="p">,</span> <span class="n">all_index_paths</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Searches the indexes for the given instances and writes the results to the output file.</span>

<span class="sd">    Args:</span>
<span class="sd">        remaining_instance (list): A list of instances to search for.</span>
<span class="sd">        output_file (str): The path to the output file to write the results to.</span>
<span class="sd">        all_index_paths (dict): A dictionary mapping instance IDs to the paths of their indexes.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">instance</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">remaining_instance</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Retrieving&quot;</span><span class="p">):</span>
        <span class="n">instance_id</span> <span class="o">=</span> <span class="n">instance</span><span class="p">[</span><span class="s2">&quot;instance_id&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">instance_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">all_index_paths</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">index_path</span> <span class="o">=</span> <span class="n">all_index_paths</span><span class="p">[</span><span class="n">instance_id</span><span class="p">]</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">search</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">index_path</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">results</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">with</span> <span class="n">FileLock</span><span class="p">(</span><span class="n">output_file</span><span class="o">.</span><span class="n">as_posix</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;.lock&quot;</span><span class="p">):</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">out_file</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">results</span><span class="p">),</span> <span class="n">file</span><span class="o">=</span><span class="n">out_file</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h6 id="swebench.inference.make_datasets.bm25_retrieval.get_missing_ids" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>            <span class="doc doc-object-name doc-function-name">get_missing_ids</span>


</h6>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">get_missing_ids</span><span class="p">(</span><span class="n">instances</span><span class="p">,</span> <span class="n">output_file</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">


            <details class="quote">
              <summary>Source code in <code>swebench/inference/make_datasets/bm25_retrieval.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_missing_ids</span><span class="p">(</span><span class="n">instances</span><span class="p">,</span> <span class="n">output_file</span><span class="p">):</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">output_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">written_ids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">instance</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="n">instance_id</span> <span class="o">=</span> <span class="n">instance</span><span class="p">[</span><span class="s2">&quot;instance_id&quot;</span><span class="p">]</span>
            <span class="n">written_ids</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">instance_id</span><span class="p">)</span>
    <span class="n">missing_ids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">instance</span> <span class="ow">in</span> <span class="n">instances</span><span class="p">:</span>
        <span class="n">instance_id</span> <span class="o">=</span> <span class="n">instance</span><span class="p">[</span><span class="s2">&quot;instance_id&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">instance_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">written_ids</span><span class="p">:</span>
            <span class="n">missing_ids</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">instance_id</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">missing_ids</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h6 id="swebench.inference.make_datasets.bm25_retrieval.get_index_paths_worker" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>            <span class="doc doc-object-name doc-function-name">get_index_paths_worker</span>


</h6>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">get_index_paths_worker</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">root_dir_name</span><span class="p">,</span> <span class="n">document_encoding_func</span><span class="p">,</span> <span class="n">python</span><span class="p">,</span> <span class="n">token</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">


            <details class="quote">
              <summary>Source code in <code>swebench/inference/make_datasets/bm25_retrieval.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_index_paths_worker</span><span class="p">(</span>
    <span class="n">instance</span><span class="p">,</span>
    <span class="n">root_dir_name</span><span class="p">,</span>
    <span class="n">document_encoding_func</span><span class="p">,</span>
    <span class="n">python</span><span class="p">,</span>
    <span class="n">token</span><span class="p">,</span>
<span class="p">):</span>
    <span class="n">index_path</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">repo</span> <span class="o">=</span> <span class="n">instance</span><span class="p">[</span><span class="s2">&quot;repo&quot;</span><span class="p">]</span>
    <span class="n">commit</span> <span class="o">=</span> <span class="n">instance</span><span class="p">[</span><span class="s2">&quot;base_commit&quot;</span><span class="p">]</span>
    <span class="n">instance_id</span> <span class="o">=</span> <span class="n">instance</span><span class="p">[</span><span class="s2">&quot;instance_id&quot;</span><span class="p">]</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">repo_dir</span> <span class="o">=</span> <span class="n">clone_repo</span><span class="p">(</span><span class="n">repo</span><span class="p">,</span> <span class="n">root_dir_name</span><span class="p">,</span> <span class="n">token</span><span class="p">)</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">instance</span><span class="p">[</span><span class="s2">&quot;problem_statement&quot;</span><span class="p">]</span>
        <span class="n">index_path</span> <span class="o">=</span> <span class="n">make_index</span><span class="p">(</span>
            <span class="n">repo_dir</span><span class="o">=</span><span class="n">repo_dir</span><span class="p">,</span>
            <span class="n">root_dir</span><span class="o">=</span><span class="n">root_dir_name</span><span class="p">,</span>
            <span class="n">query</span><span class="o">=</span><span class="n">query</span><span class="p">,</span>
            <span class="n">commit</span><span class="o">=</span><span class="n">commit</span><span class="p">,</span>
            <span class="n">document_encoding_func</span><span class="o">=</span><span class="n">document_encoding_func</span><span class="p">,</span>
            <span class="n">python</span><span class="o">=</span><span class="n">python</span><span class="p">,</span>
            <span class="n">instance_id</span><span class="o">=</span><span class="n">instance_id</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to process </span><span class="si">{</span><span class="n">repo</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">commit</span><span class="si">}</span><span class="s2"> (instance </span><span class="si">{</span><span class="n">instance_id</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">instance_id</span><span class="p">,</span> <span class="n">index_path</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h6 id="swebench.inference.make_datasets.bm25_retrieval.get_index_paths" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>            <span class="doc doc-object-name doc-function-name">get_index_paths</span>


</h6>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">get_index_paths</span><span class="p">(</span><span class="n">remaining_instances</span><span class="p">:</span> <span class="n"><span title="list">list</span></span><span class="p">[</span><span class="n"><span title="dict">dict</span></span><span class="p">[</span><span class="n"><span title="str">str</span></span><span class="p">,</span> <span class="n"><span title="typing.Any">Any</span></span><span class="p">]],</span> <span class="n">root_dir_name</span><span class="p">:</span> <span class="n"><span title="str">str</span></span><span class="p">,</span> <span class="n">document_encoding_func</span><span class="p">:</span> <span class="n"><span title="typing.Any">Any</span></span><span class="p">,</span> <span class="n">python</span><span class="p">:</span> <span class="n"><span title="str">str</span></span><span class="p">,</span> <span class="n">token</span><span class="p">:</span> <span class="n"><span title="str">str</span></span><span class="p">,</span> <span class="n">output_file</span><span class="p">:</span> <span class="n"><span title="str">str</span></span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><span title="dict">dict</span></span><span class="p">[</span><span class="n"><span title="str">str</span></span><span class="p">,</span> <span class="n"><span title="str">str</span></span><span class="p">]</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Retrieves the index paths for the given instances using multiple processes.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>remaining_instances</code>
            </td>
            <td>
                  <code><span title="list">list</span>[<span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A list of instances for which to retrieve the index paths.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>root_dir_name</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The root directory name.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>document_encoding_func</code>
            </td>
            <td>
                  <code><span title="typing.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A function for encoding documents.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>python</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The path to the Python executable.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>token</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The token to use for authentication.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>output_file</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The output file.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>num_workers</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The number of worker processes to use.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A dictionary mapping instance IDs to index paths.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>swebench/inference/make_datasets/bm25_retrieval.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_index_paths</span><span class="p">(</span>
    <span class="n">remaining_instances</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
    <span class="n">root_dir_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">document_encoding_func</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="n">python</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">token</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">output_file</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Retrieves the index paths for the given instances using multiple processes.</span>

<span class="sd">    Args:</span>
<span class="sd">        remaining_instances: A list of instances for which to retrieve the index paths.</span>
<span class="sd">        root_dir_name: The root directory name.</span>
<span class="sd">        document_encoding_func: A function for encoding documents.</span>
<span class="sd">        python: The path to the Python executable.</span>
<span class="sd">        token: The token to use for authentication.</span>
<span class="sd">        output_file: The output file.</span>
<span class="sd">        num_workers: The number of worker processes to use.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A dictionary mapping instance IDs to index paths.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">all_index_paths</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">instance</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">remaining_instances</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Indexing&quot;</span><span class="p">):</span>
        <span class="n">instance_id</span><span class="p">,</span> <span class="n">index_path</span> <span class="o">=</span> <span class="n">get_index_paths_worker</span><span class="p">(</span>
            <span class="n">instance</span><span class="o">=</span><span class="n">instance</span><span class="p">,</span>
            <span class="n">root_dir_name</span><span class="o">=</span><span class="n">root_dir_name</span><span class="p">,</span>
            <span class="n">document_encoding_func</span><span class="o">=</span><span class="n">document_encoding_func</span><span class="p">,</span>
            <span class="n">python</span><span class="o">=</span><span class="n">python</span><span class="p">,</span>
            <span class="n">token</span><span class="o">=</span><span class="n">token</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">index_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">all_index_paths</span><span class="p">[</span><span class="n">instance_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">index_path</span>
    <span class="k">return</span> <span class="n">all_index_paths</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h6 id="swebench.inference.make_datasets.bm25_retrieval.get_root_dir" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>            <span class="doc doc-object-name doc-function-name">get_root_dir</span>


</h6>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">get_root_dir</span><span class="p">(</span><span class="n">dataset_name</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">,</span> <span class="n">document_encoding_style</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">


            <details class="quote">
              <summary>Source code in <code>swebench/inference/make_datasets/bm25_retrieval.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_root_dir</span><span class="p">(</span><span class="n">dataset_name</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">,</span> <span class="n">document_encoding_style</span><span class="p">):</span>
    <span class="n">root_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">dataset_name</span><span class="p">,</span> <span class="n">document_encoding_style</span> <span class="o">+</span> <span class="s2">&quot;_indexes&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">root_dir</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
        <span class="n">root_dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">root_dir_name</span> <span class="o">=</span> <span class="n">root_dir</span>
    <span class="k">return</span> <span class="n">root_dir</span><span class="p">,</span> <span class="n">root_dir_name</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h6 id="swebench.inference.make_datasets.bm25_retrieval.main" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>            <span class="doc doc-object-name doc-function-name">main</span>


</h6>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">main</span><span class="p">(</span><span class="n">dataset_name_or_path</span><span class="p">,</span> <span class="n">document_encoding_style</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">,</span> <span class="n">shard_id</span><span class="p">,</span> <span class="n">num_shards</span><span class="p">,</span> <span class="n">splits</span><span class="p">,</span> <span class="n">leave_indexes</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">


            <details class="quote">
              <summary>Source code in <code>swebench/inference/make_datasets/bm25_retrieval.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span>
    <span class="n">dataset_name_or_path</span><span class="p">,</span>
    <span class="n">document_encoding_style</span><span class="p">,</span>
    <span class="n">output_dir</span><span class="p">,</span>
    <span class="n">shard_id</span><span class="p">,</span>
    <span class="n">num_shards</span><span class="p">,</span>
    <span class="n">splits</span><span class="p">,</span>
    <span class="n">leave_indexes</span><span class="p">,</span>
<span class="p">):</span>
    <span class="n">document_encoding_func</span> <span class="o">=</span> <span class="n">DOCUMENT_ENCODING_FUNCTIONS</span><span class="p">[</span><span class="n">document_encoding_style</span><span class="p">]</span>
    <span class="n">token</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;GITHUB_TOKEN&quot;</span><span class="p">,</span> <span class="s2">&quot;git&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">Path</span><span class="p">(</span><span class="n">dataset_name_or_path</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
        <span class="n">dataset</span> <span class="o">=</span> <span class="n">load_from_disk</span><span class="p">(</span><span class="n">dataset_name_or_path</span><span class="p">)</span>
        <span class="n">dataset_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">dataset_name_or_path</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">dataset</span> <span class="o">=</span> <span class="n">load_dataset</span><span class="p">(</span><span class="n">dataset_name_or_path</span><span class="p">)</span>
        <span class="n">dataset_name</span> <span class="o">=</span> <span class="n">dataset_name_or_path</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="s2">&quot;__&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">shard_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">split</span> <span class="ow">in</span> <span class="n">splits</span><span class="p">:</span>
            <span class="n">dataset</span><span class="p">[</span><span class="n">split</span><span class="p">]</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">[</span><span class="n">split</span><span class="p">]</span><span class="o">.</span><span class="n">shard</span><span class="p">(</span><span class="n">num_shards</span><span class="p">,</span> <span class="n">shard_id</span><span class="p">)</span>
    <span class="n">instances</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">set</span><span class="p">(</span><span class="n">splits</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">!=</span> <span class="nb">set</span><span class="p">():</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown splits </span><span class="si">{</span><span class="nb">set</span><span class="p">(</span><span class="n">splits</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nb">set</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">split</span> <span class="ow">in</span> <span class="n">splits</span><span class="p">:</span>
        <span class="n">instances</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">dataset</span><span class="p">[</span><span class="n">split</span><span class="p">])</span>
    <span class="n">python</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s2">&quot;which python&quot;</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">capture_output</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">python</span> <span class="o">=</span> <span class="n">python</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="n">output_file</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span>
        <span class="n">output_dir</span><span class="p">,</span> <span class="n">dataset_name</span><span class="p">,</span> <span class="n">document_encoding_style</span> <span class="o">+</span> <span class="s2">&quot;.retrieval.jsonl&quot;</span>
    <span class="p">)</span>
    <span class="n">remaining_instances</span> <span class="o">=</span> <span class="n">get_remaining_instances</span><span class="p">(</span><span class="n">instances</span><span class="p">,</span> <span class="n">output_file</span><span class="p">)</span>
    <span class="n">root_dir</span><span class="p">,</span> <span class="n">root_dir_name</span> <span class="o">=</span> <span class="n">get_root_dir</span><span class="p">(</span>
        <span class="n">dataset_name</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">,</span> <span class="n">document_encoding_style</span>
    <span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">all_index_paths</span> <span class="o">=</span> <span class="n">get_index_paths</span><span class="p">(</span>
            <span class="n">remaining_instances</span><span class="p">,</span>
            <span class="n">root_dir_name</span><span class="p">,</span>
            <span class="n">document_encoding_func</span><span class="p">,</span>
            <span class="n">python</span><span class="p">,</span>
            <span class="n">token</span><span class="p">,</span>
            <span class="n">output_file</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cleaning up </span><span class="si">{</span><span class="n">root_dir</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">del_dirs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">root_dir</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;repo__*&quot;</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">leave_indexes</span><span class="p">:</span>
            <span class="n">index_dirs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">root_dir</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;index__*&quot;</span><span class="p">))</span>
            <span class="n">del_dirs</span> <span class="o">+=</span> <span class="n">index_dirs</span>
        <span class="k">for</span> <span class="n">dirname</span> <span class="ow">in</span> <span class="n">del_dirs</span><span class="p">:</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">dirname</span><span class="p">,</span> <span class="n">ignore_errors</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Finished indexing </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">all_index_paths</span><span class="p">)</span><span class="si">}</span><span class="s2"> instances&quot;</span><span class="p">)</span>
    <span class="n">search_indexes</span><span class="p">(</span><span class="n">remaining_instances</span><span class="p">,</span> <span class="n">output_file</span><span class="p">,</span> <span class="n">all_index_paths</span><span class="p">)</span>
    <span class="n">missing_ids</span> <span class="o">=</span> <span class="n">get_missing_ids</span><span class="p">(</span><span class="n">instances</span><span class="p">,</span> <span class="n">output_file</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Missing indexes for </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">missing_ids</span><span class="p">)</span><span class="si">}</span><span class="s2"> instances.&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saved retrieval results to </span><span class="si">{</span><span class="n">output_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">del_dirs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">root_dir</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;repo__*&quot;</span><span class="p">))</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cleaning up </span><span class="si">{</span><span class="n">root_dir</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">leave_indexes</span><span class="p">:</span>
        <span class="n">index_dirs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">root_dir</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;index__*&quot;</span><span class="p">))</span>
        <span class="n">del_dirs</span> <span class="o">+=</span> <span class="n">index_dirs</span>
    <span class="k">for</span> <span class="n">dirname</span> <span class="ow">in</span> <span class="n">del_dirs</span><span class="p">:</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">dirname</span><span class="p">,</span> <span class="n">ignore_errors</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h5 id="swebench.inference.make_datasets.create_instance" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <span class="doc doc-object-name doc-module-name">create_instance</span>


</h5>

    <div class="doc doc-contents ">









  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h6 id="swebench.inference.make_datasets.create_instance.logger" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <span class="doc doc-object-name doc-attribute-name">logger</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-module-attribute"><code>module-attribute</code></small>
  </span>

</h6>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">logger</span> <span class="o">=</span> <span class="n"><span title="logging.getLogger">getLogger</span></span><span class="p">(</span><span class="n"><span title="__name__">__name__</span></span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h6 id="swebench.inference.make_datasets.create_instance.PATCH_EXAMPLE" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <span class="doc doc-object-name doc-attribute-name">PATCH_EXAMPLE</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-module-attribute"><code>module-attribute</code></small>
  </span>

</h6>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">PATCH_EXAMPLE</span> <span class="o">=</span> <span class="s1">&#39;--- a/file.py</span><span class="se">\n</span><span class="s1">+++ b/file.py</span><span class="se">\n</span><span class="s1">@@ -1,27 +1,35 @@</span><span class="se">\n</span><span class="s1"> def euclidean(a, b):</span><span class="se">\n</span><span class="s1">-    while b:</span><span class="se">\n</span><span class="s1">-        a, b = b, a % b</span><span class="se">\n</span><span class="s1">-    return a</span><span class="se">\n</span><span class="s1">+    if b == 0:</span><span class="se">\n</span><span class="s1">+        return a</span><span class="se">\n</span><span class="s1">+    return euclidean(b, a % b)</span><span class="se">\n</span><span class="s1"> </span><span class="se">\n</span><span class="s1"> </span><span class="se">\n</span><span class="s1"> def bresenham(x0, y0, x1, y1):</span><span class="se">\n</span><span class="s1">     points = []</span><span class="se">\n</span><span class="s1">     dx = abs(x1 - x0)</span><span class="se">\n</span><span class="s1">     dy = abs(y1 - y0)</span><span class="se">\n</span><span class="s1">-    sx = 1 if x0 &lt; x1 else -1</span><span class="se">\n</span><span class="s1">-    sy = 1 if y0 &lt; y1 else -1</span><span class="se">\n</span><span class="s1">-    err = dx - dy</span><span class="se">\n</span><span class="s1">+    x, y = x0, y0</span><span class="se">\n</span><span class="s1">+    sx = -1 if x0 &gt; x1 else 1</span><span class="se">\n</span><span class="s1">+    sy = -1 if y0 &gt; y1 else 1</span><span class="se">\n</span><span class="s1"> </span><span class="se">\n</span><span class="s1">-    while True:</span><span class="se">\n</span><span class="s1">-        points.append((x0, y0))</span><span class="se">\n</span><span class="s1">-        if x0 == x1 and y0 == y1:</span><span class="se">\n</span><span class="s1">-            break</span><span class="se">\n</span><span class="s1">-        e2 = 2 * err</span><span class="se">\n</span><span class="s1">-        if e2 &gt; -dy:</span><span class="se">\n</span><span class="s1">+    if dx &gt; dy:</span><span class="se">\n</span><span class="s1">+        err = dx / 2.0</span><span class="se">\n</span><span class="s1">+        while x != x1:</span><span class="se">\n</span><span class="s1">+            points.append((x, y))</span><span class="se">\n</span><span class="s1">             err -= dy</span><span class="se">\n</span><span class="s1">-            x0 += sx</span><span class="se">\n</span><span class="s1">-        if e2 &lt; dx:</span><span class="se">\n</span><span class="s1">-            err += dx</span><span class="se">\n</span><span class="s1">-            y0 += sy</span><span class="se">\n</span><span class="s1">+            if err &lt; 0:</span><span class="se">\n</span><span class="s1">+                y += sy</span><span class="se">\n</span><span class="s1">+                err += dx</span><span class="se">\n</span><span class="s1">+            x += sx</span><span class="se">\n</span><span class="s1">+    else:</span><span class="se">\n</span><span class="s1">+        err = dy / 2.0</span><span class="se">\n</span><span class="s1">+        while y != y1:</span><span class="se">\n</span><span class="s1">+            points.append((x, y))</span><span class="se">\n</span><span class="s1">+            err -= dx</span><span class="se">\n</span><span class="s1">+            if err &lt; 0:</span><span class="se">\n</span><span class="s1">+                x += sx</span><span class="se">\n</span><span class="s1">+                err += dy</span><span class="se">\n</span><span class="s1">+            y += sy</span><span class="se">\n</span><span class="s1"> </span><span class="se">\n</span><span class="s1">+    points.append((x, y))</span><span class="se">\n</span><span class="s1">     return points&#39;</span>
</code></pre></div>

    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h6 id="swebench.inference.make_datasets.create_instance.FULL_GENERATION_EXAMPLE" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <span class="doc doc-object-name doc-attribute-name">FULL_GENERATION_EXAMPLE</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-module-attribute"><code>module-attribute</code></small>
  </span>

</h6>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">FULL_GENERATION_EXAMPLE</span> <span class="o">=</span> <span class="s1">&#39;[start of /src/this_file.py]</span><span class="se">\n</span><span class="s1">import os</span><span class="se">\n\n</span><span class="s1">def euclidean(a, b):</span><span class="se">\n</span><span class="s1">    if b == 0:</span><span class="se">\n</span><span class="s1">        return a</span><span class="se">\n</span><span class="s1">    return euclidean(b, a % b)</span><span class="se">\n</span><span class="s1">[end of /src/this_file.py]</span><span class="se">\n</span><span class="s1">[start of /src/another_file.py]</span><span class="se">\n</span><span class="s1">def bresenham(x0, y0, x1, y1):</span><span class="se">\n</span><span class="s1">    points = []</span><span class="se">\n</span><span class="s1">    dx = abs(x1 - x0)</span><span class="se">\n</span><span class="s1">    dy = abs(y1 - y0)</span><span class="se">\n</span><span class="s1">    x, y = x0, y0</span><span class="se">\n</span><span class="s1">    sx = -1 if x0 &gt; x1 else 1</span><span class="se">\n</span><span class="s1">    sy = -1 if y0 &gt; y1 else 1</span><span class="se">\n</span><span class="s1">    if dx &gt; dy:</span><span class="se">\n</span><span class="s1">        err = dx / 2.0</span><span class="se">\n</span><span class="s1">        while x != x1:</span><span class="se">\n</span><span class="s1">            points.append((x, y))</span><span class="se">\n</span><span class="s1">            err -= dy</span><span class="se">\n</span><span class="s1">            if err &lt; 0:</span><span class="se">\n</span><span class="s1">                y += sy</span><span class="se">\n</span><span class="s1">                err += dx</span><span class="se">\n</span><span class="s1">            x += sx</span><span class="se">\n</span><span class="s1">    else:</span><span class="se">\n</span><span class="s1">        err = dy / 2.0</span><span class="se">\n</span><span class="s1">        while y != y1:</span><span class="se">\n</span><span class="s1">            points.append((x</span><span class="se">\n</span><span class="s1">            err -= dx</span><span class="se">\n</span><span class="s1">            if err &lt; 0:</span><span class="se">\n</span><span class="s1">                x += sx</span><span class="se">\n</span><span class="s1">                err += dy</span><span class="se">\n</span><span class="s1">            y += sy</span><span class="se">\n</span><span class="s1">    points.append((x, y))</span><span class="se">\n</span><span class="s1">    return points</span><span class="se">\n</span><span class="s1">[end of /src/another_file.py]&#39;</span>
</code></pre></div>

    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h6 id="swebench.inference.make_datasets.create_instance.PROMPT_FUNCTIONS" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <span class="doc doc-object-name doc-attribute-name">PROMPT_FUNCTIONS</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-module-attribute"><code>module-attribute</code></small>
  </span>

</h6>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">PROMPT_FUNCTIONS</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;style-2&#39;</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-internal" title="            prompt_style_2 (swebench.inference.make_datasets.create_instance.prompt_style_2)" href="#swebench.inference.make_datasets.create_instance.prompt_style_2">prompt_style_2</a></span><span class="p">,</span> <span class="s1">&#39;style-3&#39;</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-internal" title="            prompt_style_3 (swebench.inference.make_datasets.create_instance.prompt_style_3)" href="#swebench.inference.make_datasets.create_instance.prompt_style_3">prompt_style_3</a></span><span class="p">,</span> <span class="s1">&#39;full_file_gen&#39;</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-internal" title="            full_file_gen (swebench.inference.make_datasets.create_instance.full_file_gen)" href="#swebench.inference.make_datasets.create_instance.full_file_gen">full_file_gen</a></span><span class="p">,</span> <span class="s1">&#39;style-2-edits-only&#39;</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-internal" title="            prompt_style_2_edits_only (swebench.inference.make_datasets.create_instance.prompt_style_2_edits_only)" href="#swebench.inference.make_datasets.create_instance.prompt_style_2_edits_only">prompt_style_2_edits_only</a></span><span class="p">}</span>
</code></pre></div>

    <div class="doc doc-contents ">

    </div>

</div>



<div class="doc doc-object doc-function">


<h6 id="swebench.inference.make_datasets.create_instance.add_lines_list" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>            <span class="doc doc-object-name doc-function-name">add_lines_list</span>


</h6>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">add_lines_list</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">


            <details class="quote">
              <summary>Source code in <code>swebench/inference/make_datasets/create_instance.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">add_lines_list</span><span class="p">(</span><span class="n">content</span><span class="p">):</span>
    <span class="n">content_with_lines</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">ix</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">content</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">),</span> <span class="n">start</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">content_with_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ix</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">line</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">content_with_lines</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h6 id="swebench.inference.make_datasets.create_instance.add_lines" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>            <span class="doc doc-object-name doc-function-name">add_lines</span>


</h6>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">add_lines</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">


            <details class="quote">
              <summary>Source code in <code>swebench/inference/make_datasets/create_instance.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">123</span>
<span class="normal">124</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">add_lines</span><span class="p">(</span><span class="n">content</span><span class="p">):</span>
    <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">add_lines_list</span><span class="p">(</span><span class="n">content</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h6 id="swebench.inference.make_datasets.create_instance.make_code_text" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>            <span class="doc doc-object-name doc-function-name">make_code_text</span>


</h6>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">make_code_text</span><span class="p">(</span><span class="n">files_dict</span><span class="p">,</span> <span class="n">add_line_numbers</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">


            <details class="quote">
              <summary>Source code in <code>swebench/inference/make_datasets/create_instance.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">make_code_text</span><span class="p">(</span><span class="n">files_dict</span><span class="p">,</span> <span class="n">add_line_numbers</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="n">all_text</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">for</span> <span class="n">filename</span><span class="p">,</span> <span class="n">contents</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">files_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
        <span class="n">all_text</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;[start of </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">]</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="n">add_line_numbers</span><span class="p">:</span>
            <span class="n">all_text</span> <span class="o">+=</span> <span class="n">add_lines</span><span class="p">(</span><span class="n">contents</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">all_text</span> <span class="o">+=</span> <span class="n">contents</span>
        <span class="n">all_text</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[end of </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">]</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="k">return</span> <span class="n">all_text</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h6 id="swebench.inference.make_datasets.create_instance.make_code_text_edits_only" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>            <span class="doc doc-object-name doc-function-name">make_code_text_edits_only</span>


</h6>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">make_code_text_edits_only</span><span class="p">(</span><span class="n">files_dict</span><span class="p">,</span> <span class="n">patch</span><span class="p">,</span> <span class="n">add_line_numbers</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">


            <details class="quote">
              <summary>Source code in <code>swebench/inference/make_datasets/create_instance.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">make_code_text_edits_only</span><span class="p">(</span><span class="n">files_dict</span><span class="p">,</span> <span class="n">patch</span><span class="p">,</span> <span class="n">add_line_numbers</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="n">files</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">patch</span> <span class="o">=</span> <span class="n">unidiff</span><span class="o">.</span><span class="n">PatchSet</span><span class="p">(</span><span class="n">patch</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">patched_file</span> <span class="ow">in</span> <span class="n">patch</span><span class="p">:</span>
        <span class="n">source_file</span> <span class="o">=</span> <span class="n">patched_file</span><span class="o">.</span><span class="n">source_file</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;a/&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">files</span><span class="p">[</span><span class="n">source_file</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">hunk</span> <span class="ow">in</span> <span class="n">patched_file</span><span class="p">:</span>
            <span class="n">start</span> <span class="o">=</span> <span class="n">hunk</span><span class="o">.</span><span class="n">source_start</span> <span class="o">-</span> <span class="mi">15</span>
            <span class="n">end</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="n">hunk</span><span class="o">.</span><span class="n">source_length</span> <span class="o">+</span> <span class="mi">15</span>
            <span class="n">files</span><span class="p">[</span><span class="n">source_file</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">))</span>
    <span class="n">all_text</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">for</span> <span class="n">filename</span><span class="p">,</span> <span class="n">content</span> <span class="ow">in</span> <span class="n">files_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">all_text</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;[start of </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">]</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">content_with_lines</span> <span class="o">=</span> <span class="n">add_lines_list</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="ow">in</span> <span class="n">files</span><span class="p">[</span><span class="n">filename</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">start</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">all_text</span> <span class="o">+=</span> <span class="s2">&quot;...</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">all_text</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">content_with_lines</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">])</span>
            <span class="n">all_text</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="k">if</span> <span class="n">end</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">content_with_lines</span><span class="p">):</span>
                <span class="n">all_text</span> <span class="o">+=</span> <span class="s2">&quot;...</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">all_text</span> <span class="o">=</span> <span class="n">all_text</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">all_text</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[end of </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">]</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="k">return</span> <span class="n">all_text</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h6 id="swebench.inference.make_datasets.create_instance.prompt_style_2" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>            <span class="doc doc-object-name doc-function-name">prompt_style_2</span>


</h6>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">prompt_style_2</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">


            <details class="quote">
              <summary>Source code in <code>swebench/inference/make_datasets/create_instance.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">prompt_style_2</span><span class="p">(</span><span class="n">instance</span><span class="p">):</span>
    <span class="n">premise</span> <span class="o">=</span> <span class="s2">&quot;You will be provided with a partial code base and an issue statement explaining a problem to resolve.&quot;</span>
    <span class="n">readmes_text</span> <span class="o">=</span> <span class="n">make_code_text</span><span class="p">(</span><span class="n">instance</span><span class="p">[</span><span class="s2">&quot;readmes&quot;</span><span class="p">])</span>
    <span class="n">code_text</span> <span class="o">=</span> <span class="n">make_code_text</span><span class="p">(</span><span class="n">instance</span><span class="p">[</span><span class="s2">&quot;file_contents&quot;</span><span class="p">])</span>
    <span class="n">instructions</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">&quot;I need you to solve this issue by generating a single patch file that I can apply &quot;</span>
        <span class="o">+</span> <span class="s2">&quot;directly to this repository using git apply. Please respond with a single patch &quot;</span>
        <span class="o">+</span> <span class="s2">&quot;file in the following format.&quot;</span>
    <span class="p">)</span>
    <span class="n">problem_statement</span> <span class="o">=</span> <span class="n">instance</span><span class="p">[</span><span class="s2">&quot;problem_statement&quot;</span><span class="p">]</span>
    <span class="n">final_text</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">premise</span><span class="p">,</span>
        <span class="s2">&quot;&lt;issue&gt;&quot;</span><span class="p">,</span>
        <span class="n">problem_statement</span><span class="p">,</span>
        <span class="s2">&quot;&lt;/issue&gt;&quot;</span><span class="p">,</span>
        <span class="s2">&quot;&lt;code&gt;&quot;</span><span class="p">,</span>
        <span class="n">readmes_text</span><span class="p">,</span>
        <span class="n">code_text</span><span class="p">,</span>
        <span class="s2">&quot;&lt;/code&gt;&quot;</span><span class="p">,</span>
        <span class="n">instructions</span><span class="p">,</span>
        <span class="s2">&quot;&lt;patch&gt;&quot;</span><span class="p">,</span>
        <span class="n">PATCH_EXAMPLE</span><span class="p">,</span>
        <span class="s2">&quot;&lt;/patch&gt;&quot;</span><span class="p">,</span>
    <span class="p">]</span>
    <span class="n">final_text</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">final_text</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">final_text</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h6 id="swebench.inference.make_datasets.create_instance.prompt_style_2_edits_only" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>            <span class="doc doc-object-name doc-function-name">prompt_style_2_edits_only</span>


</h6>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">prompt_style_2_edits_only</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">


            <details class="quote">
              <summary>Source code in <code>swebench/inference/make_datasets/create_instance.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">prompt_style_2_edits_only</span><span class="p">(</span><span class="n">instance</span><span class="p">):</span>
    <span class="n">premise</span> <span class="o">=</span> <span class="s2">&quot;You will be provided with a partial code base and an issue statement explaining a problem to resolve.&quot;</span>
    <span class="n">readmes_text</span> <span class="o">=</span> <span class="n">make_code_text</span><span class="p">(</span><span class="n">instance</span><span class="p">[</span><span class="s2">&quot;readmes&quot;</span><span class="p">])</span>
    <span class="n">code_text</span> <span class="o">=</span> <span class="n">make_code_text_edits_only</span><span class="p">(</span><span class="n">instance</span><span class="p">[</span><span class="s2">&quot;file_contents&quot;</span><span class="p">],</span> <span class="n">instance</span><span class="p">[</span><span class="s2">&quot;patch&quot;</span><span class="p">])</span>
    <span class="n">instructions</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">&quot;I need you to solve this issue by generating a single patch file that I can apply &quot;</span>
        <span class="o">+</span> <span class="s2">&quot;directly to this repository using git apply. Please respond with a single patch &quot;</span>
        <span class="o">+</span> <span class="s2">&quot;file in the following format.&quot;</span>
    <span class="p">)</span>
    <span class="n">problem_statement</span> <span class="o">=</span> <span class="n">instance</span><span class="p">[</span><span class="s2">&quot;problem_statement&quot;</span><span class="p">]</span>
    <span class="n">final_text</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">premise</span><span class="p">,</span>
        <span class="s2">&quot;&lt;issue&gt;&quot;</span><span class="p">,</span>
        <span class="n">problem_statement</span><span class="p">,</span>
        <span class="s2">&quot;&lt;/issue&gt;&quot;</span><span class="p">,</span>
        <span class="s2">&quot;&lt;code&gt;&quot;</span><span class="p">,</span>
        <span class="n">readmes_text</span><span class="p">,</span>
        <span class="n">code_text</span><span class="p">,</span>
        <span class="s2">&quot;&lt;/code&gt;&quot;</span><span class="p">,</span>
        <span class="n">instructions</span><span class="p">,</span>
        <span class="s2">&quot;&lt;patch&gt;&quot;</span><span class="p">,</span>
        <span class="n">PATCH_EXAMPLE</span><span class="p">,</span>
        <span class="s2">&quot;&lt;/patch&gt;&quot;</span><span class="p">,</span>
    <span class="p">]</span>
    <span class="n">final_text</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">final_text</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">final_text</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h6 id="swebench.inference.make_datasets.create_instance.prompt_style_3" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>            <span class="doc doc-object-name doc-function-name">prompt_style_3</span>


</h6>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">prompt_style_3</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">


            <details class="quote">
              <summary>Source code in <code>swebench/inference/make_datasets/create_instance.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">prompt_style_3</span><span class="p">(</span><span class="n">instance</span><span class="p">):</span>
    <span class="n">premise</span> <span class="o">=</span> <span class="s2">&quot;You will be provided with a partial code base and an issue statement explaining a problem to resolve.&quot;</span>
    <span class="n">readmes_text</span> <span class="o">=</span> <span class="n">make_code_text</span><span class="p">(</span><span class="n">instance</span><span class="p">[</span><span class="s2">&quot;readmes&quot;</span><span class="p">])</span>
    <span class="n">code_text</span> <span class="o">=</span> <span class="n">make_code_text</span><span class="p">(</span><span class="n">instance</span><span class="p">[</span><span class="s2">&quot;file_contents&quot;</span><span class="p">])</span>
    <span class="n">example_explanation</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">&quot;Here is an example of a patch file. It consists of changes to the code base. &quot;</span>
        <span class="o">+</span> <span class="s2">&quot;It specifies the file names, the line numbers of each change, and the removed and added lines. &quot;</span>
        <span class="o">+</span> <span class="s2">&quot;A single patch file can contain changes to multiple files.&quot;</span>
    <span class="p">)</span>
    <span class="n">final_instruction</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">&quot;I need you to solve the provided issue by generating a single patch file that I can apply &quot;</span>
        <span class="o">+</span> <span class="s2">&quot;directly to this repository using git apply. Please respond with a single patch &quot;</span>
        <span class="o">+</span> <span class="s2">&quot;file in the format shown above.&quot;</span>
    <span class="p">)</span>
    <span class="n">problem_statement</span> <span class="o">=</span> <span class="n">instance</span><span class="p">[</span><span class="s2">&quot;problem_statement&quot;</span><span class="p">]</span>
    <span class="n">final_text</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">premise</span><span class="p">,</span>
        <span class="s2">&quot;&lt;issue&gt;&quot;</span><span class="p">,</span>
        <span class="n">problem_statement</span><span class="p">,</span>
        <span class="s2">&quot;&lt;/issue&gt;&quot;</span><span class="p">,</span>
        <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="s2">&quot;&lt;code&gt;&quot;</span><span class="p">,</span>
        <span class="n">readmes_text</span><span class="p">,</span>
        <span class="n">code_text</span><span class="p">,</span>
        <span class="s2">&quot;&lt;/code&gt;&quot;</span><span class="p">,</span>
        <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="n">example_explanation</span><span class="p">,</span>
        <span class="s2">&quot;&lt;patch&gt;&quot;</span><span class="p">,</span>
        <span class="n">PATCH_EXAMPLE</span><span class="p">,</span>
        <span class="s2">&quot;&lt;/patch&gt;&quot;</span><span class="p">,</span>
        <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="n">final_instruction</span><span class="p">,</span>
        <span class="s2">&quot;Respond below:&quot;</span><span class="p">,</span>
    <span class="p">]</span>
    <span class="n">final_text</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">final_text</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">final_text</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h6 id="swebench.inference.make_datasets.create_instance.full_file_gen" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>            <span class="doc doc-object-name doc-function-name">full_file_gen</span>


</h6>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">full_file_gen</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">


            <details class="quote">
              <summary>Source code in <code>swebench/inference/make_datasets/create_instance.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">full_file_gen</span><span class="p">(</span><span class="n">instance</span><span class="p">):</span>
    <span class="n">premise</span> <span class="o">=</span> <span class="s2">&quot;You will be provided with a partial code base and an issue statement explaining a problem to resolve.&quot;</span>
    <span class="n">readmes_text</span> <span class="o">=</span> <span class="n">make_code_text</span><span class="p">(</span><span class="n">instance</span><span class="p">[</span><span class="s2">&quot;readmes&quot;</span><span class="p">],</span> <span class="n">add_line_numbers</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">code_text</span> <span class="o">=</span> <span class="n">make_code_text</span><span class="p">(</span><span class="n">instance</span><span class="p">[</span><span class="s2">&quot;file_contents&quot;</span><span class="p">],</span> <span class="n">add_line_numbers</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">instructions</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">&quot;I need you to solve this issue by regenerating the full files in the code base that you would like to change. &quot;</span>
        <span class="o">+</span> <span class="s2">&quot;You can change as many files as you like. &quot;</span>
        <span class="o">+</span> <span class="s2">&quot;Please respond with a list of files and their revised contents in the following format.&quot;</span>
    <span class="p">)</span>
    <span class="n">problem_statement</span> <span class="o">=</span> <span class="n">instance</span><span class="p">[</span><span class="s2">&quot;problem_statement&quot;</span><span class="p">]</span>
    <span class="n">final_text</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">premise</span><span class="p">,</span>
        <span class="s2">&quot;&lt;issue&gt;&quot;</span><span class="p">,</span>
        <span class="n">problem_statement</span><span class="p">,</span>
        <span class="s2">&quot;&lt;/issue&gt;&quot;</span><span class="p">,</span>
        <span class="s2">&quot;&lt;code&gt;&quot;</span><span class="p">,</span>
        <span class="n">readmes_text</span><span class="p">,</span>
        <span class="n">code_text</span><span class="p">,</span>
        <span class="s2">&quot;&lt;/code&gt;&quot;</span><span class="p">,</span>
        <span class="n">instructions</span><span class="p">,</span>
        <span class="s2">&quot;&lt;example&gt;&quot;</span><span class="p">,</span>
        <span class="n">FULL_GENERATION_EXAMPLE</span><span class="p">,</span>
        <span class="s2">&quot;&lt;/example&gt;&quot;</span><span class="p">,</span>
    <span class="p">]</span>
    <span class="n">final_text</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">final_text</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">final_text</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h6 id="swebench.inference.make_datasets.create_instance.ingest_files" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>            <span class="doc doc-object-name doc-function-name">ingest_files</span>


</h6>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">ingest_files</span><span class="p">(</span><span class="n">filenames</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">


            <details class="quote">
              <summary>Source code in <code>swebench/inference/make_datasets/create_instance.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">ingest_files</span><span class="p">(</span><span class="n">filenames</span><span class="p">):</span>
    <span class="n">files_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">filenames</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">content</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">files_dict</span><span class="p">[</span><span class="n">filename</span><span class="p">]</span> <span class="o">=</span> <span class="n">content</span>
    <span class="k">return</span> <span class="n">files_dict</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h6 id="swebench.inference.make_datasets.create_instance.add_retrieval_results" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>            <span class="doc doc-object-name doc-function-name">add_retrieval_results</span>


</h6>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">add_retrieval_results</span><span class="p">(</span><span class="n">input_instances</span><span class="p">,</span> <span class="n">retrieval_file</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">file_source</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Adds retrieval results to input_instances in-place</p>


            <details class="quote">
              <summary>Source code in <code>swebench/inference/make_datasets/create_instance.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">add_retrieval_results</span><span class="p">(</span><span class="n">input_instances</span><span class="p">,</span> <span class="n">retrieval_file</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">file_source</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Adds retrieval results to input_instances in-place</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">retrieval_results_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">retrieval_file</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">retrieval_results_path</span><span class="o">.</span><span class="n">exists</span><span class="p">(),</span> <span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;Retrieval results not found at </span><span class="si">{</span><span class="n">retrieval_results_path</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="p">)</span>
    <span class="n">retrieval_results</span> <span class="o">=</span> <span class="p">[</span><span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">open</span><span class="p">(</span><span class="n">retrieval_results_path</span><span class="p">)]</span>
    <span class="n">retrieval_results</span> <span class="o">=</span> <span class="p">{</span><span class="n">x</span><span class="p">[</span><span class="s2">&quot;instance_id&quot;</span><span class="p">]:</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;hits&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">retrieval_results</span><span class="p">}</span>
    <span class="k">for</span> <span class="n">instance_id</span><span class="p">,</span> <span class="n">instance</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span>
        <span class="n">input_instances</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span>
        <span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">input_instances</span><span class="p">),</span>
        <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Adding retrieval results&quot;</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">instance</span><span class="p">[</span><span class="s2">&quot;hits&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">retrieval_results</span><span class="p">[</span><span class="n">instance_id</span><span class="p">][:</span><span class="n">k</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Instance </span><span class="si">{</span><span class="n">instance_id</span><span class="si">}</span><span class="s2"> not found in retrieval results&quot;</span><span class="p">)</span>
            <span class="n">instance</span><span class="p">[</span><span class="s2">&quot;hits&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h6 id="swebench.inference.make_datasets.create_instance.get_oracle_filenames" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>            <span class="doc doc-object-name doc-function-name">get_oracle_filenames</span>


</h6>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">get_oracle_filenames</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Returns the filenames that are changed in the patch</p>


            <details class="quote">
              <summary>Source code in <code>swebench/inference/make_datasets/create_instance.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_oracle_filenames</span><span class="p">(</span><span class="n">instance</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns the filenames that are changed in the patch</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">source_files</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">patch_file</span><span class="o">.</span><span class="n">source_file</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;a/&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">patch_file</span> <span class="ow">in</span> <span class="n">unidiff</span><span class="o">.</span><span class="n">PatchSet</span><span class="p">(</span><span class="n">instance</span><span class="p">[</span><span class="s2">&quot;patch&quot;</span><span class="p">])</span>
    <span class="p">}</span>
    <span class="n">gold_docs</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">source_file</span> <span class="ow">in</span> <span class="n">source_files</span><span class="p">:</span>
        <span class="n">gold_docs</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">source_file</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">gold_docs</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h6 id="swebench.inference.make_datasets.create_instance.add_text_inputs" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>            <span class="doc doc-object-name doc-function-name">add_text_inputs</span>


</h6>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">add_text_inputs</span><span class="p">(</span><span class="n">instances</span><span class="p">,</span> <span class="n">retrieval_file</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">prompt_style</span><span class="p">,</span> <span class="n">file_source</span><span class="p">,</span> <span class="n">max_context_len</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tokenizer_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">progress_file</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Process instances and save results to progress file.</p>
<p>Args:
- instances: dictionary with unprocessed input instances
- retrieval_file: if using retrieval method for file_contents, specify retrieval_file
- k: if using retrieval, specifies the maximum number of files to include
- prompt_style: specify the function to generate instructions and prompt
- file_source: where to collect file_contents (e.g. oracle or bm25)
- verbose: set ContextManager verbose to True
- progress_file: required, path to save processed instances</p>


            <details class="quote">
              <summary>Source code in <code>swebench/inference/make_datasets/create_instance.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">add_text_inputs</span><span class="p">(</span>
    <span class="n">instances</span><span class="p">,</span>
    <span class="n">retrieval_file</span><span class="p">,</span>
    <span class="n">k</span><span class="p">,</span>
    <span class="n">prompt_style</span><span class="p">,</span>
    <span class="n">file_source</span><span class="p">,</span>
    <span class="n">max_context_len</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">tokenizer_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">progress_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Process instances and save results to progress file.</span>

<span class="sd">    Args:</span>
<span class="sd">    - instances: dictionary with unprocessed input instances</span>
<span class="sd">    - retrieval_file: if using retrieval method for file_contents, specify retrieval_file</span>
<span class="sd">    - k: if using retrieval, specifies the maximum number of files to include</span>
<span class="sd">    - prompt_style: specify the function to generate instructions and prompt</span>
<span class="sd">    - file_source: where to collect file_contents (e.g. oracle or bm25)</span>
<span class="sd">    - verbose: set ContextManager verbose to True</span>
<span class="sd">    - progress_file: required, path to save processed instances</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="n">progress_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;progress_file is required&quot;</span>

    <span class="c1"># Create progress file directory if it doesn&#39;t exist</span>
    <span class="n">progress_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">progress_file</span><span class="p">)</span>
    <span class="n">progress_path</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Load already processed instances</span>
    <span class="n">processed_ids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="n">file_exists</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">progress_file</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">file_exists</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">progress_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">instance</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                <span class="n">processed_ids</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">instance</span><span class="p">[</span><span class="s2">&quot;instance_id&quot;</span><span class="p">])</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">processed_ids</span><span class="p">)</span><span class="si">}</span><span class="s2"> already processed instances&quot;</span><span class="p">)</span>
        <span class="n">progress_file_handle</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">progress_file</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">progress_file_handle</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">progress_file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">max_context_len</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">tokenizer_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="p">(</span>
                <span class="s2">&quot;Must specify tokenizer_name if using max_context_len&quot;</span>
            <span class="p">)</span>
            <span class="n">tokenizer</span><span class="p">,</span> <span class="n">tokenizer_func</span> <span class="o">=</span> <span class="n">TOKENIZER_FUNCS</span><span class="p">[</span><span class="n">tokenizer_name</span><span class="p">]</span>

        <span class="c1"># Add retrieval results if needed</span>
        <span class="k">if</span> <span class="n">file_source</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;bm25&quot;</span><span class="p">}:</span>
            <span class="n">instances</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">instances</span><span class="p">)</span>
            <span class="n">add_retrieval_results</span><span class="p">(</span><span class="n">instances</span><span class="p">,</span> <span class="n">retrieval_file</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">file_source</span><span class="p">)</span>

        <span class="c1"># Filter out already processed instances</span>
        <span class="n">instances_to_process</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">instances</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">processed_ids</span>
        <span class="p">}</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processing </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">instances_to_process</span><span class="p">)</span><span class="si">}</span><span class="s2"> instances&quot;</span><span class="p">)</span>

        <span class="n">orig_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">TemporaryDirectory</span><span class="p">(</span>
            <span class="nb">dir</span><span class="o">=</span><span class="s2">&quot;/scratch&quot;</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s2">&quot;/scratch&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;/tmp&quot;</span>
        <span class="p">)</span> <span class="k">as</span> <span class="n">root_dir</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">instance_id</span><span class="p">,</span> <span class="n">instance</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span>
                <span class="n">instances_to_process</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span>
                <span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">instances_to_process</span><span class="p">),</span>
                <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Processing instances&quot;</span><span class="p">,</span>
            <span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">with</span> <span class="n">AutoContextManager</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">root_dir</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span> <span class="k">as</span> <span class="n">cm</span><span class="p">:</span>
                        <span class="c1"># Process instance</span>
                        <span class="n">processed_instance</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>

                        <span class="c1"># Add readmes</span>
                        <span class="n">readmes</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">get_readme_files</span><span class="p">()</span>
                        <span class="n">processed_instance</span><span class="p">[</span><span class="s2">&quot;readmes&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ingest_files</span><span class="p">(</span><span class="n">readmes</span><span class="p">)</span>

                        <span class="c1"># Handle file contents based on configuration</span>
                        <span class="k">if</span> <span class="n">max_context_len</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">processed_instance</span><span class="p">[</span><span class="s2">&quot;file_contents&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                            <span class="n">base_text_inputs</span> <span class="o">=</span> <span class="n">PROMPT_FUNCTIONS</span><span class="p">[</span><span class="n">prompt_style</span><span class="p">](</span>
                                <span class="n">processed_instance</span>
                            <span class="p">)</span>
                            <span class="n">base_text_input_length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span>
                                <span class="n">tokenizer_func</span><span class="p">(</span><span class="n">base_text_inputs</span><span class="p">,</span> <span class="n">tokenizer</span><span class="p">)</span>
                            <span class="p">)</span>

                        <span class="k">if</span> <span class="n">file_source</span> <span class="o">==</span> <span class="s2">&quot;oracle&quot;</span><span class="p">:</span>
                            <span class="n">processed_instance</span><span class="p">[</span><span class="s2">&quot;file_contents&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ingest_files</span><span class="p">(</span>
                                <span class="n">get_oracle_filenames</span><span class="p">(</span><span class="n">processed_instance</span><span class="p">)</span>
                            <span class="p">)</span>
                        <span class="k">elif</span> <span class="n">file_source</span> <span class="o">==</span> <span class="s2">&quot;bm25&quot;</span><span class="p">:</span>
                            <span class="n">processed_instance</span><span class="p">[</span><span class="s2">&quot;file_contents&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ingest_files</span><span class="p">(</span>
                                <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="s2">&quot;docid&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">processed_instance</span><span class="p">[</span><span class="s2">&quot;hits&quot;</span><span class="p">]]</span>
                            <span class="p">)</span>
                        <span class="k">elif</span> <span class="n">file_source</span> <span class="o">==</span> <span class="s2">&quot;all&quot;</span><span class="p">:</span>
                            <span class="n">processed_instance</span><span class="p">[</span><span class="s2">&quot;file_contents&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                                <span class="n">ingest_directory_contents</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">repo_path</span><span class="p">)</span>
                            <span class="p">)</span>
                        <span class="k">elif</span> <span class="n">file_source</span> <span class="o">==</span> <span class="s2">&quot;none&quot;</span><span class="p">:</span>
                            <span class="n">processed_instance</span><span class="p">[</span><span class="s2">&quot;file_contents&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid file source </span><span class="si">{</span><span class="n">file_source</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                        <span class="c1"># Handle context length limits</span>
                        <span class="k">if</span> <span class="n">max_context_len</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">cur_input_len</span> <span class="o">=</span> <span class="n">base_text_input_length</span>
                            <span class="n">include_files</span> <span class="o">=</span> <span class="p">[]</span>
                            <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="p">[</span>
                                <span class="n">x</span><span class="p">[</span><span class="s2">&quot;docid&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">processed_instance</span><span class="p">[</span><span class="s2">&quot;hits&quot;</span><span class="p">]</span>
                            <span class="p">]:</span>
                                <span class="n">content</span> <span class="o">=</span> <span class="n">make_code_text</span><span class="p">(</span>
                                    <span class="p">{</span>
                                        <span class="n">filename</span><span class="p">:</span> <span class="n">processed_instance</span><span class="p">[</span><span class="s2">&quot;file_contents&quot;</span><span class="p">][</span>
                                            <span class="n">filename</span>
                                        <span class="p">]</span>
                                    <span class="p">}</span>
                                <span class="p">)</span>
                                <span class="k">if</span> <span class="n">tokenizer_name</span> <span class="o">==</span> <span class="s2">&quot;llama&quot;</span><span class="p">:</span>
                                    <span class="n">tokens</span> <span class="o">=</span> <span class="n">tokenizer_func</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">content</span><span class="p">,</span> <span class="n">tokenizer</span><span class="p">)</span>
                                    <span class="n">idx</span> <span class="o">=</span> <span class="n">tokens</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="mi">13</span><span class="p">)</span>
                                    <span class="n">tokens</span> <span class="o">=</span> <span class="n">tokens</span><span class="p">[</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">:]</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">tokens</span> <span class="o">=</span> <span class="n">tokenizer_func</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="n">tokenizer</span><span class="p">)</span>
                                <span class="k">if</span> <span class="n">cur_input_len</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">max_context_len</span><span class="p">:</span>
                                    <span class="n">include_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
                                    <span class="n">cur_input_len</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span>
                            <span class="n">processed_instance</span><span class="p">[</span><span class="s2">&quot;file_contents&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                                <span class="n">filename</span><span class="p">:</span> <span class="n">processed_instance</span><span class="p">[</span><span class="s2">&quot;file_contents&quot;</span><span class="p">][</span><span class="n">filename</span><span class="p">]</span>
                                <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">include_files</span>
                            <span class="p">}</span>

                        <span class="c1"># Generate final text inputs</span>
                        <span class="n">processed_instance</span><span class="p">[</span><span class="s2">&quot;text_inputs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">PROMPT_FUNCTIONS</span><span class="p">[</span>
                            <span class="n">prompt_style</span>
                        <span class="p">](</span><span class="n">processed_instance</span><span class="p">)</span>

                        <span class="c1"># Save to progress file</span>
                        <span class="n">progress_file_handle</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                            <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">processed_instance</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
                        <span class="p">)</span>
                        <span class="n">progress_file_handle</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed on instance </span><span class="si">{</span><span class="n">instance_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
                    <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
                    <span class="c1"># Save failed instance</span>
                    <span class="n">failed_instance</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">instance</span><span class="p">,</span> <span class="s2">&quot;text_inputs&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}</span>
                    <span class="n">progress_file_handle</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">failed_instance</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">progress_file_handle</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
                <span class="k">finally</span><span class="p">:</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">orig_dir</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">orig_dir</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">progress_file_handle</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h5 id="swebench.inference.make_datasets.create_text_dataset" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <span class="doc doc-object-name doc-module-name">create_text_dataset</span>


</h5>

    <div class="doc doc-contents ">

        <p>Create a dataset for text-to-text training from the raw task instance outputs.</p>









  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h6 id="swebench.inference.make_datasets.create_text_dataset.logger" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <span class="doc doc-object-name doc-attribute-name">logger</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-module-attribute"><code>module-attribute</code></small>
  </span>

</h6>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">logger</span> <span class="o">=</span> <span class="n"><span title="logging.getLogger">getLogger</span></span><span class="p">(</span><span class="n"><span title="__name__">__name__</span></span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h6 id="swebench.inference.make_datasets.create_text_dataset.parser" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <span class="doc doc-object-name doc-attribute-name">parser</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-module-attribute"><code>module-attribute</code></small>
  </span>

</h6>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">parser</span> <span class="o">=</span> <span class="n"><span title="argparse.ArgumentParser">ArgumentParser</span></span><span class="p">(</span><span class="n"><span title="argparse.ArgumentParser(description)">description</span></span><span class="o">=</span><span class="n"><span title="__doc__">__doc__</span></span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

    </div>

</div>



<div class="doc doc-object doc-function">


<h6 id="swebench.inference.make_datasets.create_text_dataset.load_jsonl_file" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>            <span class="doc doc-object-name doc-function-name">load_jsonl_file</span>


</h6>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">load_jsonl_file</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">


            <details class="quote">
              <summary>Source code in <code>swebench/inference/make_datasets/create_text_dataset.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">load_jsonl_file</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">filename</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.jsonl&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">filename</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.jsonl.all&quot;</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">filename</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.json&quot;</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown file type </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h6 id="swebench.inference.make_datasets.create_text_dataset.instances_generator" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>            <span class="doc doc-object-name doc-function-name">instances_generator</span>


</h6>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">instances_generator</span><span class="p">(</span><span class="n">files</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">


            <details class="quote">
              <summary>Source code in <code>swebench/inference/make_datasets/create_text_dataset.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">instances_generator</span><span class="p">(</span><span class="n">files</span><span class="p">):</span>
    <span class="n">all_data</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Loading instance files&quot;</span><span class="p">):</span>
        <span class="n">all_data</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">load_jsonl_file</span><span class="p">(</span><span class="n">file</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">all_data</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h6 id="swebench.inference.make_datasets.create_text_dataset.get_training_and_eval_instances" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>            <span class="doc doc-object-name doc-function-name">get_training_and_eval_instances</span>


</h6>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">get_training_and_eval_instances</span><span class="p">(</span><span class="n">raw_files</span><span class="p">,</span> <span class="n">test_dataset</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">


            <details class="quote">
              <summary>Source code in <code>swebench/inference/make_datasets/create_text_dataset.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_training_and_eval_instances</span><span class="p">(</span><span class="n">raw_files</span><span class="p">,</span> <span class="n">test_dataset</span><span class="p">):</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Loading instances&quot;</span><span class="p">)</span>
    <span class="n">raw_instances</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">instances_generator</span><span class="p">(</span><span class="n">raw_files</span><span class="p">))</span>
    <span class="n">final_instances</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">test_dataset</span><span class="p">[</span><span class="s2">&quot;test&quot;</span><span class="p">])</span>
    <span class="n">eval_repos</span> <span class="o">=</span> <span class="p">{</span><span class="n">x</span><span class="p">[</span><span class="s2">&quot;repo&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">final_instances</span><span class="p">}</span>
    <span class="n">train_instances</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">raw_instances</span> <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;repo&quot;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">eval_repos</span><span class="p">]</span>
    <span class="n">train_instances</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">train_instances</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;instance_id&quot;</span><span class="p">]))</span>
    <span class="n">eval_instances</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">final_instances</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;instance_id&quot;</span><span class="p">]))</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">train_instances</span><span class="p">)</span><span class="si">}</span><span class="s2"> training ids&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">eval_instances</span><span class="p">)</span><span class="si">}</span><span class="s2"> eval ids&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">train_instances</span><span class="p">,</span> <span class="n">eval_instances</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h6 id="swebench.inference.make_datasets.create_text_dataset.extract_fields" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>            <span class="doc doc-object-name doc-function-name">extract_fields</span>


</h6>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">extract_fields</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">


            <details class="quote">
              <summary>Source code in <code>swebench/inference/make_datasets/create_text_dataset.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">extract_fields</span><span class="p">(</span><span class="n">instance</span><span class="p">):</span>
    <span class="n">instance_id</span> <span class="o">=</span> <span class="n">instance</span><span class="p">[</span><span class="s2">&quot;instance_id&quot;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">instance</span><span class="p">[</span><span class="s2">&quot;text_inputs&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">instance</span><span class="p">[</span><span class="s2">&quot;patch&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No text for </span><span class="si">{</span><span class="n">instance_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="n">text_inputs</span> <span class="o">=</span> <span class="n">instance</span><span class="p">[</span><span class="s2">&quot;text_inputs&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span>
    <span class="k">if</span> <span class="n">text_inputs</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">instance</span><span class="p">[</span><span class="s2">&quot;patch&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No inputs for </span><span class="si">{</span><span class="n">instance_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="n">patch</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s2">&quot;&lt;patch&gt;&quot;</span><span class="p">,</span> <span class="n">instance</span><span class="p">[</span><span class="s2">&quot;patch&quot;</span><span class="p">],</span> <span class="s2">&quot;&lt;/patch&gt;&quot;</span><span class="p">])</span>
    <span class="k">return</span> <span class="p">{</span><span class="o">**</span><span class="n">instance</span><span class="p">,</span> <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="n">text_inputs</span><span class="p">,</span> <span class="s2">&quot;patch&quot;</span><span class="p">:</span> <span class="n">patch</span><span class="p">}</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h6 id="swebench.inference.make_datasets.create_text_dataset.validate_arguments" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>            <span class="doc doc-object-name doc-function-name">validate_arguments</span>


</h6>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">validate_arguments</span><span class="p">(</span><span class="n">push_to_hub_user</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">,</span> <span class="n">max_context_len</span><span class="p">,</span> <span class="n">tokenizer_name</span><span class="p">,</span> <span class="n">file_source</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Validate command line arguments and environment setup.</p>


            <details class="quote">
              <summary>Source code in <code>swebench/inference/make_datasets/create_text_dataset.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span>
<span class="normal">90</span>
<span class="normal">91</span>
<span class="normal">92</span>
<span class="normal">93</span>
<span class="normal">94</span>
<span class="normal">95</span>
<span class="normal">96</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">validate_arguments</span><span class="p">(</span>
    <span class="n">push_to_hub_user</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">,</span> <span class="n">max_context_len</span><span class="p">,</span> <span class="n">tokenizer_name</span><span class="p">,</span> <span class="n">file_source</span><span class="p">,</span> <span class="n">k</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Validate command line arguments and environment setup.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">push_to_hub_user</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">hub_token</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;HUGGING_FACE_HUB_TOKEN&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">hub_token</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="p">(</span>
            <span class="s2">&quot;Must provide HUGGING_FACE_HUB_TOKEN to push to the Hub&quot;</span>
        <span class="p">)</span>
        <span class="k">assert</span> <span class="n">output_dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Cannot provide output_dir if pushing to the Hub&quot;</span>
    <span class="k">if</span> <span class="n">max_context_len</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">tokenizer_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">push_to_hub_user</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">Path</span><span class="p">(</span><span class="n">output_dir</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
        <span class="n">Path</span><span class="p">(</span><span class="n">output_dir</span><span class="p">)</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">max_context_len</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">file_source</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;all&quot;</span><span class="p">,</span> <span class="s2">&quot;oracle&quot;</span><span class="p">},</span> <span class="p">(</span>
            <span class="s2">&quot;Cannot use max_context_len with oracle or all file sources&quot;</span>
        <span class="p">)</span>
        <span class="k">assert</span> <span class="n">tokenizer_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="p">(</span>
            <span class="s2">&quot;Must provide tokenizer_name if max_context_len is not None&quot;</span>
        <span class="p">)</span>
    <span class="k">if</span> <span class="n">k</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">file_source</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;all&quot;</span><span class="p">,</span> <span class="s2">&quot;oracle&quot;</span><span class="p">},</span> <span class="p">(</span>
            <span class="s2">&quot;Cannot use max_context_len with oracle or all file sources&quot;</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="n">hub_token</span> <span class="k">if</span> <span class="n">push_to_hub_user</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h6 id="swebench.inference.make_datasets.create_text_dataset.construct_output_filename" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>            <span class="doc doc-object-name doc-function-name">construct_output_filename</span>


</h6>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">construct_output_filename</span><span class="p">(</span><span class="n">dataset_name</span><span class="p">,</span> <span class="n">prompt_style</span><span class="p">,</span> <span class="n">file_source</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">max_context_len</span><span class="p">,</span> <span class="n">tokenizer_name</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Construct the output filename based on parameters.</p>


            <details class="quote">
              <summary>Source code in <code>swebench/inference/make_datasets/create_text_dataset.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">construct_output_filename</span><span class="p">(</span>
    <span class="n">dataset_name</span><span class="p">,</span> <span class="n">prompt_style</span><span class="p">,</span> <span class="n">file_source</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">max_context_len</span><span class="p">,</span> <span class="n">tokenizer_name</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Construct the output filename based on parameters.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">dataset_name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;princeton-nlp&quot;</span><span class="p">):</span>
        <span class="n">dataset_name</span> <span class="o">=</span> <span class="n">dataset_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">dataset_name</span> <span class="o">=</span> <span class="n">dataset_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="s2">&quot;__&quot;</span><span class="p">)</span>
    <span class="n">output_file</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">dataset_name</span><span class="si">}</span><span class="s2">__</span><span class="si">{</span><span class="n">prompt_style</span><span class="si">}</span><span class="s2">__fs-</span><span class="si">{</span><span class="n">file_source</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">if</span> <span class="n">k</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">output_file</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;__k-</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">if</span> <span class="n">max_context_len</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">output_file</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;__mcc-</span><span class="si">{</span><span class="n">max_context_len</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">tokenizer_name</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">return</span> <span class="n">output_file</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h6 id="swebench.inference.make_datasets.create_text_dataset.main" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>            <span class="doc doc-object-name doc-function-name">main</span>


</h6>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">main</span><span class="p">(</span><span class="n">dataset_name_or_path</span><span class="p">,</span> <span class="n">splits</span><span class="p">,</span> <span class="n">validation_ratio</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">,</span> <span class="n">retrieval_file</span><span class="p">,</span> <span class="n">prompt_style</span><span class="p">,</span> <span class="n">file_source</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">max_context_len</span><span class="p">,</span> <span class="n">tokenizer_name</span><span class="p">,</span> <span class="n">push_to_hub_user</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">


            <details class="quote">
              <summary>Source code in <code>swebench/inference/make_datasets/create_text_dataset.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span>
    <span class="n">dataset_name_or_path</span><span class="p">,</span>
    <span class="n">splits</span><span class="p">,</span>
    <span class="n">validation_ratio</span><span class="p">,</span>
    <span class="n">output_dir</span><span class="p">,</span>
    <span class="n">retrieval_file</span><span class="p">,</span>
    <span class="n">prompt_style</span><span class="p">,</span>
    <span class="n">file_source</span><span class="p">,</span>
    <span class="n">k</span><span class="p">,</span>
    <span class="n">max_context_len</span><span class="p">,</span>
    <span class="n">tokenizer_name</span><span class="p">,</span>
    <span class="n">push_to_hub_user</span><span class="p">,</span>
<span class="p">):</span>
    <span class="c1"># Validate arguments and setup</span>
    <span class="n">hub_token</span> <span class="o">=</span> <span class="n">validate_arguments</span><span class="p">(</span>
        <span class="n">push_to_hub_user</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">,</span> <span class="n">max_context_len</span><span class="p">,</span> <span class="n">tokenizer_name</span><span class="p">,</span> <span class="n">file_source</span><span class="p">,</span> <span class="n">k</span>
    <span class="p">)</span>
    <span class="n">output_file</span> <span class="o">=</span> <span class="n">construct_output_filename</span><span class="p">(</span>
        <span class="n">dataset_name_or_path</span><span class="p">,</span>
        <span class="n">prompt_style</span><span class="p">,</span>
        <span class="n">file_source</span><span class="p">,</span>
        <span class="n">k</span><span class="p">,</span>
        <span class="n">max_context_len</span><span class="p">,</span>
        <span class="n">tokenizer_name</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">output_file</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">output_file</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">push_to_hub_user</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">output_file</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="n">existing_dataset</span> <span class="o">=</span> <span class="n">load_from_disk</span><span class="p">(</span><span class="n">output_file</span><span class="p">)</span>
            <span class="c1"># if requested splits are in existing dataset, abort</span>
            <span class="k">for</span> <span class="n">split</span> <span class="ow">in</span> <span class="n">splits</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">split</span> <span class="ow">in</span> <span class="n">existing_dataset</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">output_file</span><span class="o">.</span><span class="n">absolute</span><span class="p">()</span><span class="o">.</span><span class="n">as_posix</span><span class="p">()</span><span class="si">}</span><span class="s2"> already exists for split </span><span class="si">{</span><span class="n">split</span><span class="si">}</span><span class="s2">. Aborting&quot;</span>
                    <span class="p">)</span>
                    <span class="k">return</span>
            <span class="k">del</span> <span class="n">existing_dataset</span>  <span class="c1"># don&#39;t store in memory</span>

    <span class="c1"># Load dataset</span>
    <span class="n">dataset</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">load_from_disk</span><span class="p">(</span><span class="n">dataset_name_or_path</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">Path</span><span class="p">(</span><span class="n">dataset_name_or_path</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span>
        <span class="k">else</span> <span class="n">load_dataset</span><span class="p">(</span><span class="n">dataset_name_or_path</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="nb">set</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="si">}</span><span class="s2"> splits&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">set</span><span class="p">(</span><span class="n">splits</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">!=</span> <span class="nb">set</span><span class="p">():</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown splits </span><span class="si">{</span><span class="nb">set</span><span class="p">(</span><span class="n">splits</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nb">set</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Define columns for final dataset</span>
    <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;instance_id&quot;</span><span class="p">,</span>
        <span class="s2">&quot;text&quot;</span><span class="p">,</span>
        <span class="s2">&quot;repo&quot;</span><span class="p">,</span>
        <span class="s2">&quot;base_commit&quot;</span><span class="p">,</span>
        <span class="s2">&quot;problem_statement&quot;</span><span class="p">,</span>
        <span class="s2">&quot;hints_text&quot;</span><span class="p">,</span>
        <span class="s2">&quot;created_at&quot;</span><span class="p">,</span>
        <span class="s2">&quot;patch&quot;</span><span class="p">,</span>
        <span class="s2">&quot;test_patch&quot;</span><span class="p">,</span>
        <span class="s2">&quot;version&quot;</span><span class="p">,</span>
        <span class="s2">&quot;FAIL_TO_PASS&quot;</span><span class="p">,</span>
        <span class="s2">&quot;PASS_TO_PASS&quot;</span><span class="p">,</span>
        <span class="s2">&quot;environment_setup_commit&quot;</span><span class="p">,</span>
    <span class="p">]</span>

    <span class="c1"># Process each split</span>
    <span class="n">split_data</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">progress_files</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">split</span> <span class="ow">in</span> <span class="n">splits</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processing </span><span class="si">{</span><span class="n">split</span><span class="si">}</span><span class="s2"> split&quot;</span><span class="p">)</span>
        <span class="n">split_instances</span> <span class="o">=</span> <span class="p">{</span><span class="n">x</span><span class="p">[</span><span class="s2">&quot;instance_id&quot;</span><span class="p">]:</span> <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">dataset</span><span class="p">[</span><span class="n">split</span><span class="p">]}</span>
        <span class="n">progress_file</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">output_file</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">split</span><span class="si">}</span><span class="s2">.progress.jsonl&quot;</span>
        <span class="n">progress_files</span><span class="p">[</span><span class="n">split</span><span class="p">]</span> <span class="o">=</span> <span class="n">progress_file</span>
        <span class="c1"># Process instances and save to progress file</span>
        <span class="n">add_text_inputs</span><span class="p">(</span>
            <span class="n">split_instances</span><span class="p">,</span>
            <span class="n">retrieval_file</span><span class="o">=</span><span class="n">retrieval_file</span><span class="p">,</span>
            <span class="n">k</span><span class="o">=</span><span class="n">k</span><span class="p">,</span>
            <span class="n">prompt_style</span><span class="o">=</span><span class="n">prompt_style</span><span class="p">,</span>
            <span class="n">file_source</span><span class="o">=</span><span class="n">file_source</span><span class="p">,</span>
            <span class="n">max_context_len</span><span class="o">=</span><span class="n">max_context_len</span><span class="p">,</span>
            <span class="n">tokenizer_name</span><span class="o">=</span><span class="n">tokenizer_name</span><span class="p">,</span>
            <span class="n">progress_file</span><span class="o">=</span><span class="n">progress_file</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Creating final dataset&quot;</span><span class="p">)</span>
    <span class="c1"># Create final dataset</span>
    <span class="k">if</span> <span class="n">output_file</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
        <span class="n">final_dataset</span> <span class="o">=</span> <span class="n">load_from_disk</span><span class="p">(</span><span class="n">output_file</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">final_dataset</span> <span class="o">=</span> <span class="n">DatasetDict</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">split</span> <span class="ow">in</span> <span class="n">splits</span><span class="p">:</span>
        <span class="n">split_data</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="p">[]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">}</span>
        <span class="n">valid_instance_ids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">dataset</span><span class="p">[</span><span class="n">split</span><span class="p">][</span><span class="s2">&quot;instance_id&quot;</span><span class="p">])</span>
        <span class="n">invalid_instances</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">progress_files</span><span class="p">[</span><span class="n">split</span><span class="p">])</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">datum</span> <span class="o">=</span> <span class="n">extract_fields</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">line</span><span class="p">))</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">datum</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="n">datum</span><span class="p">[</span><span class="s2">&quot;instance_id&quot;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">valid_instance_ids</span><span class="p">:</span>
                    <span class="n">invalid_instances</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">datum</span><span class="p">[</span><span class="s2">&quot;instance_id&quot;</span><span class="p">])</span>
                    <span class="k">continue</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">:</span>
                    <span class="n">split_data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">datum</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">invalid_instances</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">invalid_instances</span><span class="p">)</span><span class="si">}</span><span class="s2"> instances in progress file that are not in the </span><span class="si">{</span><span class="n">split</span><span class="si">}</span><span class="s2"> dataset: </span><span class="si">{</span><span class="n">invalid_instances</span><span class="si">}</span><span class="s2">. These will be removed from the final dataset.&quot;</span>
            <span class="p">)</span>

        <span class="n">final_dataset</span><span class="p">[</span><span class="n">split</span><span class="p">]</span> <span class="o">=</span> <span class="n">Dataset</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">split_data</span><span class="p">)</span>

    <span class="c1"># Handle validation split</span>
    <span class="k">if</span> <span class="n">validation_ratio</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="s2">&quot;train&quot;</span> <span class="ow">in</span> <span class="n">final_dataset</span><span class="p">:</span>
        <span class="n">train_val</span> <span class="o">=</span> <span class="n">final_dataset</span><span class="p">[</span><span class="s2">&quot;train&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">train_test_split</span><span class="p">(</span>
            <span class="n">test_size</span><span class="o">=</span><span class="n">validation_ratio</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">42</span>
        <span class="p">)</span>
        <span class="n">final_dataset</span><span class="p">[</span><span class="s2">&quot;train&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">train_val</span><span class="p">[</span><span class="s2">&quot;train&quot;</span><span class="p">]</span>
        <span class="n">final_dataset</span><span class="p">[</span><span class="s2">&quot;validation&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">train_val</span><span class="p">[</span><span class="s2">&quot;test&quot;</span><span class="p">]</span>

    <span class="c1"># Log final dataset sizes</span>
    <span class="k">for</span> <span class="n">split</span> <span class="ow">in</span> <span class="n">final_dataset</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">final_dataset</span><span class="p">[</span><span class="n">split</span><span class="p">])</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">split</span><span class="si">}</span><span class="s2"> instances&quot;</span><span class="p">)</span>

    <span class="c1"># Save dataset</span>
    <span class="k">if</span> <span class="n">push_to_hub_user</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">final_dataset</span><span class="o">.</span><span class="n">push_to_hub</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">push_to_hub_user</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">output_file</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">use_auth_token</span><span class="o">=</span><span class="n">hub_token</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">final_dataset</span><span class="o">.</span><span class="n">save_to_disk</span><span class="p">(</span><span class="n">output_file</span><span class="p">)</span>

    <span class="c1"># Cleanup progress files</span>
    <span class="k">for</span> <span class="n">progress_file</span> <span class="ow">in</span> <span class="n">progress_files</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">progress_file</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">progress_file</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Finished saving to </span><span class="si">{</span><span class="n">output_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h5 id="swebench.inference.make_datasets.eval_retrieval" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <span class="doc doc-object-name doc-module-name">eval_retrieval</span>


</h5>

    <div class="doc doc-contents ">

        <p>This script can be used to evaluate the BM25 retrieval results for a dataset created with create_text_dataset.py with the --retrieval_file option and --file_source bm25.</p>









  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h6 id="swebench.inference.make_datasets.eval_retrieval.logger" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <span class="doc doc-object-name doc-attribute-name">logger</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-module-attribute"><code>module-attribute</code></small>
  </span>

</h6>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">logger</span> <span class="o">=</span> <span class="n"><span title="logging.getLogger">getLogger</span></span><span class="p">(</span><span class="n"><span title="__name__">__name__</span></span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h6 id="swebench.inference.make_datasets.eval_retrieval.parser" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <span class="doc doc-object-name doc-attribute-name">parser</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-module-attribute"><code>module-attribute</code></small>
  </span>

</h6>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">parser</span> <span class="o">=</span> <span class="n"><span title="argparse.ArgumentParser">ArgumentParser</span></span><span class="p">(</span><span class="n"><span title="argparse.ArgumentParser(description)">description</span></span><span class="o">=</span><span class="n"><span title="__doc__">__doc__</span></span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h6 id="swebench.inference.make_datasets.eval_retrieval.args" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <span class="doc doc-object-name doc-attribute-name">args</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-module-attribute"><code>module-attribute</code></small>
  </span>

</h6>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">args</span> <span class="o">=</span> <span class="n"><span title="swebench.inference.make_datasets.eval_retrieval.parser.parse_args">parse_args</span></span><span class="p">()</span>
</code></pre></div>

    <div class="doc doc-contents ">

    </div>

</div>



<div class="doc doc-object doc-function">


<h6 id="swebench.inference.make_datasets.eval_retrieval.main" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>            <span class="doc doc-object-name doc-function-name">main</span>


</h6>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">main</span><span class="p">(</span><span class="n">dataset_name_or_path</span><span class="p">,</span> <span class="n">split</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">


            <details class="quote">
              <summary>Source code in <code>swebench/inference/make_datasets/eval_retrieval.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">dataset_name_or_path</span><span class="p">,</span> <span class="n">split</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">dataset</span> <span class="o">=</span> <span class="n">load_from_disk</span><span class="p">(</span><span class="n">dataset_name_or_path</span><span class="p">)[</span><span class="n">split</span><span class="p">]</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">dataset</span> <span class="o">=</span> <span class="n">load_dataset</span><span class="p">(</span><span class="n">dataset_name_or_path</span><span class="p">,</span> <span class="n">split</span><span class="o">=</span><span class="n">split</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;Evaluating </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span><span class="si">}</span><span class="s2"> instances from </span><span class="si">{</span><span class="n">dataset_name_or_path</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">split</span><span class="si">}</span><span class="s2"> split&quot;</span>
    <span class="p">)</span>
    <span class="n">instance_files_pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
        <span class="sa">r</span><span class="s2">&quot;\[start of ([\w\.\-\/]+)\]\n(?:.+?)\n\[end of \1\]&quot;</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">DOTALL</span>
    <span class="p">)</span>
    <span class="n">patch_files_pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\-\-\- a/(.+)&quot;</span><span class="p">)</span>
    <span class="n">patch_files</span> <span class="o">=</span> <span class="p">{</span><span class="n">instance</span><span class="p">[</span><span class="s2">&quot;instance_id&quot;</span><span class="p">]:</span> <span class="n">instance</span><span class="p">[</span><span class="s2">&quot;patch&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">instance</span> <span class="ow">in</span> <span class="n">dataset</span><span class="p">}</span>
    <span class="n">recalls_any</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="n">recalls_all</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="n">recalls</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">datum</span> <span class="ow">in</span> <span class="n">dataset</span><span class="p">:</span>
        <span class="n">instance_id</span> <span class="o">=</span> <span class="n">datum</span><span class="p">[</span><span class="s2">&quot;instance_id&quot;</span><span class="p">]</span>
        <span class="n">retrieved_files</span> <span class="o">=</span> <span class="n">instance_files_pattern</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">datum</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">retrieved_files</span> <span class="ow">and</span> <span class="s2">&quot;readme&quot;</span> <span class="ow">in</span> <span class="n">retrieved_files</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
            <span class="n">retrieved_files</span> <span class="o">=</span> <span class="n">retrieved_files</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="n">retrieved_files</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">retrieved_files</span><span class="p">)</span>
        <span class="n">gold_files</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">patch_files_pattern</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">patch_files</span><span class="p">[</span><span class="n">instance_id</span><span class="p">]))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">gold_files</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;WARNING: Instance </span><span class="si">{</span><span class="n">datum</span><span class="p">[</span><span class="s1">&#39;instance_id&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> has no gold files&quot;</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">retrieved_files</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;WARNING: Instance </span><span class="si">{</span><span class="n">datum</span><span class="p">[</span><span class="s1">&#39;instance_id&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> has no retrieved files&quot;</span><span class="p">)</span>
            <span class="n">recall</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">recall</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">retrieved_files</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">gold_files</span><span class="p">))</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">gold_files</span><span class="p">)</span>
        <span class="n">recalls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">recall</span><span class="p">)</span>
        <span class="n">recalls_any</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">recall</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))</span>
        <span class="n">recalls_all</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">recall</span> <span class="o">==</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">recalls</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">recalls</span><span class="p">)</span>
    <span class="n">recalls_any</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">recalls_any</span><span class="p">)</span>
    <span class="n">recalls_all</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">recalls_all</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Avg Recall: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">recalls</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;All Recall: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">recalls_all</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Any Recall: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">recalls_any</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h5 id="swebench.inference.make_datasets.tokenize_dataset" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <span class="doc doc-object-name doc-module-name">tokenize_dataset</span>


</h5>

    <div class="doc doc-contents ">

        <p>Provided a source (raw) directory and the final (eval) directory, create a training split by removing all instances that are in the final directory from the source directory.</p>









  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h6 id="swebench.inference.make_datasets.tokenize_dataset.logger" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <span class="doc doc-object-name doc-attribute-name">logger</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-module-attribute"><code>module-attribute</code></small>
  </span>

</h6>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">logger</span> <span class="o">=</span> <span class="n"><span title="logging.getLogger">getLogger</span></span><span class="p">(</span><span class="n"><span title="__name__">__name__</span></span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h6 id="swebench.inference.make_datasets.tokenize_dataset.TOKENIZER_FUNCS" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <span class="doc doc-object-name doc-attribute-name">TOKENIZER_FUNCS</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-module-attribute"><code>module-attribute</code></small>
  </span>

</h6>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">TOKENIZER_FUNCS</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;cl100k&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n"><span title="tiktoken.get_encoding">get_encoding</span></span><span class="p">(</span><span class="s1">&#39;cl100k_base&#39;</span><span class="p">),</span> <span class="n"><a class="autorefs autorefs-internal" title="            cl100k (swebench.inference.make_datasets.tokenize_dataset.cl100k)" href="#swebench.inference.make_datasets.tokenize_dataset.cl100k">cl100k</a></span><span class="p">),</span> <span class="s1">&#39;llama&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n"><span title="transformers.LlamaTokenizer.from_pretrained">from_pretrained</span></span><span class="p">(</span><span class="s1">&#39;togethercomputer/LLaMA-2-7B-32K&#39;</span><span class="p">),</span> <span class="n"><a class="autorefs autorefs-internal" title="            llama (swebench.inference.make_datasets.tokenize_dataset.llama)" href="#swebench.inference.make_datasets.tokenize_dataset.llama">llama</a></span><span class="p">)}</span>
</code></pre></div>

    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h6 id="swebench.inference.make_datasets.tokenize_dataset.parser" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <span class="doc doc-object-name doc-attribute-name">parser</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-module-attribute"><code>module-attribute</code></small>
  </span>

</h6>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">parser</span> <span class="o">=</span> <span class="n"><span title="argparse.ArgumentParser">ArgumentParser</span></span><span class="p">(</span><span class="n"><span title="argparse.ArgumentParser(description)">description</span></span><span class="o">=</span><span class="n"><span title="__doc__">__doc__</span></span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

    </div>

</div>



<div class="doc doc-object doc-function">


<h6 id="swebench.inference.make_datasets.tokenize_dataset.cl100k" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>            <span class="doc doc-object-name doc-function-name">cl100k</span>


</h6>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">cl100k</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">tokenizer</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">


            <details class="quote">
              <summary>Source code in <code>swebench/inference/make_datasets/tokenize_dataset.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">21</span>
<span class="normal">22</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">cl100k</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">tokenizer</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">tokenizer</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">disallowed_special</span><span class="o">=</span><span class="p">())</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h6 id="swebench.inference.make_datasets.tokenize_dataset.llama" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>            <span class="doc doc-object-name doc-function-name">llama</span>


</h6>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">llama</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">tokenizer</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">


            <details class="quote">
              <summary>Source code in <code>swebench/inference/make_datasets/tokenize_dataset.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">llama</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">tokenizer</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">tokenizer</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">add_special_tokens</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">return_attention_mask</span><span class="o">=</span><span class="kc">False</span><span class="p">)[</span>
        <span class="s2">&quot;input_ids&quot;</span>
    <span class="p">]</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h6 id="swebench.inference.make_datasets.tokenize_dataset.extract_fields" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>            <span class="doc doc-object-name doc-function-name">extract_fields</span>


</h6>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">extract_fields</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">tokenizer_name</span><span class="p">,</span> <span class="n">tokenizer</span><span class="p">,</span> <span class="n">tokenizer_func</span><span class="p">,</span> <span class="n">eos_token</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">


            <details class="quote">
              <summary>Source code in <code>swebench/inference/make_datasets/tokenize_dataset.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">extract_fields</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">tokenizer_name</span><span class="p">,</span> <span class="n">tokenizer</span><span class="p">,</span> <span class="n">tokenizer_func</span><span class="p">,</span> <span class="n">eos_token</span><span class="p">):</span>
    <span class="n">instance_id</span> <span class="o">=</span> <span class="n">instance</span><span class="p">[</span><span class="s2">&quot;instance_id&quot;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">instance</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">instance</span><span class="p">[</span><span class="s2">&quot;patch&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No text for </span><span class="si">{</span><span class="n">instance_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;input_ids&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;labels&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;patch&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">}</span>
    <span class="n">text_inputs</span> <span class="o">=</span> <span class="n">instance</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="k">if</span> <span class="n">text_inputs</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">instance</span><span class="p">[</span><span class="s2">&quot;patch&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No inputs for </span><span class="si">{</span><span class="n">instance_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="n">patch</span> <span class="o">=</span> <span class="n">instance</span><span class="p">[</span><span class="s2">&quot;patch&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">eos_token</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">patch</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="n">eos_token</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">input_ids</span> <span class="o">=</span> <span class="n">tokenizer_func</span><span class="p">(</span><span class="n">text_inputs</span><span class="p">,</span> <span class="n">tokenizer</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">tokenizer_name</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;llama&quot;</span><span class="p">}:</span>
        <span class="n">label_ids</span> <span class="o">=</span> <span class="n">tokenizer_func</span><span class="p">(</span>
            <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">patch</span><span class="p">,</span> <span class="n">tokenizer</span>
        <span class="p">)</span>  <span class="c1"># add newline to tokenize patch</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">label_ids</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="mi">13</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">idx</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">,</span> <span class="p">(</span>
            <span class="s2">&quot;Expected newline token id (13) to be one of the first three tokens&quot;</span>
        <span class="p">)</span>
        <span class="n">label_ids</span> <span class="o">=</span> <span class="n">label_ids</span><span class="p">[</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">:]</span>  <span class="c1"># remove newline tokens</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">label_ids</span> <span class="o">=</span> <span class="n">tokenizer_func</span><span class="p">(</span><span class="n">patch</span><span class="p">,</span> <span class="n">tokenizer</span><span class="p">)</span>
    <span class="n">inputs</span> <span class="o">=</span> <span class="n">input_ids</span> <span class="o">+</span> <span class="n">label_ids</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">cond_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">input_ids</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">100</span><span class="p">]</span> <span class="o">*</span> <span class="n">cond_len</span> <span class="o">+</span> <span class="n">label_ids</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="o">**</span><span class="n">instance</span><span class="p">,</span>
        <span class="s2">&quot;input_ids&quot;</span><span class="p">:</span> <span class="n">inputs</span><span class="p">,</span>
        <span class="s2">&quot;labels&quot;</span><span class="p">:</span> <span class="n">labels</span><span class="p">,</span>
        <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="n">text_inputs</span><span class="p">,</span>
        <span class="s2">&quot;patch&quot;</span><span class="p">:</span> <span class="n">patch</span><span class="p">,</span>
    <span class="p">}</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h6 id="swebench.inference.make_datasets.tokenize_dataset.extract_test_fields" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>            <span class="doc doc-object-name doc-function-name">extract_test_fields</span>


</h6>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">extract_test_fields</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">tokenizer_name</span><span class="p">,</span> <span class="n">tokenizer</span><span class="p">,</span> <span class="n">tokenizer_func</span><span class="p">,</span> <span class="n">eos_token</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">


            <details class="quote">
              <summary>Source code in <code>swebench/inference/make_datasets/tokenize_dataset.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span>
<span class="normal">90</span>
<span class="normal">91</span>
<span class="normal">92</span>
<span class="normal">93</span>
<span class="normal">94</span>
<span class="normal">95</span>
<span class="normal">96</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">extract_test_fields</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">tokenizer_name</span><span class="p">,</span> <span class="n">tokenizer</span><span class="p">,</span> <span class="n">tokenizer_func</span><span class="p">,</span> <span class="n">eos_token</span><span class="p">):</span>
    <span class="n">instance_id</span> <span class="o">=</span> <span class="n">instance</span><span class="p">[</span><span class="s2">&quot;instance_id&quot;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">instance</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">instance</span><span class="p">[</span><span class="s2">&quot;patch&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No text for </span><span class="si">{</span><span class="n">instance_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="n">text_inputs</span> <span class="o">=</span> <span class="n">instance</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="k">if</span> <span class="n">text_inputs</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">instance</span><span class="p">[</span><span class="s2">&quot;patch&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No inputs for </span><span class="si">{</span><span class="n">instance_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="n">patch</span> <span class="o">=</span> <span class="n">instance</span><span class="p">[</span><span class="s2">&quot;patch&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">eos_token</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">patch</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="n">eos_token</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">input_ids</span> <span class="o">=</span> <span class="n">tokenizer_func</span><span class="p">(</span><span class="n">text_inputs</span><span class="p">,</span> <span class="n">tokenizer</span><span class="p">)</span>
    <span class="n">label_ids</span> <span class="o">=</span> <span class="n">tokenizer_func</span><span class="p">(</span><span class="n">patch</span><span class="p">,</span> <span class="n">tokenizer</span><span class="p">)</span>
    <span class="n">inputs</span> <span class="o">=</span> <span class="n">input_ids</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="n">label_ids</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="o">**</span><span class="n">instance</span><span class="p">,</span>
        <span class="s2">&quot;input_ids&quot;</span><span class="p">:</span> <span class="n">inputs</span><span class="p">,</span>
        <span class="s2">&quot;labels&quot;</span><span class="p">:</span> <span class="n">labels</span><span class="p">,</span>
        <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="n">text_inputs</span><span class="p">,</span>
        <span class="s2">&quot;patch&quot;</span><span class="p">:</span> <span class="n">patch</span><span class="p">,</span>
    <span class="p">}</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h6 id="swebench.inference.make_datasets.tokenize_dataset.add_columns_from_dict" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>            <span class="doc doc-object-name doc-function-name">add_columns_from_dict</span>


</h6>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">add_columns_from_dict</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">dict_columns</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>dict_columns is a list of dicts with keys that are columns in dataset</p>


            <details class="quote">
              <summary>Source code in <code>swebench/inference/make_datasets/tokenize_dataset.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">add_columns_from_dict</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">dict_columns</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;dict_columns is a list of dicts with keys that are columns in dataset&quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">dict_columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span><span class="p">[</span><span class="n">column</span><span class="p">]</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">dict_columns</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">dataset</span><span class="o">.</span><span class="n">column_names</span><span class="p">:</span>
            <span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">remove_columns</span><span class="p">(</span><span class="n">column</span><span class="p">)</span>
        <span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="n">column</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">dataset</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h6 id="swebench.inference.make_datasets.tokenize_dataset.main" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>            <span class="doc doc-object-name doc-function-name">main</span>


</h6>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">main</span><span class="p">(</span><span class="n">dataset_name_or_path</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">,</span> <span class="n">tokenizer_name</span><span class="p">,</span> <span class="n">num_proc</span><span class="p">,</span> <span class="n">push_to_hub_user</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">


            <details class="quote">
              <summary>Source code in <code>swebench/inference/make_datasets/tokenize_dataset.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span>
    <span class="n">dataset_name_or_path</span><span class="p">,</span>
    <span class="n">output_dir</span><span class="p">,</span>
    <span class="n">tokenizer_name</span><span class="p">,</span>
    <span class="n">num_proc</span><span class="p">,</span>
    <span class="n">push_to_hub_user</span><span class="p">,</span>
<span class="p">):</span>
    <span class="k">if</span> <span class="n">push_to_hub_user</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">hub_token</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;HUGGING_FACE_HUB_TOKEN&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">hub_token</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Must provide HUGGING_FACE_HUB_TOKEN to push to the Hub&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">Path</span><span class="p">(</span><span class="n">output_dir</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
        <span class="n">Path</span><span class="p">(</span><span class="n">output_dir</span><span class="p">)</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">tokenizer_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">tokenizer</span><span class="p">,</span> <span class="n">tokenizer_func</span> <span class="o">=</span> <span class="n">TOKENIZER_FUNCS</span><span class="p">[</span><span class="n">tokenizer_name</span><span class="p">]</span>
        <span class="n">eos_token</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">tokenizer</span><span class="p">,</span> <span class="s2">&quot;eos_token&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">num_proc</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">tokenizer_name</span> <span class="o">==</span> <span class="s2">&quot;cl100k&quot;</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;cl100k tokenizer does not support multiprocessing. Ignoring num_proc&quot;</span>
            <span class="p">)</span>
            <span class="n">num_proc</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">if</span> <span class="n">Path</span><span class="p">(</span><span class="n">dataset_name_or_path</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
        <span class="n">dataset</span> <span class="o">=</span> <span class="n">load_from_disk</span><span class="p">(</span><span class="n">dataset_name_or_path</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">dataset</span> <span class="o">=</span> <span class="n">load_dataset</span><span class="p">(</span><span class="n">dataset_name_or_path</span><span class="p">)</span>
    <span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
        <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">])</span> <span class="o">&lt;=</span> <span class="mi">5_000_000</span>
    <span class="p">)</span>  <span class="c1"># filter out superlong instances</span>
    <span class="k">for</span> <span class="n">split</span> <span class="ow">in</span> <span class="n">dataset</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">split</span> <span class="o">==</span> <span class="s2">&quot;test&quot;</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">num_proc</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">dataset</span><span class="p">[</span><span class="n">split</span><span class="p">]</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">[</span><span class="n">split</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span>
                <span class="k">lambda</span> <span class="n">instance</span><span class="p">:</span> <span class="n">extract_fields</span><span class="p">(</span>
                    <span class="n">instance</span><span class="p">,</span>
                    <span class="n">tokenizer_name</span><span class="p">,</span>
                    <span class="n">tokenizer</span><span class="p">,</span>
                    <span class="n">tokenizer_func</span><span class="p">,</span>
                    <span class="n">eos_token</span><span class="p">,</span>
                <span class="p">),</span>
                <span class="n">num_proc</span><span class="o">=</span><span class="n">num_proc</span><span class="p">,</span>
                <span class="n">batched</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">desc</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Tokenizing </span><span class="si">{</span><span class="n">split</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="p">[</span><span class="n">split</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">new_values</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
                <span class="nb">map</span><span class="p">(</span>
                    <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">extract_fields</span><span class="p">(</span>
                        <span class="n">x</span><span class="p">,</span> <span class="n">tokenizer_name</span><span class="p">,</span> <span class="n">tokenizer</span><span class="p">,</span> <span class="n">tokenizer_func</span><span class="p">,</span> <span class="n">eos_token</span>
                    <span class="p">),</span>
                    <span class="n">tqdm</span><span class="p">(</span>
                        <span class="n">dataset</span><span class="p">[</span><span class="n">split</span><span class="p">],</span>
                        <span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="p">[</span><span class="n">split</span><span class="p">]),</span>
                        <span class="n">desc</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Tokenizing </span><span class="si">{</span><span class="n">split</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="p">),</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="n">dataset</span><span class="p">[</span><span class="n">split</span><span class="p">]</span> <span class="o">=</span> <span class="n">add_columns_from_dict</span><span class="p">(</span><span class="n">dataset</span><span class="p">[</span><span class="n">split</span><span class="p">],</span> <span class="n">new_values</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">split</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;test&quot;</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">split</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dataset</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Split </span><span class="si">{</span><span class="n">split</span><span class="si">}</span><span class="s2"> not in dataset. Skipping&quot;</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">num_proc</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">dataset</span><span class="p">[</span><span class="n">split</span><span class="p">]</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">[</span><span class="n">split</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span>
                <span class="k">lambda</span> <span class="n">instance</span><span class="p">:</span> <span class="n">extract_test_fields</span><span class="p">(</span>
                    <span class="n">instance</span><span class="p">,</span>
                    <span class="n">tokenizer_name</span><span class="p">,</span>
                    <span class="n">tokenizer</span><span class="p">,</span>
                    <span class="n">tokenizer_func</span><span class="p">,</span>
                    <span class="n">eos_token</span><span class="p">,</span>
                <span class="p">),</span>
                <span class="n">num_proc</span><span class="o">=</span><span class="n">num_proc</span><span class="p">,</span>
                <span class="n">batched</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">desc</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Tokenizing </span><span class="si">{</span><span class="n">split</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="p">[</span><span class="n">split</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">new_values</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
                <span class="nb">map</span><span class="p">(</span>
                    <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">extract_test_fields</span><span class="p">(</span>
                        <span class="n">x</span><span class="p">,</span> <span class="n">tokenizer_name</span><span class="p">,</span> <span class="n">tokenizer</span><span class="p">,</span> <span class="n">tokenizer_func</span><span class="p">,</span> <span class="n">eos_token</span>
                    <span class="p">),</span>
                    <span class="n">tqdm</span><span class="p">(</span>
                        <span class="n">dataset</span><span class="p">[</span><span class="n">split</span><span class="p">],</span>
                        <span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="p">[</span><span class="n">split</span><span class="p">]),</span>
                        <span class="n">desc</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Tokenizing </span><span class="si">{</span><span class="n">split</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="p">),</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="n">dataset</span><span class="p">[</span><span class="n">split</span><span class="p">]</span> <span class="o">=</span> <span class="n">add_columns_from_dict</span><span class="p">(</span><span class="n">dataset</span><span class="p">[</span><span class="n">split</span><span class="p">],</span> <span class="n">new_values</span><span class="p">)</span>
    <span class="n">output_file</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">dataset_name_or_path</span><span class="p">)</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;__tok-</span><span class="si">{</span><span class="n">tokenizer_name</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">if</span> <span class="n">push_to_hub_user</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">output_file</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">push_to_hub_user</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">output_file</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">dataset</span><span class="o">.</span><span class="n">push_to_hub</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span> <span class="n">use_auth_token</span><span class="o">=</span><span class="n">hub_token</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">output_file</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">output_dir</span><span class="p">)</span> <span class="o">/</span> <span class="n">output_file</span>
        <span class="n">dataset</span><span class="o">.</span><span class="n">save_to_disk</span><span class="p">(</span><span class="n">output_file</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saved to </span><span class="si">{</span><span class="n">output_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h5 id="swebench.inference.make_datasets.utils" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <span class="doc doc-object-name doc-module-name">utils</span>


</h5>

    <div class="doc doc-contents ">









  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h6 id="swebench.inference.make_datasets.utils.DIFF_PATTERN" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <span class="doc doc-object-name doc-attribute-name">DIFF_PATTERN</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-module-attribute"><code>module-attribute</code></small>
  </span>

</h6>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">DIFF_PATTERN</span> <span class="o">=</span> <span class="n"><span title="re.compile">compile</span></span><span class="p">(</span><span class="s1">&#39;^diff(?:.*)&#39;</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h6 id="swebench.inference.make_datasets.utils.PATCH_PATTERN" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <span class="doc doc-object-name doc-attribute-name">PATCH_PATTERN</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-module-attribute"><code>module-attribute</code></small>
  </span>

</h6>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">PATCH_PATTERN</span> <span class="o">=</span> <span class="n"><span title="re.compile">compile</span></span><span class="p">(</span><span class="s1">&#39;(?:diff[</span><span class="se">\\</span><span class="s1">w</span><span class="se">\\</span><span class="s1">_</span><span class="se">\\</span><span class="s1">.</span><span class="se">\\</span><span class="s1"> </span><span class="se">\\</span><span class="s1">/</span><span class="se">\\</span><span class="s1">-]+</span><span class="se">\\</span><span class="s1">n)?</span><span class="se">\\</span><span class="s1">-</span><span class="se">\\</span><span class="s1">-</span><span class="se">\\</span><span class="s1">-</span><span class="se">\\</span><span class="s1">s+a</span><span class="se">\\</span><span class="s1">/(?:.*?)</span><span class="se">\\</span><span class="s1">n</span><span class="se">\\</span><span class="s1">+</span><span class="se">\\</span><span class="s1">+</span><span class="se">\\</span><span class="s1">+</span><span class="se">\\</span><span class="s1">s+b</span><span class="se">\\</span><span class="s1">/(?:.*?)(?=diff</span><span class="se">\\</span><span class="s1"> |</span><span class="se">\\</span><span class="s1">-</span><span class="se">\\</span><span class="s1">-</span><span class="se">\\</span><span class="s1">-</span><span class="se">\\</span><span class="s1"> a</span><span class="se">\\</span><span class="s1">/|</span><span class="se">\\</span><span class="s1">Z)&#39;</span><span class="p">,</span> <span class="n"><span title="re.DOTALL">DOTALL</span></span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h6 id="swebench.inference.make_datasets.utils.PATCH_FILE_PATTERN" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <span class="doc doc-object-name doc-attribute-name">PATCH_FILE_PATTERN</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-module-attribute"><code>module-attribute</code></small>
  </span>

</h6>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">PATCH_FILE_PATTERN</span> <span class="o">=</span> <span class="n"><span title="re.compile">compile</span></span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">-</span><span class="se">\\</span><span class="s1">-</span><span class="se">\\</span><span class="s1">-</span><span class="se">\\</span><span class="s1">s+a</span><span class="se">\\</span><span class="s1">/(?:.+)</span><span class="se">\\</span><span class="s1">n</span><span class="se">\\</span><span class="s1">+</span><span class="se">\\</span><span class="s1">+</span><span class="se">\\</span><span class="s1">+</span><span class="se">\\</span><span class="s1">s+b</span><span class="se">\\</span><span class="s1">/(?:.+)&#39;</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h6 id="swebench.inference.make_datasets.utils.PATCH_HUNK_PATTERN" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <span class="doc doc-object-name doc-attribute-name">PATCH_HUNK_PATTERN</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-module-attribute"><code>module-attribute</code></small>
  </span>

</h6>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">PATCH_HUNK_PATTERN</span> <span class="o">=</span> <span class="n"><span title="re.compile">compile</span></span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">@</span><span class="se">\\</span><span class="s1">@</span><span class="se">\\</span><span class="s1">s+</span><span class="se">\\</span><span class="s1">-(</span><span class="se">\\</span><span class="s1">d+),(</span><span class="se">\\</span><span class="s1">d+)</span><span class="se">\\</span><span class="s1">s+</span><span class="se">\\</span><span class="s1">+(</span><span class="se">\\</span><span class="s1">d+),(</span><span class="se">\\</span><span class="s1">d+)</span><span class="se">\\</span><span class="s1">s+</span><span class="se">\\</span><span class="s1">@</span><span class="se">\\</span><span class="s1">@(.+?)(?=diff</span><span class="se">\\</span><span class="s1"> |</span><span class="se">\\</span><span class="s1">-</span><span class="se">\\</span><span class="s1">-</span><span class="se">\\</span><span class="s1">-</span><span class="se">\\</span><span class="s1"> a</span><span class="se">\\</span><span class="s1">/|</span><span class="se">\\</span><span class="s1">@</span><span class="se">\\</span><span class="s1">@</span><span class="se">\\</span><span class="s1"> </span><span class="se">\\</span><span class="s1">-|</span><span class="se">\\</span><span class="s1">Z)&#39;</span><span class="p">,</span> <span class="n"><span title="re.DOTALL">DOTALL</span></span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

    </div>

</div>


<div class="doc doc-object doc-class">



<h6 id="swebench.inference.make_datasets.utils.ContextManager" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>            <span class="doc doc-object-name doc-class-name">ContextManager</span>


</h6>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">ContextManager</span><span class="p">(</span><span class="n">repo_path</span><span class="p">,</span> <span class="n">base_commit</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">








                  <details class="quote">
                    <summary>Source code in <code>swebench/inference/make_datasets/utils.py</code></summary>
                    <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">repo_path</span><span class="p">,</span> <span class="n">base_commit</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">repo_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">repo_path</span><span class="p">)</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span><span class="o">.</span><span class="n">as_posix</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">old_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">base_commit</span> <span class="o">=</span> <span class="n">base_commit</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span>
</code></pre></div></td></tr></table></div>
                  </details>



  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h7 id="swebench.inference.make_datasets.utils.ContextManager.repo_path" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <span class="doc doc-object-name doc-attribute-name">repo_path</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h7>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">repo_path</span> <span class="o">=</span> <span class="n"><span title="as_posix">as_posix</span></span><span class="p">()</span>
</code></pre></div>

    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h7 id="swebench.inference.make_datasets.utils.ContextManager.old_dir" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <span class="doc doc-object-name doc-attribute-name">old_dir</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h7>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">old_dir</span> <span class="o">=</span> <span class="n"><span title="os.getcwd">getcwd</span></span><span class="p">()</span>
</code></pre></div>

    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h7 id="swebench.inference.make_datasets.utils.ContextManager.base_commit" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <span class="doc doc-object-name doc-attribute-name">base_commit</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h7>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">base_commit</span> <span class="o">=</span> <span class="n"><span title="swebench.inference.make_datasets.utils.ContextManager(base_commit)">base_commit</span></span>
</code></pre></div>

    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h7 id="swebench.inference.make_datasets.utils.ContextManager.verbose" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <span class="doc doc-object-name doc-attribute-name">verbose</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h7>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">verbose</span> <span class="o">=</span> <span class="n"><span title="swebench.inference.make_datasets.utils.ContextManager(verbose)">verbose</span></span>
</code></pre></div>

    <div class="doc doc-contents ">

    </div>

</div>



<div class="doc doc-object doc-function">


<h7 id="swebench.inference.make_datasets.utils.ContextManager.__enter__" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <span class="doc doc-object-name doc-function-name">__enter__</span>


</h7>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">__enter__</span><span class="p">()</span>
</code></pre></div>

    <div class="doc doc-contents ">


            <details class="quote">
              <summary>Source code in <code>swebench/inference/make_datasets/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">repo_path</span><span class="p">)</span>
    <span class="n">cmd</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;git reset --hard </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">base_commit</span><span class="si">}</span><span class="s2"> &amp;&amp; git clean -fdxq&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
        <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">check</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
            <span class="n">cmd</span><span class="p">,</span>
            <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">check</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">DEVNULL</span><span class="p">,</span>
            <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">DEVNULL</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h7 id="swebench.inference.make_datasets.utils.ContextManager.get_environment" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <span class="doc doc-object-name doc-function-name">get_environment</span>


</h7>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">get_environment</span><span class="p">()</span>
</code></pre></div>

    <div class="doc doc-contents ">


            <details class="quote">
              <summary>Source code in <code>swebench/inference/make_datasets/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">170</span>
<span class="normal">171</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_environment</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>  <span class="c1"># TODO: activate conda environment and return the environment file</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h7 id="swebench.inference.make_datasets.utils.ContextManager.get_readme_files" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <span class="doc doc-object-name doc-function-name">get_readme_files</span>


</h7>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">get_readme_files</span><span class="p">()</span>
</code></pre></div>

    <div class="doc doc-contents ">


            <details class="quote">
              <summary>Source code in <code>swebench/inference/make_datasets/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_readme_files</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">files</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">repo_path</span><span class="p">)</span>
    <span class="n">files</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">files</span><span class="p">))</span>
    <span class="n">files</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;readme&quot;</span><span class="p">),</span> <span class="n">files</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">files</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h7 id="swebench.inference.make_datasets.utils.ContextManager.__exit__" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <span class="doc doc-object-name doc-function-name">__exit__</span>


</h7>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">__exit__</span><span class="p">(</span><span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_val</span><span class="p">,</span> <span class="n">exc_tb</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">


            <details class="quote">
              <summary>Source code in <code>swebench/inference/make_datasets/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">179</span>
<span class="normal">180</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_val</span><span class="p">,</span> <span class="n">exc_tb</span><span class="p">):</span>
    <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">old_dir</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h6 id="swebench.inference.make_datasets.utils.AutoContextManager" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>            <span class="doc doc-object-name doc-class-name">AutoContextManager</span>


</h6>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">AutoContextManager</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">root_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">token</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="            ContextManager (swebench.inference.make_datasets.utils.ContextManager)" href="#swebench.inference.make_datasets.utils.ContextManager">ContextManager</a></code></p>


        <p>Automatically clones the repo if it doesn't exist</p>







                  <details class="quote">
                    <summary>Source code in <code>swebench/inference/make_datasets/utils.py</code></summary>
                    <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">root_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">token</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">token</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">token</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;GITHUB_TOKEN&quot;</span><span class="p">,</span> <span class="s2">&quot;git&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">tempdir</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">root_dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tempdir</span> <span class="o">=</span> <span class="n">TemporaryDirectory</span><span class="p">()</span>
        <span class="n">root_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tempdir</span><span class="o">.</span><span class="n">name</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span> <span class="o">=</span> <span class="n">root_dir</span>
    <span class="n">repo_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="p">,</span> <span class="n">instance</span><span class="p">[</span><span class="s2">&quot;repo&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="s2">&quot;__&quot;</span><span class="p">))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">repo_dir</span><span class="p">):</span>
        <span class="n">repo_url</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;https://</span><span class="si">{</span><span class="n">token</span><span class="si">}</span><span class="s2">@github.com/swe-bench-repos/&quot;</span>
            <span class="o">+</span> <span class="n">instance</span><span class="p">[</span><span class="s2">&quot;repo&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="s2">&quot;__&quot;</span><span class="p">)</span>
            <span class="o">+</span> <span class="s2">&quot;.git&quot;</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cloning </span><span class="si">{</span><span class="n">instance</span><span class="p">[</span><span class="s1">&#39;repo&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">root_dir</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">Repo</span><span class="o">.</span><span class="n">clone_from</span><span class="p">(</span><span class="n">repo_url</span><span class="p">,</span> <span class="n">repo_dir</span><span class="p">)</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">repo_dir</span><span class="p">,</span> <span class="n">instance</span><span class="p">[</span><span class="s2">&quot;base_commit&quot;</span><span class="p">],</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">instance</span> <span class="o">=</span> <span class="n">instance</span>
</code></pre></div></td></tr></table></div>
                  </details>



  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h7 id="swebench.inference.make_datasets.utils.AutoContextManager.tempdir" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <span class="doc doc-object-name doc-attribute-name">tempdir</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h7>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">tempdir</span> <span class="o">=</span> <span class="kc">None</span>
</code></pre></div>

    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h7 id="swebench.inference.make_datasets.utils.AutoContextManager.root_dir" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <span class="doc doc-object-name doc-attribute-name">root_dir</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h7>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">root_dir</span> <span class="o">=</span> <span class="n"><span title="swebench.inference.make_datasets.utils.AutoContextManager(root_dir)">root_dir</span></span>
</code></pre></div>

    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h7 id="swebench.inference.make_datasets.utils.AutoContextManager.instance" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <span class="doc doc-object-name doc-attribute-name">instance</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h7>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">instance</span> <span class="o">=</span> <span class="n"><span title="swebench.inference.make_datasets.utils.AutoContextManager(instance)">instance</span></span>
</code></pre></div>

    <div class="doc doc-contents ">

    </div>

</div>



<div class="doc doc-object doc-function">


<h7 id="swebench.inference.make_datasets.utils.AutoContextManager.__exit__" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <span class="doc doc-object-name doc-function-name">__exit__</span>


</h7>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">__exit__</span><span class="p">(</span><span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_val</span><span class="p">,</span> <span class="n">exc_tb</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">


            <details class="quote">
              <summary>Source code in <code>swebench/inference/make_datasets/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_val</span><span class="p">,</span> <span class="n">exc_tb</span><span class="p">):</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tempdir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tempdir</span><span class="o">.</span><span class="n">cleanup</span><span class="p">()</span>
    <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__exit__</span><span class="p">(</span><span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_val</span><span class="p">,</span> <span class="n">exc_tb</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>


<div class="doc doc-object doc-function">


<h6 id="swebench.inference.make_datasets.utils.get_first_idx" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>            <span class="doc doc-object-name doc-function-name">get_first_idx</span>


</h6>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">get_first_idx</span><span class="p">(</span><span class="n">charlist</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">


            <details class="quote">
              <summary>Source code in <code>swebench/inference/make_datasets/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_first_idx</span><span class="p">(</span><span class="n">charlist</span><span class="p">):</span>
    <span class="n">first_min</span> <span class="o">=</span> <span class="n">charlist</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="s2">&quot;-&quot;</span> <span class="ow">in</span> <span class="n">charlist</span> <span class="k">else</span> <span class="nb">len</span><span class="p">(</span><span class="n">charlist</span><span class="p">)</span>
    <span class="n">first_plus</span> <span class="o">=</span> <span class="n">charlist</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;+&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="s2">&quot;+&quot;</span> <span class="ow">in</span> <span class="n">charlist</span> <span class="k">else</span> <span class="nb">len</span><span class="p">(</span><span class="n">charlist</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="n">first_min</span><span class="p">,</span> <span class="n">first_plus</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h6 id="swebench.inference.make_datasets.utils.get_last_idx" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>            <span class="doc doc-object-name doc-function-name">get_last_idx</span>


</h6>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">get_last_idx</span><span class="p">(</span><span class="n">charlist</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">


            <details class="quote">
              <summary>Source code in <code>swebench/inference/make_datasets/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_last_idx</span><span class="p">(</span><span class="n">charlist</span><span class="p">):</span>
    <span class="n">char_idx</span> <span class="o">=</span> <span class="n">get_first_idx</span><span class="p">(</span><span class="n">charlist</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">last_idx</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">charlist</span><span class="p">)</span> <span class="o">-</span> <span class="n">char_idx</span>
    <span class="k">return</span> <span class="n">last_idx</span> <span class="o">+</span> <span class="mi">1</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h6 id="swebench.inference.make_datasets.utils.strip_content" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>            <span class="doc doc-object-name doc-function-name">strip_content</span>


</h6>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">strip_content</span><span class="p">(</span><span class="n">hunk</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">


            <details class="quote">
              <summary>Source code in <code>swebench/inference/make_datasets/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">strip_content</span><span class="p">(</span><span class="n">hunk</span><span class="p">):</span>
    <span class="n">first_chars</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="kc">None</span> <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">else</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">hunk</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)))</span>
    <span class="n">first_idx</span> <span class="o">=</span> <span class="n">get_first_idx</span><span class="p">(</span><span class="n">first_chars</span><span class="p">)</span>
    <span class="n">last_idx</span> <span class="o">=</span> <span class="n">get_last_idx</span><span class="p">(</span><span class="n">first_chars</span><span class="p">)</span>
    <span class="n">new_lines</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(),</span> <span class="n">hunk</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)[</span><span class="n">first_idx</span><span class="p">:</span><span class="n">last_idx</span><span class="p">]))</span>
    <span class="n">new_hunk</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">new_lines</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="k">return</span> <span class="n">new_hunk</span><span class="p">,</span> <span class="n">first_idx</span> <span class="o">-</span> <span class="mi">1</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h6 id="swebench.inference.make_datasets.utils.get_hunk_stats" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>            <span class="doc doc-object-name doc-function-name">get_hunk_stats</span>


</h6>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">get_hunk_stats</span><span class="p">(</span><span class="n">pre_start</span><span class="p">,</span> <span class="n">pre_len</span><span class="p">,</span> <span class="n">post_start</span><span class="p">,</span> <span class="n">post_len</span><span class="p">,</span> <span class="n">hunk</span><span class="p">,</span> <span class="n">total_delta</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">


            <details class="quote">
              <summary>Source code in <code>swebench/inference/make_datasets/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_hunk_stats</span><span class="p">(</span><span class="n">pre_start</span><span class="p">,</span> <span class="n">pre_len</span><span class="p">,</span> <span class="n">post_start</span><span class="p">,</span> <span class="n">post_len</span><span class="p">,</span> <span class="n">hunk</span><span class="p">,</span> <span class="n">total_delta</span><span class="p">):</span>
    <span class="n">stats</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;context&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;added&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;subtracted&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
    <span class="n">hunk</span> <span class="o">=</span> <span class="n">hunk</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">hunk</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">):</span>
            <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;subtracted&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;+&quot;</span><span class="p">):</span>
            <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;added&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;context&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">context</span> <span class="o">=</span> <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;context&quot;</span><span class="p">]</span>
    <span class="n">added</span> <span class="o">=</span> <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;added&quot;</span><span class="p">]</span>
    <span class="n">subtracted</span> <span class="o">=</span> <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;subtracted&quot;</span><span class="p">]</span>
    <span class="n">pre_len</span> <span class="o">=</span> <span class="n">context</span> <span class="o">+</span> <span class="n">subtracted</span>
    <span class="n">post_start</span> <span class="o">=</span> <span class="n">pre_start</span> <span class="o">+</span> <span class="n">total_delta</span>
    <span class="n">post_len</span> <span class="o">=</span> <span class="n">context</span> <span class="o">+</span> <span class="n">added</span>
    <span class="n">total_delta</span> <span class="o">=</span> <span class="n">total_delta</span> <span class="o">+</span> <span class="p">(</span><span class="n">post_len</span> <span class="o">-</span> <span class="n">pre_len</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">pre_start</span><span class="p">,</span> <span class="n">pre_len</span><span class="p">,</span> <span class="n">post_start</span><span class="p">,</span> <span class="n">post_len</span><span class="p">,</span> <span class="n">total_delta</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h6 id="swebench.inference.make_datasets.utils.repair_patch" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>            <span class="doc doc-object-name doc-function-name">repair_patch</span>


</h6>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">repair_patch</span><span class="p">(</span><span class="n">model_patch</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">


            <details class="quote">
              <summary>Source code in <code>swebench/inference/make_datasets/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">repair_patch</span><span class="p">(</span><span class="n">model_patch</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">model_patch</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="n">model_patch</span> <span class="o">=</span> <span class="n">model_patch</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">new_patch</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">for</span> <span class="n">patch</span> <span class="ow">in</span> <span class="n">PATCH_PATTERN</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">model_patch</span><span class="p">):</span>
        <span class="n">total_delta</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">diff_header</span> <span class="o">=</span> <span class="n">DIFF_PATTERN</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">patch</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">diff_header</span><span class="p">:</span>
            <span class="n">new_patch</span> <span class="o">+=</span> <span class="n">diff_header</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">patch_header</span> <span class="o">=</span> <span class="n">PATCH_FILE_PATTERN</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">patch</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">patch_header</span><span class="p">:</span>
            <span class="n">new_patch</span> <span class="o">+=</span> <span class="n">patch_header</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="k">for</span> <span class="n">hunk</span> <span class="ow">in</span> <span class="n">PATCH_HUNK_PATTERN</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">patch</span><span class="p">):</span>
            <span class="n">pre_start</span><span class="p">,</span> <span class="n">pre_len</span><span class="p">,</span> <span class="n">post_start</span><span class="p">,</span> <span class="n">post_len</span><span class="p">,</span> <span class="n">content</span> <span class="o">=</span> <span class="n">hunk</span>
            <span class="n">pre_start</span><span class="p">,</span> <span class="n">pre_len</span><span class="p">,</span> <span class="n">post_start</span><span class="p">,</span> <span class="n">post_len</span><span class="p">,</span> <span class="n">total_delta</span> <span class="o">=</span> <span class="n">get_hunk_stats</span><span class="p">(</span>
                <span class="o">*</span><span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">isnumeric</span><span class="p">()</span> <span class="k">else</span> <span class="n">x</span><span class="p">,</span> <span class="n">hunk</span><span class="p">)),</span> <span class="n">total_delta</span>
            <span class="p">)</span>
            <span class="n">new_patch</span> <span class="o">+=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;@@ -</span><span class="si">{</span><span class="n">pre_start</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">pre_len</span><span class="si">}</span><span class="s2"> +</span><span class="si">{</span><span class="n">post_start</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">post_len</span><span class="si">}</span><span class="s2"> @@</span><span class="si">{</span><span class="n">content</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
    <span class="k">return</span> <span class="n">new_patch</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h6 id="swebench.inference.make_datasets.utils.extract_minimal_patch" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>            <span class="doc doc-object-name doc-function-name">extract_minimal_patch</span>


</h6>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">extract_minimal_patch</span><span class="p">(</span><span class="n">model_patch</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">


            <details class="quote">
              <summary>Source code in <code>swebench/inference/make_datasets/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">extract_minimal_patch</span><span class="p">(</span><span class="n">model_patch</span><span class="p">):</span>
    <span class="n">model_patch</span> <span class="o">=</span> <span class="n">model_patch</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">new_patch</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">for</span> <span class="n">patch</span> <span class="ow">in</span> <span class="n">PATCH_PATTERN</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">model_patch</span><span class="p">):</span>
        <span class="n">total_delta</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">diff_header</span> <span class="o">=</span> <span class="n">DIFF_PATTERN</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">patch</span><span class="p">)</span>
        <span class="n">patch_header</span> <span class="o">=</span> <span class="n">PATCH_FILE_PATTERN</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">patch</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">patch_header</span><span class="p">:</span>
            <span class="n">new_patch</span> <span class="o">+=</span> <span class="n">patch_header</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="k">for</span> <span class="n">hunk</span> <span class="ow">in</span> <span class="n">PATCH_HUNK_PATTERN</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">patch</span><span class="p">):</span>
            <span class="n">pre_start</span><span class="p">,</span> <span class="n">pre_len</span><span class="p">,</span> <span class="n">post_start</span><span class="p">,</span> <span class="n">post_len</span><span class="p">,</span> <span class="n">content</span> <span class="o">=</span> <span class="n">hunk</span>
            <span class="n">pre_start</span><span class="p">,</span> <span class="n">pre_len</span><span class="p">,</span> <span class="n">post_start</span><span class="p">,</span> <span class="n">post_len</span><span class="p">,</span> <span class="n">content</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
                <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">isnumeric</span><span class="p">()</span> <span class="k">else</span> <span class="n">x</span><span class="p">,</span> <span class="n">hunk</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">content</span><span class="p">,</span> <span class="n">adjust_pre_start</span> <span class="o">=</span> <span class="n">strip_content</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
            <span class="n">pre_start</span> <span class="o">+=</span> <span class="n">adjust_pre_start</span>
            <span class="n">pre_start</span><span class="p">,</span> <span class="n">pre_len</span><span class="p">,</span> <span class="n">post_start</span><span class="p">,</span> <span class="n">post_len</span><span class="p">,</span> <span class="n">total_delta</span> <span class="o">=</span> <span class="n">get_hunk_stats</span><span class="p">(</span>
                <span class="n">pre_start</span><span class="p">,</span> <span class="n">pre_len</span><span class="p">,</span> <span class="n">post_start</span><span class="p">,</span> <span class="n">post_len</span><span class="p">,</span> <span class="n">content</span><span class="p">,</span> <span class="n">total_delta</span>
            <span class="p">)</span>
            <span class="n">new_patch</span> <span class="o">+=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;@@ -</span><span class="si">{</span><span class="n">pre_start</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">pre_len</span><span class="si">}</span><span class="s2"> +</span><span class="si">{</span><span class="n">post_start</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">post_len</span><span class="si">}</span><span class="s2"> @@</span><span class="si">{</span><span class="n">content</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
    <span class="k">return</span> <span class="n">new_patch</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h6 id="swebench.inference.make_datasets.utils.extract_diff" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>            <span class="doc doc-object-name doc-function-name">extract_diff</span>


</h6>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">extract_diff</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Extracts the diff from a response formatted in different ways</p>


            <details class="quote">
              <summary>Source code in <code>swebench/inference/make_datasets/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">extract_diff</span><span class="p">(</span><span class="n">response</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extracts the diff from a response formatted in different ways</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">response</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="n">diff_matches</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">other_matches</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\&lt;([\w-]+)\&gt;(.*?)\&lt;\/\1\&gt;&quot;</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">DOTALL</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">code</span><span class="p">,</span> <span class="n">match</span> <span class="ow">in</span> <span class="n">pattern</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">response</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">code</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;diff&quot;</span><span class="p">,</span> <span class="s2">&quot;patch&quot;</span><span class="p">}:</span>
            <span class="n">diff_matches</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">match</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">other_matches</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">match</span><span class="p">)</span>
    <span class="n">pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;```(\w+)?\n(.*?)```&quot;</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">DOTALL</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">code</span><span class="p">,</span> <span class="n">match</span> <span class="ow">in</span> <span class="n">pattern</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">response</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">code</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;diff&quot;</span><span class="p">,</span> <span class="s2">&quot;patch&quot;</span><span class="p">}:</span>
            <span class="n">diff_matches</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">match</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">other_matches</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">match</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">diff_matches</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">diff_matches</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">other_matches</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">other_matches</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;&lt;/s&gt;&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h6 id="swebench.inference.make_datasets.utils.is_test" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>            <span class="doc doc-object-name doc-function-name">is_test</span>


</h6>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">is_test</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">test_phrases</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">


            <details class="quote">
              <summary>Source code in <code>swebench/inference/make_datasets/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">is_test</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">test_phrases</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">test_phrases</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">test_phrases</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;test&quot;</span><span class="p">,</span> <span class="s2">&quot;tests&quot;</span><span class="p">,</span> <span class="s2">&quot;testing&quot;</span><span class="p">]</span>
    <span class="n">words</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot; |_|\/|\.&quot;</span><span class="p">,</span> <span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()))</span>
    <span class="k">return</span> <span class="nb">any</span><span class="p">(</span><span class="n">word</span> <span class="ow">in</span> <span class="n">words</span> <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">test_phrases</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h6 id="swebench.inference.make_datasets.utils.get_imported_modules" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>            <span class="doc doc-object-name doc-function-name">get_imported_modules</span>


</h6>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">get_imported_modules</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">


            <details class="quote">
              <summary>Source code in <code>swebench/inference/make_datasets/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_imported_modules</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
        <span class="n">tree</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">file</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span> <span class="n">filename</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">[</span>
        <span class="n">node</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">ast</span><span class="o">.</span><span class="n">iter_child_nodes</span><span class="p">(</span><span class="n">tree</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">Import</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">ImportFrom</span><span class="p">))</span>
    <span class="p">]</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h6 id="swebench.inference.make_datasets.utils.resolve_module_to_file" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>            <span class="doc doc-object-name doc-function-name">resolve_module_to_file</span>


</h6>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">resolve_module_to_file</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="n">root_dir</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">


            <details class="quote">
              <summary>Source code in <code>swebench/inference/make_datasets/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">resolve_module_to_file</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="n">root_dir</span><span class="p">):</span>
    <span class="n">components</span> <span class="o">=</span> <span class="n">module</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">level</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">components</span> <span class="o">=</span> <span class="n">components</span><span class="p">[:</span><span class="o">-</span><span class="n">level</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">dirpath</span><span class="p">,</span> <span class="n">dirnames</span><span class="p">,</span> <span class="n">filenames</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">root_dir</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">dirpath</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">components</span><span class="p">)):</span>
            <span class="k">return</span> <span class="p">[</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirpath</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">filenames</span>
                <span class="k">if</span> <span class="n">filename</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.py&quot;</span><span class="p">)</span>
            <span class="p">]</span>
    <span class="k">return</span> <span class="p">[]</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h6 id="swebench.inference.make_datasets.utils.ingest_file_directory_contents" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>            <span class="doc doc-object-name doc-function-name">ingest_file_directory_contents</span>


</h6>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">ingest_file_directory_contents</span><span class="p">(</span><span class="n">target_file</span><span class="p">,</span> <span class="n">root_dir</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">


            <details class="quote">
              <summary>Source code in <code>swebench/inference/make_datasets/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">ingest_file_directory_contents</span><span class="p">(</span><span class="n">target_file</span><span class="p">,</span> <span class="n">root_dir</span><span class="p">):</span>
    <span class="n">imported_files</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">files_to_check</span> <span class="o">=</span> <span class="p">[</span><span class="n">target_file</span><span class="p">]</span>
    <span class="k">while</span> <span class="n">files_to_check</span><span class="p">:</span>
        <span class="n">current_file</span> <span class="o">=</span> <span class="n">files_to_check</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
        <span class="n">imported_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">current_file</span><span class="p">)</span>
        <span class="n">imports</span> <span class="o">=</span> <span class="n">get_imported_modules</span><span class="p">(</span><span class="n">current_file</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">imports</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Import</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">alias</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">names</span><span class="p">:</span>
                    <span class="n">files</span> <span class="o">=</span> <span class="n">resolve_module_to_file</span><span class="p">(</span><span class="n">alias</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">root_dir</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">file</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">imported_files</span> <span class="ow">and</span> <span class="n">file</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">files_to_check</span><span class="p">:</span>
                            <span class="n">files_to_check</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">ImportFrom</span><span class="p">):</span>
                <span class="n">files</span> <span class="o">=</span> <span class="n">resolve_module_to_file</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">module</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">level</span><span class="p">,</span> <span class="n">root_dir</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">file</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">imported_files</span> <span class="ow">and</span> <span class="n">file</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">files_to_check</span><span class="p">:</span>
                        <span class="n">files_to_check</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">imported_files</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h6 id="swebench.inference.make_datasets.utils.detect_encoding" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>            <span class="doc doc-object-name doc-function-name">detect_encoding</span>


</h6>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">detect_encoding</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Detect the encoding of a file</p>


            <details class="quote">
              <summary>Source code in <code>swebench/inference/make_datasets/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">detect_encoding</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Detect the encoding of a file</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
        <span class="n">rawdata</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">chardet</span><span class="o">.</span><span class="n">detect</span><span class="p">(</span><span class="n">rawdata</span><span class="p">)[</span><span class="s2">&quot;encoding&quot;</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h6 id="swebench.inference.make_datasets.utils.list_files" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>            <span class="doc doc-object-name doc-function-name">list_files</span>


</h6>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">list_files</span><span class="p">(</span><span class="n">root_dir</span><span class="p">,</span> <span class="n">include_tests</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">


            <details class="quote">
              <summary>Source code in <code>swebench/inference/make_datasets/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">list_files</span><span class="p">(</span><span class="n">root_dir</span><span class="p">,</span> <span class="n">include_tests</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">files</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">Path</span><span class="p">(</span><span class="n">root_dir</span><span class="p">)</span><span class="o">.</span><span class="n">rglob</span><span class="p">(</span><span class="s2">&quot;*.py&quot;</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">include_tests</span> <span class="ow">and</span> <span class="n">is_test</span><span class="p">(</span><span class="n">filename</span><span class="o">.</span><span class="n">as_posix</span><span class="p">()):</span>
            <span class="k">continue</span>
        <span class="n">files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">filename</span><span class="o">.</span><span class="n">relative_to</span><span class="p">(</span><span class="n">root_dir</span><span class="p">)</span><span class="o">.</span><span class="n">as_posix</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">files</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h6 id="swebench.inference.make_datasets.utils.ingest_directory_contents" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>            <span class="doc doc-object-name doc-function-name">ingest_directory_contents</span>


</h6>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">ingest_directory_contents</span><span class="p">(</span><span class="n">root_dir</span><span class="p">,</span> <span class="n">include_tests</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">


            <details class="quote">
              <summary>Source code in <code>swebench/inference/make_datasets/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">ingest_directory_contents</span><span class="p">(</span><span class="n">root_dir</span><span class="p">,</span> <span class="n">include_tests</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">files_content</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">relative_path</span> <span class="ow">in</span> <span class="n">list_files</span><span class="p">(</span><span class="n">root_dir</span><span class="p">,</span> <span class="n">include_tests</span><span class="o">=</span><span class="n">include_tests</span><span class="p">):</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root_dir</span><span class="p">,</span> <span class="n">relative_path</span><span class="p">)</span>
        <span class="n">encoding</span> <span class="o">=</span> <span class="n">detect_encoding</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">encoding</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">content</span> <span class="o">=</span> <span class="s2">&quot;[BINARY DATA FILE]&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="n">encoding</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
                    <span class="n">content</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">UnicodeDecodeError</span><span class="p">,</span> <span class="ne">LookupError</span><span class="p">):</span>
                <span class="n">content</span> <span class="o">=</span> <span class="s2">&quot;[BINARY DATA FILE]&quot;</span>
        <span class="n">files_content</span><span class="p">[</span><span class="n">relative_path</span><span class="p">]</span> <span class="o">=</span> <span class="n">content</span>
    <span class="k">return</span> <span class="n">files_content</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h6 id="swebench.inference.make_datasets.utils.string_to_bool" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>            <span class="doc doc-object-name doc-function-name">string_to_bool</span>


</h6>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">string_to_bool</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">


            <details class="quote">
              <summary>Source code in <code>swebench/inference/make_datasets/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">string_to_bool</span><span class="p">(</span><span class="n">v</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">v</span>
    <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;yes&quot;</span><span class="p">,</span> <span class="s2">&quot;true&quot;</span><span class="p">,</span> <span class="s2">&quot;t&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;1&quot;</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">elif</span> <span class="n">v</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;no&quot;</span><span class="p">,</span> <span class="s2">&quot;false&quot;</span><span class="p">,</span> <span class="s2">&quot;f&quot;</span><span class="p">,</span> <span class="s2">&quot;n&quot;</span><span class="p">,</span> <span class="s2">&quot;0&quot;</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">ArgumentTypeError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Truthy value expected: got </span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2"> but expected one of yes/no, true/false, t/f, y/n, 1/0 (case insensitive).&quot;</span>
        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>


  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h4 id="swebench.inference.run_api" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <span class="doc doc-object-name doc-module-name">run_api</span>


</h4>

    <div class="doc doc-contents ">

        <p>This python script is designed to run inference on a dataset using either the OpenAI or Anthropic API, depending on the model specified.
It sorts instances by length and continually writes the outputs to a specified file, so that the script can be stopped and restarted without losing progress.</p>









  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h5 id="swebench.inference.run_api.logger" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <span class="doc doc-object-name doc-attribute-name">logger</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-module-attribute"><code>module-attribute</code></small>
  </span>

</h5>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">logger</span> <span class="o">=</span> <span class="n"><span title="logging.getLogger">getLogger</span></span><span class="p">(</span><span class="n"><span title="__name__">__name__</span></span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h5 id="swebench.inference.run_api.MODEL_LIMITS" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <span class="doc doc-object-name doc-attribute-name">MODEL_LIMITS</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-module-attribute"><code>module-attribute</code></small>
  </span>

</h5>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">MODEL_LIMITS</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;claude-instant-1&#39;</span><span class="p">:</span> <span class="mi">100000</span><span class="p">,</span> <span class="s1">&#39;claude-2&#39;</span><span class="p">:</span> <span class="mi">100000</span><span class="p">,</span> <span class="s1">&#39;claude-3-opus-20240229&#39;</span><span class="p">:</span> <span class="mi">200000</span><span class="p">,</span> <span class="s1">&#39;claude-3-sonnet-20240229&#39;</span><span class="p">:</span> <span class="mi">200000</span><span class="p">,</span> <span class="s1">&#39;claude-3-haiku-20240307&#39;</span><span class="p">:</span> <span class="mi">200000</span><span class="p">,</span> <span class="s1">&#39;gpt-3.5-turbo-16k-0613&#39;</span><span class="p">:</span> <span class="mi">16385</span><span class="p">,</span> <span class="s1">&#39;gpt-3.5-turbo-0613&#39;</span><span class="p">:</span> <span class="mi">4097</span><span class="p">,</span> <span class="s1">&#39;gpt-3.5-turbo-1106&#39;</span><span class="p">:</span> <span class="mi">16385</span><span class="p">,</span> <span class="s1">&#39;gpt-4-32k-0613&#39;</span><span class="p">:</span> <span class="mi">32768</span><span class="p">,</span> <span class="s1">&#39;gpt-4-0613&#39;</span><span class="p">:</span> <span class="mi">8192</span><span class="p">,</span> <span class="s1">&#39;gpt-4-1106-preview&#39;</span><span class="p">:</span> <span class="mi">128000</span><span class="p">,</span> <span class="s1">&#39;gpt-4-0125-preview&#39;</span><span class="p">:</span> <span class="mi">128000</span><span class="p">}</span>
</code></pre></div>

    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h5 id="swebench.inference.run_api.MODEL_COST_PER_INPUT" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <span class="doc doc-object-name doc-attribute-name">MODEL_COST_PER_INPUT</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-module-attribute"><code>module-attribute</code></small>
  </span>

</h5>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">MODEL_COST_PER_INPUT</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;claude-instant-1&#39;</span><span class="p">:</span> <span class="mf">1.63e-06</span><span class="p">,</span> <span class="s1">&#39;claude-2&#39;</span><span class="p">:</span> <span class="mf">1.102e-05</span><span class="p">,</span> <span class="s1">&#39;claude-3-opus-20240229&#39;</span><span class="p">:</span> <span class="mf">1.5e-05</span><span class="p">,</span> <span class="s1">&#39;claude-3-sonnet-20240229&#39;</span><span class="p">:</span> <span class="mf">3e-06</span><span class="p">,</span> <span class="s1">&#39;claude-3-haiku-20240307&#39;</span><span class="p">:</span> <span class="mf">2.5e-07</span><span class="p">,</span> <span class="s1">&#39;gpt-3.5-turbo-16k-0613&#39;</span><span class="p">:</span> <span class="mf">1.5e-06</span><span class="p">,</span> <span class="s1">&#39;gpt-3.5-turbo-0613&#39;</span><span class="p">:</span> <span class="mf">1.5e-06</span><span class="p">,</span> <span class="s1">&#39;gpt-3.5-turbo-1106&#39;</span><span class="p">:</span> <span class="mf">1e-06</span><span class="p">,</span> <span class="s1">&#39;gpt-35-turbo-0613&#39;</span><span class="p">:</span> <span class="mf">1.5e-06</span><span class="p">,</span> <span class="s1">&#39;gpt-35-turbo&#39;</span><span class="p">:</span> <span class="mf">1.5e-06</span><span class="p">,</span> <span class="s1">&#39;gpt-4-0613&#39;</span><span class="p">:</span> <span class="mf">3e-05</span><span class="p">,</span> <span class="s1">&#39;gpt-4-32k-0613&#39;</span><span class="p">:</span> <span class="mf">6e-05</span><span class="p">,</span> <span class="s1">&#39;gpt-4-32k&#39;</span><span class="p">:</span> <span class="mf">6e-05</span><span class="p">,</span> <span class="s1">&#39;gpt-4-1106-preview&#39;</span><span class="p">:</span> <span class="mf">1e-05</span><span class="p">,</span> <span class="s1">&#39;gpt-4-0125-preview&#39;</span><span class="p">:</span> <span class="mf">1e-05</span><span class="p">}</span>
</code></pre></div>

    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h5 id="swebench.inference.run_api.MODEL_COST_PER_OUTPUT" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <span class="doc doc-object-name doc-attribute-name">MODEL_COST_PER_OUTPUT</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-module-attribute"><code>module-attribute</code></small>
  </span>

</h5>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">MODEL_COST_PER_OUTPUT</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;claude-instant-1&#39;</span><span class="p">:</span> <span class="mf">5.51e-06</span><span class="p">,</span> <span class="s1">&#39;claude-2&#39;</span><span class="p">:</span> <span class="mf">3.268e-05</span><span class="p">,</span> <span class="s1">&#39;claude-3-opus-20240229&#39;</span><span class="p">:</span> <span class="mf">7.5e-05</span><span class="p">,</span> <span class="s1">&#39;claude-3-sonnet-20240229&#39;</span><span class="p">:</span> <span class="mf">1.5e-05</span><span class="p">,</span> <span class="s1">&#39;claude-3-haiku-20240307&#39;</span><span class="p">:</span> <span class="mf">1.25e-06</span><span class="p">,</span> <span class="s1">&#39;gpt-3.5-turbo-16k-0613&#39;</span><span class="p">:</span> <span class="mf">2e-06</span><span class="p">,</span> <span class="s1">&#39;gpt-3.5-turbo-16k&#39;</span><span class="p">:</span> <span class="mf">2e-06</span><span class="p">,</span> <span class="s1">&#39;gpt-3.5-turbo-1106&#39;</span><span class="p">:</span> <span class="mf">2e-06</span><span class="p">,</span> <span class="s1">&#39;gpt-35-turbo-0613&#39;</span><span class="p">:</span> <span class="mf">2e-06</span><span class="p">,</span> <span class="s1">&#39;gpt-35-turbo&#39;</span><span class="p">:</span> <span class="mf">2e-06</span><span class="p">,</span> <span class="s1">&#39;gpt-4-0613&#39;</span><span class="p">:</span> <span class="mf">6e-05</span><span class="p">,</span> <span class="s1">&#39;gpt-4-32k-0613&#39;</span><span class="p">:</span> <span class="mf">0.00012</span><span class="p">,</span> <span class="s1">&#39;gpt-4-32k&#39;</span><span class="p">:</span> <span class="mf">0.00012</span><span class="p">,</span> <span class="s1">&#39;gpt-4-1106-preview&#39;</span><span class="p">:</span> <span class="mf">3e-05</span><span class="p">,</span> <span class="s1">&#39;gpt-4-0125-preview&#39;</span><span class="p">:</span> <span class="mf">3e-05</span><span class="p">}</span>
</code></pre></div>

    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h5 id="swebench.inference.run_api.ENGINES" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <span class="doc doc-object-name doc-attribute-name">ENGINES</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-module-attribute"><code>module-attribute</code></small>
  </span>

</h5>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">ENGINES</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;gpt-3.5-turbo-16k-0613&#39;</span><span class="p">:</span> <span class="s1">&#39;gpt-35-turbo-16k&#39;</span><span class="p">,</span> <span class="s1">&#39;gpt-4-0613&#39;</span><span class="p">:</span> <span class="s1">&#39;gpt-4&#39;</span><span class="p">,</span> <span class="s1">&#39;gpt-4-32k-0613&#39;</span><span class="p">:</span> <span class="s1">&#39;gpt-4-32k&#39;</span><span class="p">}</span>
</code></pre></div>

    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h5 id="swebench.inference.run_api.parser" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <span class="doc doc-object-name doc-attribute-name">parser</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-module-attribute"><code>module-attribute</code></small>
  </span>

</h5>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">parser</span> <span class="o">=</span> <span class="n"><span title="argparse.ArgumentParser">ArgumentParser</span></span><span class="p">(</span><span class="n"><span title="argparse.ArgumentParser(description)">description</span></span><span class="o">=</span><span class="n"><span title="__doc__">__doc__</span></span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h5 id="swebench.inference.run_api.args" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <span class="doc doc-object-name doc-attribute-name">args</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-module-attribute"><code>module-attribute</code></small>
  </span>

</h5>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">args</span> <span class="o">=</span> <span class="n"><span title="swebench.inference.run_api.parser.parse_args">parse_args</span></span><span class="p">()</span>
</code></pre></div>

    <div class="doc doc-contents ">

    </div>

</div>



<div class="doc doc-object doc-function">


<h5 id="swebench.inference.run_api.calc_cost" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>            <span class="doc doc-object-name doc-function-name">calc_cost</span>


</h5>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">calc_cost</span><span class="p">(</span><span class="n">model_name</span><span class="p">,</span> <span class="n">input_tokens</span><span class="p">,</span> <span class="n">output_tokens</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Calculates the cost of a response from the openai API.</p>
<p>Args:
response (openai.ChatCompletion): The response from the API.</p>
<p>Returns:
float: The cost of the response.</p>


            <details class="quote">
              <summary>Source code in <code>swebench/inference/run_api.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">calc_cost</span><span class="p">(</span><span class="n">model_name</span><span class="p">,</span> <span class="n">input_tokens</span><span class="p">,</span> <span class="n">output_tokens</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates the cost of a response from the openai API.</span>

<span class="sd">    Args:</span>
<span class="sd">    response (openai.ChatCompletion): The response from the API.</span>

<span class="sd">    Returns:</span>
<span class="sd">    float: The cost of the response.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cost</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">MODEL_COST_PER_INPUT</span><span class="p">[</span><span class="n">model_name</span><span class="p">]</span> <span class="o">*</span> <span class="n">input_tokens</span>
        <span class="o">+</span> <span class="n">MODEL_COST_PER_OUTPUT</span><span class="p">[</span><span class="n">model_name</span><span class="p">]</span> <span class="o">*</span> <span class="n">output_tokens</span>
    <span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;input_tokens=</span><span class="si">{</span><span class="n">input_tokens</span><span class="si">}</span><span class="s2">, output_tokens=</span><span class="si">{</span><span class="n">output_tokens</span><span class="si">}</span><span class="s2">, cost=</span><span class="si">{</span><span class="n">cost</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">cost</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="swebench.inference.run_api.call_chat" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>            <span class="doc doc-object-name doc-function-name">call_chat</span>


</h5>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">call_chat</span><span class="p">(</span><span class="n">model_name_or_path</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">use_azure</span><span class="p">,</span> <span class="n">temperature</span><span class="p">,</span> <span class="n">top_p</span><span class="p">,</span> <span class="o">**</span><span class="n">model_args</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Calls the openai API to generate completions for the given inputs.</p>
<p>Args:
model_name_or_path (str): The name or path of the model to use.
inputs (str): The inputs to generate completions for.
use_azure (bool): Whether to use the azure API.
temperature (float): The temperature to use.
top_p (float): The top_p to use.
**model_args (dict): A dictionary of model arguments.</p>


            <details class="quote">
              <summary>Source code in <code>swebench/inference/run_api.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@retry</span><span class="p">(</span><span class="n">wait</span><span class="o">=</span><span class="n">wait_random_exponential</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mi">600</span><span class="p">),</span> <span class="n">stop</span><span class="o">=</span><span class="n">stop_after_attempt</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
<span class="k">def</span><span class="w"> </span><span class="nf">call_chat</span><span class="p">(</span><span class="n">model_name_or_path</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">use_azure</span><span class="p">,</span> <span class="n">temperature</span><span class="p">,</span> <span class="n">top_p</span><span class="p">,</span> <span class="o">**</span><span class="n">model_args</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calls the openai API to generate completions for the given inputs.</span>

<span class="sd">    Args:</span>
<span class="sd">    model_name_or_path (str): The name or path of the model to use.</span>
<span class="sd">    inputs (str): The inputs to generate completions for.</span>
<span class="sd">    use_azure (bool): Whether to use the azure API.</span>
<span class="sd">    temperature (float): The temperature to use.</span>
<span class="sd">    top_p (float): The top_p to use.</span>
<span class="sd">    **model_args (dict): A dictionary of model arguments.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">system_messages</span> <span class="o">=</span> <span class="n">inputs</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">user_message</span> <span class="o">=</span> <span class="n">inputs</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">use_azure</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">openai</span><span class="o">.</span><span class="n">chat</span><span class="o">.</span><span class="n">completions</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
                <span class="n">engine</span><span class="o">=</span><span class="n">ENGINES</span><span class="p">[</span><span class="n">model_name_or_path</span><span class="p">]</span> <span class="k">if</span> <span class="n">use_azure</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">messages</span><span class="o">=</span><span class="p">[</span>
                    <span class="p">{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;system&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">system_messages</span><span class="p">},</span>
                    <span class="p">{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">user_message</span><span class="p">},</span>
                <span class="p">],</span>
                <span class="n">temperature</span><span class="o">=</span><span class="n">temperature</span><span class="p">,</span>
                <span class="n">top_p</span><span class="o">=</span><span class="n">top_p</span><span class="p">,</span>
                <span class="o">**</span><span class="n">model_args</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">openai</span><span class="o">.</span><span class="n">chat</span><span class="o">.</span><span class="n">completions</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
                <span class="n">model</span><span class="o">=</span><span class="n">model_name_or_path</span><span class="p">,</span>
                <span class="n">messages</span><span class="o">=</span><span class="p">[</span>
                    <span class="p">{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;system&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">system_messages</span><span class="p">},</span>
                    <span class="p">{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">user_message</span><span class="p">},</span>
                <span class="p">],</span>
                <span class="n">temperature</span><span class="o">=</span><span class="n">temperature</span><span class="p">,</span>
                <span class="n">top_p</span><span class="o">=</span><span class="n">top_p</span><span class="p">,</span>
                <span class="o">**</span><span class="n">model_args</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="n">input_tokens</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">usage</span><span class="o">.</span><span class="n">prompt_tokens</span>
        <span class="n">output_tokens</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">usage</span><span class="o">.</span><span class="n">completion_tokens</span>
        <span class="n">cost</span> <span class="o">=</span> <span class="n">calc_cost</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">input_tokens</span><span class="p">,</span> <span class="n">output_tokens</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">response</span><span class="p">,</span> <span class="n">cost</span>
    <span class="k">except</span> <span class="n">openai</span><span class="o">.</span><span class="n">BadRequestError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">code</span> <span class="o">==</span> <span class="s2">&quot;context_length_exceeded&quot;</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Context length exceeded&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">raise</span> <span class="n">e</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="swebench.inference.run_api.gpt_tokenize" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>            <span class="doc doc-object-name doc-function-name">gpt_tokenize</span>


</h5>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">gpt_tokenize</span><span class="p">(</span><span class="n">string</span><span class="p">:</span> <span class="n"><span title="str">str</span></span><span class="p">,</span> <span class="n">encoding</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><span title="int">int</span></span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Returns the number of tokens in a text string.</p>


            <details class="quote">
              <summary>Source code in <code>swebench/inference/run_api.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">gpt_tokenize</span><span class="p">(</span><span class="n">string</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">encoding</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns the number of tokens in a text string.&quot;&quot;&quot;</span>
    <span class="n">num_tokens</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">encoding</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">string</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">num_tokens</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="swebench.inference.run_api.claude_tokenize" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>            <span class="doc doc-object-name doc-function-name">claude_tokenize</span>


</h5>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">claude_tokenize</span><span class="p">(</span><span class="n">string</span><span class="p">:</span> <span class="n"><span title="str">str</span></span><span class="p">,</span> <span class="n">api</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><span title="int">int</span></span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Returns the number of tokens in a text string.</p>


            <details class="quote">
              <summary>Source code in <code>swebench/inference/run_api.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">claude_tokenize</span><span class="p">(</span><span class="n">string</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">api</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns the number of tokens in a text string.&quot;&quot;&quot;</span>
    <span class="n">num_tokens</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">count_tokens</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">num_tokens</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="swebench.inference.run_api.openai_inference" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>            <span class="doc doc-object-name doc-function-name">openai_inference</span>


</h5>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">openai_inference</span><span class="p">(</span><span class="n">test_dataset</span><span class="p">,</span> <span class="n">model_name_or_path</span><span class="p">,</span> <span class="n">output_file</span><span class="p">,</span> <span class="n">model_args</span><span class="p">,</span> <span class="n">existing_ids</span><span class="p">,</span> <span class="n">max_cost</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Runs inference on a dataset using the openai API.</p>
<p>Args:
test_dataset (datasets.Dataset): The dataset to run inference on.
model_name_or_path (str): The name or path of the model to use.
output_file (str): The path to the output file.
model_args (dict): A dictionary of model arguments.
existing_ids (set): A set of ids that have already been processed.
max_cost (float): The maximum cost to spend on inference.</p>


            <details class="quote">
              <summary>Source code in <code>swebench/inference/run_api.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">openai_inference</span><span class="p">(</span>
    <span class="n">test_dataset</span><span class="p">,</span>
    <span class="n">model_name_or_path</span><span class="p">,</span>
    <span class="n">output_file</span><span class="p">,</span>
    <span class="n">model_args</span><span class="p">,</span>
    <span class="n">existing_ids</span><span class="p">,</span>
    <span class="n">max_cost</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Runs inference on a dataset using the openai API.</span>

<span class="sd">    Args:</span>
<span class="sd">    test_dataset (datasets.Dataset): The dataset to run inference on.</span>
<span class="sd">    model_name_or_path (str): The name or path of the model to use.</span>
<span class="sd">    output_file (str): The path to the output file.</span>
<span class="sd">    model_args (dict): A dictionary of model arguments.</span>
<span class="sd">    existing_ids (set): A set of ids that have already been processed.</span>
<span class="sd">    max_cost (float): The maximum cost to spend on inference.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">encoding</span> <span class="o">=</span> <span class="n">tiktoken</span><span class="o">.</span><span class="n">encoding_for_model</span><span class="p">(</span><span class="n">model_name_or_path</span><span class="p">)</span>
    <span class="n">test_dataset</span> <span class="o">=</span> <span class="n">test_dataset</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
        <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">gpt_tokenize</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">],</span> <span class="n">encoding</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">MODEL_LIMITS</span><span class="p">[</span><span class="n">model_name_or_path</span><span class="p">],</span>
        <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Filtering&quot;</span><span class="p">,</span>
        <span class="n">load_from_cache_file</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">openai_key</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;OPENAI_API_KEY&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">openai_key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;Must provide an api key. Expected in OPENAI_API_KEY environment variable.&quot;</span>
        <span class="p">)</span>
    <span class="n">openai</span><span class="o">.</span><span class="n">api_key</span> <span class="o">=</span> <span class="n">openai_key</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using OpenAI key </span><span class="si">{</span><span class="s1">&#39;*&#39;</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="n">openai_key</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">5</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">openai_key</span><span class="p">[</span><span class="o">-</span><span class="mi">5</span><span class="p">:]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">use_azure</span> <span class="o">=</span> <span class="n">model_args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;use_azure&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">use_azure</span><span class="p">:</span>
        <span class="n">openai</span><span class="o">.</span><span class="n">api_type</span> <span class="o">=</span> <span class="s2">&quot;azure&quot;</span>
        <span class="n">openai</span><span class="o">.</span><span class="n">api_base</span> <span class="o">=</span> <span class="s2">&quot;https://pnlpopenai3.openai.azure.com/&quot;</span>
        <span class="n">openai</span><span class="o">.</span><span class="n">api_version</span> <span class="o">=</span> <span class="s2">&quot;2023-05-15&quot;</span>
    <span class="n">temperature</span> <span class="o">=</span> <span class="n">model_args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;temperature&quot;</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">)</span>
    <span class="n">top_p</span> <span class="o">=</span> <span class="n">model_args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;top_p&quot;</span><span class="p">,</span> <span class="mf">0.95</span> <span class="k">if</span> <span class="n">temperature</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">1</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using temperature=</span><span class="si">{</span><span class="n">temperature</span><span class="si">}</span><span class="s2">, top_p=</span><span class="si">{</span><span class="n">top_p</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">basic_args</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;model_name_or_path&quot;</span><span class="p">:</span> <span class="n">model_name_or_path</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">total_cost</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Filtered to </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">test_dataset</span><span class="p">)</span><span class="si">}</span><span class="s2"> instances&quot;</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span> <span class="s2">&quot;a+&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">datum</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">test_dataset</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Inference for </span><span class="si">{</span><span class="n">model_name_or_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">):</span>
            <span class="n">instance_id</span> <span class="o">=</span> <span class="n">datum</span><span class="p">[</span><span class="s2">&quot;instance_id&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">instance_id</span> <span class="ow">in</span> <span class="n">existing_ids</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">output_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;instance_id&quot;</span><span class="p">:</span> <span class="n">instance_id</span><span class="p">}</span>
            <span class="n">output_dict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">basic_args</span><span class="p">)</span>
            <span class="n">output_dict</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">datum</span><span class="p">[</span><span class="s1">&#39;text&#39;</span><span class="p">]</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="n">response</span><span class="p">,</span> <span class="n">cost</span> <span class="o">=</span> <span class="n">call_chat</span><span class="p">(</span>
                <span class="n">output_dict</span><span class="p">[</span><span class="s2">&quot;model_name_or_path&quot;</span><span class="p">],</span>
                <span class="n">output_dict</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">],</span>
                <span class="n">use_azure</span><span class="p">,</span>
                <span class="n">temperature</span><span class="p">,</span>
                <span class="n">top_p</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">completion</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">content</span>
            <span class="n">total_cost</span> <span class="o">+=</span> <span class="n">cost</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total Cost: </span><span class="si">{</span><span class="n">total_cost</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">output_dict</span><span class="p">[</span><span class="s2">&quot;full_output&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">completion</span>
            <span class="n">output_dict</span><span class="p">[</span><span class="s2">&quot;model_patch&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">extract_diff</span><span class="p">(</span><span class="n">completion</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">output_dict</span><span class="p">),</span> <span class="n">file</span><span class="o">=</span><span class="n">f</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">max_cost</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">total_cost</span> <span class="o">&gt;=</span> <span class="n">max_cost</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Reached max cost </span><span class="si">{</span><span class="n">max_cost</span><span class="si">}</span><span class="s2">, exiting&quot;</span><span class="p">)</span>
                <span class="k">break</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="swebench.inference.run_api.call_anthropic" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>            <span class="doc doc-object-name doc-function-name">call_anthropic</span>


</h5>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">call_anthropic</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="n">anthropic</span><span class="p">,</span> <span class="n">model_name_or_path</span><span class="p">,</span> <span class="n">temperature</span><span class="p">,</span> <span class="n">top_p</span><span class="p">,</span> <span class="o">**</span><span class="n">model_args</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Calls the anthropic API to generate completions for the given inputs.</p>
<p>Args:
inputs (str): The inputs to generate completions for.
anthropic (Anthropic): The anthropic API object.
model_name_or_path (str): The name or path of the model to use.
temperature (float): The temperature to use.
top_p (float): The top_p to use.
model_args (dict): A dictionary of model arguments.</p>


            <details class="quote">
              <summary>Source code in <code>swebench/inference/run_api.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@retry</span><span class="p">(</span><span class="n">wait</span><span class="o">=</span><span class="n">wait_random_exponential</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mi">600</span><span class="p">),</span> <span class="n">stop</span><span class="o">=</span><span class="n">stop_after_attempt</span><span class="p">(</span><span class="mi">6</span><span class="p">))</span>
<span class="k">def</span><span class="w"> </span><span class="nf">call_anthropic</span><span class="p">(</span>
    <span class="n">inputs</span><span class="p">,</span> <span class="n">anthropic</span><span class="p">,</span> <span class="n">model_name_or_path</span><span class="p">,</span> <span class="n">temperature</span><span class="p">,</span> <span class="n">top_p</span><span class="p">,</span> <span class="o">**</span><span class="n">model_args</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calls the anthropic API to generate completions for the given inputs.</span>

<span class="sd">    Args:</span>
<span class="sd">    inputs (str): The inputs to generate completions for.</span>
<span class="sd">    anthropic (Anthropic): The anthropic API object.</span>
<span class="sd">    model_name_or_path (str): The name or path of the model to use.</span>
<span class="sd">    temperature (float): The temperature to use.</span>
<span class="sd">    top_p (float): The top_p to use.</span>
<span class="sd">    model_args (dict): A dictionary of model arguments.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">completion</span> <span class="o">=</span> <span class="n">anthropic</span><span class="o">.</span><span class="n">completions</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="n">model_name_or_path</span><span class="p">,</span>
            <span class="n">max_tokens_to_sample</span><span class="o">=</span><span class="mi">6000</span><span class="p">,</span>
            <span class="n">prompt</span><span class="o">=</span><span class="n">inputs</span><span class="p">,</span>
            <span class="n">temperature</span><span class="o">=</span><span class="n">temperature</span><span class="p">,</span>
            <span class="n">top_p</span><span class="o">=</span><span class="n">top_p</span><span class="p">,</span>
            <span class="o">**</span><span class="n">model_args</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">completion</span><span class="o">.</span><span class="n">completion</span>
        <span class="n">input_tokens</span> <span class="o">=</span> <span class="n">anthropic</span><span class="o">.</span><span class="n">count_tokens</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span>
        <span class="n">output_tokens</span> <span class="o">=</span> <span class="n">anthropic</span><span class="o">.</span><span class="n">count_tokens</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
        <span class="n">cost</span> <span class="o">=</span> <span class="n">calc_cost</span><span class="p">(</span><span class="n">model_name_or_path</span><span class="p">,</span> <span class="n">input_tokens</span><span class="p">,</span> <span class="n">output_tokens</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">completion</span><span class="p">,</span> <span class="n">cost</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Inputs: </span><span class="si">{</span><span class="n">inputs</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="swebench.inference.run_api.call_anthropic_v2" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>            <span class="doc doc-object-name doc-function-name">call_anthropic_v2</span>


</h5>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">call_anthropic_v2</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="n">anthropic</span><span class="p">,</span> <span class="n">model_name_or_path</span><span class="p">,</span> <span class="n">temperature</span><span class="p">,</span> <span class="n">top_p</span><span class="p">,</span> <span class="o">**</span><span class="n">model_args</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Calls the anthropic API to generate completions for the given inputs.</p>
<p>Args:
inputs list(str): The inputs to generate completions for.
anthropic (Anthropic): The anthropic API object.
model_name_or_path (str): The name or path of the model to use.
temperature (float): The temperature to use.
top_p (float): The top_p to use.
model_args (dict): A dictionary of model arguments.</p>


            <details class="quote">
              <summary>Source code in <code>swebench/inference/run_api.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@retry</span><span class="p">(</span><span class="n">wait</span><span class="o">=</span><span class="n">wait_random_exponential</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mi">600</span><span class="p">),</span> <span class="n">stop</span><span class="o">=</span><span class="n">stop_after_attempt</span><span class="p">(</span><span class="mi">6</span><span class="p">))</span>
<span class="k">def</span><span class="w"> </span><span class="nf">call_anthropic_v2</span><span class="p">(</span>
    <span class="n">inputs</span><span class="p">,</span> <span class="n">anthropic</span><span class="p">,</span> <span class="n">model_name_or_path</span><span class="p">,</span> <span class="n">temperature</span><span class="p">,</span> <span class="n">top_p</span><span class="p">,</span> <span class="o">**</span><span class="n">model_args</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calls the anthropic API to generate completions for the given inputs.</span>

<span class="sd">    Args:</span>
<span class="sd">    inputs list(str): The inputs to generate completions for.</span>
<span class="sd">    anthropic (Anthropic): The anthropic API object.</span>
<span class="sd">    model_name_or_path (str): The name or path of the model to use.</span>
<span class="sd">    temperature (float): The temperature to use.</span>
<span class="sd">    top_p (float): The top_p to use.</span>
<span class="sd">    model_args (dict): A dictionary of model arguments.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">system_messages</span> <span class="o">=</span> <span class="n">inputs</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">user_message</span> <span class="o">=</span> <span class="n">inputs</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">user_message</span><span class="p">},</span>
        <span class="p">]</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">anthropic</span><span class="o">.</span><span class="n">messages</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">,</span>
            <span class="n">max_tokens</span><span class="o">=</span><span class="mi">4096</span><span class="p">,</span>
            <span class="n">model</span><span class="o">=</span><span class="n">model_name_or_path</span><span class="p">,</span>
            <span class="n">temperature</span><span class="o">=</span><span class="n">temperature</span><span class="p">,</span>
            <span class="n">top_p</span><span class="o">=</span><span class="n">top_p</span><span class="p">,</span>
            <span class="n">system</span><span class="o">=</span><span class="n">system_messages</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">input_tokens</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">usage</span><span class="o">.</span><span class="n">input_tokens</span>
        <span class="n">output_tokens</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">usage</span><span class="o">.</span><span class="n">output_tokens</span>
        <span class="n">cost</span> <span class="o">=</span> <span class="n">calc_cost</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">input_tokens</span><span class="p">,</span> <span class="n">output_tokens</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">response</span><span class="p">,</span> <span class="n">cost</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Inputs: </span><span class="si">{</span><span class="n">inputs</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="swebench.inference.run_api.anthropic_inference" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>            <span class="doc doc-object-name doc-function-name">anthropic_inference</span>


</h5>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">anthropic_inference</span><span class="p">(</span><span class="n">test_dataset</span><span class="p">,</span> <span class="n">model_name_or_path</span><span class="p">,</span> <span class="n">output_file</span><span class="p">,</span> <span class="n">model_args</span><span class="p">,</span> <span class="n">existing_ids</span><span class="p">,</span> <span class="n">max_cost</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Runs inference on a dataset using the anthropic API.</p>
<p>Args:
test_dataset (datasets.Dataset): The dataset to run inference on.
model_name_or_path (str): The name or path of the model to use.
output_file (str): The path to the output file.
model_args (dict): A dictionary of model arguments.
existing_ids (set): A set of ids that have already been processed.
max_cost (float): The maximum cost to spend on inference.</p>


            <details class="quote">
              <summary>Source code in <code>swebench/inference/run_api.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">anthropic_inference</span><span class="p">(</span>
    <span class="n">test_dataset</span><span class="p">,</span>
    <span class="n">model_name_or_path</span><span class="p">,</span>
    <span class="n">output_file</span><span class="p">,</span>
    <span class="n">model_args</span><span class="p">,</span>
    <span class="n">existing_ids</span><span class="p">,</span>
    <span class="n">max_cost</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Runs inference on a dataset using the anthropic API.</span>

<span class="sd">    Args:</span>
<span class="sd">    test_dataset (datasets.Dataset): The dataset to run inference on.</span>
<span class="sd">    model_name_or_path (str): The name or path of the model to use.</span>
<span class="sd">    output_file (str): The path to the output file.</span>
<span class="sd">    model_args (dict): A dictionary of model arguments.</span>
<span class="sd">    existing_ids (set): A set of ids that have already been processed.</span>
<span class="sd">    max_cost (float): The maximum cost to spend on inference.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">api_key</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ANTHROPIC_API_KEY&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">api_key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;Must provide an api key. Expected in ANTHROPIC_API_KEY environment variable.&quot;</span>
        <span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using Anthropic key </span><span class="si">{</span><span class="s1">&#39;*&#39;</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="n">api_key</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">5</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">api_key</span><span class="p">[</span><span class="o">-</span><span class="mi">5</span><span class="p">:]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">anthropic</span> <span class="o">=</span> <span class="n">Anthropic</span><span class="p">(</span><span class="n">api_key</span><span class="o">=</span><span class="n">api_key</span><span class="p">)</span>
    <span class="n">test_dataset</span> <span class="o">=</span> <span class="n">test_dataset</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
        <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">claude_tokenize</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">],</span> <span class="n">anthropic</span><span class="p">)</span>
        <span class="o">&lt;=</span> <span class="n">MODEL_LIMITS</span><span class="p">[</span><span class="n">model_name_or_path</span><span class="p">],</span>
        <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Filtering&quot;</span><span class="p">,</span>
        <span class="n">load_from_cache_file</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">temperature</span> <span class="o">=</span> <span class="n">model_args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;temperature&quot;</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">)</span>
    <span class="n">top_p</span> <span class="o">=</span> <span class="n">model_args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;top_p&quot;</span><span class="p">,</span> <span class="mf">0.95</span> <span class="k">if</span> <span class="n">temperature</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">1</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using temperature=</span><span class="si">{</span><span class="n">temperature</span><span class="si">}</span><span class="s2">, top_p=</span><span class="si">{</span><span class="n">top_p</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">basic_args</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;model_name_or_path&quot;</span><span class="p">:</span> <span class="n">model_name_or_path</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">total_cost</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Filtered to </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">test_dataset</span><span class="p">)</span><span class="si">}</span><span class="s2"> instances&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="s2">&quot;claude-3&quot;</span> <span class="ow">in</span> <span class="n">model_name_or_path</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
        <span class="n">call_api</span> <span class="o">=</span> <span class="n">call_anthropic_v2</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">call_api</span> <span class="o">=</span> <span class="n">call_anthropic</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span> <span class="s2">&quot;a+&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">datum</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">test_dataset</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Inference for </span><span class="si">{</span><span class="n">model_name_or_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">):</span>
            <span class="n">instance_id</span> <span class="o">=</span> <span class="n">datum</span><span class="p">[</span><span class="s2">&quot;instance_id&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">instance_id</span> <span class="ow">in</span> <span class="n">existing_ids</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">output_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;instance_id&quot;</span><span class="p">:</span> <span class="n">instance_id</span><span class="p">}</span>
            <span class="n">output_dict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">basic_args</span><span class="p">)</span>
            <span class="k">if</span> <span class="s2">&quot;claude-3&quot;</span> <span class="ow">in</span> <span class="n">model_name_or_path</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                <span class="n">output_dict</span><span class="p">[</span><span class="s2">&quot;text_inputs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">datum</span><span class="p">[</span><span class="s1">&#39;text&#39;</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">output_dict</span><span class="p">[</span><span class="s2">&quot;text_inputs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">HUMAN_PROMPT</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">datum</span><span class="p">[</span><span class="s1">&#39;text&#39;</span><span class="p">]</span><span class="si">}</span><span class="se">\n\n</span><span class="si">{</span><span class="n">AI_PROMPT</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">completion</span><span class="p">,</span> <span class="n">cost</span> <span class="o">=</span> <span class="n">call_api</span><span class="p">(</span>
                    <span class="n">output_dict</span><span class="p">[</span><span class="s2">&quot;text_inputs&quot;</span><span class="p">],</span>
                    <span class="n">anthropic</span><span class="p">,</span>
                    <span class="n">model_name_or_path</span><span class="p">,</span>
                    <span class="n">temperature</span><span class="p">,</span>
                    <span class="n">top_p</span><span class="p">,</span>
                    <span class="o">**</span><span class="n">model_args</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
                <span class="k">continue</span>
            <span class="n">total_cost</span> <span class="o">+=</span> <span class="n">cost</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total Cost: </span><span class="si">{</span><span class="n">total_cost</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="s2">&quot;claude-3&quot;</span> <span class="ow">in</span> <span class="n">model_name_or_path</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                <span class="n">output_dict</span><span class="p">[</span><span class="s2">&quot;full_output&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">completion</span><span class="o">.</span><span class="n">content</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">text</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">output_dict</span><span class="p">[</span><span class="s2">&quot;full_output&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">completion</span><span class="o">.</span><span class="n">completion</span>
            <span class="n">output_dict</span><span class="p">[</span><span class="s2">&quot;model_patch&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">extract_diff</span><span class="p">(</span><span class="n">output_dict</span><span class="p">[</span><span class="s2">&quot;full_output&quot;</span><span class="p">])</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">output_dict</span><span class="p">),</span> <span class="n">file</span><span class="o">=</span><span class="n">f</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">max_cost</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">total_cost</span> <span class="o">&gt;=</span> <span class="n">max_cost</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Reached max cost </span><span class="si">{</span><span class="n">max_cost</span><span class="si">}</span><span class="s2">, exiting&quot;</span><span class="p">)</span>
                <span class="k">break</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="swebench.inference.run_api.parse_model_args" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>            <span class="doc doc-object-name doc-function-name">parse_model_args</span>


</h5>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">parse_model_args</span><span class="p">(</span><span class="n">model_args</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Parses a string of model arguments and returns a dictionary of keyword arguments.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>model_args</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A string of comma-separated key-value pairs representing model arguments.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>dict</code></td>            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A dictionary of keyword arguments parsed from the input string.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>swebench/inference/run_api.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">parse_model_args</span><span class="p">(</span><span class="n">model_args</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parses a string of model arguments and returns a dictionary of keyword arguments.</span>

<span class="sd">    Args:</span>
<span class="sd">        model_args (str): A string of comma-separated key-value pairs representing model arguments.</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: A dictionary of keyword arguments parsed from the input string.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">model_args</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">model_args</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">):</span>
            <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="p">)</span>
            <span class="c1"># infer value type</span>
            <span class="k">if</span> <span class="n">value</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;True&quot;</span><span class="p">,</span> <span class="s2">&quot;False&quot;</span><span class="p">}:</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span> <span class="o">==</span> <span class="s2">&quot;True&quot;</span>
            <span class="k">elif</span> <span class="n">value</span><span class="o">.</span><span class="n">isnumeric</span><span class="p">():</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">value</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">isnumeric</span><span class="p">():</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">value</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;None&quot;</span><span class="p">}:</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">elif</span> <span class="n">value</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;[]&quot;</span><span class="p">}:</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">elif</span> <span class="n">value</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">&quot;</span><span class="p">}:</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">elif</span> <span class="n">value</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">value</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">):</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">value</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">value</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">):</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
    <span class="k">return</span> <span class="n">kwargs</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="swebench.inference.run_api.main" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>            <span class="doc doc-object-name doc-function-name">main</span>


</h5>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">main</span><span class="p">(</span><span class="n">dataset_name_or_path</span><span class="p">,</span> <span class="n">split</span><span class="p">,</span> <span class="n">model_name_or_path</span><span class="p">,</span> <span class="n">shard_id</span><span class="p">,</span> <span class="n">num_shards</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">,</span> <span class="n">model_args</span><span class="p">,</span> <span class="n">max_cost</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">


            <details class="quote">
              <summary>Source code in <code>swebench/inference/run_api.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span>
    <span class="n">dataset_name_or_path</span><span class="p">,</span>
    <span class="n">split</span><span class="p">,</span>
    <span class="n">model_name_or_path</span><span class="p">,</span>
    <span class="n">shard_id</span><span class="p">,</span>
    <span class="n">num_shards</span><span class="p">,</span>
    <span class="n">output_dir</span><span class="p">,</span>
    <span class="n">model_args</span><span class="p">,</span>
    <span class="n">max_cost</span><span class="p">,</span>
<span class="p">):</span>
    <span class="k">if</span> <span class="n">shard_id</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">num_shards</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Received num_shards=</span><span class="si">{</span><span class="n">num_shards</span><span class="si">}</span><span class="s2"> but shard_id is None, ignoring&quot;</span>
        <span class="p">)</span>
    <span class="k">if</span> <span class="n">shard_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">num_shards</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Received shard_id=</span><span class="si">{</span><span class="n">shard_id</span><span class="si">}</span><span class="s2"> but num_shards is None, ignoring&quot;</span><span class="p">)</span>
    <span class="n">model_args</span> <span class="o">=</span> <span class="n">parse_model_args</span><span class="p">(</span><span class="n">model_args</span><span class="p">)</span>
    <span class="n">model_nickname</span> <span class="o">=</span> <span class="n">model_name_or_path</span>
    <span class="k">if</span> <span class="s2">&quot;checkpoint&quot;</span> <span class="ow">in</span> <span class="n">Path</span><span class="p">(</span><span class="n">model_name_or_path</span><span class="p">)</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
        <span class="n">model_nickname</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">model_name_or_path</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">name</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">model_nickname</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">model_name_or_path</span><span class="p">)</span><span class="o">.</span><span class="n">name</span>
    <span class="n">output_file</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">model_nickname</span><span class="si">}</span><span class="s2">__</span><span class="si">{</span><span class="n">dataset_name_or_path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">__</span><span class="si">{</span><span class="n">split</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">if</span> <span class="n">shard_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">num_shards</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">output_file</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;__shard-</span><span class="si">{</span><span class="n">shard_id</span><span class="si">}</span><span class="s2">__num_shards-</span><span class="si">{</span><span class="n">num_shards</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">output_file</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">output_file</span> <span class="o">+</span> <span class="s2">&quot;.jsonl&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Will write to </span><span class="si">{</span><span class="n">output_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">existing_ids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">output_file</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">output_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                <span class="n">instance_id</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;instance_id&quot;</span><span class="p">]</span>
                <span class="n">existing_ids</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">instance_id</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Read </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">existing_ids</span><span class="p">)</span><span class="si">}</span><span class="s2"> already completed ids from </span><span class="si">{</span><span class="n">output_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">Path</span><span class="p">(</span><span class="n">dataset_name_or_path</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
        <span class="n">dataset</span> <span class="o">=</span> <span class="n">load_from_disk</span><span class="p">(</span><span class="n">dataset_name_or_path</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">dataset</span> <span class="o">=</span> <span class="n">load_dataset</span><span class="p">(</span><span class="n">dataset_name_or_path</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">split</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dataset</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid split </span><span class="si">{</span><span class="n">split</span><span class="si">}</span><span class="s2"> for dataset </span><span class="si">{</span><span class="n">dataset_name_or_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">[</span><span class="n">split</span><span class="p">]</span>
    <span class="n">lens</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">len</span><span class="p">,</span> <span class="n">dataset</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">])))</span>
    <span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">lens</span><span class="p">))</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">existing_ids</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;instance_id&quot;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">existing_ids</span><span class="p">,</span>
            <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Filtering out existing ids&quot;</span><span class="p">,</span>
            <span class="n">load_from_cache_file</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">if</span> <span class="n">shard_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">num_shards</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">shard</span><span class="p">(</span><span class="n">num_shards</span><span class="p">,</span> <span class="n">shard_id</span><span class="p">,</span> <span class="n">contiguous</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">inference_args</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;test_dataset&quot;</span><span class="p">:</span> <span class="n">dataset</span><span class="p">,</span>
        <span class="s2">&quot;model_name_or_path&quot;</span><span class="p">:</span> <span class="n">model_name_or_path</span><span class="p">,</span>
        <span class="s2">&quot;output_file&quot;</span><span class="p">:</span> <span class="n">output_file</span><span class="p">,</span>
        <span class="s2">&quot;model_args&quot;</span><span class="p">:</span> <span class="n">model_args</span><span class="p">,</span>
        <span class="s2">&quot;existing_ids&quot;</span><span class="p">:</span> <span class="n">existing_ids</span><span class="p">,</span>
        <span class="s2">&quot;max_cost&quot;</span><span class="p">:</span> <span class="n">max_cost</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="n">model_name_or_path</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;claude&quot;</span><span class="p">):</span>
        <span class="n">anthropic_inference</span><span class="p">(</span><span class="o">**</span><span class="n">inference_args</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">model_name_or_path</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;gpt&quot;</span><span class="p">):</span>
        <span class="n">openai_inference</span><span class="p">(</span><span class="o">**</span><span class="n">inference_args</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid model name or path </span><span class="si">{</span><span class="n">model_name_or_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Done!&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h4 id="swebench.inference.run_live" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <span class="doc doc-object-name doc-module-name">run_live</span>


</h4>

    <div class="doc doc-contents ">

        <p>This module contains functions for running a live inference session on a GitHub issue.
It clones the repository associated with the issue, builds a BM25 retrieval index, and
generates a prompt for the user to interact with the model. The output is saved to a
specified directory.</p>









  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h5 id="swebench.inference.run_live.logger" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <span class="doc doc-object-name doc-attribute-name">logger</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-module-attribute"><code>module-attribute</code></small>
  </span>

</h5>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">logger</span> <span class="o">=</span> <span class="n"><span title="logging.getLogger">getLogger</span></span><span class="p">(</span><span class="n"><span title="__name__">__name__</span></span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h5 id="swebench.inference.run_live.parser" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <span class="doc doc-object-name doc-attribute-name">parser</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-module-attribute"><code>module-attribute</code></small>
  </span>

</h5>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">parser</span> <span class="o">=</span> <span class="n"><span title="argparse.ArgumentParser">ArgumentParser</span></span><span class="p">(</span><span class="n"><span title="argparse.ArgumentParser(description)">description</span></span><span class="o">=</span><span class="n"><span title="__doc__">__doc__</span></span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h5 id="swebench.inference.run_live.args" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <span class="doc doc-object-name doc-attribute-name">args</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-module-attribute"><code>module-attribute</code></small>
  </span>

</h5>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">args</span> <span class="o">=</span> <span class="n"><span title="swebench.inference.run_live.parser.parse_args">parse_args</span></span><span class="p">()</span>
</code></pre></div>

    <div class="doc doc-contents ">

    </div>

</div>



<div class="doc doc-object doc-function">


<h5 id="swebench.inference.run_live.get_problem_statement" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>            <span class="doc doc-object-name doc-function-name">get_problem_statement</span>


</h5>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">get_problem_statement</span><span class="p">(</span><span class="n">owner</span><span class="p">,</span> <span class="n">repo</span><span class="p">,</span> <span class="n">issue_num</span><span class="p">,</span> <span class="n">ghapi</span><span class="p">,</span> <span class="n">include_comments</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">


            <details class="quote">
              <summary>Source code in <code>swebench/inference/run_live.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_problem_statement</span><span class="p">(</span><span class="n">owner</span><span class="p">,</span> <span class="n">repo</span><span class="p">,</span> <span class="n">issue_num</span><span class="p">,</span> <span class="n">ghapi</span><span class="p">,</span> <span class="n">include_comments</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">issue</span> <span class="o">=</span> <span class="n">ghapi</span><span class="o">.</span><span class="n">issues</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">owner</span><span class="p">,</span> <span class="n">repo</span><span class="p">,</span> <span class="n">issue_num</span><span class="p">)</span>
    <span class="n">issue_text</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">issue</span><span class="o">.</span><span class="n">title</span><span class="p">,</span> <span class="n">issue</span><span class="o">.</span><span class="n">body</span><span class="p">])</span>
    <span class="c1"># Solved issues may include comments that give answers away too much</span>
    <span class="k">if</span> <span class="n">include_comments</span><span class="p">:</span>
        <span class="n">all_comments</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">ghapi</span><span class="o">.</span><span class="n">issues</span><span class="o">.</span><span class="n">list_comments</span><span class="p">(</span><span class="n">owner</span><span class="p">,</span> <span class="n">repo</span><span class="p">,</span> <span class="n">issue_num</span><span class="p">))</span>
        <span class="n">comments</span> <span class="o">=</span> <span class="p">[</span><span class="n">comment</span><span class="o">.</span><span class="n">body</span> <span class="k">for</span> <span class="n">comment</span> <span class="ow">in</span> <span class="n">all_comments</span><span class="p">]</span>
        <span class="n">comment_text</span> <span class="o">=</span> <span class="s2">&quot;Comment: &quot;</span> <span class="k">if</span> <span class="n">comments</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Comment:&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">comments</span><span class="p">)</span>
        <span class="n">issue_text</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">comment_text</span>
    <span class="k">return</span> <span class="n">issue_text</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="swebench.inference.run_live.get_readme_files" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>            <span class="doc doc-object-name doc-function-name">get_readme_files</span>


</h5>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">get_readme_files</span><span class="p">(</span><span class="n">repo_path</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">


            <details class="quote">
              <summary>Source code in <code>swebench/inference/run_live.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_readme_files</span><span class="p">(</span><span class="n">repo_path</span><span class="p">):</span>
    <span class="n">files</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">repo_path</span><span class="p">)</span><span class="o">.</span><span class="n">iterdir</span><span class="p">())</span>
    <span class="n">files</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">is_file</span><span class="p">(),</span> <span class="n">files</span><span class="p">))</span>
    <span class="n">files</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;readme&quot;</span><span class="p">),</span> <span class="n">files</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">files</span><span class="p">:</span>
        <span class="n">files</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
        <span class="n">files</span> <span class="o">=</span> <span class="p">[</span><span class="n">files</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">Path</span><span class="p">(</span><span class="n">file</span><span class="p">)</span><span class="o">.</span><span class="n">relative_to</span><span class="p">(</span><span class="n">repo_path</span><span class="p">)</span><span class="o">.</span><span class="n">as_posix</span><span class="p">()</span> <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="swebench.inference.run_live.make_instance" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>            <span class="doc doc-object-name doc-function-name">make_instance</span>


</h5>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">make_instance</span><span class="p">(</span><span class="n">owner</span><span class="p">,</span> <span class="n">repo</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">commit</span><span class="p">,</span> <span class="n">root_dir</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="n">document_encoding_func</span><span class="p">,</span> <span class="n">python</span><span class="p">,</span> <span class="n">instance_id</span><span class="p">,</span> <span class="n">tokenizer</span><span class="p">,</span> <span class="n">tokenizer_func</span><span class="p">,</span> <span class="n">prompt_style</span><span class="p">,</span> <span class="n">max_context_len</span><span class="p">,</span> <span class="n">include_readmes</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Creates an instance for a given query and repository.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>owner</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The owner of the repository.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>repo</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The name of the repository.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>query</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The query to search for.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>commit</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The commit hash to use.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>root_dir</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The root directory to clone the repository to.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>token</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The GitHub token to use for authentication.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>document_encoding_func</code>
            </td>
            <td>
                  <code><span title="function">function</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The function to use for encoding documents.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>python</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The path to the Python executable.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>instance_id</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The ID of the instance.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>tokenizer</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The name of the tokenizer to use.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>tokenizer_func</code>
            </td>
            <td>
                  <code><span title="function">function</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The function to use for tokenization.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>prompt_style</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The style of prompt to use.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>max_context_len</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The maximum length of the context.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>include_readmes</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to include README files in the instance.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>dict</code></td>            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The instance.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>swebench/inference/run_live.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">make_instance</span><span class="p">(</span>
    <span class="n">owner</span><span class="p">,</span>
    <span class="n">repo</span><span class="p">,</span>
    <span class="n">query</span><span class="p">,</span>
    <span class="n">commit</span><span class="p">,</span>
    <span class="n">root_dir</span><span class="p">,</span>
    <span class="n">token</span><span class="p">,</span>
    <span class="n">document_encoding_func</span><span class="p">,</span>
    <span class="n">python</span><span class="p">,</span>
    <span class="n">instance_id</span><span class="p">,</span>
    <span class="n">tokenizer</span><span class="p">,</span>
    <span class="n">tokenizer_func</span><span class="p">,</span>
    <span class="n">prompt_style</span><span class="p">,</span>
    <span class="n">max_context_len</span><span class="p">,</span>
    <span class="n">include_readmes</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Creates an instance for a given query and repository.</span>

<span class="sd">    Args:</span>
<span class="sd">        owner (str): The owner of the repository.</span>
<span class="sd">        repo (str): The name of the repository.</span>
<span class="sd">        query (str): The query to search for.</span>
<span class="sd">        commit (str): The commit hash to use.</span>
<span class="sd">        root_dir (str): The root directory to clone the repository to.</span>
<span class="sd">        token (str): The GitHub token to use for authentication.</span>
<span class="sd">        document_encoding_func (function): The function to use for encoding documents.</span>
<span class="sd">        python (str): The path to the Python executable.</span>
<span class="sd">        instance_id (int): The ID of the instance.</span>
<span class="sd">        tokenizer (str): The name of the tokenizer to use.</span>
<span class="sd">        tokenizer_func (function): The function to use for tokenization.</span>
<span class="sd">        prompt_style (str): The style of prompt to use.</span>
<span class="sd">        max_context_len (int): The maximum length of the context.</span>
<span class="sd">        include_readmes (bool): Whether to include README files in the instance.</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: The instance.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">thread_id</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">instance</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;instance_id&quot;</span><span class="p">:</span> <span class="n">instance_id</span><span class="p">,</span> <span class="s2">&quot;problem_statement&quot;</span><span class="p">:</span> <span class="n">query</span><span class="p">}</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cloning repo </span><span class="si">{</span><span class="n">owner</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">repo</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">repo_dir</span> <span class="o">=</span> <span class="n">clone_repo</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">owner</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">repo</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">root_dir</span><span class="p">,</span> <span class="n">token</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">commit</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">commit</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">([</span><span class="s2">&quot;git&quot;</span><span class="p">,</span> <span class="s2">&quot;rev-parse&quot;</span><span class="p">,</span> <span class="s2">&quot;HEAD&quot;</span><span class="p">],</span> <span class="n">cwd</span><span class="o">=</span><span class="n">repo_dir</span><span class="p">)</span>
            <span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
            <span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Building BM25 retrieval index for </span><span class="si">{</span><span class="n">owner</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">repo</span><span class="si">}</span><span class="s2">@</span><span class="si">{</span><span class="n">commit</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">index_dir</span> <span class="o">=</span> <span class="n">make_index</span><span class="p">(</span>
        <span class="n">repo_dir</span><span class="o">=</span><span class="n">repo_dir</span><span class="p">,</span>
        <span class="n">root_dir</span><span class="o">=</span><span class="n">root_dir</span><span class="p">,</span>
        <span class="n">query</span><span class="o">=</span><span class="n">query</span><span class="p">,</span>
        <span class="n">commit</span><span class="o">=</span><span class="n">commit</span><span class="p">,</span>
        <span class="n">document_encoding_func</span><span class="o">=</span><span class="n">document_encoding_func</span><span class="p">,</span>
        <span class="n">python</span><span class="o">=</span><span class="n">python</span><span class="p">,</span>
        <span class="n">instance_id</span><span class="o">=</span><span class="n">instance_id</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">search</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">index_dir</span><span class="p">)</span>
    <span class="n">hits</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s2">&quot;hits&quot;</span><span class="p">]</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Retrieved </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">hits</span><span class="p">)</span><span class="si">}</span><span class="s2"> documents&quot;</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">ContextManager</span><span class="p">(</span><span class="n">repo_dir</span><span class="p">,</span> <span class="n">commit</span><span class="p">)</span> <span class="k">as</span> <span class="n">cm</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">include_readmes</span><span class="p">:</span>
            <span class="n">readmes</span> <span class="o">=</span> <span class="n">get_readme_files</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">repo_path</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">readmes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="n">instance</span><span class="p">[</span><span class="s2">&quot;readmes&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ingest_files</span><span class="p">(</span><span class="n">readmes</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">hit</span> <span class="ow">in</span> <span class="n">hits</span><span class="p">:</span>
            <span class="n">hit</span><span class="p">[</span><span class="s2">&quot;file_contents&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">hit</span><span class="p">[</span><span class="s2">&quot;docid&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">instance</span><span class="p">[</span><span class="s2">&quot;file_contents&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">base_text_inputs</span> <span class="o">=</span> <span class="n">PROMPT_FUNCTIONS</span><span class="p">[</span><span class="n">prompt_style</span><span class="p">](</span><span class="n">instance</span><span class="p">)</span>
        <span class="n">base_text_input_length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tokenizer_func</span><span class="p">(</span><span class="n">base_text_inputs</span><span class="p">,</span> <span class="n">tokenizer</span><span class="p">))</span>
        <span class="n">instance</span><span class="p">[</span><span class="s2">&quot;file_contents&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">x</span><span class="p">[</span><span class="s2">&quot;docid&quot;</span><span class="p">]:</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;file_contents&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">hits</span><span class="p">}</span>
        <span class="n">cur_input_len</span> <span class="o">=</span> <span class="n">base_text_input_length</span>
        <span class="n">include_files</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="s2">&quot;docid&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">hits</span><span class="p">]:</span>
            <span class="n">content</span> <span class="o">=</span> <span class="n">make_code_text</span><span class="p">({</span><span class="n">filename</span><span class="p">:</span> <span class="n">instance</span><span class="p">[</span><span class="s2">&quot;file_contents&quot;</span><span class="p">][</span><span class="n">filename</span><span class="p">]})</span>
            <span class="n">tokens</span> <span class="o">=</span> <span class="n">tokenizer_func</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="n">tokenizer</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">cur_input_len</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">max_context_len</span><span class="p">:</span>
                <span class="n">include_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
                <span class="n">cur_input_len</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Including </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">include_files</span><span class="p">)</span><span class="si">}</span><span class="s2"> files in context with </span><span class="si">{</span><span class="n">cur_input_len</span><span class="si">}</span><span class="s2"> tokens:</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n\t</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">include_files</span><span class="p">))</span>
        <span class="p">)</span>
        <span class="n">instance</span><span class="p">[</span><span class="s2">&quot;file_contents&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">filename</span><span class="p">:</span> <span class="n">instance</span><span class="p">[</span><span class="s2">&quot;file_contents&quot;</span><span class="p">][</span><span class="n">filename</span><span class="p">]</span> <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">include_files</span>
        <span class="p">}</span>
        <span class="n">instance</span><span class="p">[</span><span class="s2">&quot;text_inputs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">PROMPT_FUNCTIONS</span><span class="p">[</span><span class="n">prompt_style</span><span class="p">](</span><span class="n">instance</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">instance</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="swebench.inference.run_live.parse_issue_url" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>            <span class="doc doc-object-name doc-function-name">parse_issue_url</span>


</h5>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">parse_issue_url</span><span class="p">(</span><span class="n">issue_url</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">


            <details class="quote">
              <summary>Source code in <code>swebench/inference/run_live.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">parse_issue_url</span><span class="p">(</span><span class="n">issue_url</span><span class="p">):</span>
    <span class="n">issue_pat</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;github\.com\/(.+?)\/(.+?)\/issues\/(\d+)&quot;</span><span class="p">)</span>
    <span class="n">match</span> <span class="o">=</span> <span class="n">issue_pat</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">issue_url</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">match</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;issue_url (</span><span class="si">{</span><span class="n">issue_url</span><span class="si">}</span><span class="s2">) does not seem to be a valid issue url.&quot;</span>
            <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Please use url like https://github.com/owner/repo/issues/12345&quot;</span>
        <span class="p">)</span>
    <span class="n">owner</span><span class="p">,</span> <span class="n">repo</span><span class="p">,</span> <span class="n">issue_num</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">groups</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">owner</span><span class="p">,</span> <span class="n">repo</span><span class="p">,</span> <span class="n">issue_num</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="swebench.inference.run_live.main" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>            <span class="doc doc-object-name doc-function-name">main</span>


</h5>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">main</span><span class="p">(</span><span class="n">model_name</span><span class="p">,</span> <span class="n">prompt_style</span><span class="p">,</span> <span class="n">issue_url</span><span class="p">,</span> <span class="n">base_commit</span><span class="p">,</span> <span class="n">max_context_length</span><span class="p">,</span> <span class="n">document_encoding_func</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">,</span> <span class="n">root_dir</span><span class="p">,</span> <span class="n">include_readmes</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">


            <details class="quote">
              <summary>Source code in <code>swebench/inference/run_live.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span>
    <span class="n">model_name</span><span class="p">,</span>
    <span class="n">prompt_style</span><span class="p">,</span>
    <span class="n">issue_url</span><span class="p">,</span>
    <span class="n">base_commit</span><span class="p">,</span>
    <span class="n">max_context_length</span><span class="p">,</span>
    <span class="n">document_encoding_func</span><span class="p">,</span>
    <span class="n">output_dir</span><span class="p">,</span>
    <span class="n">root_dir</span><span class="p">,</span>
    <span class="n">include_readmes</span><span class="p">,</span>
<span class="p">):</span>
    <span class="k">if</span> <span class="n">base_commit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">issue_url</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">base_commit</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;Must provide either no base commits or one base commit per issue url&quot;</span>
        <span class="p">)</span>
    <span class="k">if</span> <span class="n">base_commit</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">base_commit</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">issue_url</span><span class="p">)</span>
    <span class="n">gh_token</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;GITHUB_TOKEN&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">gh_token</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using GitHub token: </span><span class="si">{</span><span class="s1">&#39;*&#39;</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">8</span><span class="si">}{</span><span class="n">gh_token</span><span class="p">[</span><span class="o">-</span><span class="mi">4</span><span class="p">:]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">gh</span> <span class="o">=</span> <span class="n">GhApi</span><span class="p">(</span><span class="n">token</span><span class="o">=</span><span class="n">gh_token</span><span class="p">)</span>
    <span class="n">tokenizer</span><span class="p">,</span> <span class="n">tokenizer_func</span> <span class="o">=</span> <span class="n">TOKENIZER_FUNCS</span><span class="p">[</span><span class="s2">&quot;cl100k&quot;</span><span class="p">]</span>
    <span class="n">document_encoding_func</span> <span class="o">=</span> <span class="n">DOCUMENT_ENCODING_FUNCTIONS</span><span class="p">[</span><span class="n">document_encoding_func</span><span class="p">]</span>
    <span class="n">python</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">([</span><span class="s2">&quot;which&quot;</span><span class="p">,</span> <span class="s2">&quot;python&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="n">outputs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">issue</span><span class="p">,</span> <span class="n">commit</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">issue_url</span><span class="p">,</span> <span class="n">base_commit</span><span class="p">),</span> <span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">issue_url</span><span class="p">)):</span>
        <span class="n">owner</span><span class="p">,</span> <span class="n">repo</span><span class="p">,</span> <span class="n">issue_num</span> <span class="o">=</span> <span class="n">parse_issue_url</span><span class="p">(</span><span class="n">issue</span><span class="p">)</span>
        <span class="n">problem_statement</span> <span class="o">=</span> <span class="n">get_problem_statement</span><span class="p">(</span><span class="n">owner</span><span class="p">,</span> <span class="n">repo</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">issue_num</span><span class="p">),</span> <span class="n">gh</span><span class="p">)</span>
        <span class="n">instance_id</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">owner</span><span class="si">}</span><span class="s2">__</span><span class="si">{</span><span class="n">repo</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">issue_num</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Creating instance </span><span class="si">{</span><span class="n">instance_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">instance</span> <span class="o">=</span> <span class="n">make_instance</span><span class="p">(</span>
            <span class="n">owner</span><span class="o">=</span><span class="n">owner</span><span class="p">,</span>
            <span class="n">repo</span><span class="o">=</span><span class="n">repo</span><span class="p">,</span>
            <span class="n">query</span><span class="o">=</span><span class="n">problem_statement</span><span class="p">,</span>
            <span class="n">commit</span><span class="o">=</span><span class="n">commit</span><span class="p">,</span>
            <span class="n">root_dir</span><span class="o">=</span><span class="n">root_dir</span><span class="p">,</span>
            <span class="n">token</span><span class="o">=</span><span class="n">gh_token</span><span class="p">,</span>
            <span class="n">document_encoding_func</span><span class="o">=</span><span class="n">document_encoding_func</span><span class="p">,</span>
            <span class="n">python</span><span class="o">=</span><span class="n">python</span><span class="p">,</span>
            <span class="n">instance_id</span><span class="o">=</span><span class="n">instance_id</span><span class="p">,</span>
            <span class="n">tokenizer</span><span class="o">=</span><span class="n">tokenizer</span><span class="p">,</span>
            <span class="n">tokenizer_func</span><span class="o">=</span><span class="n">tokenizer_func</span><span class="p">,</span>
            <span class="n">prompt_style</span><span class="o">=</span><span class="n">prompt_style</span><span class="p">,</span>
            <span class="n">max_context_len</span><span class="o">=</span><span class="n">max_context_length</span><span class="p">,</span>
            <span class="n">include_readmes</span><span class="o">=</span><span class="n">include_readmes</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Calling model </span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">model_name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;gpt&quot;</span><span class="p">):</span>
            <span class="n">inputs</span> <span class="o">=</span> <span class="n">instance</span><span class="p">[</span><span class="s2">&quot;text_inputs&quot;</span><span class="p">]</span>
            <span class="n">response</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">call_chat</span><span class="p">(</span>
                <span class="n">model_name</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">use_azure</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">temperature</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">top_p</span><span class="o">=</span><span class="mi">1</span>
            <span class="p">)</span>
            <span class="n">completion</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">content</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Generated </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">usage</span><span class="o">.</span><span class="n">completion_tokens</span><span class="si">}</span><span class="s2"> tokens in </span><span class="si">{</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> seconds&quot;</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">anthropic</span><span class="w"> </span><span class="kn">import</span> <span class="n">Anthropic</span>

            <span class="n">api_key</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ANTHROPIC_API_KEY&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">anthropic</span> <span class="o">=</span> <span class="n">Anthropic</span><span class="p">(</span><span class="n">api_key</span><span class="o">=</span><span class="n">api_key</span><span class="p">)</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">call_anthropic</span><span class="p">(</span>
                <span class="n">inputs</span><span class="p">,</span> <span class="n">anthropic</span><span class="p">,</span> <span class="n">model_name</span><span class="p">,</span> <span class="n">temperature</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">top_p</span><span class="o">=</span><span class="mi">1</span>
            <span class="p">)</span>
            <span class="n">completion</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">completion</span>
        <span class="n">model_patch</span> <span class="o">=</span> <span class="n">extract_diff</span><span class="p">(</span><span class="n">completion</span><span class="p">)</span>
        <span class="n">minimal_patch</span> <span class="o">=</span> <span class="n">extract_minimal_patch</span><span class="p">(</span><span class="n">model_patch</span><span class="p">)</span>
        <span class="n">outputs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;instance_id&quot;</span><span class="p">:</span> <span class="n">instance_id</span><span class="p">,</span>
                <span class="s2">&quot;response&quot;</span><span class="p">:</span> <span class="n">completion</span><span class="p">,</span>
                <span class="s2">&quot;problem_statement&quot;</span><span class="p">:</span> <span class="n">problem_statement</span><span class="p">,</span>
                <span class="s2">&quot;text_inputs&quot;</span><span class="p">:</span> <span class="n">inputs</span><span class="p">,</span>
                <span class="s2">&quot;model_patch&quot;</span><span class="p">:</span> <span class="n">model_patch</span><span class="p">,</span>
                <span class="s2">&quot;minimal_patch&quot;</span><span class="p">:</span> <span class="n">minimal_patch</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">output_file</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span>
        <span class="n">output_dir</span><span class="p">,</span>
        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2">__</span><span class="si">{</span><span class="n">prompt_style</span><span class="si">}</span><span class="s2">__</span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">_%H-%M-%S&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">.jsonl&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span> <span class="s2">&quot;+a&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">output</span> <span class="ow">in</span> <span class="n">outputs</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">output</span><span class="p">),</span> <span class="n">file</span><span class="o">=</span><span class="n">f</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Wrote output to </span><span class="si">{</span><span class="n">output_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h4 id="swebench.inference.run_llama" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <span class="doc doc-object-name doc-module-name">run_llama</span>


</h4>

    <div class="doc doc-contents ">









  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h5 id="swebench.inference.run_llama.logger" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <span class="doc doc-object-name doc-attribute-name">logger</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-module-attribute"><code>module-attribute</code></small>
  </span>

</h5>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">logger</span> <span class="o">=</span> <span class="n"><span title="logging.getLogger">getLogger</span></span><span class="p">(</span><span class="n"><span title="__name__">__name__</span></span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h5 id="swebench.inference.run_llama.DEVICE_MAPS" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <span class="doc doc-object-name doc-attribute-name">DEVICE_MAPS</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-module-attribute"><code>module-attribute</code></small>
  </span>

</h5>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">DEVICE_MAPS</span> <span class="o">=</span> <span class="n"><span title="json.load">load</span></span><span class="p">(</span><span class="n"><span title="open">open</span></span><span class="p">(</span><span class="n"><span title="parent">parent</span></span> <span class="o">/</span> <span class="s1">&#39;codellama_device_maps.json&#39;</span><span class="p">))</span>
</code></pre></div>

    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h5 id="swebench.inference.run_llama.parser" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <span class="doc doc-object-name doc-attribute-name">parser</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-module-attribute"><code>module-attribute</code></small>
  </span>

</h5>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">parser</span> <span class="o">=</span> <span class="n"><span title="argparse.ArgumentParser">ArgumentParser</span></span><span class="p">()</span>
</code></pre></div>

    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h5 id="swebench.inference.run_llama.args" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <span class="doc doc-object-name doc-attribute-name">args</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-module-attribute"><code>module-attribute</code></small>
  </span>

</h5>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">args</span> <span class="o">=</span> <span class="n"><span title="swebench.inference.run_llama.parser.parse_args">parse_args</span></span><span class="p">()</span>
</code></pre></div>

    <div class="doc doc-contents ">

    </div>

</div>



<div class="doc doc-object doc-function">


<h5 id="swebench.inference.run_llama.get_output_file" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>            <span class="doc doc-object-name doc-function-name">get_output_file</span>


</h5>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">get_output_file</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">model_name_or_path</span><span class="p">,</span> <span class="n">peft_path</span><span class="p">,</span> <span class="n">dataset_path</span><span class="p">,</span> <span class="n">split</span><span class="p">,</span> <span class="n">temperature</span><span class="p">,</span> <span class="n">top_p</span><span class="p">,</span> <span class="n">min_len</span><span class="p">,</span> <span class="n">max_len</span><span class="p">,</span> <span class="n">shard_id</span><span class="p">,</span> <span class="n">num_shards</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Constructs the output file path based on the provided parameters.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>output_dir</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The directory where the output file will be saved.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>model_name_or_path</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The name or path of the model.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>peft_path</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The path to the PEFT file.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>dataset_path</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The path to the dataset.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>split</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The dataset split.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>temperature</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The temperature value.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>top_p</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The top-p value.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>min_len</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The minimum length of the output.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>max_len</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The maximum length of the output.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>shard_id</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The shard ID.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>num_shards</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The total number of shards.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>str</code></td>            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The constructed output file path.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>swebench/inference/run_llama.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_output_file</span><span class="p">(</span>
    <span class="n">output_dir</span><span class="p">,</span>
    <span class="n">model_name_or_path</span><span class="p">,</span>
    <span class="n">peft_path</span><span class="p">,</span>
    <span class="n">dataset_path</span><span class="p">,</span>
    <span class="n">split</span><span class="p">,</span>
    <span class="n">temperature</span><span class="p">,</span>
    <span class="n">top_p</span><span class="p">,</span>
    <span class="n">min_len</span><span class="p">,</span>
    <span class="n">max_len</span><span class="p">,</span>
    <span class="n">shard_id</span><span class="p">,</span>
    <span class="n">num_shards</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Constructs the output file path based on the provided parameters.</span>

<span class="sd">    Args:</span>
<span class="sd">        output_dir (str): The directory where the output file will be saved.</span>
<span class="sd">        model_name_or_path (str): The name or path of the model.</span>
<span class="sd">        peft_path (str): The path to the PEFT file.</span>
<span class="sd">        dataset_path (str): The path to the dataset.</span>
<span class="sd">        split (str): The dataset split.</span>
<span class="sd">        temperature (float): The temperature value.</span>
<span class="sd">        top_p (float): The top-p value.</span>
<span class="sd">        min_len (int): The minimum length of the output.</span>
<span class="sd">        max_len (int): The maximum length of the output.</span>
<span class="sd">        shard_id (int): The shard ID.</span>
<span class="sd">        num_shards (int): The total number of shards.</span>

<span class="sd">    Returns:</span>
<span class="sd">        str: The constructed output file path.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">suffix</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">if</span> <span class="n">min_len</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">suffix</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;__min-</span><span class="si">{</span><span class="n">min_len</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">if</span> <span class="n">max_len</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">suffix</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;__max-</span><span class="si">{</span><span class="n">max_len</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">if</span> <span class="n">shard_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">num_shards</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">suffix</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;__shard-</span><span class="si">{</span><span class="n">shard_id</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">num_shards</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">if</span> <span class="n">Path</span><span class="p">(</span><span class="n">dataset_path</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
        <span class="n">dset_nickname</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">dataset_path</span><span class="p">)</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;__&quot;</span> <span class="o">+</span> <span class="n">split</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">dset_nickname</span> <span class="o">=</span> <span class="n">dataset_path</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="s2">&quot;__&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;__&quot;</span> <span class="o">+</span> <span class="n">split</span>
    <span class="k">if</span> <span class="n">peft_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="s2">&quot;checkpoint&quot;</span> <span class="ow">in</span> <span class="n">Path</span><span class="p">(</span><span class="n">peft_path</span><span class="p">)</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
        <span class="n">model_nickname</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">peft_path</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;__&quot;</span> <span class="o">+</span> <span class="n">Path</span><span class="p">(</span><span class="n">peft_path</span><span class="p">)</span><span class="o">.</span><span class="n">name</span>
    <span class="k">elif</span> <span class="n">peft_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">model_nickname</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">peft_path</span><span class="p">)</span><span class="o">.</span><span class="n">name</span>
    <span class="k">elif</span> <span class="n">Path</span><span class="p">(</span><span class="n">model_name_or_path</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
        <span class="k">if</span> <span class="s2">&quot;checkpoint&quot;</span> <span class="ow">in</span> <span class="n">Path</span><span class="p">(</span><span class="n">model_name_or_path</span><span class="p">)</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
            <span class="n">model_nickname</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">Path</span><span class="p">(</span><span class="n">model_name_or_path</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">name</span>
                <span class="o">+</span> <span class="s2">&quot;__&quot;</span>
                <span class="o">+</span> <span class="n">Path</span><span class="p">(</span><span class="n">model_name_or_path</span><span class="p">)</span><span class="o">.</span><span class="n">name</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">model_nickname</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">model_name_or_path</span><span class="p">)</span><span class="o">.</span><span class="n">name</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">model_nickname</span> <span class="o">=</span> <span class="n">model_name_or_path</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="s2">&quot;__&quot;</span><span class="p">)</span>
    <span class="n">output_file</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span>
        <span class="n">output_dir</span><span class="p">,</span>
        <span class="n">dset_nickname</span>
        <span class="o">+</span> <span class="s2">&quot;__&quot;</span>
        <span class="o">+</span> <span class="n">model_nickname</span>
        <span class="o">+</span> <span class="s2">&quot;__temp-&quot;</span>
        <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">temperature</span><span class="p">)</span>
        <span class="o">+</span> <span class="s2">&quot;__top-p-&quot;</span>
        <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">top_p</span><span class="p">)</span>
        <span class="o">+</span> <span class="n">suffix</span>
        <span class="o">+</span> <span class="s2">&quot;.jsonl&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">output_file</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
        <span class="n">output_file</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span>
            <span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>  <span class="c1"># exists_ok=True for parallel</span>
    <span class="k">return</span> <span class="n">output_file</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="swebench.inference.run_llama.load_model" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>            <span class="doc doc-object-name doc-function-name">load_model</span>


</h5>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">load_model</span><span class="p">(</span><span class="n">model_name_or_path</span><span class="p">,</span> <span class="n">peft_path</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Loads a base model and optionally PEFT adapters.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>model_name_or_path</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The name or path of the base model.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>peft_path</code>
            </td>
            <td>
                  <code><span title="str">str</span> or None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The path to the PEFT adapters. If None, no PEFT adapters will be loaded.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>model</code></td>            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The loaded model.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ValueError">ValueError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If there is no device map for the specified model_name_or_path.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>swebench/inference/run_llama.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">load_model</span><span class="p">(</span><span class="n">model_name_or_path</span><span class="p">,</span> <span class="n">peft_path</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Loads a base model and optionally PEFT adapters.</span>

<span class="sd">    Args:</span>
<span class="sd">        model_name_or_path (str): The name or path of the base model.</span>
<span class="sd">        peft_path (str or None): The path to the PEFT adapters. If None, no PEFT adapters will be loaded.</span>

<span class="sd">    Returns:</span>
<span class="sd">        model: The loaded model.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If there is no device map for the specified model_name_or_path.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loading base model from </span><span class="si">{</span><span class="n">model_name_or_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">max_memory</span> <span class="o">=</span> <span class="p">{</span>
        <span class="o">**</span><span class="p">{</span>
            <span class="n">k</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">get_device_properties</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">.</span><span class="n">total_memory</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="mi">1_010_000_000</span><span class="si">:</span><span class="s2">d</span><span class="si">}</span><span class="s2">GIB&quot;</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">device_count</span><span class="p">())</span>
        <span class="p">},</span>
        <span class="s2">&quot;cpu&quot;</span><span class="p">:</span> <span class="s2">&quot;20GIB&quot;</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using max memory </span><span class="si">{</span><span class="n">max_memory</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="s2">&quot;-7b&quot;</span> <span class="ow">in</span> <span class="n">model_name_or_path</span><span class="p">:</span>
        <span class="n">device_map</span> <span class="o">=</span> <span class="n">DEVICE_MAPS</span><span class="p">[</span><span class="s2">&quot;7b&quot;</span><span class="p">][</span><span class="nb">str</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">device_count</span><span class="p">())]</span>
    <span class="k">elif</span> <span class="s2">&quot;-13b&quot;</span> <span class="ow">in</span> <span class="n">model_name_or_path</span><span class="p">:</span>
        <span class="n">device_map</span> <span class="o">=</span> <span class="n">DEVICE_MAPS</span><span class="p">[</span><span class="s2">&quot;13b&quot;</span><span class="p">][</span><span class="nb">str</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">device_count</span><span class="p">())]</span>
    <span class="k">elif</span> <span class="s2">&quot;-34b&quot;</span> <span class="ow">in</span> <span class="n">model_name_or_path</span><span class="p">:</span>
        <span class="n">device_map</span> <span class="o">=</span> <span class="n">DEVICE_MAPS</span><span class="p">[</span><span class="s2">&quot;34b&quot;</span><span class="p">][</span><span class="nb">str</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">device_count</span><span class="p">())]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No device map for </span><span class="si">{</span><span class="n">model_name_or_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using device_map </span><span class="si">{</span><span class="n">device_map</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">AutoModelForCausalLM</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span>
        <span class="n">model_name_or_path</span><span class="p">,</span>
        <span class="n">max_memory</span><span class="o">=</span><span class="n">max_memory</span><span class="p">,</span>
        <span class="n">device_map</span><span class="o">=</span><span class="n">device_map</span><span class="p">,</span>
        <span class="n">torch_dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">bfloat16</span><span class="p">,</span>
    <span class="p">)</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">peft_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;No PEFT adapters to load&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">model</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loading PEFT adapters from </span><span class="si">{</span><span class="n">peft_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">PeftModel</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span>
        <span class="n">model</span><span class="p">,</span>
        <span class="n">peft_path</span><span class="p">,</span>
        <span class="n">device_map</span><span class="o">=</span><span class="n">device_map</span><span class="p">,</span>
        <span class="n">torch_dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">bfloat16</span><span class="p">,</span>
        <span class="n">max_memory</span><span class="o">=</span><span class="n">max_memory</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">model</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="swebench.inference.run_llama.load_tokenizer" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>            <span class="doc doc-object-name doc-function-name">load_tokenizer</span>


</h5>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">load_tokenizer</span><span class="p">(</span><span class="n">model_name_or_path</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">


            <details class="quote">
              <summary>Source code in <code>swebench/inference/run_llama.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">load_tokenizer</span><span class="p">(</span><span class="n">model_name_or_path</span><span class="p">):</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loading tokenizer </span><span class="si">{</span><span class="n">model_name_or_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">tokenizer</span> <span class="o">=</span> <span class="n">LlamaTokenizer</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">model_name_or_path</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">tokenizer</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="swebench.inference.run_llama.load_data" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>            <span class="doc doc-object-name doc-function-name">load_data</span>


</h5>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">load_data</span><span class="p">(</span><span class="n">dataset_path</span><span class="p">,</span> <span class="n">split</span><span class="p">,</span> <span class="n">tokenizer</span><span class="p">,</span> <span class="n">min_len</span><span class="p">,</span> <span class="n">max_len</span><span class="p">,</span> <span class="n">model_name_or_path</span><span class="p">,</span> <span class="n">peft_path</span><span class="p">,</span> <span class="n">existing_ids</span><span class="p">,</span> <span class="n">shard_id</span><span class="p">,</span> <span class="n">num_shards</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Load and preprocess the dataset for model inference.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>dataset_path</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The path to the dataset.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>split</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The split of the dataset to load.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>tokenizer</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The tokenizer used to tokenize the text.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>min_len</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The minimum length of input sequences to include in the dataset.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>max_len</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The maximum length of input sequences to include in the dataset.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>model_name_or_path</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The name or path of the model.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>peft_path</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The path to the PEFT file.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>existing_ids</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The list of existing instance IDs to filter out from the dataset.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>shard_id</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The ID of the shard to load.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>num_shards</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The total number of shards.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>dataset</code></td>            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The preprocessed dataset for model inference.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>swebench/inference/run_llama.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">load_data</span><span class="p">(</span>
    <span class="n">dataset_path</span><span class="p">,</span>
    <span class="n">split</span><span class="p">,</span>
    <span class="n">tokenizer</span><span class="p">,</span>
    <span class="n">min_len</span><span class="p">,</span>
    <span class="n">max_len</span><span class="p">,</span>
    <span class="n">model_name_or_path</span><span class="p">,</span>
    <span class="n">peft_path</span><span class="p">,</span>
    <span class="n">existing_ids</span><span class="p">,</span>
    <span class="n">shard_id</span><span class="p">,</span>
    <span class="n">num_shards</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Load and preprocess the dataset for model inference.</span>

<span class="sd">    Args:</span>
<span class="sd">        dataset_path (str): The path to the dataset.</span>
<span class="sd">        split (str): The split of the dataset to load.</span>
<span class="sd">        tokenizer: The tokenizer used to tokenize the text.</span>
<span class="sd">        min_len (int): The minimum length of input sequences to include in the dataset.</span>
<span class="sd">        max_len (int): The maximum length of input sequences to include in the dataset.</span>
<span class="sd">        model_name_or_path (str): The name or path of the model.</span>
<span class="sd">        peft_path (str): The path to the PEFT file.</span>
<span class="sd">        existing_ids: The list of existing instance IDs to filter out from the dataset.</span>
<span class="sd">        shard_id (int): The ID of the shard to load.</span>
<span class="sd">        num_shards (int): The total number of shards.</span>

<span class="sd">    Returns:</span>
<span class="sd">        dataset: The preprocessed dataset for model inference.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loading dataset from </span><span class="si">{</span><span class="n">dataset_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">Path</span><span class="p">(</span><span class="n">dataset_path</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
        <span class="n">dataset</span> <span class="o">=</span> <span class="n">load_dataset</span><span class="p">(</span><span class="n">dataset_path</span><span class="p">,</span> <span class="n">split</span><span class="o">=</span><span class="n">split</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">Path</span><span class="p">(</span><span class="n">dataset_path</span><span class="p">,</span> <span class="n">split</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
        <span class="n">dataset</span> <span class="o">=</span> <span class="n">load_from_disk</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">dataset_path</span><span class="p">)</span> <span class="o">/</span> <span class="n">split</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">dataset</span> <span class="o">=</span> <span class="n">load_dataset</span><span class="p">(</span><span class="n">dataset_path</span><span class="p">)[</span><span class="n">split</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">peft_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">model_nickname</span> <span class="o">=</span> <span class="s2">&quot;__&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">peft_path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">2</span><span class="p">:])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">model_nickname</span> <span class="o">=</span> <span class="s2">&quot;__&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">model_name_or_path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">2</span><span class="p">:])</span>
    <span class="k">if</span> <span class="s2">&quot;input_ids&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dataset</span><span class="o">.</span><span class="n">column_names</span><span class="p">:</span>
        <span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">map</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">tokenizer</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">],</span> <span class="n">truncation</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
            <span class="n">batched</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;tokenizing&quot;</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">if</span> <span class="s2">&quot;SWE-Llama&quot;</span> <span class="ow">in</span> <span class="n">model_name_or_path</span> <span class="ow">and</span> <span class="n">dataset</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;input_ids&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">2</span><span class="p">:]</span> <span class="o">!=</span> <span class="p">[</span><span class="mi">13</span><span class="p">,</span> <span class="mi">13</span><span class="p">]:</span>
        <span class="c1"># SWE-Llama needs two exactly two newlines at the end</span>
        <span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">map</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;input_ids&quot;</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;input_ids&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="mi">13</span><span class="p">]},</span> <span class="n">batched</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>
    <span class="n">filter_func</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">min_len</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">max_len</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">filter_func</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">&gt;=</span> <span class="n">min_len</span>
    <span class="k">elif</span> <span class="n">min_len</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">max_len</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">filter_func</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">max_len</span>
    <span class="k">elif</span> <span class="n">min_len</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">max_len</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">filter_func</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">min_len</span> <span class="o">&lt;=</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">max_len</span>
    <span class="k">if</span> <span class="n">filter_func</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">filter_func</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s2">&quot;input_ids&quot;</span><span class="p">])),</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;filtering for length&quot;</span>
        <span class="p">)</span>
    <span class="n">lens</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s2">&quot;input_ids&quot;</span><span class="p">]),</span> <span class="n">dataset</span><span class="p">)))</span>
    <span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">lens</span><span class="o">.</span><span class="n">argsort</span><span class="p">())</span>
    <span class="k">if</span> <span class="n">shard_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">num_shards</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">shard</span><span class="p">(</span><span class="n">num_shards</span><span class="p">,</span> <span class="n">shard_id</span><span class="p">,</span> <span class="n">contiguous</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
        <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;instance_id&quot;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">existing_ids</span><span class="p">,</span>
        <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;filtering for existing ids&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">lens</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s2">&quot;input_ids&quot;</span><span class="p">]),</span> <span class="n">dataset</span><span class="p">)))</span>  <span class="c1"># recompute</span>
    <span class="k">if</span> <span class="n">shard_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">num_shards</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;filtered dataset - </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span><span class="si">}</span><span class="s2"> examples, min length: </span><span class="si">{</span><span class="nb">min</span><span class="p">(</span><span class="n">lens</span><span class="p">)</span><span class="si">:</span><span class="s2">_</span><span class="si">}</span><span class="s2">, max length: </span><span class="si">{</span><span class="nb">max</span><span class="p">(</span><span class="n">lens</span><span class="p">)</span><span class="si">:</span><span class="s2">_</span><span class="si">}</span><span class="s2"> (shard </span><span class="si">{</span><span class="n">shard_id</span><span class="si">}</span><span class="s2"> of </span><span class="si">{</span><span class="n">num_shards</span><span class="si">}</span><span class="s2">)&quot;</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;filtered dataset - </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span><span class="si">}</span><span class="s2"> examples, min length: </span><span class="si">{</span><span class="nb">min</span><span class="p">(</span><span class="n">lens</span><span class="p">)</span><span class="si">:</span><span class="s2">_</span><span class="si">}</span><span class="s2">, max length: </span><span class="si">{</span><span class="nb">max</span><span class="p">(</span><span class="n">lens</span><span class="p">)</span><span class="si">:</span><span class="s2">_</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="n">dataset</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="swebench.inference.run_llama.generate" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>            <span class="doc doc-object-name doc-function-name">generate</span>


</h5>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">generate</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">dataset</span><span class="p">,</span> <span class="n">tokenizer</span><span class="p">,</span> <span class="n">temperature</span><span class="p">,</span> <span class="n">top_p</span><span class="p">,</span> <span class="n">fileobj</span><span class="p">,</span> <span class="n">model_name_or_path</span><span class="p">,</span> <span class="n">peft_path</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">


            <details class="quote">
              <summary>Source code in <code>swebench/inference/run_llama.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">generate</span><span class="p">(</span>
    <span class="n">model</span><span class="p">,</span>
    <span class="n">dataset</span><span class="p">,</span>
    <span class="n">tokenizer</span><span class="p">,</span>
    <span class="n">temperature</span><span class="p">,</span>
    <span class="n">top_p</span><span class="p">,</span>
    <span class="n">fileobj</span><span class="p">,</span>
    <span class="n">model_name_or_path</span><span class="p">,</span>
    <span class="n">peft_path</span><span class="p">,</span>
<span class="p">):</span>
    <span class="k">class</span><span class="w"> </span><span class="nc">RepeatingTokensCriteria</span><span class="p">(</span><span class="n">StoppingCriteria</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Stopping criteria based on repeating tokens in the generated sequence.</span>

<span class="sd">        Attributes:</span>
<span class="sd">            min_length (int): The minimum length of the generated sequence.</span>
<span class="sd">            min_tokens (int): The minimum number of unique tokens required in the suffix of the generated sequence.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">min_length</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">min_tokens</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">min_length</span> <span class="o">=</span> <span class="n">min_length</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">min_tokens</span> <span class="o">=</span> <span class="n">min_tokens</span>

        <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_ids</span><span class="p">,</span> <span class="n">scores</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Check if the stopping criteria is met based on repeating tokens.</span>

<span class="sd">            Args:</span>
<span class="sd">                input_ids (torch.Tensor): The input token IDs of the generated sequence.</span>
<span class="sd">                scores (torch.Tensor): The scores of the generated sequence.</span>
<span class="sd">                **kwargs: Additional keyword arguments.</span>

<span class="sd">            Returns:</span>
<span class="sd">                bool: True if the stopping criteria is met, False otherwise.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="n">input_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="o">==</span> <span class="n">tokenizer</span><span class="o">.</span><span class="n">eos_token_id</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="n">input_ids</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_length</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>
            <span class="n">suffix</span> <span class="o">=</span> <span class="n">input_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">min_length</span> <span class="p">:]</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">suffix</span><span class="p">))</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_tokens</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span>
            <span class="k">return</span> <span class="kc">False</span>

    <span class="n">stopping_criteria</span> <span class="o">=</span> <span class="n">StoppingCriteriaList</span><span class="p">([</span><span class="n">RepeatingTokensCriteria</span><span class="p">()])</span>
    <span class="n">fail_count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">ix</span><span class="p">,</span> <span class="n">instance</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tqdm</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Generating patches&quot;</span><span class="p">)):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">input_ids</span> <span class="o">=</span> <span class="n">instance</span><span class="p">[</span><span class="s2">&quot;input_ids&quot;</span><span class="p">]</span>
                <span class="n">input_ids</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span>
                    <span class="p">[</span><span class="n">input_ids</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">long</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">device</span>
                <span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processing </span><span class="si">{</span><span class="n">input_ids</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2"> tokens&quot;</span><span class="p">)</span>
                <span class="n">start</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
                <span class="n">output</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span>
                    <span class="n">input_ids</span><span class="o">=</span><span class="n">input_ids</span><span class="p">,</span>
                    <span class="n">attention_mask</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">input_ids</span><span class="p">),</span>
                    <span class="n">temperature</span><span class="o">=</span><span class="mf">1.0</span> <span class="k">if</span> <span class="n">temperature</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">temperature</span><span class="p">,</span>
                    <span class="n">top_p</span><span class="o">=</span><span class="n">top_p</span><span class="p">,</span>
                    <span class="n">do_sample</span><span class="o">=</span><span class="kc">False</span> <span class="k">if</span> <span class="n">temperature</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="kc">True</span><span class="p">,</span>
                    <span class="n">max_new_tokens</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span>
                    <span class="n">stopping_criteria</span><span class="o">=</span><span class="n">stopping_criteria</span><span class="p">,</span>
                    <span class="n">use_cache</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">total_len</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">output</span> <span class="o">=</span> <span class="n">output</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">cpu</span><span class="p">()[</span><span class="n">input_ids</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="p">:]</span>
                <span class="n">new_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Generated </span><span class="si">{</span><span class="n">new_len</span><span class="si">}</span><span class="s2"> tokens (</span><span class="si">{</span><span class="n">total_len</span><span class="si">}</span><span class="s2"> total) in </span><span class="si">{</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span><span class="si">}</span><span class="s2"> &quot;</span>
                    <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;seconds (speed: </span><span class="si">{</span><span class="n">new_len</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span><span class="si">}</span><span class="s2"> tps)&quot;</span>
                <span class="p">)</span>
                <span class="n">output</span> <span class="o">=</span> <span class="n">tokenizer</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">skip_special_tokens</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">output</span><span class="p">[:</span><span class="mi">200</span><span class="p">])</span>
                <span class="n">diff</span> <span class="o">=</span> <span class="n">extract_diff</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
                <span class="n">model_name_or_path</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;__</span><span class="si">{</span><span class="n">peft_path</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">peft_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
                <span class="n">res</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;instance_id&quot;</span><span class="p">:</span> <span class="n">instance</span><span class="p">[</span><span class="s2">&quot;instance_id&quot;</span><span class="p">],</span>
                    <span class="s2">&quot;full_output&quot;</span><span class="p">:</span> <span class="n">output</span><span class="p">,</span>
                    <span class="s2">&quot;model_patch&quot;</span><span class="p">:</span> <span class="n">diff</span><span class="p">,</span>
                    <span class="s2">&quot;model_name_or_path&quot;</span><span class="p">:</span> <span class="n">model_name_or_path</span><span class="p">,</span>
                <span class="p">}</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">res</span><span class="p">),</span> <span class="n">file</span><span class="o">=</span><span class="n">fileobj</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;failed on </span><span class="si">{</span><span class="n">ix</span><span class="si">}</span><span class="s2"> with </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">input_ids</span><span class="p">)</span><span class="si">}</span><span class="s2"> tokens&quot;</span><span class="p">)</span>
                <span class="n">fail_count</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">fail_count</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;too many failures&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="swebench.inference.run_llama.get_all_existing_ids" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>            <span class="doc doc-object-name doc-function-name">get_all_existing_ids</span>


</h5>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">get_all_existing_ids</span><span class="p">(</span><span class="n">output_file</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">


            <details class="quote">
              <summary>Source code in <code>swebench/inference/run_llama.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_all_existing_ids</span><span class="p">(</span><span class="n">output_file</span><span class="p">):</span>
    <span class="n">stub_pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
        <span class="sa">r</span><span class="s2">&quot;((?:[\w\-\.]+)\_\_temp\-((\d+(\.\d+)?)|None)\_\_top\-p\-((\d+(\.\d+)?)|None))(\_\_|\.jsonl)&quot;</span>
    <span class="p">)</span>
    <span class="n">match</span> <span class="o">=</span> <span class="n">stub_pattern</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">output_file</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">output_file</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
        <span class="k">return</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">match</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;output_file </span><span class="si">{</span><span class="n">output_file</span><span class="si">}</span><span class="s2"> doesn&#39;t match pattern&quot;</span><span class="p">)</span>
    <span class="n">stub</span> <span class="o">=</span> <span class="n">match</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">existing_ids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="n">output_files</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">output_file</span><span class="o">.</span><span class="n">parent</span><span class="p">)</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">stub</span> <span class="o">+</span> <span class="s2">&quot;*&quot;</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">output_files</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loading existing ids from existing </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">datum</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                <span class="n">existing_ids</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">datum</span><span class="p">[</span><span class="s2">&quot;instance_id&quot;</span><span class="p">])</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">existing_ids</span><span class="p">)</span><span class="si">}</span><span class="s2"> existing ids&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">existing_ids</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="swebench.inference.run_llama.main" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>            <span class="doc doc-object-name doc-function-name">main</span>


</h5>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">main</span><span class="p">(</span><span class="n">model_name_or_path</span><span class="p">,</span> <span class="n">peft_path</span><span class="p">,</span> <span class="n">dataset_path</span><span class="p">,</span> <span class="n">split</span><span class="p">,</span> <span class="n">temperature</span><span class="p">,</span> <span class="n">top_p</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">,</span> <span class="n">min_len</span><span class="p">,</span> <span class="n">max_len</span><span class="p">,</span> <span class="n">shard_id</span><span class="p">,</span> <span class="n">num_shards</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">


            <details class="quote">
              <summary>Source code in <code>swebench/inference/run_llama.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span>
    <span class="n">model_name_or_path</span><span class="p">,</span>
    <span class="n">peft_path</span><span class="p">,</span>
    <span class="n">dataset_path</span><span class="p">,</span>
    <span class="n">split</span><span class="p">,</span>
    <span class="n">temperature</span><span class="p">,</span>
    <span class="n">top_p</span><span class="p">,</span>
    <span class="n">output_dir</span><span class="p">,</span>
    <span class="n">min_len</span><span class="p">,</span>
    <span class="n">max_len</span><span class="p">,</span>
    <span class="n">shard_id</span><span class="p">,</span>
    <span class="n">num_shards</span><span class="p">,</span>
<span class="p">):</span>
    <span class="k">if</span> <span class="n">shard_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">num_shards</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;num_shards must be specified with shard_id&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">shard_id</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">num_shards</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;shard_id must be specified with num_shards&quot;</span><span class="p">)</span>
    <span class="n">peft_config</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">peft_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">peft_config</span> <span class="o">=</span> <span class="n">PeftConfig</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">peft_path</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">peft_config</span><span class="o">.</span><span class="n">base_model_name_or_path</span> <span class="o">!=</span> <span class="n">model_name_or_path</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;model_name_or_path </span><span class="si">{</span><span class="n">model_name_or_path</span><span class="si">}</span><span class="s2"> does not match peft_path base_model </span><span class="si">{</span><span class="n">peft_config</span><span class="o">.</span><span class="n">base_model_name_or_path</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
    <span class="n">output_file</span> <span class="o">=</span> <span class="n">get_output_file</span><span class="p">(</span>
        <span class="n">output_dir</span><span class="o">=</span><span class="n">output_dir</span><span class="p">,</span>
        <span class="n">model_name_or_path</span><span class="o">=</span><span class="n">model_name_or_path</span><span class="p">,</span>
        <span class="n">peft_path</span><span class="o">=</span><span class="n">peft_path</span><span class="p">,</span>
        <span class="n">dataset_path</span><span class="o">=</span><span class="n">dataset_path</span><span class="p">,</span>
        <span class="n">split</span><span class="o">=</span><span class="n">split</span><span class="p">,</span>
        <span class="n">temperature</span><span class="o">=</span><span class="n">temperature</span><span class="p">,</span>
        <span class="n">top_p</span><span class="o">=</span><span class="n">top_p</span><span class="p">,</span>
        <span class="n">min_len</span><span class="o">=</span><span class="n">min_len</span><span class="p">,</span>
        <span class="n">max_len</span><span class="o">=</span><span class="n">max_len</span><span class="p">,</span>
        <span class="n">shard_id</span><span class="o">=</span><span class="n">shard_id</span><span class="p">,</span>
        <span class="n">num_shards</span><span class="o">=</span><span class="n">num_shards</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;output_file: </span><span class="si">{</span><span class="n">output_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">load_model</span><span class="p">(</span><span class="n">model_name_or_path</span><span class="p">,</span> <span class="n">peft_path</span><span class="p">)</span>
    <span class="n">tokenizer</span> <span class="o">=</span> <span class="n">load_tokenizer</span><span class="p">(</span><span class="n">model_name_or_path</span><span class="p">)</span>
    <span class="n">existing_ids</span> <span class="o">=</span> <span class="n">get_all_existing_ids</span><span class="p">(</span><span class="n">output_file</span><span class="p">)</span>
    <span class="n">dataset</span> <span class="o">=</span> <span class="n">load_data</span><span class="p">(</span>
        <span class="n">dataset_path</span><span class="o">=</span><span class="n">dataset_path</span><span class="p">,</span>
        <span class="n">split</span><span class="o">=</span><span class="n">split</span><span class="p">,</span>
        <span class="n">tokenizer</span><span class="o">=</span><span class="n">tokenizer</span><span class="p">,</span>
        <span class="n">min_len</span><span class="o">=</span><span class="n">min_len</span><span class="p">,</span>
        <span class="n">max_len</span><span class="o">=</span><span class="n">max_len</span><span class="p">,</span>
        <span class="n">model_name_or_path</span><span class="o">=</span><span class="n">model_name_or_path</span><span class="p">,</span>
        <span class="n">peft_path</span><span class="o">=</span><span class="n">peft_path</span><span class="p">,</span>
        <span class="n">existing_ids</span><span class="o">=</span><span class="n">existing_ids</span><span class="p">,</span>
        <span class="n">shard_id</span><span class="o">=</span><span class="n">shard_id</span><span class="p">,</span>
        <span class="n">num_shards</span><span class="o">=</span><span class="n">num_shards</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">generate</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
            <span class="n">dataset</span><span class="o">=</span><span class="n">dataset</span><span class="p">,</span>
            <span class="n">tokenizer</span><span class="o">=</span><span class="n">tokenizer</span><span class="p">,</span>
            <span class="n">temperature</span><span class="o">=</span><span class="n">temperature</span><span class="p">,</span>
            <span class="n">top_p</span><span class="o">=</span><span class="n">top_p</span><span class="p">,</span>
            <span class="n">fileobj</span><span class="o">=</span><span class="n">f</span><span class="p">,</span>
            <span class="n">model_name_or_path</span><span class="o">=</span><span class="n">model_name_or_path</span><span class="p">,</span>
            <span class="n">peft_path</span><span class="o">=</span><span class="n">peft_path</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Done&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>


  </div>

    </div>

</div>









  




                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    
      
      <nav class="md-footer__inner md-grid" aria-label="Footer" >
        
          
          <a href="../harness/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Harness">
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Previous
              </span>
              <div class="md-ellipsis">
                Harness
              </div>
            </div>
          </a>
        
        
          
          <a href="../versioning/" class="md-footer__link md-footer__link--next" aria-label="Next: Versioning">
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Next
              </span>
              <div class="md-ellipsis">
                Versioning
              </div>
            </div>
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"/></svg>
            </div>
          </a>
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.tabs", "navigation.tabs.sticky", "navigation.indexes", "content.action.edit", "navigation.footer", "content.code.copy", "content.footnote.tooltips", "header.autohide", "announce.dismiss", "content.code.annotate"], "search": "../../assets/javascripts/workers/search.d50fe291.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": {"provider": "mike"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.50899def.min.js"></script>
      
    
  <script id="init-glightbox">const lightbox = GLightbox({"touchNavigation": true, "loop": false, "zoomable": true, "draggable": true, "openEffect": "zoom", "closeEffect": "zoom", "slideEffect": "slide"});
document$.subscribe(() => { lightbox.reload() });
</script></body>
</html>